<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>西北打卡系統</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' rx='6' fill='%23dc2626'/%3E%3Cg transform='translate(12,12) scale(0.6) translate(-12,-12)'%3E%3Ccircle cx='12' cy='12' r='10' stroke='white' stroke-width='2.5' fill='none'/%3E%3Cpolyline points='12 6 12 12 16 14' stroke='white' stroke-width='2.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/g%3E%3C/svg%3E" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        (function(){
            var w=console.warn.bind(console);
            var e=console.error.bind(console);
            function s(args){
                try{
                    var t=Array.prototype.map.call(args,function(a){return String(a)}).join(' ');
                    return t.indexOf('[BABEL] Note: The code generator has deoptimised the styling')>=0;
                }catch(_){return false}
            }
            console.warn=function(){ if(s(arguments)) return; w.apply(console,arguments); };
            console.error=function(){ if(s(arguments)) return; e.apply(console,arguments); };
        })();
    </script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Import Map for Modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js",
        "firebase/storage": "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>

    <style>
        /* Font Unification: Traditional Chinese */
        body {
            font-family: "Microsoft JhengHei", "PingFang TC", "Heiti TC", "Apple LiGothic Medium", "PMingLiU", sans-serif !important;
        }

        /* Mobile optimization */
        body {
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Custom Background Pulse Animation for Abnormal Status */
        @keyframes bg-red-pulse {
            0%, 100% { background-color: #fecaca; } /* bg-red-200 */
            50% { background-color: #fee2e2; } /* bg-red-100 */
        }
        .animate-bg-red-pulse {
            animation: bg-red-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @media print {
            @page {
                size: A4 portrait;
                margin: 10mm;
            }
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                background-color: white;
            }
            #attendance-report {
                overflow: visible !important;
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
            }
            #attendance-report > div {
                min-width: 0 !important;
            }
            /* Ensure grid rows expand and don't break awkwardly */
            #attendance-report .grid {
                break-inside: avoid;
                page-break-inside: avoid;
                height: auto !important;
                align-items: start;
            }
        }
    </style>
    <script src="./firebase-config.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzhLdWtycJgfz8UsXWlji63DkXpA4kmyY&loading=async&language=zh-TW"></script>
</head>
<body class="bg-gray-100 text-gray-900 font-sans antialiased">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { initializeApp, setLogLevel, deleteApp } from 'firebase/app';
        import { 
            getAuth,
            onAuthStateChanged,
            signInWithCustomToken,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            sendPasswordResetEmail,
            updatePassword
        } from 'firebase/auth';
        import { 
            getFirestore, 
            initializeFirestore,
            collection, 
            addDoc, 
            query, 
            where, 
            orderBy, 
            serverTimestamp,
            getDocs,
            updateDoc,
            setDoc,
            deleteDoc,
            doc,
            onSnapshot,
            limit,
            writeBatch,
            arrayUnion
        } from 'firebase/firestore';
        import {
            getStorage,
            ref as storageRef,
            uploadBytes,
            getDownloadURL
        } from 'firebase/storage';
        import { 
            Clock, 
            Bell, 
            LogOut, 
            Shield, 
            Users, 
            FileText, 
            Briefcase, 
            AlertCircle, 
            CheckCircle, 
            MapPin, 
            Calendar, 
            LayoutDashboard,
            Building,
            Building2,
            Eye,
            EyeOff,
            Home,
            BarChart3,
            ClipboardList,
            Settings,
            X,

            Edit,
            Trash2,
            Camera,
            RefreshCw,
            ChevronLeft,
            ChevronRight,
            ChevronUp,
            ChevronDown,
            Check,
            Gavel,
            XCircle,
            CheckSquare,
            Phone
        } from 'lucide-react';

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(() => {});
        }

        // --- Firebase Configuration ---
        // 如果您在本地打開此檔案，請在此處填入您的 Firebase Config
        const manualConfig = null; 
        
        // 嘗試從環境變數或手動設定中獲取配置
        const getFirebaseConfig = () => {
            if (manualConfig) return manualConfig;
            if (typeof window !== 'undefined' && window.FIREBASE_CONFIG) {
                return window.FIREBASE_CONFIG;
            }
            if (typeof __firebase_config !== 'undefined') {
                try {
                    return JSON.parse(__firebase_config);
                } catch (e) {
                    return {};
                }
            }
            return {};
        };

        const firebaseConfig = getFirebaseConfig();
        const __DEBUG__ = false;
        if (!__DEBUG__) {
            try { console.log = function(){}; } catch(e){}
            try { console.info = function(){}; } catch(e){}
            try { console.warn = function(){}; } catch(e){}
        }
        setLogLevel('silent');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = initializeFirestore(app, {
            ignoreUndefinedProperties: true,
            experimentalForceLongPolling: true,
        });
        const storage = getStorage(app);
        
        // App ID logic for compatibility
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-attendance-app';

        // --- Components ---

        // 1. Loading Spinner (Red Theme)
        const Loading = () => (
            <div className="min-h-screen flex items-center justify-center bg-gray-50">
                <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-600"></div>
            </div>
        );

        // 1.2 Company Map Preview Component
        const CompanyMapPreview = ({ lat, lng, radius, avatarUrl, users, externalSelectedUserId, onUserSelect }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const circleRef = useRef(null);
            const userRangeCircleRef = useRef(null);
            const checkInRangeCircleRef = useRef(null);
            const markerRef = useRef(null);
            const userMarkerRef = useRef(null);
            const markersRef = useRef([]);
            const [showResetBtn, setShowResetBtn] = useState(false);
            const [selectedUser, setSelectedUser] = useState(null);

            // Handle external selection changes
            useEffect(() => {
                if (externalSelectedUserId && users) {
                    const target = users.find(u => u.id === externalSelectedUserId);
                    if (target) {
                        if (mapInstanceRef.current) {
                            let panLat, panLng;
                            if (target.lat && target.lng) {
                                panLat = parseFloat(target.lat);
                                panLng = parseFloat(target.lng);
                            } else if (target.refLat && target.refLng) {
                                panLat = parseFloat(target.refLat);
                                panLng = parseFloat(target.refLng);
                            }

                            if (panLat != null && panLng != null) {
                                mapInstanceRef.current.panTo({ lat: panLat, lng: panLng });
                                mapInstanceRef.current.setZoom(19);
                                setShowResetBtn(true);
                            }
                        }
                        setSelectedUser(target);
                    }
                }
            }, [externalSelectedUserId, users]);

            // Reset state when location changes (e.g. switching companies)
            useEffect(() => {
                setShowResetBtn(false);
                setSelectedUser(null);
                if (onUserSelect) onUserSelect(null);
            }, [lat, lng]);

            const handleResetCenter = () => {
                if (mapInstanceRef.current && lat && lng) {
                    const center = { lat: parseFloat(lat), lng: parseFloat(lng) };
                    mapInstanceRef.current.panTo(center);
                    mapInstanceRef.current.setZoom(17);
                    setShowResetBtn(false);
                    setSelectedUser(null);
                    if (onUserSelect) onUserSelect(null);
                }
            };

            // Custom Overlay for Avatar Markers
            // Defined inside useEffect to ensure google.maps is loaded
            
            useEffect(() => {
                if (!lat || !lng || !window.google || !window.google.maps || !mapRef.current) return;

                class AvatarOverlay extends google.maps.OverlayView {
                    constructor(position, imageUrl, name, map, onSelect) {
                        super();
                        this.position = position;
                        this.imageUrl = imageUrl;
                        this.name = name;
                        this.onSelect = onSelect;
                        this.div = null;
                        this.setMap(map);
                    }

                    onAdd() {
                        const div = document.createElement('div');
                        div.style.position = 'absolute';
                        div.style.cursor = 'pointer';
                        div.style.width = '40px';
                        div.style.height = '40px';
                        div.style.zIndex = '100'; // Ensure above other elements
                        
                        // Create inner content
                        const inner = document.createElement('div');
                        inner.style.width = '100%';
                        inner.style.height = '100%';
                        inner.style.borderRadius = '50%';
                        inner.style.border = '2px solid white';
                        inner.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                        inner.style.overflow = 'hidden';
                        inner.style.backgroundColor = 'white';

                        if (this.imageUrl) {
                            const img = document.createElement('img');
                            img.src = this.imageUrl;
                            img.style.width = '100%';
                            img.style.height = '100%';
                            img.style.objectFit = 'cover';
                            inner.appendChild(img);
                        } else {
                            inner.style.backgroundColor = '#9CA3AF';
                            inner.style.display = 'flex';
                            inner.style.alignItems = 'center';
                            inner.style.justifyContent = 'center';
                            inner.style.color = 'white';
                            inner.style.fontWeight = 'bold';
                            inner.style.fontSize = '16px';
                            inner.innerText = this.name ? this.name.charAt(0).toUpperCase() : '?';
                        }
                        
                        div.appendChild(inner);

                        div.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (this.onSelect) this.onSelect();
                        });

                        this.div = div;
                        const panes = this.getPanes();
                        panes.overlayMouseTarget.appendChild(div);
                    }

                    draw() {
                        const overlayProjection = this.getProjection();
                        if (!overlayProjection || !this.position) return;
                        
                        const point = overlayProjection.fromLatLngToDivPixel(this.position);
                        if (this.div && point) {
                            this.div.style.left = (point.x - 20) + 'px';
                            this.div.style.top = (point.y - 20) + 'px';
                        }
                    }

                    onRemove() {
                        if (this.div) {
                            this.div.parentNode.removeChild(this.div);
                            this.div = null;
                        }
                    }
                }

                const location = { lat: parseFloat(lat), lng: parseFloat(lng) };
                const r = parseFloat(radius) || 100;

                const initMap = async () => {
                    // Clear previous multiple markers
                    markersRef.current.forEach(m => m.setMap(null));
                    markersRef.current = [];

                    if (!mapInstanceRef.current) {
                        // Init Map
                        mapInstanceRef.current = new google.maps.Map(mapRef.current, {
                            center: location,
                            zoom: 17,
                            disableDefaultUI: false,
                            zoomControl: true,
                            mapTypeControl: true,
                            streetViewControl: false,
                            fullscreenControl: false,
                            rotateControl: false,
                            scaleControl: false,
                            gestureHandling: 'greedy'
                        });
                        
                        mapInstanceRef.current.addListener('dragend', () => {
                            setShowResetBtn(true);
                        });

                        mapInstanceRef.current.addListener('zoomend', () => {
                            setShowResetBtn(true);
                        });
                        
                        // Close info window on map click
                        mapInstanceRef.current.addListener('click', () => {
                            setSelectedUser(null);
                        });

                        // Init Circle
                        circleRef.current = new google.maps.Circle({
                            strokeColor: "#EF4444",
                            strokeOpacity: 0.8,
                            strokeWeight: 2,
                            fillColor: "#EF4444",
                            fillOpacity: 0.15,
                            map: mapInstanceRef.current,
                            center: location,
                            radius: r
                        });
                        
                        // Add center marker
                         if (markerRef.current) markerRef.current.setMap(null);
                         markerRef.current = new google.maps.Marker({
                             position: location,
                             map: mapInstanceRef.current,
                             icon: {
                                  path: google.maps.SymbolPath.CIRCLE,
                                  scale: 6,
                                  fillColor: "#EF4444",
                                  fillOpacity: 1,
                                  strokeColor: "white",
                                  strokeWeight: 2,
                             },
                             title: "公司中心"
                         });
                    } else {
                        // Update Circle
                        if (circleRef.current) {
                            circleRef.current.setCenter(location);
                            circleRef.current.setRadius(r);
                        }
                        if (markerRef.current) {
                            if (selectedUser && selectedUser.lat && selectedUser.lng) {
                                markerRef.current.setMap(null);
                            } else {
                                markerRef.current.setPosition(location);
                                markerRef.current.setIcon({
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 6,
                                    fillColor: "#EF4444",
                                    fillOpacity: 1,
                                    strokeColor: "white",
                                    strokeWeight: 2
                                });
                                markerRef.current.setTitle("公司中心");
                                markerRef.current.setMap(mapInstanceRef.current);
                            }
                        }
                    }

                    // Handle Users
                    if (users && users.length > 0) {
                        const newMarkers = [];
                        for (const u of users) {
                             if (u.lat && u.lng) {
                                 const uLoc = { lat: parseFloat(u.lat), lng: parseFloat(u.lng) };
                                 
                                 // Use AvatarOverlay instead of Marker
                                 const m = new AvatarOverlay(
                                     new google.maps.LatLng(uLoc.lat, uLoc.lng),
                                     u.avatarUrl,
                                     u.name,
                                     mapInstanceRef.current,
                                     () => {
                                         // onSelect logic
                                         mapInstanceRef.current.panTo(uLoc);
                                         mapInstanceRef.current.setZoom(19); 
                                         setShowResetBtn(true);
                                         setSelectedUser(u);
                                         if (onUserSelect) onUserSelect(u);
                                     }
                                 );
                                 
                                 newMarkers.push(m);
                             }
                        }
                        markersRef.current = newMarkers;
                    }
                    
                    const targetUser = selectedUser || (users && externalSelectedUserId ? users.find(u => u.id === externalSelectedUserId) : null);
                    if (targetUser && targetUser.refLat && targetUser.refLng) {
                        const uLoc = { lat: parseFloat(targetUser.refLat), lng: parseFloat(targetUser.refLng) };
                        const uRadius = parseFloat(targetUser.refRadius || 100);
                        if (!userRangeCircleRef.current) {
                            userRangeCircleRef.current = new google.maps.Circle({
                                strokeColor: "#3B82F6",
                                strokeOpacity: 0.8,
                                strokeWeight: 2,
                                fillColor: "#3B82F6",
                                fillOpacity: 0.15,
                                map: mapInstanceRef.current,
                                center: uLoc,
                                radius: uRadius,
                                zIndex: 50
                            });
                        } else {
                            userRangeCircleRef.current.setCenter(uLoc);
                            userRangeCircleRef.current.setRadius(uRadius);
                            userRangeCircleRef.current.setMap(mapInstanceRef.current);
                        }
                    } else {
                        if (userRangeCircleRef.current) {
                            userRangeCircleRef.current.setMap(null);
                        }
                    }
                    
                    if (targetUser && targetUser.lat && targetUser.lng && targetUser.refRadius) {
                        const cLoc = { lat: parseFloat(targetUser.lat), lng: parseFloat(targetUser.lng) };
                        const cRadius = parseFloat(targetUser.refRadius || 100);
                        if (!checkInRangeCircleRef.current) {
                            checkInRangeCircleRef.current = new google.maps.Circle({
                                strokeColor: "#10B981",
                                strokeOpacity: 0.8,
                                strokeWeight: 2,
                                fillColor: "#10B981",
                                fillOpacity: 0.08,
                                map: mapInstanceRef.current,
                                center: cLoc,
                                radius: cRadius,
                                zIndex: 49
                            });
                        } else {
                            checkInRangeCircleRef.current.setCenter(cLoc);
                            checkInRangeCircleRef.current.setRadius(cRadius);
                            checkInRangeCircleRef.current.setMap(mapInstanceRef.current);
                        }
                    } else {
                        if (checkInRangeCircleRef.current) {
                            checkInRangeCircleRef.current.setMap(null);
                        }
                    }
                    
                    if (targetUser && ((targetUser.lat && targetUser.lng) || (targetUser.refLat && targetUser.refLng))) {
                        const pos = (targetUser.lat && targetUser.lng)
                            ? { lat: parseFloat(targetUser.lat), lng: parseFloat(targetUser.lng) }
                            : { lat: parseFloat(targetUser.refLat), lng: parseFloat(targetUser.refLng) };
                        const icon = targetUser.avatarUrl
                            ? { url: targetUser.avatarUrl, scaledSize: new google.maps.Size(40, 40), anchor: new google.maps.Point(20, 20) }
                            : { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: "#10B981", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 };
                        if (!userMarkerRef.current) {
                            userMarkerRef.current = new google.maps.Marker({ position: pos, map: mapInstanceRef.current, icon, title: targetUser.name || "" });
                        } else {
                            userMarkerRef.current.setPosition(pos);
                            userMarkerRef.current.setIcon(icon);
                            userMarkerRef.current.setMap(mapInstanceRef.current);
                        }
                    } else {
                        if (userMarkerRef.current) {
                            userMarkerRef.current.setMap(null);
                        }
                    }
                    
                    // Force center on company location ONLY if NOT manually moved/zoomed (reset button hidden)
                    // AND no user is currently selected externally
                    if (!showResetBtn && !selectedUser && !externalSelectedUserId) {
                        mapInstanceRef.current.setCenter(location);
                        mapInstanceRef.current.setZoom(17);
                    }
                };
                
                initMap();
            }, [lat, lng, radius, avatarUrl, users, showResetBtn, selectedUser, externalSelectedUserId]);

            return (
                <div className="w-full h-full relative">
                    <div ref={mapRef} className="w-full h-full"></div>
                    {showResetBtn && (
                        <button 
                            onClick={handleResetCenter}
                            className="absolute top-2 right-2 bg-white text-red-600 px-3 py-1.5 rounded-xl shadow-md text-xs font-bold flex items-center gap-1 hover:bg-gray-50 transition-all z-10"
                        >
                            <MapPin className="w-3 h-3" /> 回到公司
                        </button>
                    )}

                    


                    {selectedUser && (
                        <div 
                            onClick={() => selectedUser.phone && (window.location.href = `tel:${selectedUser.phone}`)}
                            className={`absolute bottom-4 left-4 right-4 ${selectedUser.statusBgClass || 'bg-white/95'} backdrop-blur-sm p-3 rounded-2xl shadow-lg border border-gray-100 z-10 animate-fade-in-up ${selectedUser.phone ? 'cursor-pointer active:scale-95 transition-transform' : ''}`}
                        >
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-full bg-gray-200 overflow-hidden flex-shrink-0 border border-gray-100">
                                    {selectedUser.avatarUrl ? (
                                        <img src={selectedUser.avatarUrl} alt={selectedUser.name} className="w-full h-full object-cover" />
                                    ) : (
                                        <div className="w-full h-full flex items-center justify-center font-bold text-gray-500 text-xs">
                                            {selectedUser.name?.[0]}
                                        </div>
                                    )}
                                </div>
                                <div className="flex-1 min-w-0">
                                    <div className="font-bold text-gray-800 text-sm truncate">{selectedUser.name}</div>
                                    {(function(){
                                        const statusText = selectedUser.statusText || '今日尚未打卡';
                                        const statusClass = selectedUser.statusClass || 'text-red-600';
                                        
                                        return (
                                            <div className={`mt-0.5 text-xs font-bold ${statusClass}`}>
                                                {statusText}
                                            </div>
                                        );
                                    })()}
                                    {selectedUser.phone && (
                                        <div className="mt-0.5 text-xs text-gray-500 font-medium flex items-center gap-1">
                                            <Phone className="w-3 h-3" /> {selectedUser.phone}
                                        </div>
                                    )}
                                </div>
                                <button 
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        setSelectedUser(null);
                                        if (onUserSelect) onUserSelect(null);
                                    }}
                                    className="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100"
                                >
                                    <X className="w-4 h-4" />
                                </button>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const NotificationModal = ({ isOpen, onClose, onConfirm, form, setForm, loading, users = [], companies = [] }) => {
            const [showDropdown, setShowDropdown] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');

            // Derived state from form.target
            const selectedTargets = useMemo(() => {
                return form.target ? form.target.split('、').filter(Boolean) : [];
            }, [form.target]);

            const handleToggle = (value) => {
                const newSet = new Set(selectedTargets);
                if (newSet.has(value)) {
                    newSet.delete(value);
                } else {
                    newSet.add(value);
                }
                const newTarget = Array.from(newSet).join('、');
                setForm({ ...form, target: newTarget });
                setSearchTerm('');
            };

            // Group users by company
            const groupedUsers = useMemo(() => {
                const groups = {};
                const getCompanyName = (cId) => {
                    const c = companies.find(x => x.id === cId);
                    return c ? c.name : '未分類';
                };

                users.forEach(u => {
                    const roleMap = {
                        'admin': '系統管理員',
                        'manager': '管理層',
                        'hr': '人事',
                        'property': '物業',
                        'cadre': '幹部',
                        'staff': '員工'
                    };
                    const roleName = roleMap[u.role] || u.role;
                    const companyName = getCompanyName(u.companyId);
                    if (!groups[companyName]) {
                        groups[companyName] = [];
                    }
                    groups[companyName].push({
                        ...u,
                        roleName
                    });
                });
                return groups;
            }, [users, companies]);

            const filteredOptions = useMemo(() => {
                const term = searchTerm.toLowerCase();
                const options = [];

                // Special options
                const specialOptions = [
                    { id: 'all', label: '全部', value: '全部' },
                    { id: 'all_tp', label: '全台北公司', value: '全台北公司' },
                    { id: 'all_ty', label: '全桃園公司', value: '全桃園公司' }
                ];

                specialOptions.forEach(opt => {
                     if (!term || opt.label.includes(term)) {
                         options.push(opt);
                     }
                });

                Object.entries(groupedUsers).forEach(([companyName, companyUsers]) => {
                    companyUsers.forEach(u => {
                        const label = `${companyName}${u.name}`;
                        if (!term || label.toLowerCase().includes(term)) {
                            options.push({ id: u.id, label, value: label });
                        }
                    });
                });
                return options;
            }, [groupedUsers, searchTerm]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl w-full max-w-md p-6 animate-in fade-in zoom-in duration-200" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-gray-800">新增通知</h3>
                            <button onClick={onClose} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors"><X className="w-5 h-5 text-gray-500" /></button>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">通知對象</label>
                                <div className="relative">
                                    <div className="flex flex-wrap gap-2 mb-2 p-2 bg-gray-50 rounded-xl min-h-[42px] border border-transparent focus-within:border-red-200 focus-within:bg-white transition-colors">
                                        {selectedTargets.map(target => (
                                            <span key={target} className="bg-white border border-gray-200 text-gray-700 px-2 py-1 rounded-lg text-xs flex items-center gap-1 shadow-sm animate-in fade-in zoom-in duration-100">
                                                {target}
                                                <button onClick={() => handleToggle(target)} className="hover:text-red-500"><X className="w-3 h-3" /></button>
                                            </span>
                                        ))}
                                        <input 
                                            type="text"
                                            value={searchTerm} 
                                            onChange={e => {
                                                setSearchTerm(e.target.value);
                                                setShowDropdown(true);
                                            }}
                                            onFocus={() => setShowDropdown(true)}
                                            onBlur={() => setTimeout(() => setShowDropdown(false), 200)}
                                            className="flex-1 bg-transparent border-0 p-1 text-sm outline-none min-w-[80px]"
                                            placeholder={selectedTargets.length === 0 ? "搜尋對象..." : ""}
                                        />
                                    </div>

                                    {showDropdown && (
                                        <ul className="absolute left-0 right-0 mt-1 bg-white border border-gray-100 rounded-xl shadow-xl max-h-[200px] overflow-y-auto z-50 py-1">
                                            {filteredOptions.map(option => {
                                                const isSelected = selectedTargets.includes(option.value);
                                                return (
                                                    <li 
                                                        key={option.id}
                                                        className={`px-4 py-2 hover:bg-red-50 cursor-pointer text-sm text-gray-700 transition-colors border-b border-gray-50 last:border-0 flex items-center justify-between ${isSelected ? 'bg-red-50' : ''}`}
                                                        onMouseDown={(e) => {
                                                            e.preventDefault();
                                                            handleToggle(option.value);
                                                        }}
                                                    >
                                                        <span>{option.label}</span>
                                                        {isSelected && <span className="text-red-500 font-bold">✓</span>}
                                                    </li>
                                                );
                                            })}
                                            {filteredOptions.length === 0 && (
                                                <li className="px-4 py-2 text-gray-400 text-sm text-center">無符合對象</li>
                                            )}
                                        </ul>
                                    )}
                                </div>
                                <p className="text-[10px] text-gray-400 mt-1 ml-1">可多選，支援：全部、全台北公司、全桃園公司</p>
                            </div>
                            
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">通知內容</label>
                                <textarea 
                                    value={form.content}
                                    onChange={e => setForm({...form, content: e.target.value})}
                                    className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm min-h-[120px] outline-none focus:ring-2 focus:ring-red-500 resize-none transition-shadow"
                                    placeholder="請輸入通知內容..."
                                />
                            </div>

                            <div className="flex gap-2 justify-end mt-4">
                                <button onClick={onClose} className="px-5 py-2.5 bg-gray-100 rounded-xl text-gray-600 font-bold text-sm hover:bg-gray-200 transition-colors">取消</button>
                                <button 
                                    onClick={onConfirm} 
                                    disabled={loading}
                                    className="px-5 py-2.5 bg-red-600 rounded-xl text-white font-bold text-sm flex items-center shadow-md shadow-red-200 hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {loading ? '發送中...' : '發送通知'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Error Boundary Component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error("ErrorBoundary caught an error", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-6 bg-red-50 border border-red-200 rounded-2xl text-red-700 text-center m-4">
                            <h2 className="font-bold text-lg mb-2">頁面發生錯誤</h2>
                            <p className="text-sm mb-4">很抱歉，系統遇到預期外的錯誤。</p>
                            <pre className="text-xs bg-white p-3 rounded-xl overflow-auto text-left mx-auto max-w-lg shadow-inner">
                                {this.state.error && this.state.error.toString()}
                            </pre>
                            <button 
                                onClick={() => window.location.reload()}
                                className="mt-4 px-4 py-2 bg-red-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-red-200 hover:bg-red-700 transition"
                            >
                                重新整理頁面
                            </button>
                                        </div>
                                        );
                                    }
                                    
                                    
                return this.props.children; 
            }
        }

        // 1. Camera Modal
        const CameraModal = ({ isOpen, onClose, onConfirm, type, userName, userAvatar, workSite, checkInLocationName, availableLocations = [], checkInLocation, setCheckInLocation }) => {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const mapRef = useRef(null);
            const workSiteCircleRef = useRef(null);
            const [stream, setStream] = useState(null);
            const [image, setImage] = useState(null);
            const [location, setLocation] = useState(null);
            const [address, setAddress] = useState('定位中...');
            const [error, setError] = useState('');
            const [step, setStep] = useState('location'); // location, camera, preview
            const [isProcessing, setIsProcessing] = useState(false);
            const [showLocationList, setShowLocationList] = useState(false);
            const [facing, setFacing] = useState('user');
            const [cameraDevices, setCameraDevices] = useState([]);
            const [selectedDeviceId, setSelectedDeviceId] = useState(null);

            useEffect(() => {
                if (isOpen) {
                    setStep('location');
                    startLocation();
                } else {
                    stopCamera();
                    setImage(null);
                    setStep('location');
                    setLocation(null);
                    setAddress('定位中...');
                    setError('');
                    if (workSiteCircleRef.current) {
                        workSiteCircleRef.current.setMap(null);
                        workSiteCircleRef.current = null;
                    }
                }
            }, [isOpen]);

            // Initialize Map when location is found and step is 'location'
            useEffect(() => {
                try {
                    if (step === 'location' && location && mapRef.current && window.google && window.google.maps) {
                        // Calculate Target Location (prioritize checkInLocation over workSite)
                        let targetLocation = null;
                        let targetName = "服務單位";
                        const target = checkInLocation || workSite;

                        if (target) {
                            if (target.lat && target.lng) {
                                targetLocation = { lat: parseFloat(target.lat), lng: parseFloat(target.lng) };
                            } else if (target.location) {
                                const locStr = String(target.location);
                                const parts = locStr.split(',');
                                if (parts.length === 2) {
                                    const lat = parseFloat(parts[0].trim());
                                    const lng = parseFloat(parts[1].trim());
                                    if (!isNaN(lat) && !isNaN(lng)) {
                                        targetLocation = { lat, lng };
                                    }
                                }
                            }
                            targetName = target.name || "服務單位";
                        }

                        // Center on User Location if available, otherwise Target Location
                        const mapCenter = location || targetLocation;

                        const map = new google.maps.Map(mapRef.current, {
                            center: mapCenter,
                            zoom: 17,
                            disableDefaultUI: false,
                            zoomControl: true,
                            mapTypeControl: true,
                            streetViewControl: false,
                            fullscreenControl: false,
                            rotateControl: false,
                            scaleControl: false,
                        });

                        // User Marker
                        const createDefaultMarker = () => {
                            new google.maps.Marker({
                                position: location,
                                map: map,
                                title: "目前位置",
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 7,
                                    fillColor: "#4285F4",
                                    fillOpacity: 1,
                                    strokeColor: "white",
                                    strokeWeight: 2,
                                },
                                zIndex: 1000
                            });
                        };

                        if (userAvatar) {
                            const img = new Image();
                            img.crossOrigin = "Anonymous";
                            img.src = userAvatar;
                            img.onload = () => {
                                try {
                                    const canvas = document.createElement('canvas');
                                    canvas.width = 80;
                                    canvas.height = 80;
                                    const ctx = canvas.getContext('2d');

                                    // White background/border
                                    ctx.beginPath();
                                    ctx.arc(40, 40, 40, 0, Math.PI * 2, true);
                                    ctx.fillStyle = '#ffffff';
                                    ctx.fill();

                                    // Clip for image
                                    ctx.save();
                                    ctx.beginPath();
                                    ctx.arc(40, 40, 36, 0, Math.PI * 2, true);
                                    ctx.closePath();
                                    ctx.clip();
                                    
                                    // Draw Image (cover)
                                    // Calculate aspect ratio to cover
                                    const scale = Math.max(80 / img.width, 80 / img.height);
                                    const x = (80 - img.width * scale) / 2;
                                    const y = (80 - img.height * scale) / 2;
                                    ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                                    ctx.restore();

                                    // Blue Border Ring
                                    ctx.beginPath();
                                    ctx.lineWidth = 4;
                                    ctx.strokeStyle = '#4285F4';
                                    ctx.arc(40, 40, 38, 0, Math.PI * 2, true);
                                    ctx.stroke();

                                    new google.maps.Marker({
                                        position: location,
                                        map: map,
                                        title: "目前位置",
                                        icon: {
                                            url: canvas.toDataURL(),
                                            scaledSize: new google.maps.Size(48, 48),
                                            anchor: new google.maps.Point(24, 24)
                                        },
                                        zIndex: 1000
                                    });
                                } catch (e) {
                                    console.error("Avatar marker error:", e);
                                    createDefaultMarker();
                                }
                            };
                            img.onerror = () => {
                                console.warn("Avatar load failed, using default marker");
                                createDefaultMarker();
                            };
                        } else {
                            createDefaultMarker();
                        }

                        // Target Location Marker and Circle
                        if (targetLocation) {
                            if (workSiteCircleRef.current) {
                                workSiteCircleRef.current.setMap(null);
                            }
                            
                            workSiteCircleRef.current = new google.maps.Circle({
                                strokeColor: "#FF0000",
                                strokeOpacity: 0.8,
                                strokeWeight: 2,
                                fillColor: "#FF0000",
                                fillOpacity: 0.15,
                                map: map,
                                center: targetLocation,
                                radius: 100 // Default 100m
                            });

                            if (userAvatar) {
                                const img2 = new Image();
                                img2.crossOrigin = "Anonymous";
                                img2.src = userAvatar;
                                img2.onload = () => {
                                    try {
                                        const canvas2 = document.createElement('canvas');
                                        canvas2.width = 80;
                                        canvas2.height = 80;
                                        const ctx2 = canvas2.getContext('2d');
                                        ctx2.beginPath();
                                        ctx2.arc(40, 40, 40, 0, Math.PI * 2, true);
                                        ctx2.fillStyle = '#ffffff';
                                        ctx2.fill();
                                        ctx2.save();
                                        ctx2.beginPath();
                                        ctx2.arc(40, 40, 36, 0, Math.PI * 2, true);
                                        ctx2.closePath();
                                        ctx2.clip();
                                        const scale2 = Math.max(80 / img2.width, 80 / img2.height);
                                        const x2 = (80 - img2.width * scale2) / 2;
                                        const y2 = (80 - img2.height * scale2) / 2;
                                        ctx2.drawImage(img2, x2, y2, img2.width * scale2, img2.height * scale2);
                                        ctx2.restore();
                                        ctx2.beginPath();
                                        ctx2.lineWidth = 4;
                                        ctx2.strokeStyle = '#4285F4';
                                        ctx2.arc(40, 40, 38, 0, Math.PI * 2, true);
                                        ctx2.stroke();
                                        new google.maps.Marker({
                                            position: targetLocation,
                                            map: map,
                                            title: targetName,
                                            icon: {
                                                url: canvas2.toDataURL(),
                                                scaledSize: new google.maps.Size(48, 48),
                                                anchor: new google.maps.Point(24, 24)
                                            }
                                        });
                                    } catch (e) {
                                        new google.maps.Marker({
                                            position: targetLocation,
                                            map: map,
                                            title: targetName
                                        });
                                    }
                                };
                                img2.onerror = () => {
                                    new google.maps.Marker({
                                        position: targetLocation,
                                        map: map,
                                        title: targetName
                                    });
                                };
                            } else {
                                new google.maps.Marker({
                                    position: targetLocation,
                                    map: map,
                                    title: targetName
                                });
                            }
                        }
                    }
                } catch (err) {
                    console.error("Map initialization error:", err);
                    // Don't crash the UI, just log the error
                }
            }, [step, location, workSite, checkInLocation, userAvatar]);

            const startCamera = async (targetFacing = facing) => {
                try {
                    if (stream) {
                        stream.getTracks().forEach(t => t.stop());
                    }
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error(/iPhone|iPad|iPod/.test(navigator.userAgent) ? '無法存取相機：請至「設定 > Safari > 相機」允許存取' : '您的瀏覽器不支援相機功能，請使用 Safari (iOS) 或 Chrome (Android)');
                    }
                    let constraints = { video: { facingMode: { exact: targetFacing }, width: { ideal: 1280 }, height: { ideal: 720 } } };
                    let s = null;
                    try {
                        s = await navigator.mediaDevices.getUserMedia(constraints);
                    } catch {
                        constraints = { video: { facingMode: targetFacing, width: { ideal: 1280 }, height: { ideal: 720 } } };
                        try {
                            s = await navigator.mediaDevices.getUserMedia(constraints);
                        } catch {
                            const base = await navigator.mediaDevices.getUserMedia({ video: true, audio: false }).catch(() => null);
                            if (base) {
                                const devices = await navigator.mediaDevices.enumerateDevices();
                                const vids = devices.filter(d => d.kind === 'videoinput');
                                setCameraDevices(vids);
                                const pickFront = vids.find(d => /front|前/i.test(d.label));
                                const pickBack = vids.find(d => /back|rear|後/i.test(d.label));
                                const pick = targetFacing === 'user' ? (pickFront || vids[0]) : (pickBack || vids[vids.length - 1] || vids[0]);
                                if (pick) {
                                    setSelectedDeviceId(pick.deviceId);
                                    s = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: pick.deviceId }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false });
                                }
                            }
                            if (!s) {
                                s = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                            }
                        }
                    }
                    setStream(s);
                    if (videoRef.current) {
                        videoRef.current.srcObject = s;
                    }
                } catch (e) {
                    setError('無法存取相機：' + (e.message || '請確認權限'));
                    console.error(e);
                }
            };

            const stopCamera = () => {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    setStream(null);
                }
            };

            const startLocation = () => {
                setAddress('定位中...');
                setError('');
                if (!navigator.geolocation) {
                    setAddress('瀏覽器不支援定位');
                    return;
                }

                const successCallback = async (pos) => {
                    const { latitude, longitude } = pos.coords;
                    setLocation({ lat: latitude, lng: longitude });
                    setError('');
                    // Reverse Geocoding
                    try {
                        if (window.google && window.google.maps) {
                            const gc = new google.maps.Geocoder();
                            const latlng = { lat: latitude, lng: longitude };
                            gc.geocode({ location: latlng }, (results, status) => {
                                if (status === 'OK' && results[0]) {
                                    setAddress(results[0].formatted_address);
                                } else {
                                    setAddress(`${latitude.toFixed(4)}, ${longitude.toFixed(4)}`);
                                }
                            });
                        } else {
                            setAddress(`${latitude.toFixed(4)}, ${longitude.toFixed(4)}`);
                        }
                    } catch (e) {
                        setAddress(`${latitude.toFixed(4)}, ${longitude.toFixed(4)}`);
                    }
                };

                const errorCallback = (err) => {
                    console.error(err);
                    let msg = '定位失敗';
                    switch(err.code) {
                        case err.PERMISSION_DENIED:
                            msg = '定位權限被拒絕，請允許存取位置';
                            break;
                        case err.POSITION_UNAVAILABLE:
                            msg = '無法偵測位置資訊';
                            break;
                        case err.TIMEOUT:
                            msg = '定位逾時，請重試或確認訊號';
                            break;
                    }
                    setAddress(msg);
                    setError(msg);
                };

                // 策略：根據裝置類型決定優先順序
                // 手機 (Mobile)：優先嘗試高精準度 (GPS)，失敗降級
                // 電腦 (Desktop)：優先使用 Wi-Fi/IP 定位，避免 GPS 逾時
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (isMobile) {
                    // Mobile: High Accuracy Priority
                    navigator.geolocation.getCurrentPosition(
                        successCallback,
                        (err) => {
                            console.warn("Mobile GPS failed, falling back to low accuracy...", err);
                            navigator.geolocation.getCurrentPosition(
                                successCallback,
                                errorCallback,
                                { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 }
                            );
                        },
                        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                    );
                } else {
                    // Desktop: Low Accuracy Priority
                    // We can optionally try to refine with High Accuracy afterwards, but let's stick to stable Low Accuracy first
                    navigator.geolocation.getCurrentPosition(
                        (lowPos) => {
                            successCallback(lowPos);
                            // Optional: Silently try to upgrade to High Accuracy for better precision
                            navigator.geolocation.getCurrentPosition(
                                (highPos) => {
                                    console.log("Desktop High Accuracy refinement success");
                                    successCallback(highPos);
                                },
                                (err) => {
                                    console.log("Desktop High Accuracy refinement failed (expected), keeping low accuracy");
                                },
                                { enableHighAccuracy: true, timeout: 3000, maximumAge: 0 }
                            );
                        },
                        (err) => {
                             // If Low Accuracy fails, try High Accuracy as last resort
                             console.warn("Desktop Low Accuracy failed, trying High Accuracy...", err);
                             navigator.geolocation.getCurrentPosition(
                                successCallback,
                                errorCallback,
                                { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                             );
                        },
                        { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 }
                    );
                }
            };

            const handleRelocate = () => {
                setLocation(null);
                if (workSiteCircleRef.current) {
                    workSiteCircleRef.current.setMap(null);
                    workSiteCircleRef.current = null;
                }
                startLocation();
            };

            const handleShowWorkSite = () => {
                const target = checkInLocation || workSite;
                if (!target) {
                    alert('未找到您的服務單位資料');
                    return;
                }
                
                let wsLocation = null;
                if (target.lat && target.lng) {
                    wsLocation = { lat: parseFloat(target.lat), lng: parseFloat(target.lng) };
                } else if (target.location) {
                    const locStr = String(target.location);
                    const parts = locStr.split(',');
                    if (parts.length === 2) {
                        const lat = parseFloat(parts[0].trim());
                        const lng = parseFloat(parts[1].trim());
                        if (!isNaN(lat) && !isNaN(lng)) {
                            wsLocation = { lat, lng };
                        }
                    }
                }

                if (!wsLocation) {
                    alert('服務單位未設定有效的 GPS 座標');
                    return;
                }

                if (mapRef.current && window.google && window.google.maps) {
                    const mapInstance = new google.maps.Map(mapRef.current, {
                        center: wsLocation || location,
                        zoom: 17,
                        disableDefaultUI: false,
                        zoomControl: true,
                        mapTypeControl: true,
                        streetViewControl: false,
                        fullscreenControl: false,
                        rotateControl: false,
                        scaleControl: false,
                    });

                    if (location) {
                        if (userAvatar) {
                            const img3 = new Image();
                            img3.crossOrigin = "Anonymous";
                            img3.src = userAvatar;
                            img3.onload = () => {
                                try {
                                    const canvas3 = document.createElement('canvas');
                                    canvas3.width = 80;
                                    canvas3.height = 80;
                                    const ctx3 = canvas3.getContext('2d');
                                    ctx3.beginPath();
                                    ctx3.arc(40, 40, 40, 0, Math.PI * 2, true);
                                    ctx3.fillStyle = '#ffffff';
                                    ctx3.fill();
                                    ctx3.save();
                                    ctx3.beginPath();
                                    ctx3.arc(40, 40, 36, 0, Math.PI * 2, true);
                                    ctx3.closePath();
                                    ctx3.clip();
                                    const scale3 = Math.max(80 / img3.width, 80 / img3.height);
                                    const x3 = (80 - img3.width * scale3) / 2;
                                    const y3 = (80 - img3.height * scale3) / 2;
                                    ctx3.drawImage(img3, x3, y3, img3.width * scale3, img3.height * scale3);
                                    ctx3.restore();
                                    ctx3.beginPath();
                                    ctx3.lineWidth = 4;
                                    ctx3.strokeStyle = '#4285F4';
                                    ctx3.arc(40, 40, 38, 0, Math.PI * 2, true);
                                    ctx3.stroke();
                                    new google.maps.Marker({
                                        position: location,
                                        map: mapInstance,
                                        title: "目前位置",
                                        icon: {
                                            url: canvas3.toDataURL(),
                                            scaledSize: new google.maps.Size(48, 48),
                                            anchor: new google.maps.Point(24, 24)
                                        }
                                    });
                                } catch (e) {
                                    new google.maps.Marker({
                                        position: location,
                                        map: mapInstance,
                                        title: "目前位置"
                                    });
                                }
                            };
                            img3.onerror = () => {
                                new google.maps.Marker({
                                    position: location,
                                    map: mapInstance,
                                    title: "目前位置"
                                });
                            };
                        } else {
                            new google.maps.Marker({
                                position: location,
                                map: mapInstance,
                                title: "目前位置"
                            });
                        }
                    }

                    // Work Site Circle
                    if (workSiteCircleRef.current) {
                        workSiteCircleRef.current.setMap(null);
                    }
                    
                    workSiteCircleRef.current = new google.maps.Circle({
                        strokeColor: "#FF0000",
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: "#FF0000",
                        fillOpacity: 0.15,
                        map: mapInstance,
                        center: wsLocation,
                        radius: 100 // Default 100m if not specified
                    });

                    if (userAvatar) {
                        const img4 = new Image();
                        img4.crossOrigin = "Anonymous";
                        img4.src = userAvatar;
                        img4.onload = () => {
                            try {
                                const canvas4 = document.createElement('canvas');
                                canvas4.width = 80;
                                canvas4.height = 80;
                                const ctx4 = canvas4.getContext('2d');
                                ctx4.beginPath();
                                ctx4.arc(40, 40, 40, 0, Math.PI * 2, true);
                                ctx4.fillStyle = '#ffffff';
                                ctx4.fill();
                                ctx4.save();
                                ctx4.beginPath();
                                ctx4.arc(40, 40, 36, 0, Math.PI * 2, true);
                                ctx4.closePath();
                                ctx4.clip();
                                const scale4 = Math.max(80 / img4.width, 80 / img4.height);
                                const x4 = (80 - img4.width * scale4) / 2;
                                const y4 = (80 - img4.height * scale4) / 2;
                                ctx4.drawImage(img4, x4, y4, img4.width * scale4, img4.height * scale4);
                                ctx4.restore();
                                ctx4.beginPath();
                                ctx4.lineWidth = 4;
                                ctx4.strokeStyle = '#4285F4';
                                ctx4.arc(40, 40, 38, 0, Math.PI * 2, true);
                                ctx4.stroke();
                                new google.maps.Marker({
                                    position: wsLocation,
                                    map: mapInstance,
                                    title: target.name || "服務單位",
                                    icon: {
                                        url: canvas4.toDataURL(),
                                        scaledSize: new google.maps.Size(48, 48),
                                        anchor: new google.maps.Point(24, 24)
                                    }
                                });
                            } catch (e) {
                                new google.maps.Marker({
                                    position: wsLocation,
                                    map: mapInstance,
                                    title: target.name || "服務單位"
                                });
                            }
                        };
                        img4.onerror = () => {
                            new google.maps.Marker({
                                position: wsLocation,
                                map: mapInstance,
                                title: target.name || "服務單位"
                            });
                        };
                    } else {
                        new google.maps.Marker({
                            position: wsLocation,
                            map: mapInstance,
                            title: target.name || "服務單位"
                        });
                    }
                }
            };

            const nextToCamera = () => {
                setStep('camera');
                startCamera(facing);
            };

            const capture = () => {
                if (!videoRef.current || !canvasRef.current) return;
                const video = videoRef.current;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                
                // Resize logic - Force 1:1 Crop
                const videoW = video.videoWidth;
                const videoH = video.videoHeight;
                
                // Determine crop size (square)
                const size = Math.min(videoW, videoH);
                
                // Calculate center crop
                const startX = (videoW - size) / 2;
                const startY = (videoH - size) / 2;
                
                const outputSize = 800; // Output resolution

                canvas.width = outputSize;
                canvas.height = outputSize;
                
                // Draw Video - Crop center square
                // drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight)
                ctx.drawImage(video, startX, startY, size, size, 0, 0, outputSize, outputSize);
                
                // Draw Watermark
                const dateStr = new Date().toLocaleString('zh-TW');
                
                // Gradient Background for text
                const grad = ctx.createLinearGradient(0, canvas.height - 100, 0, canvas.height);
                grad.addColorStop(0, 'transparent');
                grad.addColorStop(1, 'rgba(0,0,0,0.8)');
                ctx.fillStyle = grad;
                ctx.fillRect(0, canvas.height - 100, canvas.width, 100);

                ctx.fillStyle = 'white';
                ctx.font = 'bold 24px sans-serif';
                ctx.fillText(dateStr, 20, canvas.height - 60);
                ctx.font = '16px sans-serif';
                ctx.fillText(address, 20, canvas.height - 35);
                if (location) {
                    ctx.fillText(`GPS: ${location.lat}, ${location.lng}`, 20, canvas.height - 15);
                }
                
                // CheckIn Location Name (Top Left)
                if (checkInLocationName) {
                    ctx.textAlign = 'left';
                    ctx.font = 'bold 20px sans-serif';
                    ctx.fillStyle = 'white';
                    ctx.shadowColor = 'black';
                    ctx.shadowBlur = 4;
                    ctx.fillText(checkInLocationName, 20, 40);
                }

                // User Name (Top Right)
                ctx.textAlign = 'right';
                ctx.font = 'bold 20px sans-serif';
                ctx.shadowColor = 'black';
                ctx.shadowBlur = 4;
                ctx.fillText(userName || '', canvas.width - 20, 40);

                canvas.toBlob((blob) => {
                    if (blob) {
                        console.log(`Image size: ${(blob.size / 1024).toFixed(2)} KB`);
                        // Optional: alert(`照片大小: ${(blob.size / 1024).toFixed(2)} KB`);
                    }
                    setImage(blob);
                    setStep('preview');
                    stopCamera();
                }, 'image/jpeg', 0.5);
            };

            const retake = () => {
                setImage(null);
                setStep('camera');
                startCamera(facing);
            };
            
            const toggleFacing = async () => {
                const next = facing === 'user' ? 'environment' : 'user';
                setFacing(next);
                await startCamera(next);
            };

            const isMounted = useRef(true);
            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            const confirm = async () => {
                if (!image || !location) return;
                setIsProcessing(true);
                try {
                    await onConfirm(image, location, address);
                } catch (e) {
                    console.error(e);
                } finally {
                    if (isMounted.current) {
                        setIsProcessing(false);
                    }
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[100] bg-black bg-opacity-90 flex flex-col items-center justify-center p-4">
                    <div className="bg-white rounded-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh] h-[600px]">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50 flex-shrink-0">
                            <h3 className="font-bold text-lg">
                                {{
                                    'in': '上班打卡',
                                    'out': '下班簽退',
                                    'outing_start': '外出打卡',
                                    'outing_arrive': '抵達打卡',
                                    'outing_end': '離開打卡'
                                }[type] || '打卡'} - 流程
                            </h3>
                            <button onClick={onClose} className="p-2 bg-gray-200 rounded-full"><X className="w-5 h-5" /></button>
                        </div>
                        
                        <div className="flex-1 bg-gray-100 relative flex items-center justify-center overflow-hidden w-full">
                            {step === 'location' && (
                                <div className="w-full h-full flex flex-col">
                                    <div className="flex-1 relative w-full h-full">
                                        {location ? (
                                            <div className="relative w-full h-full">
                                                <div ref={mapRef} className="w-full h-full"></div>

                                                {/* Check-In Location Selector */}
                                                <div className="absolute top-4 left-4 z-10 flex flex-col gap-1">
                                                    <div className="bg-white/90 px-3 py-1 rounded-t-lg shadow-sm text-xs font-bold text-gray-500 w-fit">
                                                        打卡位置
                                                    </div>
                                                    <div className="bg-white rounded-lg shadow-lg overflow-hidden min-w-[160px] transition-all duration-200">
                                                        {(availableLocations || []).length > 1 || checkInLocation?.type === 'custom' ? (
                                                            <div className="flex flex-col">
                                                                <button
                                                                    onClick={() => setShowLocationList(!showLocationList)}
                                                                    className="px-4 py-3 text-left font-bold text-sm text-gray-800 hover:bg-gray-50 transition-colors flex items-center justify-between w-full"
                                                                >
                                                                    <div className="flex items-center gap-2">
                                                                        <span className={checkInLocation ? 'text-red-600' : ''}>
                                                                            {checkInLocation?.name || '請選擇位置'}
                                                                        </span>
                                                                    </div>
                                                                    {showLocationList ? <ChevronUp className="w-4 h-4 text-gray-400" /> : <ChevronDown className="w-4 h-4 text-gray-400" />}
                                                                </button>
                                                                
                                                                {showLocationList && (
                                                                    <div className="border-t max-h-[200px] overflow-y-auto">
                                                                        {(availableLocations || []).map(loc => (
                                                                            <button
                                                                                key={loc.id}
                                                                                onClick={() => {
                                                                                    setCheckInLocation && setCheckInLocation(loc);
                                                                                    setShowLocationList(false);
                                                                                }}
                                                                                className={`px-4 py-3 text-left font-bold text-sm border-b last:border-0 hover:bg-gray-50 transition-colors flex items-center justify-between w-full ${checkInLocation?.id === loc.id ? 'bg-red-50 text-red-600' : 'text-gray-800'}`}
                                                                            >
                                                                                {loc.name}
                                                                                {checkInLocation?.id === loc.id && <Check className="w-4 h-4" />}
                                                                            </button>
                                                                        ))}
                                                                    </div>
                                                                )}

                                                                {/* Custom Location Input */}
                                                                {checkInLocation?.type === 'custom' && (
                                                                    <div className="p-2 border-t bg-gray-50">
                                                                        <input 
                                                                            type="text" 
                                                                            placeholder="請輸入地點名稱" 
                                                                            className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-red-500 outline-none"
                                                                            value={checkInLocation.name === '自定義地點' ? '' : checkInLocation.name}
                                                                            onChange={(e) => setCheckInLocation && setCheckInLocation({ ...checkInLocation, name: e.target.value || '自定義地點' })}
                                                                            onClick={(e) => e.stopPropagation()}
                                                                        />
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ) : (
                                                            <div className="px-4 py-3 font-bold text-sm text-gray-800 flex items-center gap-2">
                                                                <Building2 className="w-4 h-4 text-red-600" />
                                                                {checkInLocationName || '未指定位置'}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                
                                                {/* Relocate Button */}
                                                <button 
                                                    onClick={handleRelocate}
                                                    className="absolute bottom-4 right-4 bg-white p-3 rounded-full shadow-lg hover:bg-gray-100 z-10"
                                                    title="重新定位"
                                                >
                                                    <RefreshCw className="w-6 h-6 text-gray-700" />
                                                </button>

                                                {/* Show Work Site Button */}
                                                <button 
                                                    onClick={handleShowWorkSite}
                                                    className="absolute top-4 right-4 bg-red-600 text-white px-4 py-2 rounded-2xl shadow-lg hover:bg-red-700 z-10 font-bold text-sm flex items-center gap-2"
                                                    title="顯示打卡點範圍"
                                                >
                                                    <MapPin className="w-4 h-4" /> 打卡點
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="w-full h-full flex items-center justify-center text-gray-500 flex-col gap-2">
                                                <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-red-600"></div>
                                                <div>定位中...</div>
                                            </div>
                                        )}
                                    </div>
                                    <div className="p-4 bg-white border-t">
                                        <div className="flex items-start gap-3">
                                            <MapPin className={`w-5 h-5 mt-1 flex-shrink-0 ${error ? 'text-gray-400' : 'text-red-600'}`} />
                                            <div className="flex-1">
                                                <div className="text-xs text-gray-400">目前位置</div>
                                                <div className={`font-bold text-sm ${error ? 'text-red-500' : 'text-gray-800'}`}>{address}</div>
                                            </div>
                                            {error && (
                                                <button onClick={startLocation} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200" title="重新定位">
                                                    <RefreshCw className="w-4 h-4 text-gray-600" />
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {step === 'camera' && (
                                <div className="w-full max-w-md aspect-square relative overflow-hidden bg-black shadow-lg rounded-2xl">
                                    <video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover"></video>
                                    <div className="absolute bottom-4 left-4 right-4 text-white text-xs bg-black/50 p-2 rounded-2xl">
                                        <MapPin className="w-3 h-3 inline mr-1" />
                                        {address}
                                    </div>
                                </div>
                            )}

                            {step === 'preview' && (
                                <div className="w-full max-w-md aspect-square relative overflow-hidden bg-black shadow-lg rounded-2xl">
                                    <img src={URL.createObjectURL(image)} className="w-full h-full object-cover" />
                                </div>
                            )}
                            <canvas ref={canvasRef} className="hidden"></canvas>
                        </div>

                        <div className="p-6 bg-white flex-shrink-0">
                            {error && <div className="text-red-500 text-center mb-4 text-sm">{error}</div>}
                            
                            {step === 'location' && (
                                <button 
                                    onClick={nextToCamera} 
                                    disabled={!location}
                                    className="w-full py-4 bg-red-600 text-white rounded-2xl font-bold text-lg flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    下一步：拍照認證
                                </button>
                            )}

                            {step === 'camera' && (
                                <div className="flex gap-3">
                                    <button onClick={toggleFacing} className="flex-1 py-3 bg-gray-100 text-gray-700 rounded-2xl font-bold flex items-center justify-center gap-2">
                                        前/後鏡頭
                                    </button>
                                    <button onClick={capture} className="flex-1 py-3 bg-red-600 text-white rounded-2xl font-bold text-lg flex items-center justify-center gap-2">
                                        <Camera className="w-6 h-6" /> 拍照
                                    </button>
                                </div>
                            )}

                            {step === 'preview' && (
                                <div className="flex gap-3">
                                    <button onClick={retake} className="flex-1 py-3 bg-gray-100 text-gray-700 rounded-2xl font-bold flex items-center justify-center gap-2">
                                        <RefreshCw className="w-5 h-5" /> 重拍
                                    </button>
                                    <button onClick={confirm} disabled={isProcessing} className="flex-1 py-3 bg-red-600 text-white rounded-2xl font-bold flex items-center justify-center gap-2">
                                        {isProcessing ? '處理中...' : '確認打卡'}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>


                </div>
            );
        };

        const SignatureModal = ({ isOpen, onClose, onConfirm, loading, error, form, setForm, signatureTypes, title, confirmText }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl w-full max-w-md p-6 animate-in fade-in zoom-in duration-200" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-gray-800">{title || '新增電子簽呈'}</h3>
                            <button onClick={onClose} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors"><X className="w-5 h-5 text-gray-500" /></button>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">類型</label>
                                <select 
                                    value={form.type} 
                                    onChange={e => setForm({...form, type: e.target.value})}
                                    className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-red-500 transition-shadow"
                                >
                                    <option value="" disabled>請選擇類型</option>
                                    {signatureTypes && signatureTypes.length > 0 ? (
                                        signatureTypes.map(type => (
                                            <option key={type.id} value={type.name}>{type.name}</option>
                                        ))
                                    ) : (
                                        <>
                                            <option value="請假申請">請假申請</option>
                                            <option value="加班申請">加班申請</option>
                                            <option value="費用報銷">費用報銷</option>
                                            <option value="採購申請">採購申請</option>
                                            <option value="其他事項">其他事項</option>
                                        </>
                                    )}
                                </select>
                            </div>
                            
                            {(form.type && form.type.includes('請假')) && (
                                <div className="grid grid-cols-1 gap-3">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">請假日期</label>
                                        <input 
                                            type="date" 
                                            value={form.leaveDate || ''} 
                                            onChange={e => setForm({ ...form, leaveDate: e.target.value })} 
                                            className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-orange-500 transition-shadow"
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">開始時間</label>
                                            <input 
                                                type="time" 
                                                value={form.leaveStartTime || ''} 
                                                onChange={e => setForm({ ...form, leaveStartTime: e.target.value })} 
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-orange-500 transition-shadow"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">結束時間</label>
                                            <input 
                                                type="time" 
                                                value={form.leaveEndTime || ''} 
                                                onChange={e => setForm({ ...form, leaveEndTime: e.target.value })} 
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-orange-500 transition-shadow"
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">請假事由</label>
                                        <select 
                                            value={form.leaveReason || ''} 
                                            onChange={e => setForm({ ...form, leaveReason: e.target.value })} 
                                            className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-orange-500 transition-shadow"
                                        >
                                            <option value="">選擇事由</option>
                                            <option value="事假">事假</option>
                                            <option value="病假">病假</option>
                                            <option value="公出">公出</option>
                                            <option value="婚喪假">婚喪假</option>
                                            <option value="其他">其他</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">說明</label>
                                        <textarea 
                                            value={form.note || ''} 
                                            onChange={e => setForm({ ...form, note: e.target.value })} 
                                            className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm min-h-[80px] outline-none focus:ring-2 focus:ring-orange-500 resize-none transition-shadow"
                                            placeholder="請輸入說明..."
                                        />
                                    </div>
                                </div>
                            )}

                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">內容說明</label>
                                <textarea 
                                    value={form.content}
                                    onChange={e => setForm({...form, content: e.target.value})}
                                    className="w-full bg-gray-50 border-0 p-3 rounded-xl text-sm min-h-[120px] outline-none focus:ring-2 focus:ring-red-500 resize-none transition-shadow"
                                    placeholder="請輸入詳細內容..."
                                />
                            </div>

                            {error && <div className="text-red-500 text-xs font-bold bg-red-50 p-2 rounded-lg">{error}</div>}

                            <div className="flex gap-2 justify-end mt-4">
                                <button onClick={onClose} className="px-5 py-2.5 bg-gray-100 rounded-xl text-gray-600 font-bold text-sm hover:bg-gray-200 transition-colors">取消</button>
                                <button 
                                    onClick={onConfirm} 
                                    disabled={loading}
                                    className="px-5 py-2.5 bg-red-600 rounded-xl text-white font-bold text-sm flex items-center shadow-md shadow-red-200 hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {loading ? '送出中...' : (confirmText || '送出申請')}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. Login Component (Mobile Optimized, Red Theme)
        const Login = ({ onLogin, onLoginSuccess, isOnline }) => {
            const [showUpgradeNotice, setShowUpgradeNotice] = useState(true);
            const [noticeCountdown, setNoticeCountdown] = useState(10);

            useEffect(() => {
                if (!showUpgradeNotice) return;
                if (noticeCountdown <= 0) {
                    setShowUpgradeNotice(false);
                    return;
                }
                const timer = setInterval(() => {
                    setNoticeCountdown(prev => prev - 1);
                }, 1000);
                return () => clearInterval(timer);
            }, [showUpgradeNotice, noticeCountdown]);

            const [identifier, setIdentifier] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isSeeding, setIsSeeding] = useState(false);
            const [rememberMe, setRememberMe] = useState(true);
            const [showPassword, setShowPassword] = useState(false);
            const [isLoading, setIsLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                if (!identifier || !password) {
                    setError('請輸入帳號密碼');
                    return;
                }
                setError('');
                setIsLoading(true);
                try {
                    await onLogin(identifier, password, rememberMe);
                    setError('登入成功！正在跳轉...');
                    setTimeout(() => {
                        onLoginSuccess();
                    }, 1000);
                } catch (e) {
                    setIsLoading(false);
                    if (e && e.code === 'auth/network-request-failed') {
                        setError('網路連線失敗，請確認網路與允許網域設定後重試');
                    } else if (e && e.code === 'auth/invalid-email') {
                        setError('Email 格式不正確');
                    } else if (e && e.code === 'auth/invalid-credential') {
                        setError('帳號或密碼錯誤');
                    } else {
                        setError(`登入錯誤: ${e.message || '請重試'}`);
                    }
                }
            };


            return (
                <div className="min-h-screen flex flex-col justify-center bg-gray-50 px-6 py-12">
                    {showUpgradeNotice && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden relative animate-bounce-in">
                                <button 
                                    onClick={() => setShowUpgradeNotice(false)}
                                    className="absolute top-3 right-3 p-1 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-500 transition-colors"
                                >
                                    <X className="w-5 h-5" />
                                </button>
                                
                                <div className="p-6 text-center">
                                    <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <Bell className="w-8 h-8 text-red-600" />
                                    </div>
                                    <h3 className="text-xl font-bold text-gray-800 mb-2">系統升級通知</h3>
                                    <p className="text-gray-600 mb-6 leading-relaxed">
                                        西北打卡系統已升級至2026版<br/>
                                        請使用原帳號密碼登入，謝謝~
                                    </p>
                                    <div className="text-xs font-bold text-gray-400 bg-gray-50 py-2 rounded-lg">
                                        {noticeCountdown} 秒後自動關閉
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="w-full max-w-sm mx-auto bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
                        <div className="text-center mb-8">
                            <div className="bg-red-600 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-red-200">
                                <Clock className="text-white w-10 h-10" />
                            </div>
                            <h1 className="text-2xl font-bold text-gray-800 tracking-tight">西北社區打卡系統</h1>
                            <p className="text-gray-400 text-sm mt-2">安居管家 · 智慧服務</p>
                        </div>

                        <form onSubmit={handleLogin} className="space-y-5">
                            <div>
                                <div className="flex items-center justify-between mb-2">
                                    <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider">帳號 (Email 或 手機號碼)</label>
                                    <label className="flex items-center gap-1 text-[11px] text-gray-500">
                                        <input type="checkbox" checked={rememberMe} onChange={(e) => setRememberMe(e.target.checked)} /> 記住我
                                    </label>
                                </div>
                                <input
                                    type="text"
                                    value={identifier}
                                    onChange={(e) => setIdentifier(e.target.value)}
                                    className="w-full px-5 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition text-gray-700 font-medium"
                                    placeholder="電子信箱 或 手機號碼"
                                    disabled={isLoading}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">密碼</label>
                                <div className="relative">
                                    <input
                                        type={showPassword ? 'text' : 'password'}
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full pr-12 px-5 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition text-gray-700 font-medium"
                                        placeholder="••••••"
                                        disabled={isLoading}
                                    />
                                    <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-700">
                                        {showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                                    </button>
                                </div>
                            </div>

                            {error && (
                                <div className={`text-sm text-center p-3 rounded-2xl font-medium ${error.includes('成功') ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-600'}`}>
                                    {error}
                                </div>
                            )}

                            <button
                                type="submit"
                                disabled={!isOnline || isLoading}
                                className="w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-bold py-4 rounded-2xl transition duration-200 shadow-lg shadow-red-200 text-lg disabled:opacity-50 flex items-center justify-center gap-2"
                            >
                                {isLoading ? (
                                    <>
                                        <div className="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"></div>
                                        處理中...
                                    </>
                                ) : (
                                    '登入系統'
                                )}
                            </button>

                            
                            {!isOnline && (
                                <div className="mt-3 text-center text-xs text-yellow-700 bg-yellow-50 border border-yellow-200 rounded-2xl py-2">
                                    目前離線，請確認網路後再試
                                </div>
                            )}
                        </form>

                        
                    </div>
                </div>
            );
        };

        // 3. Admin Dashboard (System Config)
        const AdminDashboard = ({ user, currentUser, users, communities, roles, companies, areas, signatureTypes, pages, onAddUser, onAddCommunity, subtab, setActiveTab, setCadreSubtab, setCadreMapSelectedUserId, subPagesMap, hasSubPermission }) => {
            const [newCommName, setNewCommName] = useState('');
            const [newUser, setNewUser] = useState({ name: '', email: '', role: 'staff', communityId: '' });
            const [showAddModal, setShowAddModal] = useState(false);
            const [modalUser, setModalUser] = useState({ role: 'admin', title: '', name: '', email: '', phone: '', communityId: '', avatarUrl: '', status: '在職', startDate: '', resignDate: '' });

            // Sorting State
            const [roleSort, setRoleSort] = useState({ key: null, direction: 'asc' });
            const [companySort, setCompanySort] = useState({ key: null, direction: 'asc' });
            const [areaSort, setAreaSort] = useState({ key: null, direction: 'asc' });
            const [signatureTypeSort, setSignatureTypeSort] = useState({ key: null, direction: 'asc' });

            const handleSort = (key, currentSort, setSort) => {
                let direction = 'asc';
                if (currentSort.key === key && currentSort.direction === 'asc') {
                    direction = 'desc';
                }
                setSort({ key, direction });
            };

            const getSortedData = (data, sortConfig, defaultSortFunc) => {
                if (!sortConfig.key) {
                    return defaultSortFunc ? defaultSortFunc([...data]) : data;
                }

                return [...data].sort((a, b) => {
                    let aValue = a[sortConfig.key];
                    let bValue = b[sortConfig.key];

                    // Handle nulls
                    if (aValue == null) aValue = '';
                    if (bValue == null) bValue = '';
                    
                    // Handle Firestore Timestamps
                    if (aValue && typeof aValue.toDate === 'function') aValue = aValue.toDate().getTime();
                    else if (aValue && aValue.seconds) aValue = aValue.seconds * 1000;
                    
                    if (bValue && typeof bValue.toDate === 'function') bValue = bValue.toDate().getTime();
                    else if (bValue && bValue.seconds) bValue = bValue.seconds * 1000;

                    // Check for numeric strings
                    const aNum = parseFloat(aValue);
                    const bNum = parseFloat(bValue);
                    if (!isNaN(aNum) && !isNaN(bNum) && String(aNum) === String(aValue) && String(bNum) === String(bValue)) {
                        return sortConfig.direction === 'asc' ? aNum - bNum : bNum - aNum;
                    }

                    if (aValue < bValue) {
                        return sortConfig.direction === 'asc' ? -1 : 1;
                    }
                    if (aValue > bValue) {
                        return sortConfig.direction === 'asc' ? 1 : -1;
                    }
                    return 0;
                });
            };

            const SortHeader = ({ label, sortKey, currentSort, setSort, className }) => (
                <div 
                    className={`cursor-pointer hover:bg-gray-100 p-1 rounded transition-colors flex items-center gap-1 ${className || ''}`}
                    onClick={() => handleSort(sortKey, currentSort, setSort)}
                >
                    {label}
                    {currentSort.key === sortKey ? (
                        currentSort.direction === 'asc' ? <ChevronUp className="w-3 h-3" /> : <ChevronDown className="w-3 h-3" />
                    ) : <div className="w-3 h-3" />}
                </div>
            );

            const [showRoleModal, setShowRoleModal] = useState(false);
            const [roleForm, setRoleForm] = useState({ name: '', permissions: [], subPermissions: {} });
            const [roleSaving, setRoleSaving] = useState(false);
            const [roleError, setRoleError] = useState('');

            // Role Reordering Logic
            const [draggedRole, setDraggedRole] = useState(null);

            const handleReorderRoles = async (newItems) => {
                setRoleSaving(true);
                try {
                    const batch = writeBatch(db);
                    newItems.forEach((item, idx) => {
                        const ref = doc(db, 'artifacts', appId, 'public', 'data', 'roles', item.id);
                        batch.update(ref, { order: idx });
                    });
                    await batch.commit();
                    setToast('角色排序已更新');
                } catch (e) {
                    console.error(e);
                    setToast('角色排序更新失敗');
                } finally {
                    setRoleSaving(false);
                }
            };

            const handleMoveRole = (index, direction) => {
                const newItems = [...roles].sort((a, b) => {
                    if (typeof a.order === 'number' && typeof b.order === 'number') return a.order - b.order;
                    return 0;
                });
                const targetIndex = index + direction;
                [newItems[index], newItems[targetIndex]] = [newItems[targetIndex], newItems[index]];
                handleReorderRoles(newItems);
            };

            const onRoleDragStart = (e, index) => {
                // Ensure we pick the correct item from sorted list
                const sortedItems = [...roles].sort((a, b) => {
                    if (typeof a.order === 'number' && typeof b.order === 'number') return a.order - b.order;
                    return 0;
                });
                setDraggedRole(sortedItems[index]);
                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData("text/plain", index);
            };

            const onRoleDragOver = (e, index) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = "move";
            };

            const onRoleDrop = (e, index) => {
                e.preventDefault();
                if (!draggedRole) return;
                
                const newItems = [...roles].sort((a, b) => {
                    if (typeof a.order === 'number' && typeof b.order === 'number') return a.order - b.order;
                    return 0;
                });
                const draggedIdx = newItems.findIndex(i => i.id === draggedRole.id);
                if (draggedIdx === index) return;

                newItems.splice(draggedIdx, 1);
                newItems.splice(index, 0, draggedRole);
                
                handleReorderRoles(newItems);
                setDraggedRole(null);
            };

            // Area Reordering Logic
            const [draggedArea, setDraggedArea] = useState(null);

            const handleReorderAreas = async (newItems) => {
                setAreaSaving(true);
                try {
                    const batch = writeBatch(db);
                    newItems.forEach((item, idx) => {
                        const ref = doc(db, 'artifacts', appId, 'public', 'data', 'areas', item.id);
                        batch.update(ref, { order: idx });
                    });
                    await batch.commit();
                    setToast('區域排序已更新');
                } catch (e) {
                    console.error(e);
                    setToast('區域排序更新失敗');
                } finally {
                    setAreaSaving(false);
                }
            };

            const handleMoveArea = (index, direction) => {
                const newItems = [...areas].sort((a, b) => {
                    if (typeof a.order === 'number' && typeof b.order === 'number') return a.order - b.order;
                    return 0;
                });
                const targetIndex = index + direction;
                [newItems[index], newItems[targetIndex]] = [newItems[targetIndex], newItems[index]];
                handleReorderAreas(newItems);
            };

            const onAreaDragStart = (e, index) => {
                const sortedItems = [...areas].sort((a, b) => {
                    if (typeof a.order === 'number' && typeof b.order === 'number') return a.order - b.order;
                    return 0;
                });
                setDraggedArea(sortedItems[index]);
                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData("text/plain", index);
            };

            const onAreaDragOver = (e, index) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = "move";
            };

            const onAreaDrop = (e, index) => {
                e.preventDefault();
                if (!draggedArea) return;
                
                const newItems = [...areas].sort((a, b) => {
                    if (typeof a.order === 'number' && typeof b.order === 'number') return a.order - b.order;
                    return 0;
                });
                const draggedIdx = newItems.findIndex(i => i.id === draggedArea.id);
                if (draggedIdx === index) return;

                newItems.splice(draggedIdx, 1);
                newItems.splice(index, 0, draggedArea);
                
                handleReorderAreas(newItems);
                setDraggedArea(null);
            };

            // Company Reordering Logic
            const [draggedCompany, setDraggedCompany] = useState(null);

            const handleReorderCompanies = async (newItems) => {
                setCompanySaving(true);
                try {
                    const batch = writeBatch(db);
                    newItems.forEach((item, idx) => {
                        const ref = doc(db, 'artifacts', appId, 'public', 'data', 'companies', item.id);
                        batch.update(ref, { order: idx });
                    });
                    await batch.commit();
                    setToast('公司排序已更新');
                } catch (e) {
                    console.error(e);
                    setToast('公司排序更新失敗');
                } finally {
                    setCompanySaving(false);
                }
            };

            const handleMoveCompany = (index, direction) => {
                const newItems = [...companies].sort((a, b) => {
                    if (typeof a.order === 'number' && typeof b.order === 'number') return a.order - b.order;
                    return 0;
                });
                const targetIndex = index + direction;
                [newItems[index], newItems[targetIndex]] = [newItems[targetIndex], newItems[index]];
                handleReorderCompanies(newItems);
            };

            const onCompanyDragStart = (e, index) => {
                const sortedItems = [...companies].sort((a, b) => {
                    if (typeof a.order === 'number' && typeof b.order === 'number') return a.order - b.order;
                    return 0;
                });
                setDraggedCompany(sortedItems[index]);
                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData("text/plain", index);
            };

            const onCompanyDragOver = (e, index) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = "move";
            };

            const onCompanyDrop = (e, index) => {
                e.preventDefault();
                if (!draggedCompany) return;
                
                const newItems = [...companies].sort((a, b) => {
                    if (typeof a.order === 'number' && typeof b.order === 'number') return a.order - b.order;
                    return 0;
                });
                const draggedIdx = newItems.findIndex(i => i.id === draggedCompany.id);
                if (draggedIdx === index) return;

                newItems.splice(draggedIdx, 1);
                newItems.splice(index, 0, draggedCompany);
                
                handleReorderCompanies(newItems);
                setDraggedCompany(null);
            };

            const [showCompanyModal, setShowCompanyModal] = useState(false);
            const [companyForm, setCompanyForm] = useState({ id: '', name: '', address: '', lat: '', lng: '', radius: 100 });
            const [companySaving, setCompanySaving] = useState(false);
            const [companyError, setCompanyError] = useState('');
            const [showAreaModal, setShowAreaModal] = useState(false);
            const [areaForm, setAreaForm] = useState({ id: '', name: '' });
            const [showSignatureTypeModal, setShowSignatureTypeModal] = useState(false);
            const [signatureTypeForm, setSignatureTypeForm] = useState({ id: '', name: '' });
            const [signatureTypeLoading, setSignatureTypeLoading] = useState(false);
            const [signatureTypeError, setSignatureTypeError] = useState('');

            // Reordering Logic
            const [draggedSignatureType, setDraggedSignatureType] = useState(null);

            const handleReorderSignatureTypes = async (newItems) => {
                setSignatureTypeLoading(true);
                try {
                    const batch = writeBatch(db);
                    newItems.forEach((item, idx) => {
                        const ref = doc(db, 'artifacts', appId, 'public', 'data', 'signature_types', item.id);
                        batch.update(ref, { order: idx });
                    });
                    await batch.commit();
                    setToast('排序已更新');
                } catch (e) {
                    console.error(e);
                    setToast('排序更新失敗');
                } finally {
                    setSignatureTypeLoading(false);
                }
            };

            const handleMoveSignatureType = (index, direction) => {
                const newItems = [...signatureTypes].sort((a, b) => {
                    if (typeof a.order === 'number' && typeof b.order === 'number') return a.order - b.order;
                    return 0;
                });
                // Swap
                const targetIndex = index + direction;
                [newItems[index], newItems[targetIndex]] = [newItems[targetIndex], newItems[index]];
                handleReorderSignatureTypes(newItems);
            };

            const onDragStart = (e, index) => {
                const sortedItems = [...signatureTypes].sort((a, b) => {
                    if (typeof a.order === 'number' && typeof b.order === 'number') return a.order - b.order;
                    return 0;
                });
                setDraggedSignatureType(sortedItems[index]);
                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData("text/plain", index);
                // Optional: set drag image
            };

            const onDragOver = (e, index) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = "move";
            };

            const onDrop = (e, index) => {
                e.preventDefault();
                if (!draggedSignatureType) return;
                
                const newItems = [...signatureTypes].sort((a, b) => {
                    if (typeof a.order === 'number' && typeof b.order === 'number') return a.order - b.order;
                    return 0;
                });
                const draggedIdx = newItems.findIndex(i => i.id === draggedSignatureType.id);
                if (draggedIdx === index) return;

                // Remove and insert
                newItems.splice(draggedIdx, 1);
                newItems.splice(index, 0, draggedSignatureType);
                
                handleReorderSignatureTypes(newItems);
                setDraggedSignatureType(null);
            };

            



            const handleExportUsers = () => {
                if (!users || users.length === 0) {
                    setToast('無資料可匯出');
                    return;
                }
                const data = users.map(u => {
                     const roleName = u.role === 'admin' ? '系統管理員' : (roles.find(r => r.id === u.role)?.name || u.role);
                     const companyNames = (u.companyIds || (u.companyId ? [u.companyId] : [])).map(id => {
                         const c = companies.find(c => c.id === id);
                         return c ? c.name : id;
                     }).join('、');
                     const communityNames = (u.communityIds || (u.communityId ? [u.communityId] : [])).map(id => {
                         const c = communities.find(c => c.id === id);
                         return c ? c.name : id;
                     }).join('、');

                     return {
                        '角色': roleName,
                        '職稱': u.title || '',
                        '姓名': u.name || '',
                        '電子郵件': u.email || '',
                        '密碼': u.password || '',
                        '手機號碼': u.phone || '',
                        '所屬公司': companyNames,
                        '服務社區': communityNames,
                        '狀況': u.status || '在職',
                        '在職起始時間': u.startDate || '',
                        '離職起始時間': u.resignDate || ''
                     };
                });
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Users");
                XLSX.writeFile(wb, "users_export.xlsx");
            };

            const handleImportUsers = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const data = XLSX.utils.sheet_to_json(ws);

                        if (!data || data.length === 0) {
                            setToast('檔案無資料');
                            return;
                        }

                        let successCount = 0;
                        let failCount = 0;

                        setToast('開始匯入...');

                        for (const row of data) {
                            const email = (row['電子郵件'] || '').toString().trim();
                            if (!email) continue;

                            const roleName = (row['角色'] || '').trim();
                            let roleId = 'staff';
                            if (roleName === '系統管理員') roleId = 'admin';
                            else {
                                const foundRole = roles.find(r => r.name === roleName);
                                if (foundRole) roleId = foundRole.id;
                            }

                            const companyNamesStr = (row['所屬公司'] || '').toString();
                            const companyIds = [];
                            if (companyNamesStr) {
                                const names = companyNamesStr.split(/[、,]/).map(s => s.trim());
                                names.forEach(name => {
                                    const c = companies.find(c => c.name === name || c.id === name);
                                    if (c) companyIds.push(c.id);
                                });
                            }

                            const communityNamesStr = (row['服務社區'] || '').toString();
                            const communityIds = [];
                            if (communityNamesStr) {
                                const names = communityNamesStr.split(/[、,]/).map(s => s.trim());
                                names.forEach(name => {
                                    const c = communities.find(c => c.name === name || c.id === name);
                                    if (c) communityIds.push(c.id);
                                });
                            }

                            const userData = {
                                role: roleId,
                                title: (row['職稱'] || '').toString().trim(),
                                name: (row['姓名'] || '').toString().trim(),
                                email: email,
                                password: (row['密碼'] || '').toString().trim(),
                                phone: (row['手機號碼'] || '').toString().trim(),
                                companyIds: companyIds,
                                communityIds: communityIds,
                                status: (row['狀況'] || '在職').toString().trim(),
                                startDate: (row['在職起始時間'] || '').toString().trim(),
                                resignDate: (row['離職起始時間'] || '').toString().trim(),
                                companyId: companyIds.length > 0 ? companyIds[0] : '',
                                communityId: communityIds.length > 0 ? communityIds[0] : ''
                            };

                            const existingUser = users.find(u => u.email === email);
                            
                            try {
                                if (existingUser) {
                                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', existingUser.id), {
                                        ...userData,
                                        updatedByName: (currentUser && currentUser.name) || '匯入',
                                        updatedAt: serverTimestamp()
                                    });
                                } else {
                                    await onAddUser(userData);
                                }
                                successCount++;
                            } catch (err) {
                                console.error(`Error importing ${email}:`, err);
                                failCount++;
                            }
                        }
                        setToast(`匯入完成：成功 ${successCount} 筆，失敗 ${failCount} 筆`);
                    } catch (err) {
                        console.error(err);
                        setToast('匯入失敗：' + err.message);
                    }
                };
                reader.readAsBinaryString(file);
                e.target.value = '';
            };

            const handleExportCommunities = () => {
                if (!communities || communities.length === 0) {
                    setToast('無資料可匯出');
                    return;
                }
                const data = communities.map(c => ({
                    '社區編號': c.id,
                    '社區名稱': c.name,
                    '所屬公司ID': c.companyId || '',
                    '所屬區域ID': c.areaId || '',
                    '總幹事數': c.gmCount || 0,
                    '秘書數': c.secretaryCount || 0,
                    '清潔數': c.cleanCount || 0,
                    '機電數': c.mechCount || 0,
                    '保全數': c.guardCount || 0,
                    '白天哨數': c.dayGuardCount || 0,
                    '晚上哨數': c.nightGuardCount || 0,
                    '社區地址': c.address || '',
                    '緯度': c.coordLat || '',
                    '經度': c.coordLng || '',
                    '打卡範圍(公尺)': c.radiusMeters || 100
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Communities");
                XLSX.writeFile(wb, "communities_export.xlsx");
            };

            const handleImportCommunities = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const data = XLSX.utils.sheet_to_json(ws);
                        
                        if (!data || data.length === 0) {
                            setToast('檔案無資料');
                            return;
                        }

                        let count = 0;
                        for (const row of data) {
                            const id = (row['社區編號'] || '').toString().trim();
                            if (!id) continue;
                            
                            const communityData = {
                                name: row['社區名稱'] || '',
                                companyId: (row['所屬公司ID'] || '').toString(),
                                areaId: (row['所屬區域ID'] || '').toString(),
                                gmCount: parseInt(row['總幹事數'] || 0),
                                secretaryCount: parseInt(row['秘書數'] || 0),
                                cleanCount: parseInt(row['清潔數'] || 0),
                                mechCount: parseInt(row['機電數'] || 0),
                                guardCount: parseInt(row['保全數'] || 0),
                                dayGuardCount: parseInt(row['白天哨數'] || 0),
                                nightGuardCount: parseInt(row['晚上哨數'] || 0),
                                address: row['社區地址'] || '',
                                coordLat: row['緯度'] || '',
                                coordLng: row['經度'] || '',
                                radiusMeters: parseInt(row['打卡範圍(公尺)'] || 100),
                                updatedByName: (currentUser && currentUser.name) || '匯入',
                                updatedAt: serverTimestamp()
                            };

                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'communities', id), communityData, { merge: true });
                            count++;
                        }
                        setToast(`成功匯入 ${count} 筆社區資料`);
                    } catch (err) {
                        console.error(err);
                        setToast('匯入失敗：' + err.message);
                    }
                };
                reader.readAsBinaryString(file);
                e.target.value = ''; // Reset input
            };
            const [areaSaving, setAreaSaving] = useState(false);
            const [areaError, setAreaError] = useState('');
            const [userSaving, setUserSaving] = useState(false);
            const [userError, setUserError] = useState('');
            const [confirmDelete, setConfirmDelete] = useState(null);
            const [toast, setToast] = useState('');

            useEffect(() => {
                if (!toast) return;
                const timer = setTimeout(() => {
                    setToast('');
                }, 3000);
                return () => clearTimeout(timer);
            }, [toast]);






            const [editingUserId, setEditingUserId] = useState(null);
            const [showCommunityModal, setShowCommunityModal] = useState(false);
            const [communityForm, setCommunityForm] = useState({ id:'', name:'', companyId:'', areaId:'', gmCount:0, secretaryCount:0, cleanCount:0, mechCount:0, guardCount:0, dayGuardCount:0, nightGuardCount:0, address:'', coordLat:'', coordLng:'', radiusMeters:100 });
            const [communitySaving, setCommunitySaving] = useState(false);
            const [communityError, setCommunityError] = useState('');
            const [mapTarget, setMapTarget] = useState(null);
            const [mapPreviewTarget, setMapPreviewTarget] = useState(null);
            const mapTargetElRef = useRef(null);
            const mapTargetMapRef = useRef(null);
            const mapTargetCircleRef = useRef(null);

            const communityMapElRef = useRef(null);
            const communityGMapRef = useRef(null);
            const communityGCircleRef = useRef(null);
            const communityGMarkerRef = useRef(null);
            const communityGClickListenerRef = useRef(null);

            useEffect(()=>{
                if (!showCommunityModal) return;
                if (!window.google || !window.google.maps) return;
                const lat = parseFloat(communityForm.coordLat);
                const lng = parseFloat(communityForm.coordLng);
                const hasCoords = !isNaN(lat) && !isNaN(lng);
                const defaultCenter = { lat: 25.0330, lng: 121.5654 };
                const center = hasCoords ? { lat, lng } : defaultCenter;
                if (!communityGMapRef.current && communityMapElRef.current) {
                    communityGMapRef.current = new google.maps.Map(communityMapElRef.current, { center, zoom: 16 });
                } else if (communityGMapRef.current) {
                    communityGMapRef.current.setCenter(center);
                    communityGMapRef.current.setZoom(16);
                }
                if (hasCoords) {
                    if (!communityGMarkerRef.current) {
                        communityGMarkerRef.current = new google.maps.Marker({ position: center, map: communityGMapRef.current });
                    } else {
                        communityGMarkerRef.current.setPosition(center);
                    }
                }
                if (communityGCircleRef.current) {
                    communityGCircleRef.current.setMap(null);
                    communityGCircleRef.current = null;
                }
                if (hasCoords) {
                    communityGCircleRef.current = new google.maps.Circle({ center, radius: communityForm.radiusMeters || 0, strokeColor: '#dc2626', fillColor: '#dc2626', fillOpacity: 0.15, map: communityGMapRef.current });
                }
                if (communityGClickListenerRef.current) {
                    google.maps.event.removeListener(communityGClickListenerRef.current);
                    communityGClickListenerRef.current = null;
                }
                communityGClickListenerRef.current = google.maps.event.addListener(communityGMapRef.current, 'click', (e) => {
                    const latLng = e.latLng;
                    const newLat = latLng.lat();
                    const newLng = latLng.lng();
                    setCommunityForm(prev => ({ ...prev, coordLat: newLat, coordLng: newLng }));
                    if (!communityGMarkerRef.current) {
                        communityGMarkerRef.current = new google.maps.Marker({ position: latLng, map: communityGMapRef.current });
                    } else {
                        communityGMarkerRef.current.setPosition(latLng);
                    }
                });
            }, [showCommunityModal, communityForm.coordLat, communityForm.coordLng, communityForm.radiusMeters]);

            useEffect(()=>{
                if (!showCommunityModal && communityGMapRef.current) {
                    if (communityGClickListenerRef.current) {
                        google.maps.event.removeListener(communityGClickListenerRef.current);
                        communityGClickListenerRef.current = null;
                    }
                    communityGMarkerRef.current = null;
                    communityGCircleRef.current = null;
                    communityGMapRef.current = null;
                }
            }, [showCommunityModal]);

            useEffect(() => {
                if (!mapTarget) return;
                const init = () => {
                    if (!mapTargetElRef.current) return;
                    const center = { lat: mapTarget.lat, lng: mapTarget.lng };
                    if (!mapTargetMapRef.current) {
                        mapTargetMapRef.current = new google.maps.Map(mapTargetElRef.current, { center, zoom: 16 });
                    } else {
                        mapTargetMapRef.current.setCenter(center);
                        mapTargetMapRef.current.setZoom(16);
                    }
                    new google.maps.Marker({ position: center, map: mapTargetMapRef.current });
                    if (mapTargetCircleRef.current) {
                        mapTargetCircleRef.current.setMap(null);
                        mapTargetCircleRef.current = null;
                    }
                    mapTargetCircleRef.current = new google.maps.Circle({ center, radius: mapTarget.radius || 0, strokeColor: '#dc2626', fillColor: '#dc2626', fillOpacity: 0.15, map: mapTargetMapRef.current });
                };
                if (window.google && window.google.maps) {
                    init();
                } else {
                    const script = document.querySelector('script[src*="maps.googleapis.com/maps/api/js"]');
                    if (script) {
                        const handler = () => init();
                        script.addEventListener('load', handler, { once: true });
                        return () => { script.removeEventListener('load', handler); };
                    }
                }
                return () => {
                    mapTargetCircleRef.current = null;
                    mapTargetMapRef.current = null;
                };
            }, [mapTarget]);

            useEffect(()=>{ if (!toast) return; const t = setTimeout(()=>setToast(''), 2000); return ()=>clearTimeout(t); }, [toast]);

            const handleAvatarUpload = (file) => {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const size = 512;
                        canvas.width = size; canvas.height = size;
                        const ctx = canvas.getContext('2d');
                        
                        // Center crop
                        const scale = Math.max(size / img.width, size / img.height);
                        const x = (size - img.width * scale) / 2;
                        const y = (size - img.height * scale) / 2;
                        
                        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
                        setModalUser(prev => ({ ...prev, avatarUrl: dataUrl }));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            };

            const formatDateTime = (v, withSeconds = true) => {
                if (!v) return '-';
                const d = v && typeof v.toDate === 'function' ? v.toDate() : new Date(v);
                if (!d || isNaN(d.getTime())) return '-';
                const options = {
                    timeZone: 'Asia/Taipei',
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit',
                    hour12: false
                };
                if (withSeconds) {
                    options.second = '2-digit';
                }
                return new Intl.DateTimeFormat('zh-TW', options).format(d).replace(/\//g, '/');
            };

            return (
                <div className="space-y-4 pb-20">
                    <div className="grid grid-cols-1 gap-4">
                        {subtab === 'general' && hasSubPermission('settings', 'general') && (
                        <div className="space-y-6">
                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <Shield className="w-5 h-5 mr-2 text-red-600" /> 角色列表
                                </h3>
                                <div className="mb-4">
                                    <button onClick={() => { setRoleForm({ name: '', permissions: [], subPermissions: {} }); setShowRoleModal(true); }} className="bg-red-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-red-700">新增</button>
                                </div>
                                <div className="max-h-[500px] overflow-y-auto overflow-x-auto no-scrollbar">
                                    <div className="flex flex-row gap-4 px-3 py-2 text-[11px] font-bold text-gray-500 whitespace-nowrap min-w-[1020px] text-left">
                                        <div className="min-w-[160px]">
                                            <SortHeader label="角色名稱" sortKey="name" currentSort={roleSort} setSort={setRoleSort} />
                                        </div>
                                        <div className="min-w-[420px]">權限</div>
                                        <div className="min-w-[180px]">操作</div>
                                        <div className="min-w-[240px]">
                                            <SortHeader label="紀錄" sortKey="updatedAt" currentSort={roleSort} setSort={setRoleSort} />
                                        </div>
                                    </div>
                                    <div className="space-y-2">
                                        {roles.length === 0 ? (
                                            <div className="flex flex-row gap-4 items-center p-3 bg-gray-50 rounded-2xl text-xs whitespace-nowrap min-w-[1020px]">
                                                <div className="font-bold text-gray-300 min-w-[160px]">—</div>
                                                <div className="text-gray-300 min-w-[420px]">—</div>
                                                <div className="flex gap-2 justify-start min-w-[180px]">
                                                    <button disabled className="px-2 py-1 rounded-2xl bg-gray-200 text-gray-400">編輯</button>
                                                    <button disabled className="px-2 py-1 rounded-2xl bg-gray-200 text-gray-400">刪除</button>
                                                </div>
                                                <div className="min-w-[240px] text-gray-300">—</div>
                                            </div>
                                        ) : getSortedData(roles, roleSort, (data) => data.sort((a, b) => {
                                            // Prefer manual order if available, otherwise default list
                                            if (typeof a.order === 'number' && typeof b.order === 'number') {
                                                return a.order - b.order;
                                            }
                                            const order = ['系統管理員', '管理層', '人事', '幹部', '員工', '總幹事', '秘書', '清潔', '機電', '保全'];
                                            const indexA = order.indexOf(a.name);
                                            const indexB = order.indexOf(b.name);
                                            if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                                            if (indexA !== -1) return -1;
                                            if (indexB !== -1) return 1;
                                            return 0;
                                        })).map((r, index) => {
                                            const isReorderable = !roleSort.key;
                                            return (
                                            <div 
                                                key={r.id} 
                                                draggable={isReorderable}
                                                onDragStart={(e) => isReorderable && onRoleDragStart(e, index)}
                                                onDragOver={(e) => isReorderable && onRoleDragOver(e, index)}
                                                onDrop={(e) => isReorderable && onRoleDrop(e, index)}
                                                className={`flex flex-row gap-4 items-center p-3 bg-gray-50 rounded-2xl text-xs whitespace-nowrap min-w-[1020px] ${isReorderable ? 'cursor-move hover:bg-gray-100 transition-colors' : ''} ${draggedRole?.id === r.id ? 'opacity-30 border-2 border-dashed border-gray-400' : ''}`}
                                            >
                                                <div className="font-bold text-gray-700 min-w-[160px] flex items-center gap-2">
                                                    {isReorderable && (
                                                        <div className="flex flex-col text-gray-400">
                                                            <button 
                                                                disabled={index === 0} 
                                                                onClick={(e) => { e.stopPropagation(); handleMoveRole(index, -1); }}
                                                                className="hover:text-red-600 disabled:opacity-0"
                                                            >
                                                                <ChevronUp className="w-3 h-3" />
                                                            </button>
                                                            <button 
                                                                disabled={index === roles.length - 1} 
                                                                onClick={(e) => { e.stopPropagation(); handleMoveRole(index, 1); }}
                                                                className="hover:text-red-600 disabled:opacity-0"
                                                            >
                                                                <ChevronDown className="w-3 h-3" />
                                                            </button>
                                                        </div>
                                                    )}
                                                    {r.name}
                                                </div>
                                                <div className="text-gray-700 min-w-[420px]">{(r.permissions || []).map(p => pages.find(x=>x.key===p)?.label || p).join('、') || '-'}</div>
                                                <div className="flex gap-2 justify-start min-w-[180px]">
                                                <button onClick={()=>{ setRoleForm({ name: r.name, permissions: r.permissions || [], subPermissions: r.subPermissions || {} }); setShowRoleModal(true); setRoleForm(prev=>({ ...prev, id: r.id })); }} className="px-2 py-1 rounded-2xl bg-gray-800 text-white">編輯</button>
                                                <button onClick={()=>{ setConfirmDelete({ type:'role', id:r.id, label:r.name }); }} className="px-2 py-1 rounded-2xl bg-red-600 text-white">刪除</button>
                                                </div>
                                                <div className="min-w-[240px] text-gray-700">{r.updatedByName ? `${r.updatedByName} ${formatDateTime(r.updatedAt)}` : '-'}</div>
                                            </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                {showRoleModal && (
                                    <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                        <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                            <h4 className="text-lg font-bold text-gray-800 mb-4">新增/編輯角色</h4>
                                            <div className="space-y-3">
                                                <label className="block text-xs font-bold text-gray-500 uppercase">角色名稱</label>
                                                <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={roleForm.name} onChange={e=>setRoleForm(prev=>({...prev, name: e.target.value}))} placeholder="例如：系統管理員" />
                                                <div className="text-[11px] text-gray-500">常用：系統管理員、管理層、人事、幹部、總幹事、秘書、清潔、機電、保全</div>
                                                <label className="block text-xs font-bold text-gray-500 uppercase">權限</label>
                                                <div className="grid grid-cols-2 gap-2">
                                                    {pages.map(p => (
                                                        <div key={p.key} className="flex flex-col gap-2 bg-gray-50 px-3 py-2 rounded-2xl">
                                                            <label className="flex items-center gap-2 text-sm font-bold">
                                                                <input type="checkbox" checked={roleForm.permissions.includes(p.key)} onChange={(e)=>{
                                                                    const checked = e.target.checked;
                                                                    setRoleForm(prev=>({ ...prev, permissions: checked ? [...prev.permissions, p.key] : prev.permissions.filter(x=>x!==p.key) }));
                                                                }} />
                                                                <span>{p.label}</span>
                                                            </label>
                                                            {roleForm.permissions.includes(p.key) && subPagesMap && subPagesMap[p.key] && (
                                                                <div className="ml-5 grid grid-cols-1 gap-1">
                                                                    {subPagesMap[p.key].map(sub => (
                                                                        <label key={sub.key} className="flex items-center gap-2 text-xs text-gray-600">
                                                                            <input type="checkbox" 
                                                                                checked={ (roleForm.subPermissions && roleForm.subPermissions[p.key]) ? roleForm.subPermissions[p.key].includes(sub.key) : true } 
                                                                                onChange={(e) => {
                                                                                    const checked = e.target.checked;
                                                                                    setRoleForm(prev => {
                                                                                        const allKeys = subPagesMap[p.key].map(x => x.key);
                                                                                        const currentSubs = (prev.subPermissions && prev.subPermissions[p.key]) ? prev.subPermissions[p.key] : allKeys;
                                                                                        
                                                                                        const newSubs = checked ? [...currentSubs, sub.key] : currentSubs.filter(k => k !== sub.key);
                                                                                        return {
                                                                                            ...prev,
                                                                                            subPermissions: {
                                                                                                ...prev.subPermissions,
                                                                                                [p.key]: newSubs
                                                                                            }
                                                                                        };
                                                                                    });
                                                                                }} 
                                                                            />
                                                                            <span>{sub.label}</span>
                                                                        </label>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                                {roleError && <div className="text-xs text-red-600">{roleError}</div>}
                                            </div>
                                            <div className="flex justify-end gap-2 mt-4">
                                                <button onClick={()=>setShowRoleModal(false)} className="px-3 py-2 rounded-2xl bg-gray-100 text-gray-700">取消</button>
                                                <button disabled={roleSaving} onClick={async()=>{ try { setRoleError(''); setRoleSaving(true); if (!user) { setRoleError('沒有登入權限，請先登入'); return; } if (!roleForm.name.trim()) { setRoleError('請輸入角色名稱'); return; } if (roleForm.id) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roles', roleForm.id), { name: roleForm.name.trim(), permissions: roleForm.permissions, subPermissions: roleForm.subPermissions, updatedByName: (currentUser && currentUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() }); setToast('儲存成功'); } else { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'roles'), { name: roleForm.name.trim(), permissions: roleForm.permissions, subPermissions: roleForm.subPermissions, updatedByName: '新增', updatedAt: serverTimestamp() }); setToast('新增成功'); } setShowRoleModal(false); } catch (e) { console.error(e); setRoleError(`儲存失敗：${e.code || e.message}`); } finally { setRoleSaving(false);} }} className="px-3 py-2 rounded-2xl bg-red-600 text-white">儲存</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>



                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <Building2 className="w-5 h-5 mr-2 text-red-600" /> 公司列表
                                </h3>
                                <div className="mb-4">
                                    <button onClick={() => { setCompanyForm({ id: '', name: '' }); setShowCompanyModal(true); }} className="bg-red-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-red-700">新增</button>
                                </div>
                                <div className="max-h-[500px] overflow-y-auto overflow-x-auto no-scrollbar">
                                    <div className="grid grid-cols-11 gap-2 px-3 py-2 text-[11px] font-bold text-gray-500 whitespace-nowrap min-w-[1300px] text-left">
                                        <div><SortHeader label="公司編號" sortKey="id" currentSort={companySort} setSort={setCompanySort} /></div>
                                        <div><SortHeader label="公司名稱" sortKey="name" currentSort={companySort} setSort={setCompanySort} /></div>
                                        <div className="col-span-2"><SortHeader label="公司地址" sortKey="address" currentSort={companySort} setSort={setCompanySort} /></div>
                                        <div>公司座標</div>
                                        <div>公司地圖</div>
                                        <div><SortHeader label="設定打卡範圍(公尺)" sortKey="radius" currentSort={companySort} setSort={setCompanySort} /></div>
                                        <div>幹部數</div>
                                        <div>員工數</div>
                                        <div>操作</div>
                                        <div><SortHeader label="紀錄" sortKey="updatedAt" currentSort={companySort} setSort={setCompanySort} /></div>
                                    </div>
                                    <div className="space-y-2">
                                        {companies.length === 0 ? (
                                            <div className="grid grid-cols-11 gap-2 items-center p-3 bg-gray-50 rounded-2xl text-xs whitespace-nowrap min-w-[1300px]">
                                                <div className="font-bold text-gray-300">—</div>
                                                <div className="text-gray-300">—</div>
                                                <div className="col-span-2 text-gray-300">—</div>
                                                <div className="text-gray-300">—</div>
                                                <div className="text-gray-300">—</div>
                                                <div className="text-gray-300">—</div>
                                                <div className="text-gray-300">0</div>
                                                <div className="text-gray-300">0</div>
                                                <div className="flex gap-2 justify-start">
                                                    <button disabled className="px-2 py-1 rounded-2xl bg-gray-200 text-gray-400">編輯</button>
                                                    <button disabled className="px-2 py-1 rounded-2xl bg-gray-200 text-gray-400">刪除</button>
                                                </div>
                                                <div className="text-gray-300">—</div>
                                            </div>
                                        ) : getSortedData(companies, companySort, (data) => data.sort((a, b) => {
                                            if (typeof a.order === 'number' && typeof b.order === 'number') {
                                                return a.order - b.order;
                                            }
                                            return 0;
                                        })).map((c, index) => {
                                            const execRoles = ['admin', 'hr', 'cadre', 'staff'];
                                            // DEBUG Logic
                                            const allExecCandidates = users.filter(u => execRoles.includes(u.role));
                                            const debugTooltip = allExecCandidates.map(u => 
                                                `${u.name || u.email}: ${u.role}, Main=${u.companyId}, Subs=${JSON.stringify(u.companyIds || [])}, Match=${((u.companyIds && u.companyIds.some(cid => String(cid) === String(c.id))) || String(u.companyId) === String(c.id))}`
                                            ).join('\n');

                                            const execUsers = users.filter(u => ((u.companyIds && u.companyIds.some(cid => String(cid) === String(c.id))) || String(u.companyId) === String(c.id)) && execRoles.includes(u.role));
                                            const execCount = execUsers.length;
                                            const execNames = execUsers.map(u => u.name || u.email).join('\n');

                                            const staffRoles = ['manager', 'secretary', 'cleaner', 'mechanic', 'guard'];
                                            const staffUsers = users.filter(u => ((u.companyIds && u.companyIds.some(cid => String(cid) === String(c.id))) || String(u.companyId) === String(c.id)) && staffRoles.includes(u.role));
                                            const staffCount = staffUsers.length;
                                            const staffNames = staffUsers.map(u => u.name || u.email).join('\n');
                                            
                                            const isReorderable = !companySort.key;
                                            
                                            return (
                                            <div 
                                                key={c.id} 
                                                draggable={isReorderable}
                                                onDragStart={(e) => isReorderable && onCompanyDragStart(e, index)}
                                                onDragOver={(e) => isReorderable && onCompanyDragOver(e, index)}
                                                onDrop={(e) => isReorderable && onCompanyDrop(e, index)}
                                                className={`grid grid-cols-11 gap-2 items-center p-3 bg-gray-50 rounded-2xl text-xs whitespace-nowrap min-w-[1300px] ${isReorderable ? 'cursor-move hover:bg-gray-100 transition-colors' : ''} ${draggedCompany?.id === c.id ? 'opacity-30 border-2 border-dashed border-gray-400' : ''}`}
                                            >
                                                <div className="font-bold text-gray-700 flex items-center gap-2">
                                                    {isReorderable && (
                                                        <div className="flex flex-col text-gray-400">
                                                            <button 
                                                                disabled={index === 0} 
                                                                onClick={(e) => { e.stopPropagation(); handleMoveCompany(index, -1); }}
                                                                className="hover:text-red-600 disabled:opacity-0"
                                                            >
                                                                <ChevronUp className="w-3 h-3" />
                                                            </button>
                                                            <button 
                                                                disabled={index === companies.length - 1} 
                                                                onClick={(e) => { e.stopPropagation(); handleMoveCompany(index, 1); }}
                                                                className="hover:text-red-600 disabled:opacity-0"
                                                            >
                                                                <ChevronDown className="w-3 h-3" />
                                                            </button>
                                                        </div>
                                                    )}
                                                    {c.id}
                                                </div>
                                                <div className="text-gray-700">{c.name}</div>
                                                <div className="col-span-2 text-gray-700 truncate" title={c.address || '-'}>{c.address || '-'}</div>
                                                <div className="text-gray-700">{c.lat && c.lng ? `${parseFloat(c.lat).toFixed(4)}, ${parseFloat(c.lng).toFixed(4)}` : '-'}</div>
                                                <div>
                                                    {c.lat && c.lng ? (
                                                        <button onClick={()=>setMapPreviewTarget(c)} className="text-red-600 hover:text-red-800 flex items-center bg-red-50 hover:bg-red-100 px-2 py-1 rounded-lg transition-colors">
                                                            <MapPin className="w-3 h-3 mr-1" /> 地圖
                                                        </button>
                                                    ) : (
                                                        <span className="text-gray-300">-</span>
                                                    )}
                                                </div>
                                                <div className="text-gray-700">{c.radius ? `${c.radius}m` : '100m'}</div>
                                                <div className="text-gray-700 cursor-help underline decoration-dotted" title={debugTooltip}>{execCount}</div>
                                                <div className="text-gray-700 cursor-help underline decoration-dotted" title={staffNames}>{staffCount}</div>
                                                <div className="flex gap-2 justify-start">
                                                <button onClick={()=>{ setCompanyForm({ id: c.id, name: c.name, address: c.address || '', lat: c.lat || '', lng: c.lng || '', radius: c.radius || 100 }); setShowCompanyModal(true); }} className="px-2 py-1 rounded-2xl bg-gray-800 text-white">編輯</button>
                                                <button onClick={()=>{ setConfirmDelete({ type:'company', id:c.id, label:c.name }); }} className="px-2 py-1 rounded-2xl bg-red-600 text-white">刪除</button>
                                                </div>
                                                <div className="text-gray-700">{c.updatedByName ? `${c.updatedByName} ${formatDateTime(c.updatedAt)}` : '-'}</div>
                                            </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                {showCompanyModal && (
                                    <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                        <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                            <h4 className="text-lg font-bold text-gray-800 mb-4">新增/編輯公司</h4>
                                            <div className="space-y-3">
                                                <label className="block text-xs font-bold text-gray-500 uppercase">公司編號</label>
                                                <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={companyForm.id} onChange={e=>setCompanyForm(prev=>({...prev, id: e.target.value}))} />
                                                
                                                <label className="block text-xs font-bold text-gray-500 uppercase">公司名稱</label>
                                                <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={companyForm.name} onChange={e=>setCompanyForm(prev=>({...prev, name: e.target.value}))} />
                                                
                                                <label className="block text-xs font-bold text-gray-500 uppercase">公司地址</label>
                                                <div className="flex gap-2">
                                                    <input 
                                                        className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" 
                                                        value={companyForm.address || ''} 
                                                        onChange={e=>setCompanyForm(prev=>({...prev, address: e.target.value}))}
                                                        onBlur={async(e)=>{ 
                                                            const addr = e.target.value.trim(); 
                                                            if (!addr) return; 
                                                            
                                                            const doNominatim = async () => {
                                                                try {
                                                                    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(addr)}`); 
                                                                    const d = await r.json(); 
                                                                    if (d && d[0]) { 
                                                                        setCompanyForm(prev=>({...prev, lat: d[0].lat, lng: d[0].lon})); 
                                                                    }
                                                                } catch (err) {
                                                                    console.error("Nominatim error:", err);
                                                                }
                                                            };

                                                            try { 
                                                                if (window.google && window.google.maps) { 
                                                                    const gc = new google.maps.Geocoder(); 
                                                                    gc.geocode({ address: addr }, (res, status)=>{ 
                                                                        if (status === 'OK' && res && res[0]) { 
                                                                            const loc = res[0].geometry.location; 
                                                                            setCompanyForm(prev=>({...prev, lat: loc.lat(), lng: loc.lng()})); 
                                                                        } else {
                                                                            console.warn("Google Geocode failed:", status);
                                                                            doNominatim();
                                                                        }
                                                                    }); 
                                                                } else { 
                                                                    doNominatim(); 
                                                                } 
                                                            } catch (e) { 
                                                                console.error(e);
                                                                doNominatim();
                                                            } 
                                                        }}
                                                        placeholder="輸入地址"
                                                    />
                                                </div>

                                                <label className="block text-xs font-bold text-gray-500 uppercase">公司座標 (Lat, Lng)</label>
                                                <input 
                                                    className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" 
                                                    value={companyForm.lat && companyForm.lng ? `${companyForm.lat}, ${companyForm.lng}` : ''} 
                                                    onChange={e=>{
                                                        const parts = e.target.value.split(',');
                                                        if (parts.length === 2) {
                                                            setCompanyForm(prev=>({...prev, lat: parts[0].trim(), lng: parts[1].trim()}));
                                                        }
                                                    }}
                                                    placeholder="例如: 25.0330, 121.5654"
                                                />

                                                <label className="block text-xs font-bold text-gray-500 uppercase">設定打卡範圍 (公尺)</label>
                                                <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={companyForm.radius || 100} onChange={e=>setCompanyForm(prev=>({...prev, radius: parseInt(e.target.value) || 100}))} />

                                                <div className="w-full h-48 bg-gray-100 rounded-2xl overflow-hidden mt-2 relative">
                                                    {companyForm.lat && companyForm.lng ? (
                                                        <>
                                                            <CompanyMapPreview 
                                                                lat={companyForm.lat} 
                                                                lng={companyForm.lng} 
                                                                radius={companyForm.radius} 
                                                            />
                                                            <div className="absolute bottom-0 left-0 bg-white/80 px-2 py-1 text-[10px] font-bold text-gray-600 z-10 pointer-events-none">
                                                                範圍: {companyForm.radius}公尺
                                                            </div>
                                                        </>
                                                    ) : (
                                                        <div className="w-full h-full flex items-center justify-center text-gray-400 text-xs">
                                                            請輸入地址或座標以顯示地圖
                                                        </div>
                                                    )}
                                                </div>

                                                {companyError && <div className="text-xs text-red-600">{companyError}</div>}
                                            </div>
                                            <div className="flex justify-end gap-2 mt-4">
                                                <button onClick={()=>setShowCompanyModal(false)} className="px-3 py-2 rounded-2xl bg-gray-100 text-gray-700">取消</button>
                                                <button disabled={companySaving} onClick={async()=>{ try { setCompanyError(''); setCompanySaving(true); if (!user) { setCompanyError('沒有登入權限，請先登入'); return; } if (!companyForm.id.trim() || !companyForm.name.trim()) { setCompanyError('請輸入公司編號與公司名稱'); return; } if (companies.find(x=>x.id===companyForm.id.trim())) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'companies', companyForm.id.trim()), { name: companyForm.name.trim(), address: companyForm.address || '', lat: companyForm.lat || '', lng: companyForm.lng || '', radius: companyForm.radius || 100, updatedByName: (currentUser && currentUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() }); setToast('儲存成功'); } else { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'companies', companyForm.id.trim()), { name: companyForm.name.trim(), address: companyForm.address || '', lat: companyForm.lat || '', lng: companyForm.lng || '', radius: companyForm.radius || 100, updatedByName: '新增', updatedAt: serverTimestamp() }); setToast('新增成功'); } setShowCompanyModal(false); } catch (e) { console.error(e); setCompanyError(`儲存失敗：${e.code || e.message}`); } finally { setCompanySaving(false);} }} className="px-3 py-2 rounded-2xl bg-red-600 text-white">儲存</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <LayoutDashboard className="w-5 h-5 mr-2 text-red-600" /> 區域列表
                                </h3>
                                <div className="mb-4">
                                    <button onClick={() => { setAreaForm({ id: '', name: '' }); setShowAreaModal(true); }} className="bg-red-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-red-700">新增</button>
                                </div>
                                <div className="max-h-[500px] overflow-y-auto overflow-x-auto no-scrollbar">
                                    <div className="grid grid-cols-4 gap-2 px-3 py-2 text-[11px] font-bold text-gray-500 whitespace-nowrap min-w-[800px] text-left">
                                        <div><SortHeader label="區域編號" sortKey="id" currentSort={areaSort} setSort={setAreaSort} /></div>
                                        <div><SortHeader label="區域名稱" sortKey="name" currentSort={areaSort} setSort={setAreaSort} /></div>
                                        <div>操作</div>
                                        <div><SortHeader label="紀錄" sortKey="updatedAt" currentSort={areaSort} setSort={setAreaSort} /></div>
                                    </div>
                                    <div className="space-y-2">
                                        {areas.length === 0 ? (
                                            <div className="grid grid-cols-4 gap-2 items-center p-3 bg-gray-50 rounded-2xl text-xs whitespace-nowrap min-w-[800px]">
                                                <div className="font-bold text-gray-300">—</div>
                                                <div className="text-gray-300">—</div>
                                                <div className="flex gap-2 justify-start">
                                                    <button disabled className="px-2 py-1 rounded-2xl bg-gray-200 text-gray-400">編輯</button>
                                                    <button disabled className="px-2 py-1 rounded-2xl bg-gray-200 text-gray-400">刪除</button>
                                                </div>
                                                <div className="text-gray-300">—</div>
                                            </div>
                                        ) : getSortedData(areas, areaSort, (data) => data.sort((a, b) => {
                                            if (typeof a.order === 'number' && typeof b.order === 'number') {
                                                return a.order - b.order;
                                            }
                                            return 0;
                                        })).map((a, index) => {
                                            const isReorderable = !areaSort.key;
                                            return (
                                            <div 
                                                key={a.id} 
                                                draggable={isReorderable}
                                                onDragStart={(e) => isReorderable && onAreaDragStart(e, index)}
                                                onDragOver={(e) => isReorderable && onAreaDragOver(e, index)}
                                                onDrop={(e) => isReorderable && onAreaDrop(e, index)}
                                                className={`grid grid-cols-4 gap-2 items-center p-3 bg-gray-50 rounded-2xl text-xs whitespace-nowrap min-w-[800px] ${isReorderable ? 'cursor-move hover:bg-gray-100 transition-colors' : ''} ${draggedArea?.id === a.id ? 'opacity-30 border-2 border-dashed border-gray-400' : ''}`}
                                            >
                                                <div className="font-bold text-gray-700 flex items-center gap-2">
                                                    {isReorderable && (
                                                        <div className="flex flex-col text-gray-400">
                                                            <button 
                                                                disabled={index === 0} 
                                                                onClick={(e) => { e.stopPropagation(); handleMoveArea(index, -1); }}
                                                                className="hover:text-red-600 disabled:opacity-0"
                                                            >
                                                                <ChevronUp className="w-3 h-3" />
                                                            </button>
                                                            <button 
                                                                disabled={index === areas.length - 1} 
                                                                onClick={(e) => { e.stopPropagation(); handleMoveArea(index, 1); }}
                                                                className="hover:text-red-600 disabled:opacity-0"
                                                            >
                                                                <ChevronDown className="w-3 h-3" />
                                                            </button>
                                                        </div>
                                                    )}
                                                    {a.id}
                                                </div>
                                                <div className="text-gray-700">{a.name}</div>
                                                <div className="flex gap-2 justify-start">
                                                <button onClick={()=>{ setAreaForm({ id: a.id, name: a.name }); setShowAreaModal(true); }} className="px-2 py-1 rounded-2xl bg-gray-800 text-white">編輯</button>
                                                <button onClick={()=>{ setConfirmDelete({ type:'area', id:a.id, label:a.name }); }} className="px-2 py-1 rounded-2xl bg-red-600 text-white">刪除</button>
                                                </div>
                                                <div className="text-gray-700">{a.updatedByName ? `${a.updatedByName} ${formatDateTime(a.updatedAt)}` : '-'}</div>
                                            </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                {showAreaModal && (
                                    <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                        <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                            <h4 className="text-lg font-bold text-gray-800 mb-4">新增/編輯區域</h4>
                                            <div className="space-y-3">
                                                <label className="block text-xs font-bold text-gray-500 uppercase">區域編號</label>
                                                <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={areaForm.id} onChange={e=>setAreaForm(prev=>({...prev, id: e.target.value}))} />
                                                <label className="block text-xs font-bold text-gray-500 uppercase">區域名稱</label>
                                                <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={areaForm.name} onChange={e=>setAreaForm(prev=>({...prev, name: e.target.value}))} />
                                                {areaError && <div className="text-xs text-red-600">{areaError}</div>}
                                            </div>
                                            <div className="flex justify-end gap-2 mt-4">
                                                <button onClick={()=>setShowAreaModal(false)} className="px-3 py-2 rounded-2xl bg-gray-100 text-gray-700">取消</button>
                                                <button disabled={areaSaving} onClick={async()=>{ try { setAreaError(''); setAreaSaving(true); if (!user) { setAreaError('沒有登入權限，請先登入'); return; } if (!areaForm.id.trim() || !areaForm.name.trim()) { setAreaError('請輸入區域編號與區域名稱'); return; } if (areas.find(x=>x.id===areaForm.id.trim())) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'areas', areaForm.id.trim()), { name: areaForm.name.trim(), updatedByName: (currentUser && currentUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() }); setToast('儲存成功'); } else { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'areas', areaForm.id.trim()), { name: areaForm.name.trim(), updatedByName: '新增', updatedAt: serverTimestamp() }); setToast('新增成功'); } setShowAreaModal(false); } catch (e) { console.error(e); setAreaError(`儲存失敗：${e.code || e.message}`); } finally { setAreaSaving(false);} }} className="px-3 py-2 rounded-2xl bg-red-600 text-white">儲存</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <FileText className="w-5 h-5 mr-2 text-red-600" /> 簽呈類型列表
                                </h3>
                                <div className="mb-4">
                                    <button onClick={() => { setSignatureTypeForm({ id: '', name: '' }); setShowSignatureTypeModal(true); }} className="bg-red-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-red-700">新增</button>
                                    {signatureTypes.length === 0 && (
                                        <button onClick={async () => {
                                            if (!confirm('確定要匯入預設簽呈類型嗎？')) return;
                                            setSignatureTypeLoading(true);
                                            try {
                                                const defaults = ['請假申請', '加班申請', '費用報銷', '採購申請', '其他事項'];
                                                const batchPromises = defaults.map(name => 
                                                    addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'signature_types'), { 
                                                        name: name, 
                                                        updatedByName: (currentUser && currentUser.name) || (user && user.email) || '', 
                                                        updatedAt: serverTimestamp() 
                                                    })
                                                );
                                                await Promise.all(batchPromises);
                                                setToast('匯入成功');
                                            } catch (e) {
                                                console.error(e);
                                                setToast('匯入失敗: ' + e.message);
                                            } finally {
                                                setSignatureTypeLoading(false);
                                            }
                                        }} className="bg-gray-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-gray-700 ml-2">匯入預設</button>
                                    )}
                                </div>
                                <div className="max-h-[500px] overflow-y-auto overflow-x-auto no-scrollbar">
                                    <div className="grid grid-cols-3 gap-2 px-3 py-2 text-[11px] font-bold text-gray-500 whitespace-nowrap min-w-[600px] text-left">
                                        <div><SortHeader label="類型名稱" sortKey="name" currentSort={signatureTypeSort} setSort={setSignatureTypeSort} /></div>
                                        <div>操作</div>
                                        <div><SortHeader label="紀錄" sortKey="updatedAt" currentSort={signatureTypeSort} setSort={setSignatureTypeSort} /></div>
                                    </div>
                                    <div className="space-y-2">
                                        {signatureTypes.length === 0 ? (
                                            <div className="grid grid-cols-3 gap-2 items-center p-3 bg-gray-50 rounded-2xl text-xs whitespace-nowrap min-w-[600px]">
                                                <div className="font-bold text-gray-300">—</div>
                                                <div className="flex gap-2 justify-start">
                                                    <button disabled className="px-2 py-1 rounded-2xl bg-gray-200 text-gray-400">編輯</button>
                                                    <button disabled className="px-2 py-1 rounded-2xl bg-gray-200 text-gray-400">刪除</button>
                                                </div>
                                                <div className="text-gray-300">—</div>
                                            </div>
                                        ) : getSortedData(signatureTypes, signatureTypeSort).map((st, index) => {
                                            const isReorderable = !signatureTypeSort.key;
                                            return (
                                            <div 
                                                key={st.id} 
                                                draggable={isReorderable}
                                                onDragStart={(e) => isReorderable && onDragStart(e, index)}
                                                onDragOver={(e) => isReorderable && onDragOver(e, index)}
                                                onDrop={(e) => isReorderable && onDrop(e, index)}
                                                className={`grid grid-cols-3 gap-2 items-center p-3 bg-gray-50 rounded-2xl text-xs whitespace-nowrap min-w-[600px] ${isReorderable ? 'cursor-move hover:bg-gray-100 transition-colors' : ''} ${draggedSignatureType?.id === st.id ? 'opacity-30 border-2 border-dashed border-gray-400' : ''}`}
                                            >
                                                <div className="font-bold text-gray-700 flex items-center gap-2">
                                                    {isReorderable && (
                                                        <div className="flex flex-col text-gray-400">
                                                            <button 
                                                                disabled={index === 0} 
                                                                onClick={(e) => { e.stopPropagation(); handleMoveSignatureType(index, -1); }}
                                                                className="hover:text-red-600 disabled:opacity-0"
                                                            >
                                                                <ChevronUp className="w-3 h-3" />
                                                            </button>
                                                            <button 
                                                                disabled={index === signatureTypes.length - 1} 
                                                                onClick={(e) => { e.stopPropagation(); handleMoveSignatureType(index, 1); }}
                                                                className="hover:text-red-600 disabled:opacity-0"
                                                            >
                                                                <ChevronDown className="w-3 h-3" />
                                                            </button>
                                                        </div>
                                                    )}
                                                    {st.name}
                                                </div>
                                                <div className="flex gap-2 justify-start">
                                                    <button onClick={()=>{ setSignatureTypeForm({ id: st.id, name: st.name }); setShowSignatureTypeModal(true); }} className="px-2 py-1 rounded-2xl bg-gray-800 text-white">編輯</button>
                                                    <button onClick={()=>{ setConfirmDelete({ type:'signatureType', id:st.id, label:st.name }); }} className="px-2 py-1 rounded-2xl bg-red-600 text-white">刪除</button>
                                                </div>
                                                <div className="text-gray-700">{st.updatedByName ? `${st.updatedByName} ${formatDateTime(st.updatedAt)}` : '-'}</div>
                                            </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                {showSignatureTypeModal && (
                                    <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                        <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                            <h4 className="text-lg font-bold text-gray-800 mb-4">新增/編輯簽呈類型</h4>
                                            <div className="space-y-3">
                                                <label className="block text-xs font-bold text-gray-500 uppercase">類型名稱</label>
                                                <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={signatureTypeForm.name} onChange={e=>setSignatureTypeForm(prev=>({...prev, name: e.target.value}))} />
                                                {signatureTypeError && <div className="text-xs text-red-600">{signatureTypeError}</div>}
                                            </div>
                                            <div className="flex justify-end gap-2 mt-4">
                                                <button onClick={()=>setShowSignatureTypeModal(false)} className="px-3 py-2 rounded-2xl bg-gray-100 text-gray-700">取消</button>
                                                <button disabled={signatureTypeLoading} onClick={async()=>{ 
                                                    try { 
                                                        setSignatureTypeError(''); 
                                                        setSignatureTypeLoading(true); 
                                                        if (!user) { setSignatureTypeError('沒有登入權限，請先登入'); return; } 
                                                        if (!signatureTypeForm.name.trim()) { setSignatureTypeError('請輸入類型名稱'); return; } 
                                                        
                                                        if (signatureTypeForm.id) {
                                                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'signature_types', signatureTypeForm.id), { 
                                                                name: signatureTypeForm.name.trim(), 
                                                                updatedByName: (currentUser && currentUser.name) || (user && user.email) || '', 
                                                                updatedAt: serverTimestamp() 
                                                            }); 
                                                            setToast('儲存成功'); 
                                                        } else { 
                                                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'signature_types'), { 
                                                                name: signatureTypeForm.name.trim(), 
                                                                updatedByName: (currentUser && currentUser.name) || (user && user.email) || '', 
                                                                updatedAt: serverTimestamp() 
                                                            }); 
                                                            setToast('新增成功'); 
                                                        } 
                                                        setShowSignatureTypeModal(false); 
                                                    } catch (e) { 
                                                        console.error(e); 
                                                        setSignatureTypeError(`儲存失敗：${e.code || e.message}`); 
                                                    } finally { 
                                                        setSignatureTypeLoading(false);
                                                    } 
                                                }} className="px-3 py-2 rounded-2xl bg-red-600 text-white">儲存</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        )}
                        {subtab === 'account' && hasSubPermission('settings', 'account') && (
                        <>
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                <Users className="w-5 h-5 mr-2 text-red-600" />
                                帳號列表
                            </h3>
                            <div className="mb-4 flex gap-2">
                                <button onClick={()=>{ setEditingUserId(null); setModalUser({ role:'admin', title:'', name:'', email:'', phone:'', communityIds:[], companyIds:[], avatarUrl:'', status:'在職', startDate:'', resignDate:'' }); setShowAddModal(true); }} className="bg-red-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-red-700">新增</button>
                                <button onClick={handleExportUsers} className="bg-green-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-green-700">匯出</button>
                                <label className="bg-blue-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-blue-700 cursor-pointer flex items-center">
                                    匯入
                                    <input type="file" accept=".xlsx, .xls" className="hidden" onChange={handleImportUsers} />
                                </label>
                            </div>
                            <div className="h-[calc(100vh-280px)] overflow-y-auto overflow-x-auto no-scrollbar">
                                <div className="grid grid-cols-[100px_60px_100px_100px_220px_100px_120px_150px_250px_160px_140px_1fr] gap-2 px-3 py-2 text-[11px] font-bold text-gray-500 whitespace-nowrap min-w-[1750px] text-left">
                                    <div>角色</div>
                                    <div>大頭照</div>
                                    <div>職稱</div>
                                    <div>姓名</div>
                                    <div>電子郵件</div>
                                    <div>密碼</div>
                                    <div>手機號碼</div>
                                    <div>所屬公司</div>
                                    <div>服務社區</div>
                                    <div>狀況</div>
                                    <div>操作</div>
                                    <div>紀錄</div>
                                </div>
                                <div className="space-y-2">
                                    {[...users].filter(u => {
                                        // Admin sees everyone
                                        if (currentUser?.role === 'admin') return true;
                                        // Show only requested roles: Admin, HR, Cadre, Staff
                                        const allowedRoles = ['admin', 'hr', 'cadre', 'staff'];
                                        return allowedRoles.includes(u.role);
                                    }).sort((a, b) => {
                                        // Status Sort: '離職' at bottom
                                        const statusA = a.status || '在職';
                                        const statusB = b.status || '在職';
                                        if (statusA === '離職' && statusB !== '離職') return 1;
                                        if (statusA !== '離職' && statusB === '離職') return -1;

                                        // Company Sort
                                        const getCompanyName = (u) => {
                                            const cid = (u.companyIds && u.companyIds.length > 0) ? u.companyIds[0] : u.companyId;
                                            if (!cid) return 'ZZZ';
                                            const c = companies.find(comp => comp.id === cid);
                                            return c ? c.name : 'ZZZ';
                                        };
                                        const cA = getCompanyName(a);
                                        const cB = getCompanyName(b);
                                        const cOrder = ['台北公司', '桃園公司'];
                                        const cIdxA = cOrder.indexOf(cA);
                                        const cIdxB = cOrder.indexOf(cB);
                                        
                                        if (cIdxA !== -1 && cIdxB !== -1) {
                                            if (cIdxA !== cIdxB) return cIdxA - cIdxB;
                                        } else if (cIdxA !== -1) return -1;
                                        else if (cIdxB !== -1) return 1;
                                        else if (cA !== cB) return cA.localeCompare(cB);

                                        // Role Sort
                                        const getRolePriority = (u) => {
                                            if (u.role === 'admin') return 1;
                                            const rName = roles.find(r => r.id === u.role)?.name;
                                            if (rName === '管理層') return 2;
                                            if (rName === '人事') return 3;
                                            if (rName === '幹部') return 4;
                                            if (rName === '員工') return 5;
                                            return 99;
                                        };
                                        return getRolePriority(a) - getRolePriority(b);
                                    }).map(u => (
                                        <div key={u.id} className={`grid grid-cols-[100px_60px_100px_100px_220px_100px_120px_150px_250px_160px_140px_1fr] gap-2 items-center p-3 rounded-2xl text-xs whitespace-nowrap min-w-[1750px] ${u.status === '離職' ? 'bg-red-100' : 'bg-gray-50'}`}>
                                            <div className="font-bold text-gray-700">
                                                {u.role === 'admin' ? '系統管理員' : (roles.find(r => r.id === u.role)?.name || u.role)}
                                            </div>
                                            <div 
                                                className="flex items-center cursor-pointer hover:opacity-80 transition-opacity"
                                                onClick={() => {
                                                    setCadreMapSelectedUserId(u.id);
                                                    setActiveTab('cadre');
                                                    setCadreSubtab('schedule');
                                                }}
                                                title="點擊查看班表"
                                            >
                                                {u.avatarUrl ? (
                                                    <img src={u.avatarUrl} alt="avatar" className="w-10 h-10 rounded-full object-cover" />
                                                ) : (
                                                    <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-700">{(u.name || '?').charAt(0)}</div>
                                                )}
                                            </div>
                                            <div className="text-gray-700">{u.title || '-'}</div>
                                            <div className="font-bold text-gray-700">{u.name || '-'}</div>
                                            <div className="text-gray-700">{u.email || '-'}</div>
                                            <div className="text-gray-500 font-mono">{u.password || '-'}</div>
                                            <div className="text-gray-700">{u.phone || '-'}</div>
                                            <div className="text-gray-700">
                                                {(function(){ 
                                                    const ids = u.companyIds || (u.companyId ? [u.companyId] : []);
                                                    if (ids.length === 0) return '-';
                                                    return ids.map(id => {
                                                        const c = companies.find(c => c.id === id);
                                                        return c ? c.name : id;
                                                    }).join('、');
                                                })()}
                                            </div>
                                            <div className="text-gray-700">
                                                {(function(){ 
                                                    const ids = u.communityIds || (u.communityId ? [u.communityId] : []);
                                                    if (ids.length === 0) return '-';
                                                    const text = ids.map(id => {
                                                        const c = communities.find(c => c.id === id);
                                                        return c ? c.name : id;
                                                    }).join('、');
                                                    return text.length > 10 ? text.substring(0, 10) + '...' : text;
                                                })()}
                                            </div>
                                            <div className="text-gray-700">
                                                <div className={`px-2 py-0.5 rounded text-xs w-fit mb-1 ${u.status === '離職' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                                                    {u.status || '在職'}
                                                </div>
                                                <div className="text-[10px] text-gray-500">
                                                    {u.startDate && <div>入: {u.startDate}</div>}
                                                    {u.resignDate && <div>離: {u.resignDate}</div>}
                                                </div>
                                            </div>
                                            <div className="flex gap-2 justify-start">
                                                <button onClick={()=>{ setEditingUserId(u.id); setModalUser({ role: u.role || 'staff', title: u.title || '', name: u.name || '', email: u.email || '', phone: u.phone || '', communityIds: u.communityIds || (u.communityId ? [u.communityId] : []), companyIds: u.companyIds || (u.companyId ? [u.companyId] : []), avatarUrl: u.avatarUrl || '', status: u.status || '在職', startDate: u.startDate || '', resignDate: u.resignDate || '' }); setShowAddModal(true); }} className="px-2 py-1 rounded-2xl bg-gray-800 text-white">編輯</button>
                                                <button onClick={()=>{ setConfirmDelete({ type:'user', id:u.id, label:u.name || u.email || u.id }); }} className="px-2 py-1 rounded-2xl bg-red-600 text-white">刪除</button>
                                            </div>
                                            <div className="text-gray-700">{u.updatedByName ? `${u.updatedByName} ${formatDateTime(u.updatedAt)}` : '-'}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            {showAddModal && (
                                <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                    <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                        <h4 className="text-lg font-bold text-gray-800 mb-4">新增/編輯人員</h4>
                                        <div className="space-y-3">
                                            <label className="block text-xs font-bold text-gray-500 uppercase">角色</label>
                                            <select className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.role} onChange={e=>setModalUser(prev=>({...prev, role: e.target.value}))}>
                                                <option value="admin">系統管理員</option>
                                                {getSortedData(roles, { key: null }, (data) => data.sort((a, b) => {
                                                    if (typeof a.order === 'number' && typeof b.order === 'number') {
                                                        return a.order - b.order;
                                                    }
                                                    const order = ['系統管理員', '管理層', '人事', '幹部', '員工', '總幹事', '秘書', '清潔', '機電', '保全'];
                                                    const indexA = order.indexOf(a.name);
                                                    const indexB = order.indexOf(b.name);
                                                    if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                                                    if (indexA !== -1) return -1;
                                                    if (indexB !== -1) return 1;
                                                    return 0;
                                                })).filter(r => r.name !== '系統管理員').map(r => (
                                                    <option key={r.id} value={r.id}>{r.name}</option>
                                                ))}
                                            </select>
                                            <label className="block text-xs font-bold text-gray-500 uppercase">大頭照</label>
                                            <input type="file" accept="image/*" onChange={(e)=>handleAvatarUpload(e.target.files?.[0])} />
                                            {modalUser.avatarUrl && <img src={modalUser.avatarUrl} alt="preview" className="w-10 h-10 rounded-full object-cover" />}
                                            <label className="block text-xs font-bold text-gray-500 uppercase">職稱</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.title} onChange={e=>setModalUser(prev=>({...prev, title: e.target.value}))} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">姓名</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.name} onChange={e=>setModalUser(prev=>({...prev, name: e.target.value}))} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">電子郵件（預設帳號）</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.email} onChange={e=>setModalUser(prev=>({...prev, email: e.target.value}))} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">手機號碼</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.phone} onChange={e=>setModalUser(prev=>({...prev, phone: e.target.value}))} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">密碼</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.password || ''} onChange={e=>setModalUser(prev=>({...prev, password: e.target.value}))} placeholder={editingUserId ? "若不修改請留空" : "預設: 123456"} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">狀況</label>
                                            <select className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.status || '在職'} onChange={e=>setModalUser(prev=>({...prev, status: e.target.value}))}>
                                                <option value="在職">在職</option>
                                                <option value="離職">離職</option>
                                            </select>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">在職起始時間</label>
                                                    <input type="date" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.startDate || ''} onChange={e=>setModalUser(prev=>({...prev, startDate: e.target.value}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">離職起始時間</label>
                                                    <input type="date" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={modalUser.resignDate || ''} onChange={e=>setModalUser(prev=>({...prev, resignDate: e.target.value}))} />
                                                </div>
                                            </div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase">所屬公司</label>
                                            <div className="space-y-2 border border-gray-200 rounded-2xl p-3 max-h-40 overflow-y-auto bg-gray-50">
                                                {['admin', 'manager'].includes(modalUser.role) && (
                                                <div className="flex items-center gap-2 pb-2 border-b border-gray-200">
                                                    <label className="flex items-center gap-2 text-xs font-bold text-red-600 cursor-pointer select-none">
                                                        <input type="checkbox" 
                                                            className="w-4 h-4 text-red-600 rounded-2xl focus:ring-red-500"
                                                            checked={companies.length > 0 && modalUser.companyIds?.length === companies.length}
                                                            onChange={(e) => {
                                                                if (e.target.checked) {
                                                                    setModalUser(prev => ({ ...prev, companyIds: companies.map(c => c.id) }));
                                                                } else {
                                                                    setModalUser(prev => ({ ...prev, companyIds: [] }));
                                                                }
                                                            }}
                                                        />
                                                        全選
                                                    </label>
                                                </div>
                                                )}
                                                {getSortedData(companies, { key: null }, (data) => data.sort((a, b) => {
                                                    if (typeof a.order === 'number' && typeof b.order === 'number') {
                                                        return a.order - b.order;
                                                    }
                                                    return 0;
                                                })).map(c => (
                                                    <label key={c.id} className="flex items-center gap-2 text-sm cursor-pointer select-none hover:bg-gray-100 p-1 rounded-2xl">
                                                        <input type="checkbox" 
                                                            className="w-4 h-4 text-red-600 rounded-2xl focus:ring-red-500"
                                                            checked={modalUser.companyIds?.includes(c.id)}
                                                            onChange={(e) => {
                                                                const checked = e.target.checked;
                                                                const canMulti = ['admin', 'manager'].includes(modalUser.role);
                                                                setModalUser(prev => {
                                                                    const currentIds = prev.companyIds || [];
                                                                    let newIds;
                                                                    if (checked) {
                                                                        if (canMulti) {
                                                                            newIds = [...currentIds, c.id];
                                                                        } else {
                                                                            newIds = [c.id];
                                                                        }
                                                                    } else {
                                                                        newIds = currentIds.filter(id => id !== c.id);
                                                                    }
                                                                    return { ...prev, companyIds: newIds };
                                                                });
                                                            }}
                                                        />
                                                        <span className="text-gray-700">[{c.id}] {c.name}</span>
                                                    </label>
                                                ))}
                                            </div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase">服務社區</label>
                                            <div className="space-y-2 border border-gray-200 rounded-2xl p-3 max-h-40 overflow-y-auto bg-gray-50">
                                                <div className="flex items-center gap-2 pb-2 border-b border-gray-200">
                                                    <label className="flex items-center gap-2 text-xs font-bold text-red-600 cursor-pointer select-none">
                                                        <input type="checkbox" 
                                                            className="w-4 h-4 text-red-600 rounded-2xl focus:ring-red-500"
                                                            checked={communities.length > 0 && modalUser.communityIds?.length === communities.length}
                                                            onChange={(e) => {
                                                                if (e.target.checked) {
                                                                    setModalUser(prev => ({ ...prev, communityIds: communities.map(c => c.id) }));
                                                                } else {
                                                                    setModalUser(prev => ({ ...prev, communityIds: [] }));
                                                                }
                                                            }}
                                                        />
                                                        全選
                                                    </label>
                                                    <label className="flex items-center gap-2 text-xs font-bold text-gray-600 cursor-pointer select-none">
                                                        <input 
                                                            type="checkbox" 
                                                            className="w-4 h-4 text-gray-600 rounded-2xl focus:ring-gray-500" 
                                                            checked={communities.some(c => c.id.startsWith('A')) && communities.filter(c => c.id.startsWith('A')).every(c => modalUser.communityIds?.includes(c.id))}
                                                            onChange={(e) => {
                                                                const checked = e.target.checked;
                                                                const targetIds = communities.filter(c => c.id.startsWith('A')).map(c => c.id);
                                                                setModalUser(prev => {
                                                                    const currentIds = prev.communityIds || [];
                                                                    let newIds;
                                                                    if (checked) {
                                                                        newIds = [...new Set([...currentIds, ...targetIds])];
                                                                    } else {
                                                                        newIds = currentIds.filter(id => !targetIds.includes(id));
                                                                    }
                                                                    return { ...prev, communityIds: newIds };
                                                                });
                                                            }}
                                                        /> A
                                                    </label>
                                                    <label className="flex items-center gap-2 text-xs font-bold text-gray-600 cursor-pointer select-none">
                                                        <input 
                                                            type="checkbox" 
                                                            className="w-4 h-4 text-gray-600 rounded-2xl focus:ring-gray-500" 
                                                            checked={communities.some(c => c.id.startsWith('B')) && communities.filter(c => c.id.startsWith('B')).every(c => modalUser.communityIds?.includes(c.id))}
                                                            onChange={(e) => {
                                                                const checked = e.target.checked;
                                                                const targetIds = communities.filter(c => c.id.startsWith('B')).map(c => c.id);
                                                                setModalUser(prev => {
                                                                    const currentIds = prev.communityIds || [];
                                                                    let newIds;
                                                                    if (checked) {
                                                                        newIds = [...new Set([...currentIds, ...targetIds])];
                                                                    } else {
                                                                        newIds = currentIds.filter(id => !targetIds.includes(id));
                                                                    }
                                                                    return { ...prev, communityIds: newIds };
                                                                });
                                                            }}
                                                        /> B
                                                    </label>
                                                    <label className="flex items-center gap-2 text-xs font-bold text-gray-600 cursor-pointer select-none">
                                                        <input 
                                                            type="checkbox" 
                                                            className="w-4 h-4 text-gray-600 rounded-2xl focus:ring-gray-500" 
                                                            checked={communities.some(c => c.id.startsWith('C')) && communities.filter(c => c.id.startsWith('C')).every(c => modalUser.communityIds?.includes(c.id))}
                                                            onChange={(e) => {
                                                                const checked = e.target.checked;
                                                                const targetIds = communities.filter(c => c.id.startsWith('C')).map(c => c.id);
                                                                setModalUser(prev => {
                                                                    const currentIds = prev.communityIds || [];
                                                                    let newIds;
                                                                    if (checked) {
                                                                        newIds = [...new Set([...currentIds, ...targetIds])];
                                                                    } else {
                                                                        newIds = currentIds.filter(id => !targetIds.includes(id));
                                                                    }
                                                                    return { ...prev, communityIds: newIds };
                                                                });
                                                            }}
                                                        /> C
                                                    </label>
                                                </div>
                                                {communities.map(c => (
                                                    <label key={c.id} className="flex items-center gap-2 text-sm cursor-pointer select-none hover:bg-gray-100 p-1 rounded-2xl">
                                                        <input type="checkbox" 
                                                            className="w-4 h-4 text-red-600 rounded-2xl focus:ring-red-500"
                                                            checked={modalUser.communityIds?.includes(c.id)}
                                                            onChange={(e) => {
                                                                const checked = e.target.checked;
                                                                setModalUser(prev => {
                                                                    const currentIds = prev.communityIds || [];
                                                                    let newIds;
                                                                    if (checked) {
                                                                        newIds = [...currentIds, c.id];
                                                                    } else {
                                                                        newIds = currentIds.filter(id => id !== c.id);
                                                                    }
                                                                    return { ...prev, communityIds: newIds };
                                                                });
                                                            }}
                                                        />
                                                        <span className="text-gray-700">[{c.id}] {c.name}</span>
                                                    </label>
                                                ))}
                                            </div>
                                            {modalUser.role !== 'manager' && (
                                                <>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">預設打卡位置</label>
                                                    <select
                                                        className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100"
                                                        value={
                                                            ((() => {
                                                                const isModalCompanyGroup =
                                                                    ['admin', 'hr', 'cadre', 'property'].includes(modalUser.role) ||
                                                                    (modalUser.title && modalUser.title.includes('幹部')) ||
                                                                    ((roles || []).some(r => r.id === modalUser.role && (r.name.includes('幹部') || r.name.includes('人事') || r.name.includes('系統管理員') || r.name.includes('物業'))));
                                                                const companyDefault = modalUser.companyId || ((modalUser.companyIds && modalUser.companyIds[0]) || '');
                                                                const communityDefault = modalUser.communityId || ((modalUser.communityIds && modalUser.communityIds[0]) || '');
                                                                if (isModalCompanyGroup) {
                                                                    return companyDefault ? `company:${companyDefault}` : (communityDefault ? `community:${communityDefault}` : '');
                                                                }
                                                                return communityDefault ? `community:${communityDefault}` : (companyDefault ? `company:${companyDefault}` : '');
                                                            })())
                                                        }
                                                        onChange={(e) => {
                                                            const val = e.target.value;
                                                            const [type, id] = String(val).split(':');
                                                            if (type === 'company') {
                                                                setModalUser(prev => ({ ...prev, companyId: id }));
                                                            } else if (type === 'community') {
                                                                setModalUser(prev => ({ ...prev, communityId: id }));
                                                            }
                                                        }}
                                                    >
                                                        <optgroup label="所屬公司">
                                                            {
                                                                ((() => {
                                                                    const pool = (modalUser.companyIds && modalUser.companyIds.length > 0)
                                                                        ? companies.filter(c => (modalUser.companyIds || []).includes(c.id))
                                                                        : companies;
                                                                    return pool.map(c => <option key={c.id} value={`company:${c.id}`}>{c.name}</option>);
                                                                })())
                                                            }
                                                        </optgroup>
                                                        <optgroup label="服務社區">
                                                            {
                                                                ((() => {
                                                                    const pool = (modalUser.communityIds && modalUser.communityIds.length > 0)
                                                                        ? communities.filter(c => (modalUser.communityIds || []).includes(c.id))
                                                                        : communities;
                                                                    return pool.map(c => <option key={c.id} value={`community:${c.id}`}>{c.name}</option>);
                                                                })())
                                                            }
                                                        </optgroup>
                                                    </select>
                                                </>
                                            )}
                                        </div>
                                            {userError && <div className="text-xs text-red-600">{userError}</div>}
                                            <div className="flex justify-end gap-2 mt-4">
                                                <button onClick={()=>{ setShowAddModal(false); setEditingUserId(null); }} className="px-3 py-2 rounded-2xl bg-gray-100 text-gray-700">取消</button>
                                                <button disabled={userSaving} onClick={async()=>{ try { setUserError(''); setUserSaving(true); if (!user) { setUserError('沒有登入權限，請先登入'); return; } const userDataToSave = { ...modalUser, communityId: modalUser.communityId || ((modalUser.communityIds && modalUser.communityIds.length > 0) ? modalUser.communityIds[0] : ''), companyId: modalUser.companyId || ((modalUser.companyIds && modalUser.companyIds.length > 0) ? modalUser.companyIds[0] : ''), status: modalUser.status || '在職' }; if (editingUserId && !userDataToSave.password) { delete userDataToSave.password; } if (editingUserId) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', editingUserId), { ...userDataToSave, updatedByName: (currentUser && currentUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() }); setToast('儲存成功'); } else { await onAddUser(userDataToSave); setToast('新增成功'); } setShowAddModal(false); setEditingUserId(null); setModalUser({ role:'admin', title:'', name:'', email:'', phone:'', communityIds:[], companyIds:[], avatarUrl:'', status:'在職', startDate:'', resignDate:'' }); } catch(e) { handleFetchError(e, 'save_user'); setUserError(`儲存失敗：${e.code || e.message}`); } finally { setUserSaving(false);} }} className="px-3 py-2 rounded-2xl bg-red-600 text-white">儲存</button>
                                            </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        </>
                        )}

                        {subtab === 'system' && hasSubPermission('settings', 'system') && (
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                <CheckSquare className="w-5 h-5 mr-2 text-red-600" />
                                核薪按鈕
                            </h3>
                            <div className="text-sm text-gray-600 mb-4">
                                在此區塊放置核薪相關操作按鈕。
                            </div>
                            <button
                                onClick={() => {
                                    const w = window.open('salary.html', '_blank');
                                    if (w) w.opener = null;
                                }}
                                className="bg-red-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-red-700"
                            >
                                核薪
                            </button>
                        </div>
                        )}

                        {subtab === 'community' && hasSubPermission('settings', 'community') && (
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                <Building2 className="w-5 h-5 mr-2 text-red-600" />
                                社區列表
                            </h3>
                            <div className="mb-4 flex gap-2">
                                    <button onClick={()=>{ setCommunityForm({ id:'', name:'', companyId:'', areaId:'', gmCount:0, secretaryCount:0, cleanCount:0, mechCount:0, guardCount:0, dayGuardCount:0, nightGuardCount:0, address:'', coordLat:'', coordLng:'', radiusMeters:100 }); setShowCommunityModal(true); }} className="bg-red-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-red-700">新增</button>
                                    <button onClick={handleExportCommunities} className="bg-green-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-green-700">匯出</button>
                                    <label className="bg-blue-600 text-white px-4 py-2 rounded-2xl text-sm font-bold hover:bg-blue-700 cursor-pointer flex items-center">
                                        匯入
                                        <input type="file" accept=".xlsx, .xls" className="hidden" onChange={handleImportCommunities} />
                                    </label>
                                </div>
                                <div className="h-[calc(100vh-280px)] overflow-y-auto overflow-x-auto no-scrollbar">
                                <div className="flex flex-row gap-2 px-3 py-2 text-[11px] font-bold text-gray-500 whitespace-nowrap min-w-[1820px] text-left [&>div]:shrink-0">
                                    <div className="w-[120px]">社區編號</div>
                                    <div className="w-[160px]">社區名稱</div>
                                    <div className="w-[140px]">所屬公司</div>
                                    <div className="w-[120px]">所屬區域</div>
                                    <div className="w-[80px]">總幹事數</div>
                                    <div className="w-[80px]">秘書數</div>
                                    <div className="w-[80px]">清潔數</div>
                                    <div className="w-[80px]">機電數</div>
                                    <div className="w-[80px]">保全數</div>
                                    <div className="w-[80px]">白天哨數</div>
                                    <div className="w-[80px]">晚上哨數</div>
                                    <div className="w-[200px]">社區地址</div>
                                    <div className="w-[160px]">社區座標</div>
                                    <div className="w-[120px]">社區地圖</div>
                                    <div className="w-[140px]">設定打卡範圍(公尺)</div>
                                    <div className="w-[160px]">操作</div>
                                    <div className="w-[220px]">紀錄</div>
                                </div>
                                <div className="space-y-2">
                                    {communities.map(c => {
                                        const companyName = (function(){ const cm = companies.find(x=>x.id === c.companyId); return cm ? cm.name : '-'; })();
                                        const areaName = (function(){ const ar = areas.find(x=>x.id === c.areaId); return ar ? ar.name : '-'; })();
                                        const coord = (c.coordLat && c.coordLng) ? `${c.coordLat}, ${c.coordLng}` : '-';
                                        return (
                                            <div key={c.id} className="flex flex-row gap-2 items-center p-3 bg-gray-50 rounded-2xl text-xs whitespace-nowrap min-w-[1820px] [&>div]:shrink-0">
                                                <div className="w-[120px] font-bold text-gray-700">{c.id}</div>
                                                <div className="w-[160px] text-gray-700">{c.name || '-'}</div>
                                                <div className="w-[140px] text-gray-700">{companyName}</div>
                                                <div className="w-[120px] text-gray-700">{areaName}</div>
                                                <div className="w-[80px] text-gray-700">{c.gmCount || 0}</div>
                                                <div className="w-[80px] text-gray-700">{c.secretaryCount || 0}</div>
                                                <div className="w-[80px] text-gray-700">{c.cleanCount || 0}</div>
                                                <div className="w-[80px] text-gray-700">{c.mechCount || 0}</div>
                                                <div className="w-[80px] text-gray-700">{c.guardCount || 0}</div>
                                                <div className="w-[80px] text-gray-700">{c.dayGuardCount || 0}</div>
                                                <div className="w-[80px] text-gray-700">{c.nightGuardCount || 0}</div>
                                                <div className="w-[200px] text-gray-700">{c.address || '-'}</div>
                                                <div className="w-[160px] text-gray-700">{coord}</div>
                                                <div className="w-[120px]">
                                                    <button onClick={()=>{ if (c.coordLat && c.coordLng) { setMapTarget({ name: c.name, lat: parseFloat(c.coordLat), lng: parseFloat(c.coordLng), radius: c.radiusMeters || 0 }); } }} className="px-2 py-1 rounded-2xl bg-gray-800 text-white">社區地圖</button>
                                                </div>
                                                <div className="w-[140px] text-gray-700">{c.radiusMeters || 0}</div>
                                                <div className="w-[160px] flex gap-2 justify-start">
                                                    <button onClick={()=>{ setCommunityForm({ id:c.id, name:c.name || '', companyId:c.companyId || '', areaId:c.areaId || '', gmCount:c.gmCount || 0, secretaryCount:c.secretaryCount || 0, cleanCount:c.cleanCount || 0, mechCount:c.mechCount || 0, guardCount:c.guardCount || 0, dayGuardCount:c.dayGuardCount || 0, nightGuardCount:c.nightGuardCount || 0, address:c.address || '', coordLat:c.coordLat || '', coordLng:c.coordLng || '', radiusMeters:c.radiusMeters || 100 }); setShowCommunityModal(true); }} className="px-2 py-1 rounded-2xl bg-gray-800 text-white">編輯</button>
                                                    <button onClick={()=>{ setConfirmDelete({ type:'community', id:c.id, label:c.name || c.id }); }} className="px-2 py-1 rounded-2xl bg-red-600 text-white">刪除</button>
                                                </div>
                                                <div className="w-[220px] text-gray-700">{c.updatedByName ? `${c.updatedByName} ${formatDateTime(c.updatedAt)}` : '-'}</div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                            {showCommunityModal && (
                                <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                    <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                        <h4 className="text-lg font-bold text-gray-800 mb-4">新增/編輯社區</h4>
                                        <div className="space-y-3">
                                            <label className="block text-xs font-bold text-gray-500 uppercase">社區編號</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={communityForm.id} onChange={e=>setCommunityForm(prev=>({...prev, id: e.target.value}))} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">社區名稱</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={communityForm.name} onChange={e=>setCommunityForm(prev=>({...prev, name: e.target.value}))} />
                                            <label className="block text-xs font-bold text-gray-500 uppercase">所屬公司</label>
                                            <select className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={communityForm.companyId} onChange={e=>setCommunityForm(prev=>({...prev, companyId: e.target.value}))}>
                                                <option value="">選擇公司</option>
                                                {getSortedData(companies, { key: null }, (data) => data.sort((a, b) => {
                                                    if (typeof a.order === 'number' && typeof b.order === 'number') {
                                                        return a.order - b.order;
                                                    }
                                                    return 0;
                                                })).map(cm => <option key={cm.id} value={cm.id}>{cm.name}</option>)}
                                            </select>
                                            <label className="block text-xs font-bold text-gray-500 uppercase">所屬區域</label>
                                            <select className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100" value={communityForm.areaId} onChange={e=>setCommunityForm(prev=>({...prev, areaId: e.target.value}))}>
                                                <option value="">選擇區域</option>
                                                {getSortedData(areas, { key: null }, (data) => data.sort((a, b) => {
                                                    if (typeof a.order === 'number' && typeof b.order === 'number') {
                                                        return a.order - b.order;
                                                    }
                                                    return 0;
                                                })).map(ar => <option key={ar.id} value={ar.id}>{ar.name}</option>)}
                                            </select>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">總幹事數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" value={communityForm.gmCount} onChange={e=>setCommunityForm(prev=>({...prev, gmCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">秘書數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" value={communityForm.secretaryCount} onChange={e=>setCommunityForm(prev=>({...prev, secretaryCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">清潔數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" value={communityForm.cleanCount} onChange={e=>setCommunityForm(prev=>({...prev, cleanCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">機電數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" value={communityForm.mechCount} onChange={e=>setCommunityForm(prev=>({...prev, mechCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">保全數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" value={communityForm.guardCount} onChange={e=>setCommunityForm(prev=>({...prev, guardCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">白天哨數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" value={communityForm.dayGuardCount} onChange={e=>setCommunityForm(prev=>({...prev, dayGuardCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">晚上哨數</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" value={communityForm.nightGuardCount} onChange={e=>setCommunityForm(prev=>({...prev, nightGuardCount: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                            </div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase">社區地址</label>
                                            <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" value={communityForm.address} onChange={e=>setCommunityForm(prev=>({...prev, address: e.target.value}))} onBlur={async(e)=>{ const addr = e.target.value.trim(); if (!addr) return; try { if (window.google && window.google.maps) { const gc = new google.maps.Geocoder(); gc.geocode({ address: addr }, (res, status)=>{ if (status === 'OK' && res && res[0]) { const loc = res[0].geometry.location; setCommunityForm(prev=>({...prev, coordLat: loc.lat(), coordLng: loc.lng()})); } }); } else { const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(addr)}`); const d = await r.json(); if (d && d[0]) { setCommunityForm(prev=>({...prev, coordLat: d[0].lat, coordLng: d[0].lon})); } } } catch {} }} />
                                            <div className="grid grid-cols-2 gap-2">
                                                <div className="col-span-2">
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">社區座標（緯度, 經度）</label>
                                                    <input className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" placeholder="例如：25.0330, 121.5654" value={(communityForm.coordLat!=='' && communityForm.coordLng!=='') ? `${communityForm.coordLat}, ${communityForm.coordLng}` : ''} onChange={e=>{ const v = e.target.value; const parts = v.split(','); if (parts.length >= 2) { const lat = parts[0].trim(); const lng = parts[1].trim(); setCommunityForm(prev=>({...prev, coordLat: lat, coordLng: lng})); } else { setCommunityForm(prev=>({...prev, coordLat: v.trim(), coordLng: prev.coordLng})); } }} />
                                                </div>
                                                <div className="col-span-2">
                                                    <label className="block text-xs font-bold text-gray-500 uppercase">設定打卡範圍(公尺)</label>
                                                    <input type="number" className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm" value={communityForm.radiusMeters} onChange={e=>setCommunityForm(prev=>({...prev, radiusMeters: parseInt(e.target.value||'0',10)}))} />
                                                </div>
                                            </div>
                                            <div className="mt-3">
                                                <div ref={communityMapElRef} className="w-full h-48 rounded-2xl border"></div>
                                            </div>
                                            {communityError && <div className="text-xs text-red-600">{communityError}</div>}
                                        </div>
                                        <div className="flex justify-end gap-2 mt-4">
                                            <button onClick={()=>setShowCommunityModal(false)} className="px-3 py-2 rounded-2xl bg-gray-100 text-gray-700">取消</button>
                                            <button disabled={communitySaving} onClick={async()=>{ try { setCommunityError(''); setCommunitySaving(true); if (!user) { setCommunityError('沒有登入權限，請先登入'); return; } const id = (communityForm.id || '').trim(); const name = (communityForm.name || '').trim(); if (!name) { setCommunityError('請輸入社區名稱'); return; } const latNum = communityForm.coordLat !== '' && communityForm.coordLat != null ? parseFloat(communityForm.coordLat) : undefined; const lngNum = communityForm.coordLng !== '' && communityForm.coordLng != null ? parseFloat(communityForm.coordLng) : undefined; const payload = { name, companyId: communityForm.companyId || '', areaId: communityForm.areaId || '', gmCount: communityForm.gmCount||0, secretaryCount: communityForm.secretaryCount||0, cleanCount: communityForm.cleanCount||0, mechCount: communityForm.mechCount||0, guardCount: communityForm.guardCount||0, dayGuardCount: communityForm.dayGuardCount||0, nightGuardCount: communityForm.nightGuardCount||0, address: communityForm.address||'', coordLat: latNum, coordLng: lngNum, radiusMeters: communityForm.radiusMeters||0, updatedByName: (currentUser && currentUser.name) || (user && user.email) || '', updatedAt: serverTimestamp() }; if (id) { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'communities', id), payload, { merge: true }); setToast(communities.find(x=>x.id===id)?'儲存成功':'新增成功'); } else { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'communities'), { ...payload, updatedByName: '新增' }); setToast('新增成功'); } setShowCommunityModal(false); } catch(e) { console.error(e); setCommunityError(`儲存失敗：${e.code || e.message}`); } finally { setCommunitySaving(false);} }} className="px-3 py-2 rounded-2xl bg-red-600 text-white">儲存</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {mapTarget && (
                                <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                    <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                        <h4 className="text-lg font-bold text-gray-800 mb-4">{mapTarget.name || '社區地圖'}</h4>
                                        <div ref={mapTargetElRef} className="w-full h-80 rounded-2xl border"></div>
                                        <div className="flex justify-end gap-2 mt-4">
                                            <button onClick={()=>setMapTarget(null)} className="px-3 py-2 rounded-2xl bg-gray-100 text-gray-700">關閉</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                        )}
                    </div>
                    {confirmDelete && (
                        <div className="fixed inset-0 z-[70] bg-black/40 flex items-center justify-center">
                            <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-sm p-6 max-h-[90vh] overflow-y-auto">
                                <div className="text-sm text-gray-700 mb-4">確認刪除{confirmDelete.type==='role'?'角色':confirmDelete.type==='company'?'公司':confirmDelete.type==='area'?'區域':confirmDelete.type==='signatureType'?'簽呈類型':confirmDelete.type==='signature'?'簽呈':confirmDelete.type==='community'?'社區':'人員'}「{confirmDelete.label}」？</div>
                                <div className="flex justify-end gap-2">
                                    <button onClick={()=>setConfirmDelete(null)} className="px-3 py-2 rounded-2xl bg-gray-100 text-gray-700">取消</button>
                                    <button onClick={async()=>{ try { 
                                        if (confirmDelete.type==='role') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roles', confirmDelete.id)); } 
                                        else if (confirmDelete.type==='company') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'companies', confirmDelete.id)); } 
                                        else if (confirmDelete.type==='area') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'areas', confirmDelete.id)); } 
                                        else if (confirmDelete.type==='signatureType') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'signature_types', confirmDelete.id)); } 
                                        else if (confirmDelete.type==='signature') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'signatures', confirmDelete.id)); } 
                                        else if (confirmDelete.type==='community') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'communities', confirmDelete.id)); } 
                                        else if (confirmDelete.type==='user') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', confirmDelete.id)); } 
                                        else if (confirmDelete.type==='schedule') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'schedules', confirmDelete.id)); } 
                                        setConfirmDelete(null); 
                                        setToast('刪除成功'); 
                                    } catch(e) { console.error(e); setConfirmDelete(null); setToast('刪除失敗'); } }} className="px-3 py-2 rounded-2xl bg-red-600 text-white">刪除</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Leave Request Modal
        const LeaveRequestModal = ({ isOpen, onClose, onSubmit, loading, defaultCompany, initialData, users = [] }) => {
            const [company, setCompany] = useState(defaultCompany || '所屬公司');
            const [userId, setUserId] = useState('');
            const [reason, setReason] = useState('病假');
            const [customReason, setCustomReason] = useState('');
            
            const getFormattedDateTime = (date, timeStr) => {
                const d = date ? new Date(date) : new Date();
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}T${timeStr}`;
            };

            const [startDate, setStartDate] = useState(getFormattedDateTime(new Date(), '09:00'));
            const [endDate, setEndDate] = useState(getFormattedDateTime(new Date(), '17:30'));
            const [description, setDescription] = useState('');
            const [photo, setPhoto] = useState(null);
            const [previewPhotoUrl, setPreviewPhotoUrl] = useState(null);
            const [initialized, setInitialized] = useState(false);

            useEffect(() => {
                if (!isOpen) {
                    setInitialized(false);
                    return;
                }
                if (initialized) return;
                const initUserId = initialData?.userId || (users.length > 0 ? users[0].id : '');
                setUserId(initUserId);
                if (initialData) {
                    setCompany(defaultCompany || '所屬公司');
                    if (['病假', '事假'].includes(initialData.leaveReason)) {
                        setReason(initialData.leaveReason);
                        setCustomReason('');
                    } else {
                        setReason('其他');
                        setCustomReason(initialData.leaveReason);
                    }
                    setStartDate(initialData.leaveStartDate || getFormattedDateTime(new Date(), '09:00'));
                    setEndDate(initialData.leaveEndDate || getFormattedDateTime(new Date(), '17:30'));
                    setDescription(initialData.leaveDescription || '');
                    if (initialData.photoUrl) {
                        setPhoto(initialData.photoUrl);
                        setPreviewPhotoUrl(initialData.photoUrl);
                    } else {
                        setPhoto(null);
                        setPreviewPhotoUrl(null);
                    }
                } else {
                    setCompany(defaultCompany || '所屬公司');
                    setReason('病假');
                    setCustomReason('');
                    setStartDate(getFormattedDateTime(new Date(), '09:00'));
                    setEndDate(getFormattedDateTime(new Date(), '18:00'));
                    setDescription('');
                    setPhoto(null);
                    setPreviewPhotoUrl(null);
                }
                setInitialized(true);
            }, [isOpen, initialData, defaultCompany, users, initialized]);
            
            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (new Date(endDate) < new Date(startDate)) {
                    alert('結束日期不可以早於開始日期');
                    return;
                }

                onSubmit({
                    id: initialData?.id, // Pass ID if editing
                    userId,
                    company,
                    reason: reason === '其他' ? customReason : reason,
                    startDate,
                    endDate,
                    description,
                    photo
                });
            };

            const handleFileChange = (e) => {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    setPhoto(file);
                    // Create local preview
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setPreviewPhotoUrl(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 p-4">
                    <div className="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <div className="p-6">
                            <h3 className="text-xl font-bold mb-4">{initialData ? '編輯請假申請' : '請假申請'}</h3>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                {users.length > 0 && (
                                    <div>
                                        <label className="block text-sm font-bold mb-1">請假人員</label>
                                        <select 
                                            value={userId}
                                            onChange={(e) => setUserId(e.target.value)}
                                            className="w-full p-2 border rounded-xl"
                                        >
                                            {users.map(u => (
                                                <option key={u.id} value={u.id}>{u.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                )}
                                <div>
                                    <label className="block text-sm font-bold mb-1">所屬公司</label>
                                    <input 
                                        type="text" 
                                        value={company}
                                        readOnly
                                        className="w-full p-2 border rounded-xl bg-gray-50 text-gray-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold mb-1">事由</label>
                                    <select 
                                        value={reason} 
                                        onChange={(e) => setReason(e.target.value)}
                                        className="w-full p-2 border rounded-xl"
                                    >
                                        <option value="病假">病假</option>
                                        <option value="事假">事假</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                                {reason === '其他' && (
                                    <div>
                                        <input 
                                            type="text" 
                                            placeholder="請輸入事由"
                                            value={customReason}
                                            onChange={(e) => setCustomReason(e.target.value)}
                                            className="w-full p-2 border rounded-xl"
                                            required
                                        />
                                    </div>
                                )}
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-1">開始日期</label>
                                        <input 
                                            type="datetime-local" 
                                            value={startDate}
                                            onChange={(e) => setStartDate(e.target.value)}
                                            className="w-full p-2 border rounded-xl"
                                            required
                                            step="600"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-1">結束日期</label>
                                        <input 
                                            type="datetime-local" 
                                            value={endDate}
                                            min={startDate}
                                            onChange={(e) => setEndDate(e.target.value)}
                                            className="w-full p-2 border rounded-xl"
                                            required
                                            step="600"
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold mb-1">說明</label>
                                    <textarea 
                                        value={description}
                                        onChange={(e) => setDescription(e.target.value)}
                                        className="w-full p-2 border rounded-xl"
                                        rows="3"
                                    ></textarea>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold mb-1">拍照上傳</label>
                                    <div className="flex flex-col gap-2">
                                        {previewPhotoUrl && (
                                            <div className="relative w-full h-40 bg-gray-100 rounded-xl overflow-hidden">
                                                <img src={previewPhotoUrl} className="w-full h-full object-cover" />
                                                <button 
                                                    type="button"
                                                    onClick={() => {
                                                        setPhoto(null);
                                                        setPreviewPhotoUrl(null);
                                                    }}
                                                    className="absolute top-2 right-2 w-8 h-8 bg-black/50 text-white rounded-full flex items-center justify-center hover:bg-black/70"
                                                >
                                                    <X className="w-4 h-4" />
                                                </button>
                                            </div>
                                        )}
                                        <input 
                                            type="file" 
                                            accept="image/*" 
                                            onChange={handleFileChange}
                                            className="w-full"
                                        />
                                    </div>
                                </div>
                                <div className="flex gap-2 pt-4">
                                    <button type="button" onClick={onClose} className="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-600">取消</button>
                                    <button type="submit" disabled={loading} className="flex-1 py-3 bg-orange-500 text-white rounded-xl font-bold disabled:opacity-50">
                                        {loading ? (initialData ? '更新中...' : '送出中...') : (initialData ? '更新申請' : '送出申請')}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        // Approval Modal
        const ApprovalModal = ({ isOpen, onClose, onApprove, onReject, onReset, leaveData }) => {
            if (!isOpen || !leaveData) return null;
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div className="bg-white rounded-3xl w-full max-w-sm overflow-hidden shadow-2xl animate-fade-in">
                        <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                            <h3 className="font-bold text-gray-800">請假審核</h3>
                            <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full transition-colors">
                                <X className="w-5 h-5 text-gray-400" />
                            </button>
                        </div>
                        <div className="p-6">
                            <div className="mb-4">
                                <div className="text-sm text-gray-500 mb-1">申請人</div>
                                <div className="font-bold text-gray-800 text-lg">{leaveData.userName}</div>
                            </div>
                            <div className="mb-4">
                                <div className="text-sm text-gray-500 mb-1">假別</div>
                                <div className="font-bold text-gray-800">{leaveData.leaveReason}</div>
                            </div>
                            <div className="mb-6">
                                <div className="text-sm text-gray-500 mb-1">時間</div>
                                <div className="font-bold text-gray-800 text-sm">
                                    {leaveData.leaveStartDate ? `${leaveData.leaveStartDate.replace('T', ' ').replace(/-/g, '/')} ~ ${leaveData.leaveEndDate ? leaveData.leaveEndDate.replace('T', ' ').replace(/-/g, '/') : ''}` : `${(leaveData.leaveDate || '').replace(/-/g, '/')} ${leaveData.leaveTime}`}
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                {leaveData.approvalStatus === 'rejected' ? (
                                    <button 
                                        onClick={onReset}
                                        className="w-full py-3 rounded-xl bg-yellow-50 text-yellow-600 font-bold hover:bg-yellow-100 transition-colors flex items-center justify-center gap-2"
                                    >
                                        <AlertCircle className="w-5 h-5" /> 待核准
                                    </button>
                                ) : (
                                    <button 
                                        onClick={onReject}
                                        className="w-full py-3 rounded-xl bg-red-50 text-red-600 font-bold hover:bg-red-100 transition-colors flex items-center justify-center gap-2"
                                    >
                                        <XCircle className="w-5 h-5" /> 拒絕
                                    </button>
                                )}
                                
                                {leaveData.approvalStatus === 'approved' ? (
                                    <button 
                                        onClick={onReset}
                                        className="w-full py-3 rounded-xl bg-yellow-50 text-yellow-600 font-bold hover:bg-yellow-100 transition-colors flex items-center justify-center gap-2"
                                    >
                                        <AlertCircle className="w-5 h-5" /> 待核准
                                    </button>
                                ) : (
                                    <button 
                                        onClick={onApprove}
                                        className="w-full py-3 rounded-xl bg-green-50 text-green-600 font-bold hover:bg-green-100 transition-colors flex items-center justify-center gap-2"
                                    >
                                        <CheckCircle className="w-5 h-5" /> 核准
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 3.5 Attendance Edit Modal
        const AttendanceEditModal = ({ isOpen, onClose, record, mode, onSubmit, loading, availableLocations = [] }) => {
            const [formData, setFormData] = useState({
                type: '',
                date: '',
                time: '',
                reason: '',
                locationName: '',
                shift: 'day'
            });

            useEffect(() => {
                if (record) {
                    const seconds = record.timestamp?.seconds || record.createdAt?.seconds || Date.now() / 1000;
                    const dateObj = new Date(seconds * 1000);
                    
                    // Format date as YYYY-MM-DD
                    const dateStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;
                    // Format time as HH:mm
                    const timeStr = `${String(dateObj.getHours()).padStart(2, '0')}:${String(dateObj.getMinutes()).padStart(2, '0')}`;

                    setFormData({
                        type: record.type,
                        date: dateStr,
                        time: timeStr,
                        reason: '',
                        locationName: record.checkInLocationName || record.address || '',
                        shift: record.isNightShift ? 'night' : 'day'
                    });
                }
            }, [record, isOpen]);

            if (!isOpen) return null;

            const typeOptions = [
                { value: 'in', label: '上班' },
                { value: 'out', label: '下班' },
                { value: 'outing_start', label: '外出' },
                { value: 'outing_arrive', label: '抵達' },
                { value: 'outing_end', label: '離開' },
                { value: 'late_in', label: '卡班上班' },
                { value: 'late_out', label: '卡班下班' }
            ];

            return (
                <div className="fixed inset-0 z-[100] bg-black/50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-xl animate-fade-in-up" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <Edit className="w-6 h-6 text-red-600" />
                            {mode === 'request' ? '申請修改打卡紀錄' : '編輯打卡紀錄'}
                        </h3>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">打卡位置</label>
                                <select
                                    value={formData.locationName}
                                    onChange={e => setFormData({...formData, locationName: e.target.value})}
                                    className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:outline-none"
                                >
                                    <option value="">{formData.locationName ? `目前：${formData.locationName}` : '請選擇位置'}</option>
                                    {availableLocations.length > 0 && (
                                        <>
                                            <optgroup label="公司">
                                                {availableLocations.filter(l => l.type === 'company').map(l => (
                                                    <option key={`company_${l.id}`} value={l.name}>{l.name}</option>
                                                ))}
                                            </optgroup>
                                            <optgroup label="社區">
                                                {availableLocations.filter(l => l.type === 'community').map(l => (
                                                    <option key={`community_${l.id}`} value={l.name}>{l.name}</option>
                                                ))}
                                            </optgroup>
                                        </>
                                    )}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">打卡狀態</label>
                                {mode === 'request' ? (
                                    <input 
                                        type="text" 
                                        value={typeOptions.find(opt => opt.value === formData.type)?.label || formData.type} 
                                        disabled 
                                        className="w-full p-3 bg-gray-100 border border-gray-200 rounded-xl text-gray-500 cursor-not-allowed focus:outline-none"
                                    />
                                ) : (
                                    <select 
                                        value={formData.type}
                                        onChange={e => setFormData({...formData, type: e.target.value})}
                                        className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:outline-none"
                                    >
                                        {typeOptions.map(opt => (
                                            <option key={opt.value} value={opt.value}>{opt.label}</option>
                                        ))}
                                    </select>
                                )}
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-1">日期</label>
                                    <input 
                                        type="date"
                                        value={formData.date}
                                        onChange={e => setFormData({...formData, date: e.target.value})}
                                        className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-1">時間</label>
                                    <input 
                                        type="time"
                                        value={formData.time}
                                        onChange={e => setFormData({...formData, time: e.target.value})}
                                        className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:outline-none"
                                    />
                                </div>
                            </div>

                            {mode === 'edit' && (
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-1">班別</label>
                                    <div className="inline-flex text-[11px] font-bold rounded-lg overflow-hidden border border-gray-200 bg-gray-50">
                                        <button
                                            type="button"
                                            onClick={() => setFormData({ ...formData, shift: 'day' })}
                                            className={`px-2 py-1 ${
                                                formData.shift !== 'night'
                                                    ? 'bg-blue-600 text-white'
                                                    : 'text-gray-600 bg-gray-50'
                                            }`}
                                        >
                                            日班
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => setFormData({ ...formData, shift: 'night' })}
                                            className={`px-2 py-1 ${
                                                formData.shift === 'night'
                                                    ? 'bg-indigo-600 text-white'
                                                    : 'text-gray-600 bg-gray-50'
                                            }`}
                                        >
                                            夜班
                                        </button>
                                    </div>
                                </div>
                            )}

                            {mode === 'request' && (
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-1">修改原因</label>
                                    <textarea 
                                        value={formData.reason}
                                        onChange={e => setFormData({...formData, reason: e.target.value})}
                                        placeholder="請輸入修改原因..."
                                        className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:outline-none h-24 resize-none"
                                    />
                                </div>
                            )}

                            <div className="flex gap-3 mt-6">
                                <button 
                                    onClick={onClose}
                                    className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition-colors"
                                >
                                    取消
                                </button>
                                <button 
                                    onClick={() => onSubmit(formData)}
                                    disabled={loading}
                                    className="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors disabled:opacity-50 flex items-center justify-center gap-2"
                                >
                                    {loading ? <RefreshCw className="w-5 h-5 animate-spin" /> : <CheckCircle className="w-5 h-5" />}
                                    {mode === 'request' ? '送出申請' : '確認修改'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 3.6 Modification Review Modal
        const ModificationReviewModal = ({ isOpen, onClose, record, onApprove, onReject }) => {
            if (!isOpen || !record || !record.modification) return null;

            const { modification } = record;
            
            const typeMap = {
                'in': '上班',
                'out': '下班',
                'outing_start': '外出',
                'outing_arrive': '抵達',
                'outing_end': '離開',
                'late_in': '卡班上班',
                'late_out': '卡班下班'
            };

            const originalDate = new Date((record.timestamp?.seconds || Date.now()/1000) * 1000);
            const originalType = typeMap[record.type] || record.type;
            const originalTimeStr = originalDate.toLocaleString('zh-TW', { hour12: false });

            return (
                <div className="fixed inset-0 z-[100] bg-black/50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-xl animate-fade-in-up" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <CheckSquare className="w-6 h-6 text-red-600" />
                            審核修改申請
                        </h3>

                        <div className="bg-gray-50 p-4 rounded-xl space-y-3 mb-6">
                            <div className="flex justify-between items-center pb-2 border-b border-gray-200">
                                <span className="text-gray-500 font-bold text-sm">申請人</span>
                                <span className="font-bold text-gray-800">{record.userName || '未知'}</span>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <div className="text-xs text-gray-400 mb-1">原始資料</div>
                                    <div className="font-bold text-gray-600 text-sm">{originalType}</div>
                                    <div className="text-xs text-gray-500">{originalTimeStr}</div>
                                </div>
                                <div>
                                    <div className="text-xs text-red-400 mb-1">修改為</div>
                                    <div className="font-bold text-red-600 text-sm">{typeMap[modification.type] || modification.type}</div>
                                    <div className="text-xs text-red-500">{modification.date} {modification.time}</div>
                                </div>
                            </div>

                            <div className="pt-2 border-t border-gray-200">
                                <span className="text-gray-500 font-bold text-sm block mb-1">修改原因</span>
                                <p className="text-gray-700 text-sm">{modification.reason || '無'}</p>
                            </div>
                        </div>

                        <div className="flex gap-3">
                            <button 
                                onClick={onReject}
                                className="flex-1 py-3 bg-red-50 text-red-600 rounded-xl font-bold hover:bg-red-100 transition-colors flex items-center justify-center gap-2"
                            >
                                <X className="w-5 h-5" /> 拒絕
                            </button>
                            <button 
                                onClick={onApprove}
                                className="flex-1 py-3 bg-green-50 text-green-600 rounded-xl font-bold hover:bg-green-100 transition-colors flex items-center justify-center gap-2"
                            >
                                <CheckCircle className="w-5 h-5" /> 核准
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 4. Staff Dashboard
        const StaffDashboard = ({ currentUser, onClockIn, onLeaveSubmit, onDeleteRecord, attendanceHistory, timeOffset, companies, communities, checkInLocation, setCheckInLocation, setMapPreviewTarget, setPreviewImageUrl, roles = [], hideHeaderInfo = false, mode = 'work', isNightShift = false, setIsNightShift, timeSynced = false, networkTime = null }) => {
            const [currentTime, setCurrentTime] = useState(new Date(Date.now() + (timeOffset || 0)));
            const [toast, setToast] = useState(''); // Add toast state to StaffDashboard
            const [showLeaveModal, setShowLeaveModal] = useState(false);
            const [leaveLoading, setLeaveLoading] = useState(false);
            const [showLocationSelector, setShowLocationSelector] = useState(false);
            const [viewDate, setViewDate] = useState(new Date());
            const [currentLocation, setCurrentLocation] = useState(null);
            const [hasLocationSorted, setHasLocationSorted] = useState(false);
            const [showDescriptionModal, setShowDescriptionModal] = useState(false);
            const [selectedDescription, setSelectedDescription] = useState('');
            const [editingLeave, setEditingLeave] = useState(null);
            const [showEditModal, setShowEditModal] = useState(false);
            const [editData, setEditData] = useState(null);
            const [editLoading, setEditLoading] = useState(false);

            // New State for Schedule & Holiday Logic
            const [mySchedules, setMySchedules] = useState({});
            const [myLeaves, setMyLeaves] = useState([]);
            const [showScheduleConfirmModal, setShowScheduleConfirmModal] = useState(false);
            const [scheduleConfirmData, setScheduleConfirmData] = useState(null);
            const [outingReasonOption, setOutingReasonOption] = useState('例行督察');
            const [outingCustomReason, setOutingCustomReason] = useState('');
            const [showOutingReasonSelector, setShowOutingReasonSelector] = useState(false);
            const [isManualLocation, setIsManualLocation] = useState(false);

            useEffect(() => {
                setIsManualLocation(false);
            }, [currentUser?.id]);

            // Hardcoded Holidays (Taiwan)
            const holidays = [
                '2025-01-01', '2025-01-25', '2025-01-26', '2025-01-27', '2025-01-28', '2025-01-29', '2025-01-30', '2025-01-31', '2025-02-01', '2025-02-02', '2025-02-28', '2025-04-03', '2025-04-04', '2025-04-05', '2025-04-06', '2025-05-01', '2025-05-30', '2025-05-31', '2025-06-01', '2025-10-04', '2025-10-05', '2025-10-06', '2025-10-10', '2025-10-11', '2025-10-12', '2025-12-25',
                '2026-01-01', '2026-02-14', '2026-02-15', '2026-02-16', '2026-02-17', '2026-02-18', '2026-02-19', '2026-02-20', '2026-02-21', '2026-02-22', '2026-02-27', '2026-02-28', '2026-03-01', '2026-04-03', '2026-04-04', '2026-04-05', '2026-04-06', '2026-05-01', '2026-06-19', '2026-06-20', '2026-06-21', '2026-09-25', '2026-09-26', '2026-09-27', '2026-10-09', '2026-10-10', '2026-10-11', '2026-12-25'
            ];

            // 5. Toast Auto-Close Logic (Added to StaffDashboard)
            useEffect(() => {
                if (!toast) return;
                const timer = setTimeout(() => {
                    setToast('');
                }, 3000);
                return () => clearTimeout(timer);
            }, [toast]);

            // Fetch My Schedules & Leaves
            useEffect(() => {
                if (!currentUser?.id) return;

                // Schedules
                const qSchedules = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'schedules'),
                    where('userId', '==', currentUser.id)
                );
                const unsubSchedules = onSnapshot(qSchedules, (snapshot) => {
                    const newSchedules = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        newSchedules[data.date] = data;
                    });
                    setMySchedules(newSchedules);
                });

                // Leaves (All Status)
                const qLeaves = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'leaves'),
                    where('userId', '==', currentUser.id)
                );
                const unsubLeaves = onSnapshot(qLeaves, (snapshot) => {
                    const leaves = [];
                    snapshot.forEach(doc => leaves.push({ id: doc.id, ...doc.data() }));
                    setMyLeaves(leaves);
                });

                return () => {
                    unsubSchedules();
                    unsubLeaves();
                };
            }, [currentUser?.id]);


            const handleRequestModification = async (formData) => {
                if (!editData) return;
                setEditLoading(true);
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', editData.id), {
                        modification: {
                            status: 'pending',
                            type: formData.type,
                            date: formData.date,
                            time: formData.time,
                            reason: formData.reason,
                            requestTime: new Date()
                        }
                    });
                    alert('修改申請已送出');
                    setShowEditModal(false);
                    setEditData(null);
                } catch (e) {
                    console.error(e);
                    alert('申請失敗: ' + e.message);
                } finally {
                    setEditLoading(false);
                }
            };

            // Robust isCompanyGroup check
            const isCompanyGroup = useMemo(() => {
                if (!currentUser) return false;
                // 1. Check hardcoded IDs
                if (['admin', 'hr', 'cadre', 'property'].includes(currentUser.role)) return true;
                // 2. Check Title
                if (currentUser.title && currentUser.title.includes('幹部')) return true;
                // 3. Check Role Name (using passed roles prop)
                const roleObj = (roles || []).find(r => r.id === currentUser.role);
                if (roleObj && (roleObj.name.includes('幹部') || roleObj.name.includes('人事') || roleObj.name.includes('系統管理員') || roleObj.name.includes('物業'))) return true;
                
                return false;
            }, [currentUser, roles]);

            useEffect(() => {
                if (!timeSynced || !networkTime) return;
                setCurrentTime(networkTime);
            }, [timeSynced, networkTime]);

            // Get Current Location for sorting
            useEffect(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            setCurrentLocation({
                                lat: pos.coords.latitude,
                                lng: pos.coords.longitude
                            });
                        },
                        (err) => { /* Suppress location sorting error */ },
                        { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 }
                    );
                }
            }, []);

            // Helper to compare dates
            const isSameDay = (d1, d2) => {
                return d1.getFullYear() === d2.getFullYear() &&
                       d1.getMonth() === d2.getMonth() &&
                       d1.getDate() === d2.getDate();
            };

            // Helper to calculate distance
            const calculateDistance = (lat1, lon1, lat2, lon2) => {
                const R = 6371e3; // metres
                const φ1 = lat1 * Math.PI / 180;
                const φ2 = lat2 * Math.PI / 180;
                const Δφ = (lat2 - lat1) * Math.PI / 180;
                const Δλ = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                        Math.cos(φ1) * Math.cos(φ1) *
                        Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            };

            const handlePrevDay = () => {
                const newDate = new Date(viewDate);
                newDate.setDate(viewDate.getDate() - 1);
                setViewDate(newDate);
            };

            const handleNextDay = () => {
                const newDate = new Date(viewDate);
                newDate.setDate(viewDate.getDate() + 1);
                if (newDate <= new Date()) {
                    setViewDate(newDate);
                }
            };

            const isToday = isSameDay(viewDate, new Date());
            const sourceHistory = mode === 'leave' ? myLeaves : attendanceHistory;
            
            const filteredHistory = sourceHistory.filter(record => {
                // Ensure timestamp exists and has seconds, otherwise use current time or skip
                const seconds = record.timestamp?.seconds || (record.createdAt?.seconds) || (Date.now() / 1000);
                const recordDate = new Date(seconds * 1000);
                if (mode === 'leave') {
                    return recordDate.getFullYear() === viewDate.getFullYear() && 
                           recordDate.getMonth() === viewDate.getMonth();
                }
                return isSameDay(recordDate, viewDate);
            }).sort((a, b) => {
                if (mode === 'leave') {
                    // Sort by timestamp desc (latest first)
                    const timeA = a.timestamp?.seconds || a.createdAt?.seconds || 0;
                    const timeB = b.timestamp?.seconds || b.createdAt?.seconds || 0;
                    return timeB - timeA;
                }
                return 0;
            });

            const lastRecord = useMemo(() => {
                const sorted = [...sourceHistory].sort((a, b) => {
                    const ta = a.timestamp?.seconds || a.createdAt?.seconds || 0;
                    const tb = b.timestamp?.seconds || b.createdAt?.seconds || 0;
                    return tb - ta;
                });
                return sorted[0];
            }, [sourceHistory]);

            useEffect(() => {
                if (typeof setIsNightShift !== 'function') return;
                if (mode !== 'work') return;
                if (!currentUser) return;

                const year = currentTime.getFullYear();
                const month = String(currentTime.getMonth() + 1).padStart(2, '0');
                const date = String(currentTime.getDate()).padStart(2, '0');
                const todayStr = `${year}-${month}-${date}`;
                const scheduleToday = mySchedules[todayStr];
                const scheduleNight = !!(scheduleToday && (scheduleToday.startTime === '12:00' || scheduleToday.crossDay === true));

                let defaultNight = scheduleNight;

                let windowStart = new Date(currentTime);
                let windowEnd = new Date(currentTime);
                if (scheduleNight) {
                    if (windowStart.getHours() >= 12) {
                        windowStart.setHours(12, 0, 0, 0);
                    } else {
                        windowStart.setDate(windowStart.getDate() - 1);
                        windowStart.setHours(12, 0, 0, 0);
                    }
                    windowEnd = new Date(windowStart);
                    windowEnd.setDate(windowEnd.getDate() + 1);
                    windowEnd.setHours(11, 59, 59, 999);
                } else {
                    windowStart.setHours(0, 0, 0, 0);
                    windowEnd.setHours(23, 59, 59, 999);
                }

                const recordsInWindow = sourceHistory
                    .filter(r => {
                        const seconds = r.timestamp?.seconds || r.createdAt?.seconds || 0;
                        const t = new Date(seconds * 1000);
                        return t >= windowStart && t <= windowEnd;
                    })
                    .sort((a, b) => {
                        const ta = a.timestamp?.seconds || a.createdAt?.seconds || 0;
                        const tb = b.timestamp?.seconds || b.createdAt?.seconds || 0;
                        return ta - tb;
                    });

                if (recordsInWindow.length > 0) {
                    let lastInNight = null;
                    for (let i = recordsInWindow.length - 1; i >= 0; i--) {
                        if (recordsInWindow[i].type === 'in') {
                            const r = recordsInWindow[i];
                            lastInNight = typeof r.isNightShift === 'boolean' ? r.isNightShift : defaultNight;
                            break;
                        }
                    }
                    if (lastInNight !== null) {
                        setIsNightShift(lastInNight);
                        return;
                    }
                }

                if (!isWorking) {
                    setIsNightShift(defaultNight);
                }
            }, [setIsNightShift, mode, currentUser, currentTime, mySchedules, sourceHistory, isWorking]);

            const getAvailableLocations = () => {
                 if (!currentUser) return [];

                 // Special handling for Outing/Card modes: Service Community + Custom
                 if (['outing', 'card'].includes(mode)) {
                    const available = [];
                    
                    // 1. Companies (所屬公司 - All Options for Admin, User Company for Staff)
                    const allComps = (companies || []).map(c => ({ 
                        ...c, 
                        type: 'company',
                        lat: c.lat,
                        lng: c.lng
                    }));
                    
                    if (isCompanyGroup) {
                        // Admin/Cadre: Use Work Mode sorting logic for Companies
                        const userCompany = allComps.find(c => c.id === currentUser.companyId);
                        let sortedComps = allComps;
                        
                        if (userCompany) {
                             const isTaipei = userCompany.name.includes('台北');
                             const isTaoyuan = userCompany.name.includes('桃園');
                             
                             if (isTaipei) {
                                sortedComps = allComps
                                    .filter(c => c.name.includes('台北') || c.name.includes('桃園'))
                                    .sort((a, b) => {
                                        if (a.name.includes('台北')) return -1;
                                        if (b.name.includes('台北')) return 1;
                                        return 0;
                                    });
                            } else if (isTaoyuan) {
                                sortedComps = allComps
                                    .filter(c => c.name.includes('台北') || c.name.includes('桃園'))
                                    .sort((a, b) => {
                                        if (a.name.includes('桃園')) return -1;
                                        if (b.name.includes('桃園')) return 1;
                                        return 0;
                                    });
                            } else {
                                 sortedComps = allComps.sort((a, b) => {
                                     if (a.id === userCompany.id) return -1;
                                     if (b.id === userCompany.id) return 1;
                                     return 0;
                                 });
                             }
                        }
                        available.push(...sortedComps);
                    } else {
                        // Staff: Only My Company
                        const userCompany = allComps.find(c => c.id === currentUser.companyId);
                        if (userCompany) available.push(userCompany);
                    }
                    
                    // 2. Service Communities (服務地點)
                    let targetCommunities = [];
                    if (isCompanyGroup) {
                        targetCommunities = communities || [];
                    } else {
                        const userCommIds = currentUser.communityIds || (currentUser.communityId ? [currentUser.communityId] : []);
                        targetCommunities = (communities || []).filter(c => userCommIds.includes(c.id));
                    }
                    
                    const communityLocs = targetCommunities.map(c => ({ 
                        ...c, 
                        type: 'community',
                        lat: c.coordLat, 
                        lng: c.coordLng 
                    }));
                    
                    // 3. Sorting and Mixing
                    if (isCompanyGroup) {
                        // Admin: Companies (already sorted by Logic) + Communities (sorted by Distance)
                         if (currentLocation) {
                            communityLocs.sort((a, b) => {
                                 const latA = parseFloat(a.lat || a.coordLat);
                                 const lngA = parseFloat(a.lng || a.coordLng);
                                 const latB = parseFloat(b.lat || b.coordLat);
                                 const lngB = parseFloat(b.lng || b.coordLng);
                                 if (!isNaN(latA) && !isNaN(lngA) && !isNaN(latB) && !isNaN(lngB)) {
                                     const distA = calculateDistance(currentLocation.lat, currentLocation.lng, latA, lngA);
                                     const distB = calculateDistance(currentLocation.lat, currentLocation.lng, latB, lngB);
                                     return distA - distB;
                                 }
                                 return 0;
                            });
                        }
                        available.push(...communityLocs);
                    } else {
                        // Staff: Mix Company + Communities, Sort ALL by Distance
                        available.push(...communityLocs);
                        
                        if (currentLocation) {
                            available.sort((a, b) => {
                                 const latA = parseFloat(a.lat || a.coordLat);
                                 const lngA = parseFloat(a.lng || a.coordLng);
                                 const latB = parseFloat(b.lat || b.coordLat);
                                 const lngB = parseFloat(b.lng || b.coordLng);
                                 if (!isNaN(latA) && !isNaN(lngA) && !isNaN(latB) && !isNaN(lngB)) {
                                     const distA = calculateDistance(currentLocation.lat, currentLocation.lng, latA, lngA);
                                     const distB = calculateDistance(currentLocation.lat, currentLocation.lng, latB, lngB);
                                     return distA - distB;
                                 }
                                 return 0;
                            });
                        }
                    }
                    
                    // 4. Custom (Always last)
                    available.push({ id: 'custom', name: '自定義地點', type: 'custom' });
                    
                    return available;
                 }
                 
                 if (isCompanyGroup) {
                     const allCompanies = (companies || []).map(c => ({ ...c, type: 'company' }));
                     const allCommunities = (communities || []).map(c => ({ 
                         ...c, 
                         type: 'community',
                         lat: c.coordLat,
                         lng: c.coordLng
                     }));

                     let resultLocations = [];
                     const userCompany = allCompanies.find(c => String(c.id) === String(currentUser.companyId));
                     
                     if (userCompany) {
                         const isTaipei = userCompany.name.includes('台北');
                         const isTaoyuan = userCompany.name.includes('桃園');
                         
                         if (isTaipei) {
                            resultLocations = allCompanies
                                .filter(c => c.name.includes('台北') || c.name.includes('桃園'))
                                .sort((a, b) => {
                                    // Prioritize user's own company
                                    if (String(a.id) === String(userCompany.id)) return -1;
                                    if (String(b.id) === String(userCompany.id)) return 1;

                                    if (a.name.includes('台北')) return -1;
                                    if (b.name.includes('台北')) return 1;
                                    return 0;
                                });
                        } else if (isTaoyuan) {
                            resultLocations = allCompanies
                                .filter(c => c.name.includes('台北') || c.name.includes('桃園'))
                                .sort((a, b) => {
                                    if (String(a.id) === String(userCompany.id)) return -1;
                                    if (String(b.id) === String(userCompany.id)) return 1;

                                    if (a.name.includes('桃園')) return -1;
                                    if (b.name.includes('桃園')) return 1;
                                    return 0;
                                });
                        } else {
                            resultLocations = allCompanies.sort((a, b) => {
                                if (String(a.id) === String(userCompany.id)) return -1;
                                if (String(b.id) === String(userCompany.id)) return 1;
                                return 0;
                            });
                        }
                     } else {
                         // Fallback: Sort Taipei first, then Taoyuan, then others
                         resultLocations = allCompanies.sort((a, b) => {
                             const isTaipeiA = a.name.includes('台北');
                             const isTaipeiB = b.name.includes('台北');
                             const isTaoyuanA = a.name.includes('桃園');
                             const isTaoyuanB = b.name.includes('桃園');
                             
                             if (isTaipeiA && !isTaipeiB) return -1;
                             if (!isTaipeiA && isTaipeiB) return 1;
                             
                             if (isTaoyuanA && !isTaoyuanB) return -1;
                             if (!isTaoyuanA && isTaoyuanB) return 1;
                             
                             return 0;
                         });
                     }

                     // Add all communities for selection
                     return [...resultLocations, ...allCommunities];
                 } else {
                     const userCommIds = currentUser.communityIds || (currentUser.communityId ? [currentUser.communityId] : []);
                     const userComms = (communities || []).filter(c => userCommIds.includes(c.id)).map(c => ({ 
                         ...c, 
                         type: 'community',
                         lat: c.coordLat, // Map coordLat to lat for CameraModal
                         lng: c.coordLng  // Map coordLng to lng for CameraModal
                     }));
                     
                     if (currentLocation && userComms.length > 1) {
                         return userComms.sort((a, b) => {
                             const latA = parseFloat(a.coordLat);
                             const lngA = parseFloat(a.coordLng);
                             const latB = parseFloat(b.coordLat);
                             const lngB = parseFloat(b.coordLng);
                             
                             if (isNaN(latA) || isNaN(lngA)) return 1;
                             if (isNaN(latB) || isNaN(lngB)) return -1;
                             
                             const distA = calculateDistance(currentLocation.lat, currentLocation.lng, latA, lngA);
                             const distB = calculateDistance(currentLocation.lat, currentLocation.lng, latB, lngB);
                             return distA - distB;
                         });
                     }
                     
                     // Fallback: Sort by ID
                     return userComms.sort((a, b) => a.id.localeCompare(b.id, undefined, {numeric: true}));
                 }
            };
            
            const availableLocations = getAvailableLocations();

            // Initialize CheckIn Location
            useEffect(() => {
                if (!currentUser) return;

                if (availableLocations?.length > 0) {
                    const isLocationValid = checkInLocation && availableLocations.some(l => l.id === checkInLocation.id);

                    if (!checkInLocation || !isLocationValid) {
                        let defaultLocation = availableLocations[0];
                        const savedCompanyId = (currentUser.companyId) || ((currentUser.companyIds && currentUser.companyIds.length > 0) ? currentUser.companyIds[0] : null);
                        const savedCommunityId = (currentUser.communityId) || ((currentUser.communityIds && currentUser.communityIds.length > 0) ? currentUser.communityIds[0] : null);

                        if (isCompanyGroup) {
                            if (savedCompanyId) {
                                const savedCompanyLoc = availableLocations.find(l => l.type === 'company' && String(l.id) === String(savedCompanyId));
                                if (savedCompanyLoc) {
                                    defaultLocation = savedCompanyLoc;
                                } else {
                                    const companyLoc = availableLocations.find(l => l.type === 'company');
                                    if (companyLoc) defaultLocation = companyLoc;
                                }
                            } else {
                                const companyLoc = availableLocations.find(l => l.type === 'company');
                                if (companyLoc) defaultLocation = companyLoc;
                            }
                        } else {
                            if (savedCommunityId) {
                                const savedCommunityLoc = availableLocations.find(l => l.type === 'community' && String(l.id) === String(savedCommunityId));
                                if (savedCommunityLoc) {
                                    defaultLocation = savedCommunityLoc;
                                } else {
                                    const communityLoc = availableLocations.find(l => l.type === 'community');
                                    if (communityLoc) defaultLocation = communityLoc;
                                }
                            } else {
                                const communityLoc = availableLocations.find(l => l.type === 'community');
                                if (communityLoc) defaultLocation = communityLoc;
                            }
                        }

                        setCheckInLocation(defaultLocation);
                        if (!isCompanyGroup && currentLocation) setHasLocationSorted(true);
                    } else {
                        // Restore default location logic, but only if user hasn't manually selected one
                        if (!isManualLocation) {
                            const savedCompanyId = (currentUser.companyId) || ((currentUser.companyIds && currentUser.companyIds.length > 0) ? currentUser.companyIds[0] : null);
                            const savedCommunityId = (currentUser.communityId) || ((currentUser.communityIds && currentUser.communityIds.length > 0) ? currentUser.communityIds[0] : null);
                            const desiredType = isCompanyGroup ? 'company' : 'community';
                            const desiredId = isCompanyGroup ? savedCompanyId : savedCommunityId;
                            let desiredLoc = null;
                            if (desiredId) {
                                desiredLoc = availableLocations.find(l => l.type === desiredType && String(l.id) === String(desiredId));
                            }
                            if (!desiredLoc) {
                                desiredLoc = availableLocations.find(l => l.type === desiredType) || availableLocations[0];
                            }
                            if (!checkInLocation || checkInLocation.id !== desiredLoc.id) {
                                setCheckInLocation(desiredLoc);
                            }
                        }

                        // Only auto-update for community users when GPS becomes available (to sort by distance)
                        if (!isCompanyGroup && currentLocation && !hasLocationSorted && !isManualLocation) {
                            setCheckInLocation(availableLocations[0]);
                            setHasLocationSorted(true);
                        }
                    }
                }
            }, [currentUser, companies, communities, checkInLocation, setCheckInLocation, currentLocation, hasLocationSorted, isCompanyGroup, mode, isManualLocation]);

            // Auto-Reset Logic: Determine if still "Working" within the shift window
            const isWorking = useMemo(() => {
                // 1. Determine current shift window (day: 00:00~23:59, night: 12:00~11:59 next day)
                const y = currentTime.getFullYear();
                const m = String(currentTime.getMonth() + 1).padStart(2, '0');
                const d = String(currentTime.getDate()).padStart(2, '0');
                const todayStr = `${y}-${m}-${d}`;
                const scheduleToday = mySchedules[todayStr];
                const isNightShift = !!(scheduleToday && (scheduleToday.startTime === '12:00' || scheduleToday.crossDay === true));
                
                let windowStart = new Date(currentTime);
                let windowEnd = new Date(currentTime);
                if (isNightShift) {
                    if (windowStart.getHours() >= 12) {
                        windowStart.setHours(12, 0, 0, 0);
                    } else {
                        windowStart.setDate(windowStart.getDate() - 1);
                        windowStart.setHours(12, 0, 0, 0);
                    }
                    windowEnd = new Date(windowStart);
                    windowEnd.setDate(windowEnd.getDate() + 1);
                    windowEnd.setHours(11, 59, 59, 999);
                } else {
                    windowStart.setHours(0, 0, 0, 0);
                    windowEnd.setHours(23, 59, 59, 999);
                }

                // 2. Get records within window, sorted by time asc
                const recordsInWindow = sourceHistory
                    .filter(r => {
                        const seconds = r.timestamp?.seconds || r.createdAt?.seconds || 0;
                        const t = new Date(seconds * 1000);
                        return t >= windowStart && t <= windowEnd;
                    })
                    .sort((a, b) => {
                        const ta = a.timestamp?.seconds || a.createdAt?.seconds || 0;
                        const tb = b.timestamp?.seconds || b.createdAt?.seconds || 0;
                        return ta - tb;
                    });

                // 3. If no 'in' in window -> not working
                const lastInIndex = (() => {
                    for (let i = recordsInWindow.length - 1; i >= 0; i--) {
                        if (recordsInWindow[i].type === 'in') return i;
                    }
                    return -1;
                })();
                if (lastInIndex === -1) return false;

                // 4. If has 'out' after last 'in' -> not working; otherwise working
                const hasOutAfterIn = recordsInWindow.slice(lastInIndex + 1).some(r => r.type === 'out');
                return !hasOutAfterIn;
            }, [sourceHistory, mySchedules, currentTime]);

            const isOutingActive = useMemo(() => {
                if (!lastRecord || !['outing_start','outing_arrive'].includes(lastRecord.type)) return false;
                const seconds = lastRecord.timestamp?.seconds || (lastRecord.createdAt?.seconds) || (Date.now() / 1000);
                const recordTime = new Date(seconds * 1000);
                const y = recordTime.getFullYear();
                const m = String(recordTime.getMonth() + 1).padStart(2, '0');
                const d = String(recordTime.getDate()).padStart(2, '0');
                const recordDateStr = `${y}-${m}-${d}`;
                const schedule = mySchedules[recordDateStr];
                const isNightShiftRecord = schedule && (schedule.startTime === '12:00' || schedule.crossDay === true);
                const resetTime = new Date(recordTime);
                resetTime.setHours(0, 0, 0, 0);
                if (isNightShiftRecord) {
                    resetTime.setDate(resetTime.getDate() + 1);
                    resetTime.setHours(12, 0, 0, 0);
                } else {
                    resetTime.setDate(resetTime.getDate() + 1);
                    resetTime.setHours(0, 0, 0, 0);
                }
                return currentTime < resetTime;
            }, [lastRecord, mySchedules, currentTime]);

            const getButtonConfig = () => {
                if (!timeSynced || !networkTime) {
                    return { type: 'in', text: 'UTC+8同步中', sub: '請稍候', icon: MapPin, colorClass: 'bg-gray-200 text-gray-500 border-2 border-gray-100 cursor-not-allowed', iconBg: 'bg-gray-100', iconColor: 'text-gray-500', disabled: true };
                }
                if (mode === 'card') {
                    const lastType = lastRecord?.type;
                    const isCardWorking = lastType === 'late_in';
                    
                    return isCardWorking
                        ? { type: 'late_out', text: '卡班下班', sub: '結束卡班勤務', icon: LogOut, colorClass: 'bg-gray-800 text-white border-2 border-gray-700', iconBg: 'bg-gray-700', iconColor: 'text-white' }
                        : { type: 'late_in', text: '卡班上班', sub: '紀錄卡班開始', icon: MapPin, colorClass: 'bg-white text-green-600 border-2 border-green-100', iconBg: 'bg-green-50', iconColor: 'text-green-600' };
                }

                if (mode === 'outing') {
                    const lastType = lastRecord?.type;
                    if (!isOutingActive) {
                        return { type: 'outing_start', text: '外出打卡', sub: '紀錄外出開始', icon: LogOut, colorClass: 'bg-white text-blue-600 border-2 border-blue-100', iconBg: 'bg-blue-50', iconColor: 'text-blue-600' };
                    }
                    if (lastType === 'outing_start') {
                        return { type: 'outing_arrive', text: '抵達打卡', sub: '紀錄抵達時間', icon: MapPin, colorClass: 'bg-white text-blue-600 border-2 border-blue-100', iconBg: 'bg-blue-50', iconColor: 'text-blue-600' };
                    } else if (lastType === 'outing_arrive') {
                        return { type: 'outing_end', text: '離開打卡', sub: '紀錄離開時間', icon: LogOut, colorClass: 'bg-white text-blue-600 border-2 border-blue-100', iconBg: 'bg-blue-50', iconColor: 'text-blue-600' };
                    } else {
                        return { type: 'outing_start', text: '外出打卡', sub: '紀錄外出開始', icon: LogOut, colorClass: 'bg-white text-blue-600 border-2 border-blue-100', iconBg: 'bg-blue-50', iconColor: 'text-blue-600' };
                    }
                }

                if (mode === 'leave') {
                    return { type: 'leave', text: '請假', sub: '申請休假', icon: FileText, colorClass: 'bg-white text-orange-600 border-2 border-orange-100', iconBg: 'bg-orange-50', iconColor: 'text-orange-600' };
                }
                
                // Default work mode
                if (!isWorking) { // Preparing for Clock In
                     const y = currentTime.getFullYear();
                     const m = String(currentTime.getMonth() + 1).padStart(2, '0');
                     const d = String(currentTime.getDate()).padStart(2, '0');
                     const todayStr = `${y}-${m}-${d}`;
                     
                     // Check Schedule & Holiday Logic
                     const schedule = mySchedules[todayStr];
                     const dayOfWeek = currentTime.getDay();
                     const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                     const isNationalHoliday = holidays.includes(todayStr);
                     const isCalendarHoliday = isWeekend || isNationalHoliday;

                     // 1. If Schedule Exists
                     if (schedule) {
                         // 'work' or 'duty' -> Allow Clock In (Button Active)
                         if (schedule.type === 'work' || schedule.type === 'duty') {
                             return { type: 'in', text: '上班打卡', sub: '紀錄開始時間', icon: MapPin, colorClass: 'bg-white text-green-600 border-2 border-green-100', iconBg: 'bg-green-50', iconColor: 'text-green-600' };
                         }
                         // 'off' -> Allow Clock In but will trigger Confirmation (Button Active)
                         // User requirement: "如果當日是'特休' 則於打卡時顯示...確認..." (Implies button is clickable)
                         if (schedule.type === 'off') {
                             return { type: 'in', text: '上班打卡', sub: '紀錄開始時間', icon: MapPin, colorClass: 'bg-white text-green-600 border-2 border-green-100', iconBg: 'bg-green-50', iconColor: 'text-green-600' };
                         }
                     } 
                     
                     // 2. If No Schedule -> Check Calendar
                     if (!schedule) {
                         if (isCalendarHoliday) {
                             return { type: 'in', text: '非上班日', sub: '', icon: MapPin, colorClass: 'bg-gray-200 text-gray-500 border-2 border-gray-100 cursor-not-allowed', iconBg: 'bg-gray-100', iconColor: 'text-gray-500', disabled: true };
                         }
                     }
                }

                return isWorking 
                    ? { type: 'out', text: '下班打卡', sub: '結束今日勤務', icon: LogOut, colorClass: 'bg-white text-red-600 border-2 border-red-100', iconBg: 'bg-red-50', iconColor: 'text-red-600' }
                    : { type: 'in', text: '上班打卡', sub: '紀錄開始時間', icon: MapPin, colorClass: 'bg-white text-green-600 border-2 border-green-100', iconBg: 'bg-green-50', iconColor: 'text-green-600' };
            };

            const handleCheckInClick = (config) => {
                 if (!timeSynced || !networkTime) {
                     alert('目前無法取得網路UTC+8台北時間，暫時無法打卡');
                     return;
                 }
                 if (config.disabled) return;
                 
                 // Intercept only 'in' (Clock In)
                 if (config.type === 'in') {
                     const y = currentTime.getFullYear();
                     const m = String(currentTime.getMonth() + 1).padStart(2, '0');
                     const d = String(currentTime.getDate()).padStart(2, '0');
                     const todayStr = `${y}-${m}-${d}`;
                     
                     // 1. Check if 'Leave' (Approved Leave Request)
                     const todayStart = new Date(`${todayStr}T00:00:00`);
                     const todayEnd = new Date(`${todayStr}T23:59:59`);
                     
                     const isLeaveToday = myLeaves.some(l => {
                         const start = new Date(l.startDate);
                         const end = new Date(l.endDate);
                         return start <= todayEnd && end >= todayStart;
                     });

                     if (isLeaveToday) {
                         setScheduleConfirmData({
                             message: '您今日請假，您是否"確認"上班打卡?',
                             type: 'leave'
                         });
                         setShowScheduleConfirmModal(true);
                         return;
                     }

                     // 2. Check Schedule
                     const schedule = mySchedules[todayStr];
                     if (schedule) {
                         if (schedule.type === 'off') {
                            setScheduleConfirmData({
                                message: '您今日特休，您是否"確認"上班打卡?',
                                type: 'off'
                            });
                             setShowScheduleConfirmModal(true);
                             return;
                         }

                         if (schedule.type === 'work' || schedule.type === 'duty') {
                             const startTimeStr = schedule.startTime || '09:00';
                             const endTimeStr = schedule.endTime || '18:00';
                             
                             const [sh, sm] = startTimeStr.split(':').map(Number);
                             const scheduleStart = new Date(currentTime);
                             scheduleStart.setHours(sh, sm, 0, 0);

                             const isEarly = currentTime < scheduleStart;
                             const msgPrefix = `今日班表上班時間 ${startTimeStr} 及下班時間 ${endTimeStr}`;
                             
                             if (isEarly) {
                                 setScheduleConfirmData({
                                     message: `${msgPrefix}\n您上班時間尚未開始，是否"確認"打卡?`,
                                     type: 'early'
                                 });
                             } else {
                                 setScheduleConfirmData({
                                     message: `${msgPrefix}\n您已超過上班時間，請盡快"確認"打卡`,
                                     type: 'late'
                                 });
                             }
                             setShowScheduleConfirmModal(true);
                             return;
                         }
                     }
                 }

                 // Default behavior
                 if (config.type === 'leave') {
                     setShowLeaveModal(true);
                } else {
                    onClockIn(
                        config.type, 
                        availableLocations,
                        (config.type || '').startsWith('outing') 
                            ? { outingReason: (outingReasonOption === '其他' ? (outingCustomReason || '其他') : outingReasonOption) } 
                            : undefined
                    );
                }
            };


            const btnConfig = getButtonConfig();
            const BtnIcon = btnConfig.icon;

            const getTypeLabel = (type) => {
                const map = {
                    'in': { text: '上班', color: 'bg-green-100 text-green-700' },
                    'out': { text: '下班', color: 'bg-red-100 text-red-700' },
                    'outing_start': { text: '外出', color: 'bg-blue-100 text-blue-700' },
                    'outing_arrive': { text: '抵達', color: 'bg-blue-100 text-blue-700' },
                    'outing_end': { text: '離開', color: 'bg-blue-100 text-blue-700' },
                    'leave': { text: '請假', color: 'bg-orange-100 text-orange-700' },
                    'late_in': { text: '卡上', color: 'bg-green-100 text-green-700' },
                    'late_out': { text: '卡下', color: 'bg-red-100 text-red-700' }
                };
                return map[type] || { text: type, color: 'bg-gray-100 text-gray-700' };
            };

            // Calculate Header Background
            let headerBgClass = 'bg-gradient-to-br from-gray-600 to-gray-700 shadow-gray-200';
            
            // Check Schedule / Approved Leave for Background
            const hY = currentTime.getFullYear();
            const hM = String(currentTime.getMonth() + 1).padStart(2, '0');
            const hD = String(currentTime.getDate()).padStart(2, '0');
            const hTodayStr = `${hY}-${hM}-${hD}`;
            const hSchedule = mySchedules[hTodayStr];
            const hApprovedLeave = myLeaves.find(l => {
                 if (l.approvalStatus !== 'approved') return false;
                 return hTodayStr >= l.leaveStartDate && hTodayStr <= l.leaveEndDate;
            });

            if (hSchedule?.type === 'off') {
                 headerBgClass = 'bg-gradient-to-br from-stone-500 to-stone-600 shadow-stone-200';
            } else if (hSchedule?.type === 'leave' || hApprovedLeave) {
                 headerBgClass = 'bg-gradient-to-br from-orange-500 to-orange-600 shadow-orange-200';
            } else {
                // Get Today's Records for Background Logic
                const todayRecordsForBg = sourceHistory.filter(r => {
                    const seconds = r.timestamp?.seconds || r.createdAt?.seconds || Date.now() / 1000;
                    const rDate = new Date(seconds * 1000);
                    // Use currentTime from state for consistent date comparison
                    return rDate.getFullYear() === currentTime.getFullYear() && 
                           rDate.getMonth() === currentTime.getMonth() && 
                           rDate.getDate() === currentTime.getDate();
                }).sort((a, b) => {
                     const ta = a.timestamp?.seconds || a.createdAt?.seconds || 0;
                     const tb = b.timestamp?.seconds || b.createdAt?.seconds || 0;
                     return ta - tb;
                });
                const lastRecordForBg = todayRecordsForBg[todayRecordsForBg.length - 1];
    
                if (lastRecordForBg?.type) {
                    const t = lastRecordForBg.type;
                    if (['in', 'late_in'].includes(t)) {
                        headerBgClass = 'bg-gradient-to-br from-green-600 to-green-700 shadow-green-200';
                    } else if (['out', 'late_out'].includes(t)) {
                        headerBgClass = 'bg-gradient-to-br from-red-600 to-red-700 shadow-red-200';
                    } else if (['outing_start', 'outing_arrive', 'outing_end'].includes(t)) {
                        headerBgClass = 'bg-gradient-to-br from-blue-600 to-blue-700 shadow-blue-200';
                    } else if (t === 'leave') {
                        headerBgClass = 'bg-gradient-to-br from-orange-500 to-orange-600 shadow-orange-200';
                    }
                }
            }

            return (
                <div className="max-w-md mx-auto space-y-4 pb-20">
                    {/* Header Info Card */}
                    {!hideHeaderInfo && (
                    <div className={`${headerBgClass} rounded-2xl shadow-xl overflow-hidden relative`}>
                        <div className="absolute top-0 right-0 p-4 opacity-10">
                            <Clock className="w-32 h-32 transform rotate-12 text-white" />
                        </div>
                        <div className="p-6 relative z-10 text-white">
                            <div className="flex justify-between items-start mb-6">
                                <div>
                                    <h2 className="text-2xl font-bold">
                                        {(function() {
                                            if (!currentUser) return '';
                                            // 1. Try to find role name from roles list
                                            const roleObj = (roles || []).find(r => r?.id === currentUser?.role);
                                            if (roleObj) return roleObj.name;
                                            
                                            // 2. Fallback to hardcoded mapping
                                            const roleMap = {
                                                'admin': '系統管理員',
                                                'manager': '總幹事', // or 管理層
                                                'hr': '人事',
                                                'cadre': '幹部',
                                                'staff': '員工',
                                                'secretary': '秘書',
                                                'cleaner': '清潔',
                                                'mechanic': '機電',
                                                'guard': '保全'
                                            };
                                            return roleMap[currentUser.role] || currentUser.role;
                                        })()} {currentUser?.name}
                                    </h2>
                                    <p className="text-white/80 text-sm flex items-center gap-1 mt-1">
                                        {(function() {
                                            // Show Last Record Location + Time (Only for Today)
                                            if (lastRecord) {
                                                const recordDate = new Date((lastRecord.timestamp?.seconds || Date.now()/1000) * 1000);
                                                const now = new Date();
                                                
                                                if (recordDate.toDateString() === now.toDateString()) {
                                                    const timeStr = recordDate.toLocaleString('zh-TW', { 
                                                        year: 'numeric', 
                                                        month: '2-digit', 
                                                        day: '2-digit', 
                                                        hour: '2-digit', 
                                                        minute: '2-digit', 
                                                        second: '2-digit',
                                                        hour12: false 
                                                    });
                                                    return (
                                                        <>
                                                            <Building2 className="w-4 h-4" />
                                                            {`${lastRecord.checkInLocationName || lastRecord.address || '未記錄位置'} ${timeStr}`}
                                                        </>
                                                    );
                                                }
                                            }
                                            return null;
                                        })()}
                                    </p>
                                </div>
                                {(function(){
                                    // 1. Get Today's Schedule
                                    const y = currentTime.getFullYear();
                                    const m = String(currentTime.getMonth() + 1).padStart(2, '0');
                                    const d = String(currentTime.getDate()).padStart(2, '0');
                                    const todayStr = `${y}-${m}-${d}`;
                                    const schedule = mySchedules[todayStr];

                                    // 2. Get Today's Records
                                    // Filter strictly for today based on currentTime
                                    const todayRecords = sourceHistory.filter(r => {
                                        const seconds = r.timestamp?.seconds || r.createdAt?.seconds || Date.now() / 1000;
                                        const rDate = new Date(seconds * 1000);
                                        return rDate.getFullYear() === y && 
                                               rDate.getMonth() === currentTime.getMonth() && 
                                               rDate.getDate() === currentTime.getDate();
                                    }).sort((a, b) => {
                                         const ta = a.timestamp?.seconds || a.createdAt?.seconds || 0;
                                         const tb = b.timestamp?.seconds || b.createdAt?.seconds || 0;
                                         return ta - tb;
                                    });
                                    
                                    const lastRec = todayRecords[todayRecords.length - 1];

                                    // 3. Determine Status Text & Color
                                    let statusText = '未打卡';
                                    let statusClass = 'bg-gray-500 text-white';

                                    // Check for approved leave in myLeaves (Fallback if no schedule found)
                                    const approvedLeave = myLeaves.find(l => {
                                        if (l.approvalStatus !== 'approved') return false;
                                        return todayStr >= l.leaveStartDate && todayStr <= l.leaveEndDate;
                                    });

                                    // Priority: Schedule (Off/Leave) -> Approved Leave -> Records -> Default
                                    if (schedule?.type === 'off') {
                                        statusText = '特休';
                                        statusClass = 'bg-stone-500 text-white';
                                    } else if (schedule?.type === 'leave' || approvedLeave) {
                                        statusText = '請假';
                                        statusClass = 'bg-orange-500 text-white';
                                    } else {
                                        // Work or Duty or No Schedule
                                        if (lastRec) {
                                            const type = lastRec.type;
                                            
                                            // Determine Text and Color based on type
                                            if (type === 'in') {
                                                statusText = '上班';
                                                statusClass = 'bg-green-600 text-white';
                                            } else if (type === 'out') {
                                                statusText = '下班';
                                                statusClass = 'bg-red-600 text-white';
                                            } else if (type === 'outing_start') {
                                                statusText = '外出';
                                                statusClass = 'bg-blue-600 text-white';
                                            } else if (type === 'outing_arrive') {
                                                statusText = '抵達';
                                                statusClass = 'bg-blue-600 text-white';
                                            } else if (type === 'outing_end') {
                                                statusText = '離開';
                                                statusClass = 'bg-blue-600 text-white';
                                            } else if (type === 'late_in') {
                                                statusText = '卡上';
                                                statusClass = 'bg-green-600 text-white';
                                            } else if (type === 'late_out') {
                                                statusText = '卡下';
                                                statusClass = 'bg-red-600 text-white';
                                            } else if (type === 'leave') {
                                                statusText = '請假';
                                                statusClass = 'bg-orange-500 text-white';
                                            } else {
                                                // Fallback for unknown types
                                                statusText = getTypeLabel(type).text;
                                                statusClass = 'bg-gray-600 text-white';
                                            }
                                        } else {
                                            statusText = '未打卡';
                                            statusClass = 'bg-gray-500 text-white';
                                        }
                                    }

                                    return (
                                        <div className={`backdrop-blur-sm px-3 py-1 rounded-full text-2xl font-mono ${statusClass} bg-opacity-90 border-2 border-white/20 shadow-sm`}>
                                            {statusText}
                                        </div>
                                    );
                                })()}
                            </div>
                            <div className="text-center py-4">
                                <div className="text-5xl font-bold font-mono tracking-wider drop-shadow-sm">
                                    {networkTime
                                        ? networkTime.toLocaleTimeString('zh-TW', { timeZone: 'Asia/Taipei', hour12: false, hour: '2-digit', minute:'2-digit', second: '2-digit' })
                                        : ''}
                                </div>
                                <p className="text-white text-2xl mt-2 opacity-80">
                                    {networkTime
                                        ? networkTime.toLocaleDateString('zh-TW', { timeZone: 'Asia/Taipei', year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })
                                        : ''}
                                </p>
                            </div>
                        </div>
                    </div>
                    )}
                    
                    {mode === 'outing' && (
                        <div className="px-2 mb-4">
                            <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex flex-col gap-2">
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center gap-2 text-gray-700">
                                        <ClipboardList className="w-5 h-5 text-red-600" />
                                        <span className="text-xs font-bold text-gray-500">外出事由</span>
                                        <span className="font-bold text-sm">
                                            {outingReasonOption === '其他' ? (outingCustomReason || '其他') : outingReasonOption}
                                        </span>
                                    </div>
                                    <button 
                                        onClick={() => setShowOutingReasonSelector(v => !v)}
                                        className="text-xs bg-gray-100 px-3 py-1.5 rounded-lg text-gray-600 font-bold hover:bg-gray-200"
                                    >
                                        更換
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    {/* Location Display & Selector */}
                    {['work', 'outing', 'card'].includes(mode) && (
                        <div className="px-2 mb-4">
                            <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex flex-col gap-2">
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center gap-2 text-gray-700">
                                        <MapPin className="w-5 h-5 text-red-600" />
                                        <span className="font-bold text-sm">
                                            {checkInLocation?.id === 'custom' ? '自定義地點' : (checkInLocation?.name || '定位中...')}
                                        </span>
                                        {availableLocations.length > 1 && (
                                            <button 
                                                onClick={() => setShowLocationSelector(true)}
                                                className="text-xs bg-gray-100 px-3 py-1.5 rounded-lg text-gray-600 font-bold hover:bg-gray-200"
                                            >
                                                更換
                                            </button>
                                        )}
                                    </div>
                                    <div className="flex items-center gap-2">
                                        {typeof setIsNightShift === 'function' && (
                                            <div className="flex text-[11px] font-bold rounded-lg overflow-hidden border border-gray-200 bg-gray-50">
                                                <button
                                                    type="button"
                                                    onClick={() => setIsNightShift(false)}
                                                    className={`px-2 py-1 ${
                                                        !isNightShift
                                                            ? 'bg-blue-600 text-white'
                                                            : 'text-gray-600 bg-gray-50'
                                                    }`}
                                                >
                                                    日班
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => setIsNightShift(true)}
                                                    className={`px-2 py-1 ${
                                                        isNightShift
                                                            ? 'bg-indigo-600 text-white'
                                                            : 'text-gray-600 bg-gray-50'
                                                    }`}
                                                >
                                                    夜班
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                {checkInLocation?.id === 'custom' && (
                                    <input 
                                        type="text" 
                                        className="w-full mt-2 bg-gray-50 border-0 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-red-500"
                                        placeholder="請輸入地點名稱"
                                        value={checkInLocation.name === '自定義地點' ? '' : checkInLocation.name}
                                        onChange={(e) => setCheckInLocation(prev => ({ ...prev, name: e.target.value }))}
                                    />
                                )}
                            </div>
                        </div>
                    )}

                    {/* Big Action Button */}
                    <div className="px-2">
                        <button
                            onClick={() => handleCheckInClick(btnConfig)}
                            disabled={btnConfig.disabled}
                            className={`w-full h-32 rounded-2xl flex flex-row items-center justify-center gap-4 shadow-lg transition-all transform ${btnConfig.disabled ? 'opacity-50 cursor-not-allowed' : 'active:scale-95'} ${btnConfig.colorClass}`}
                        >
                            <div className={`${btnConfig.iconBg} p-3 rounded-full`}>
                                <BtnIcon className={`w-8 h-8 ${btnConfig.iconColor}`} />
                            </div>
                            <div className="text-left">
                                <span className="block text-2xl font-bold">{btnConfig.text}</span>
                                <span className="text-xs opacity-60">{btnConfig.sub}</span>
                            </div>
                        </button>
                    </div>

                    {/* History List */}
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                        <h3 className="font-bold text-gray-800 mb-4 text-sm flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <button onClick={handlePrevDay} className="p-1 rounded-full hover:bg-gray-100 text-gray-500">
                                    <ChevronLeft className="w-5 h-5" />
                                </button>
                                <span>{mode === 'leave' ? '本月請假紀錄' : (isToday ? '今日打卡紀錄' : `${viewDate.getFullYear()}/${viewDate.getMonth() + 1}/${viewDate.getDate()} 打卡紀錄`)}</span>
                                <button 
                                    onClick={handleNextDay} 
                                    disabled={isToday}
                                    className={`p-1 rounded-full hover:bg-gray-100 text-gray-500 ${isToday ? 'opacity-30 cursor-not-allowed' : ''}`}
                                >
                                    <ChevronRight className="w-5 h-5" />
                                </button>
                            </div>
                            <span className="text-sm text-gray-400 font-normal">共 {filteredHistory.length} 筆</span>
                        </h3>
                        <div className="space-y-4">
                            {filteredHistory.length === 0 ? (
                                <div className="text-center py-8">
                                    <div className="bg-gray-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2">
                                        <Calendar className="w-5 h-5 text-gray-300" />
                                    </div>
                                    <p className="text-gray-400 text-xs">尚無打卡紀錄</p>
                                </div>
                            ) : (
                                filteredHistory.map((r, idx) => {
                                    const seconds = r.timestamp?.seconds || r.createdAt?.seconds || Date.now() / 1000;
                                    const dateObj = new Date(seconds * 1000);
                                    const timeStr = dateObj.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                                    const typeConfig = getTypeLabel(r.type);
                                    const isLeave = r.type === 'leave';
                                    
                                    const dateStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;
                                    const schedule = mySchedules[dateStr];
                                    const isNightShiftDisplay = !!(r.isNightShift || (schedule && (schedule.startTime === '12:00' || schedule.crossDay === true)));
                                    
                                    return (
                                        <div key={r.id} className={`p-3 bg-white border rounded-2xl shadow-sm flex items-start gap-3 ${
                                            r.approvalStatus === 'approved' || r.modification?.status === 'approved' ? 'border-green-500' : 
                                            r.approvalStatus === 'rejected' || r.modification?.status === 'rejected' ? 'border-red-500' : 
                                            r.modification?.status === 'pending' ? 'border-orange-500' :
                                            'border-gray-100'
                                        }`}>
                                            <div className="w-10 h-10 rounded-full bg-gray-200 flex-shrink-0 overflow-hidden border border-gray-100">
                                                {currentUser.avatarUrl ? (
                                                    <img src={currentUser.avatarUrl} className="w-full h-full object-cover" />
                                                ) : (
                                                    <div className="w-full h-full flex items-center justify-center font-bold text-gray-500">
                                                        {currentUser.name?.[0]}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex justify-between items-center">
                                                    <div>
                                                        <div className="font-bold text-gray-800 flex items-center gap-2">
                                                            {currentUser.name}
                                                            <span className={`text-[10px] px-1.5 py-0.5 rounded-lg ${typeConfig.color}`}>
                                                                {typeConfig.text}
                                                                {['outing_start', 'outing_arrive', 'outing_end'].includes(r.type) && (r.checkInLocationName || r.address) ? ` ${r.checkInLocationName || r.address}` : ''}
                                                            </span>
                                                            {isNightShiftDisplay && (
                                                                <span className="text-[10px] px-1.5 py-0.5 rounded-lg bg-indigo-100 text-indigo-700">
                                                                    夜班
                                                                </span>
                                                            )}
                                                            {isLeave && (
                                                                <span className={`text-[10px] px-1.5 py-0.5 rounded-lg ml-1 ${
                                                                    r.approvalStatus === 'approved' ? 'bg-green-100 text-green-700' : 
                                                                    r.approvalStatus === 'rejected' ? 'bg-red-100 text-red-700' : 
                                                                    'bg-yellow-100 text-yellow-700'
                                                                }`}>
                                                                    {r.approvalStatus === 'approved' ? '核准' : (r.approvalStatus === 'rejected' ? '拒絕' : '待核准')}
                                                                </span>
                                                            )}
                                                            {!isLeave && r.modification?.status === 'pending' && (
                                                                <span className="text-[10px] px-1.5 py-0.5 rounded-lg ml-1 bg-yellow-100 text-yellow-700">
                                                                    待核准
                                                                </span>
                                                            )}
                                                            {!isLeave && r.modification?.status === 'approved' && (
                                                                <span className="text-[10px] px-1.5 py-0.5 rounded-lg ml-1 bg-green-100 text-green-700">
                                                                    核准
                                                                </span>
                                                            )}
                                                            {!isLeave && r.modification?.status === 'rejected' && (
                                                                <span className="text-[10px] px-1.5 py-0.5 rounded-lg ml-1 bg-red-100 text-red-700">
                                                                    拒絕
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div className="text-sm text-gray-500 mt-0.5">
                                                            {!isLeave && r.modification ? (
                                                                <>
                                                                    <div className="flex items-center gap-1 mb-1 font-bold text-blue-600">
                                                                        <Clock className="w-3 h-3" /> 修改時間: {r.modification.time}
                                                                    </div>
                                                                    <div className="flex items-center gap-1 mb-1">
                                                                        <Clock className="w-3 h-3" /> 原始時間: {(function(){
                                                                            if (r.modification.status === 'approved' && r.modification.originalTimestamp) {
                                                                                const ot = r.modification.originalTimestamp;
                                                                                const s = ot.seconds || (ot instanceof Date ? ot.getTime()/1000 : 0);
                                                                                if (s) return new Date(s * 1000).toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                                                                            }
                                                                            return timeStr;
                                                                        })()}
                                                                    </div>
                                                                </>
                                                            ) : (
                                                                <div className="flex items-center gap-1 mb-1">
                                                                    <Clock className="w-3 h-3" /> 
                                                                    {isLeave 
                                                                        ? `請假日期 : ${r.leaveStartDate ? `${r.leaveStartDate.replace('T', ' ').replace(/-/g, '/')} ~ ${r.leaveEndDate ? r.leaveEndDate.replace('T', ' ').replace(/-/g, '/') : ''}` : `${(r.leaveDate || '').replace(/-/g, '/')} ${r.leaveTime}`}` 
                                                                        : timeStr
                                                                    }
                                                                </div>
                                                            )}
                                                            {isLeave && (
                                                                <div className="pl-5 text-xs text-gray-500 space-y-1 mt-1">
                                                                    {(function() {
                                                                        let dates = [];
                                                                        if (r.leaveStartDate && r.leaveEndDate) {
                                                                            const s = new Date(r.leaveStartDate.split('T')[0]);
                                                                            const e = new Date(r.leaveEndDate.split('T')[0]);
                                                                            for(let d = new Date(s); d <= e; d.setDate(d.getDate()+1)) {
                                                                                dates.push(new Date(d));
                                                                            }
                                                                        } else if (r.leaveDate) {
                                                                            dates.push(new Date(r.leaveDate));
                                                                        }
                                                                        
                                                                        if (dates.length === 0) return null;

                                                                        const nationalHolidays = [
                                                                            '2025-01-01','2025-01-25','2025-01-26','2025-01-27','2025-01-28','2025-01-29','2025-01-30','2025-01-31','2025-02-01','2025-02-02',
                                                                            '2025-02-28','2025-04-03','2025-04-04','2025-04-05','2025-04-06','2025-05-01','2025-05-30','2025-05-31','2025-06-01',
                                                                            '2025-10-04','2025-10-05','2025-10-06','2025-10-10','2025-10-11','2025-10-12','2025-12-25',
                                                                            '2026-01-01','2026-02-14','2026-02-15','2026-02-16','2026-02-17','2026-02-18','2026-02-19','2026-02-20','2026-02-21','2026-02-22',
                                                                            '2026-02-27','2026-02-28','2026-03-01','2026-04-03','2026-04-04','2026-04-05','2026-04-06','2026-05-01',
                                                                            '2026-06-19','2026-06-20','2026-06-21','2026-09-25','2026-09-26','2026-09-27','2026-10-09','2026-10-10','2026-10-11','2026-12-25'
                                                                        ];

                                                                        let totalDays = 0;
                                                                        let totalHours = 0;

                                                                        const items = dates.map(dateObj => {
                                                                            const dateStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${String(dateObj.getDate()).padStart(2,'0')}`;
                                                                            const schedule = mySchedules[dateStr];
                                                                            
                                                                            let type = 'work';
                                                                            let hours = 0;
                                                                            let timeRangeStr = '';
                                                                            
                                                                            if (schedule) {
                                                                                type = schedule.type;
                                                                                if (['work', 'duty', 'card'].includes(type) && schedule.startTime && schedule.endTime) {
                                                                                    const [sH, sM] = schedule.startTime.split(':').map(Number);
                                                                                    const [eH, eM] = schedule.endTime.split(':').map(Number);
                                                                                    const [dy, dm, dd] = dateStr.split('-').map(Number);
                                                                                    let sDate = new Date(dy, dm-1, dd, sH, sM);
                                                                                    let eDate = new Date(dy, dm-1, dd, eH, eM);
                                                                                    if (eDate < sDate) eDate.setDate(eDate.getDate() + 1);
                                                                                    hours = (eDate - sDate) / (1000 * 60 * 60);
                                                                                    let lStart = null, lEnd = null;
                                                                                    if (r.leaveStartDate && r.leaveEndDate) {
                                                                                        const [dS, tS] = String(r.leaveStartDate).split(/T| /);
                                                                                        const [dE, tE] = String(r.leaveEndDate).split(/T| /);
                                                                                        if (dS && tS && dE && tE) {
                                                                                            const [yS, mS, dayS] = dS.split('-').map(Number);
                                                                                            const [hS, mnS] = tS.split(':').map(Number);
                                                                                            const [yE, mE, dayE] = dE.split('-').map(Number);
                                                                                            const [hE, mnE] = tE.split(':').map(Number);
                                                                                            lStart = new Date(yS, mS-1, dayS, hS, mnS);
                                                                                            lEnd = new Date(yE, mE-1, dayE, hE, mnE);
                                                                                        }
                                                                                    } else if (r.leaveDate) {
                                                                                        let sTime = r.leaveTime;
                                                                                        let eTime = r.leaveEndTime;
                                                                                        if (sTime && sTime.includes('~') && !eTime) {
                                                                                            const parts = sTime.split('~').map(s => s.trim());
                                                                                            sTime = parts[0];
                                                                                            eTime = parts[1];
                                                                                        }
                                                                                        if (sTime && eTime) {
                                                                                            const [ly, lm, ld] = r.leaveDate.split('-').map(Number);
                                                                                            const [lsh, lsm] = sTime.split(':').map(Number);
                                                                                            const [leh, lem] = eTime.split(':').map(Number);
                                                                                            lStart = new Date(ly, lm-1, ld, lsh, lsm);
                                                                                            lEnd = new Date(ly, lm-1, ld, leh, lem);
                                                                                        }
                                                                                    }
                                                                                    if (lStart && lEnd) {
                                                                                        const overlapStart = new Date(Math.max(sDate.getTime(), lStart.getTime()));
                                                                                        const overlapEnd = new Date(Math.min(eDate.getTime(), lEnd.getTime()));
                                                                                        if (overlapEnd > overlapStart) {
                                                                                            hours = (overlapEnd - overlapStart) / (1000 * 60 * 60);
                                                                                            const fmt = (d) => `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                                                                                            timeRangeStr = `${fmt(overlapStart)}~${fmt(overlapEnd)}`;
                                                                                        } else {
                                                                                            hours = 0;
                                                                                        }
                                                                                    }
                                                                                }
                                                                            } else {
                                                                                if (nationalHolidays.includes(dateStr)) type = 'holiday';
                                                                                else {
                                                                                    const w = dateObj.getDay();
                                                                                    if (w === 0 || w === 6) type = 'holiday';
                                                                                    else if (w === 5) type = 'off';
                                                                                    else type = 'work';
                                                                                }
                                                                            }
                                                                            
                                                                            if (type === 'off' || type === 'holiday') return null;
                                                                            if (hours <= 0) return null;

                                                                            totalDays++;
                                                                            totalHours += hours;

                                                                            return (
                                                                                <div key={dateStr} className="flex items-center gap-2">
                                                                                    <span>{dateStr.replace(/-/g, '/')}</span>
                                                                                    {hours > 0 && <span>{hours.toFixed(1)} hr</span>}
                                                                                    {timeRangeStr && <span className="text-gray-500 text-xs">({timeRangeStr})</span>}
                                                                                </div>
                                                                            );
                                                                        }).filter(Boolean);

                                                                        if (items.length === 0) return null;

                                                                        return (
                                                                            <>
                                                                                <div className="font-bold text-gray-600 mb-1">實際請假日期</div>
                                                                                {items}
                                                                                <div className="border-t border-gray-200 mt-2 pt-1 font-bold text-gray-600">
                                                                                    總天數及總工時 : 共 {totalDays} 天, {totalHours.toFixed(1)} hr
                                                                                </div>
                                                                            </>
                                                                        );
                                                                    })()}
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div className="text-sm text-gray-500 mt-0.5 flex items-center gap-1">
                                                            {isLeave ? <Clock className="w-3 h-3" /> : <MapPin className="w-3 h-3" />}
                                                            {isLeave
                                                                ? `申請日期 : ${new Intl.DateTimeFormat('zh-TW', {
                                                                    timeZone: 'Asia/Taipei',
                                                                    year: 'numeric', month: '2-digit', day: '2-digit',
                                                                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                                                                    hour12: false
                                                                }).format(new Date((r.timestamp?.seconds || r.createdAt?.seconds || Date.now() / 1000) * 1000)).replace(/\//g, '/')}`
                                                                : (r.checkInLocationName || r.address || '未記錄')
                                                            }
                                                        </div>
                                                        {['outing_start', 'outing_arrive', 'outing_end'].includes(r.type) && (r.outingReason || '').trim() && (
                                                            <div className="text-sm text-gray-500 mt-0.5 flex items-center gap-1">
                                                                <ClipboardList className="w-3 h-3" />
                                                                外出事由：{r.outingReason}
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        {(function(){
                                                            if (isLeave) {
                                                                return (
                                                                    <div className="flex gap-2">
                                                                        <div className="flex flex-col gap-2">
                                                                            <button 
                                                                                onClick={() => {
                                                                                    setSelectedDescription(r.leaveDescription || '無說明');
                                                                                    setShowDescriptionModal(true);
                                                                                }}
                                                                                className="w-12 h-12 rounded-lg bg-orange-50 text-orange-500 flex items-center justify-center border border-orange-100 hover:opacity-90 transition-opacity"
                                                                            >
                                                                                <FileText className="w-5 h-5" />
                                                                            </button>
                                                                            <button 
                                                                                onClick={() => {
                                                                                    if (r.approvalStatus === 'approved') return;
                                                                                    setEditingLeave(r);
                                                                                    setShowLeaveModal(true);
                                                                                }}
                                                                                disabled={r.approvalStatus === 'approved'}
                                                                                className={`w-12 h-12 rounded-lg flex items-center justify-center border transition-opacity ${r.approvalStatus === 'approved' ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed' : 'bg-blue-50 text-blue-500 border-blue-100 hover:opacity-90'}`}
                                                                            >
                                                                                <Edit className="w-5 h-5" />
                                                                            </button>
                                                                            {r.approvalStatus !== 'approved' && (
                                                                                <button 
                                                                                    onClick={() => onDeleteRecord(r)}
                                                                                    className="w-12 h-12 rounded-lg flex items-center justify-center border transition-opacity bg-red-50 text-red-500 border-red-100 hover:opacity-90"
                                                                                    title="刪除"
                                                                                >
                                                                                    <Trash2 className="w-5 h-5" />
                                                                                </button>
                                                                            )}
                                                                        </div>
                                                                        <div className="flex flex-col gap-2">
                                                                            {r.photoUrl ? (
                                                                                <div className="w-12 h-12 rounded-lg bg-gray-100 overflow-hidden cursor-pointer border border-gray-200 hover:opacity-90 transition-opacity" onClick={() => setPreviewImageUrl({ url: r.photoUrl, isLeave: isLeave })}>
                                                                                    <img src={r.photoUrl} className="w-full h-full object-cover" />
                                                                                </div>
                                                                            ) : <div className="w-12 h-12"></div>}
                                                                        </div>
                                                                    </div>
                                                                );
                                                            }

                                                            const loc = (function(){
                                                                const raw = r.location;
                                                                if (!raw) return null;
                                                                if (typeof raw === 'string') {
                                                                    const parts = raw.split(',');
                                                                    if (parts.length >= 2) {
                                                                        const lat = parseFloat((parts[0] || '').trim());
                                                                        const lng = parseFloat((parts[1] || '').trim());
                                                                        if (Number.isFinite(lat) && Number.isFinite(lng)) return { lat, lng };
                                                                    }
                                                                    return null;
                                                                }
                                                                if (Array.isArray(raw) && raw.length >= 2) {
                                                                    const lat = parseFloat(raw[0]);
                                                                    const lng = parseFloat(raw[1]);
                                                                    if (Number.isFinite(lat) && Number.isFinite(lng)) return { lat, lng };
                                                                    return null;
                                                                }
                                                                if (typeof raw === 'object') {
                                                                    const lat = parseFloat(raw.lat ?? raw.latitude);
                                                                    const lng = parseFloat(raw.lng ?? raw.longitude);
                                                                    if (Number.isFinite(lat) && Number.isFinite(lng)) return { lat, lng };
                                                                }
                                                                return null;
                                                            })();

                                                            const fallbackMapImgUrl = loc
                                                                ? `https://maps.googleapis.com/maps/api/staticmap?center=${loc.lat},${loc.lng}&zoom=15&size=100x100&maptype=roadmap&markers=color:red%7C${loc.lat},${loc.lng}&key=AIzaSyAzhLdWtycJgfz8UsXWlji63DkXpA4kmyY`
                                                                : null;

                                                            let mapImgUrl = fallbackMapImgUrl;
                                                            if (loc && currentUser && currentUser.avatarUrl && /^https?:\/\//i.test(currentUser.avatarUrl)) {
                                                                const iconUrl = encodeURIComponent(currentUser.avatarUrl);
                                                                const withIcon = `https://maps.googleapis.com/maps/api/staticmap?center=${loc.lat},${loc.lng}&zoom=15&size=100x100&maptype=roadmap&markers=icon:${iconUrl}%7C${loc.lat},${loc.lng}&key=AIzaSyAzhLdWtycJgfz8UsXWlji63DkXpA4kmyY`;
                                                                if (withIcon.length <= 1800) mapImgUrl = withIcon;
                                                            }
                                                            return (
                                                                <div className="flex gap-2">
                                                                    <div className="flex gap-2">
                                                                        <div className="flex flex-col gap-2">
                                                                            <button 
                                                                                onClick={() => {
                                                                                    if (loc) {
                                                                                        setMapPreviewTarget({
                                                                                            lat: loc.lat,
                                                                                            lng: loc.lng,
                                                                                            name: currentUser.name + ' - ' + (r.address || '打卡位置'),
                                                                                            radius: 10
                                                                                        });
                                                                                    } else {
                                                                                        alert('無座標資訊: ' + (r.address || ''));
                                                                                    }
                                                                                }}
                                                                                className="w-12 h-12 rounded-lg bg-gray-100 text-gray-500 flex items-center justify-center border border-gray-200 hover:opacity-90 transition-opacity overflow-hidden p-0"
                                                                            >
                                                                                {mapImgUrl ? (
                                                                                    <img
                                                                                        src={mapImgUrl}
                                                                                        className="w-full h-full object-cover"
                                                                                        alt="地圖"
                                                                                        onError={(e) => {
                                                                                            if (fallbackMapImgUrl && e.currentTarget.src !== fallbackMapImgUrl) {
                                                                                                e.currentTarget.src = fallbackMapImgUrl;
                                                                                            }
                                                                                        }}
                                                                                    />
                                                                                ) : (
                                                                                    <MapPin className="w-5 h-5" />
                                                                                )}
                                                                            </button>
                                                                            <button 
                                                                                onClick={() => {
                                                                                    setEditData(r);
                                                                                    setShowEditModal(true);
                                                                                }}
                                                                                className="w-12 h-12 rounded-lg bg-orange-50 text-orange-600 flex items-center justify-center border border-orange-100 hover:opacity-90 transition-opacity"
                                                                                title="申請修改"
                                                                            >
                                                                                <Edit className="w-5 h-5" />
                                                                            </button>
                                                                        </div>
                                                                        <div className="flex flex-col gap-2">
                                                                            {r.photoUrl ? (
                                                                                <div className="w-12 h-12 rounded-lg bg-gray-100 overflow-hidden cursor-pointer border border-gray-200 hover:opacity-90 transition-opacity" onClick={() => setPreviewImageUrl({ url: r.photoUrl, isLeave: isLeave })}>
                                                                                    <img src={r.photoUrl} className="w-full h-full object-cover" />
                                                                                </div>
                                                                            ) : <div className="w-12 h-12"></div>}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })()}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    </div>
                    {/* Location Selector Modal */}`
                    {showLocationSelector && (
                        <div className="fixed inset-0 z-[100] bg-black/50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-xs rounded-2xl shadow-xl overflow-hidden animate-fade-in-up max-h-[80vh] flex flex-col">
                                <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                    <h3 className="font-bold text-gray-800">選擇打卡地點</h3>
                                    <button onClick={() => setShowLocationSelector(false)} className="p-1 bg-gray-200 rounded-full text-gray-500 hover:bg-gray-300 transition"><X className="w-4 h-4" /></button>
                                </div>
                                <div className="overflow-y-auto p-2">
                                    {availableLocations.map(loc => (
                                        <button
                                            key={loc.id}
                                            onClick={() => {
                                                setCheckInLocation({ id: loc.id, name: loc.name, type: loc.type });
                                                setIsManualLocation(true);
                                                setShowLocationSelector(false);
                                            }}
                                            className={`w-full text-left px-4 py-3 rounded-xl mb-1 flex items-center justify-between ${checkInLocation?.id === loc.id ? 'bg-red-50 text-red-600 font-bold' : 'hover:bg-gray-50 text-gray-700'}`}
                                        >
                                            <span>{loc.name}</span>
                                            {checkInLocation?.id === loc.id && <CheckCircle className="w-4 h-4" />}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {showOutingReasonSelector && (
                        <div className="fixed inset-0 z-[100] bg-black/50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-xs rounded-2xl shadow-xl overflow-hidden animate-fade-in-up max-h-[80vh] flex flex-col">
                                <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                    <h3 className="font-bold text-gray-800">選擇外出事由</h3>
                                    <button onClick={() => setShowOutingReasonSelector(false)} className="p-1 bg-gray-200 rounded-full text-gray-500 hover:bg-gray-300 transition"><X className="w-4 h-4" /></button>
                                </div>
                                <div className="overflow-y-auto p-2">
                                    {['例行督察','例會','臨時會','區大','節日活動','簡報','其他'].map(opt => (
                                        <button
                                            key={opt}
                                            onClick={() => {
                                                setOutingReasonOption(opt);
                                                if (opt !== '其他') { 
                                                    setOutingCustomReason('');
                                                    setShowOutingReasonSelector(false);
                                                }
                                            }}
                                            className={`w-full text-left px-4 py-3 rounded-xl mb-1 flex items-center justify-between ${outingReasonOption === opt ? 'bg-red-50 text-red-600 font-bold' : 'hover:bg-gray-50 text-gray-700'}`}
                                        >
                                            <span>{opt}</span>
                                            {outingReasonOption === opt && <CheckCircle className="w-4 h-4" />}
                                        </button>
                                    ))}
                                    {outingReasonOption === '其他' && (
                                        <div className="p-2">
                                            <input 
                                                type="text" 
                                                className="w-full bg-gray-50 border-0 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-red-500"
                                                placeholder="請輸入外出事由"
                                                value={outingCustomReason}
                                                onChange={(e) => setOutingCustomReason(e.target.value)}
                                            />
                                            <div className="mt-3 flex justify-end gap-2">
                                                <button 
                                                    className="px-3 py-1.5 rounded-lg text-xs bg-gray-100 text-gray-600 font-bold hover:bg-gray-200"
                                                    onClick={() => setShowOutingReasonSelector(false)}
                                                >
                                                    確定
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    <LeaveRequestModal 
                        isOpen={showLeaveModal} 
                        onClose={() => { setShowLeaveModal(false); setEditingLeave(null); }}
                        defaultCompany={currentUser.companyName || (companies || []).find(c => c.id === currentUser.companyId)?.name || '所屬公司'}
                        initialData={editingLeave}
                        onSubmit={async (data) => {
                            if (onLeaveSubmit) {
                                setLeaveLoading(true);
                                try {
                                    await onLeaveSubmit(data);
                                    setShowLeaveModal(false);
                                    setEditingLeave(null);
                                } catch (e) {
                                    console.error(e);
                                } finally {
                                    setLeaveLoading(false);
                                }
                            }
                        }}
                        loading={leaveLoading}
                    />
                    
                    {showDescriptionModal && (
                        <div className="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4" onClick={() => setShowDescriptionModal(false)}>
                            <div className="bg-white rounded-2xl w-full max-w-sm p-6" onClick={e => e.stopPropagation()}>
                                <h3 className="font-bold text-lg mb-4 text-gray-800">說明內容</h3>
                                <div className="bg-gray-50 p-4 rounded-xl text-gray-600 min-h-[100px] whitespace-pre-wrap">
                                    {selectedDescription}
                                </div>
                                <div className="mt-4 flex justify-end">
                                    <button 
                                        onClick={() => setShowDescriptionModal(false)}
                                        className="px-4 py-2 bg-gray-100 text-gray-600 rounded-xl font-bold"
                                    >
                                        關閉
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}


                    <AttendanceEditModal 
                        isOpen={showEditModal} 
                        onClose={() => { setShowEditModal(false); setEditData(null); }}
                        record={editData}
                        mode="request"
                        onSubmit={handleRequestModification}
                        loading={editLoading}
                    />

                    {/* Schedule Confirmation Modal */}
                    {showScheduleConfirmModal && scheduleConfirmData && (
                        <div className="fixed inset-0 z-[100] bg-black/50 flex items-center justify-center p-4 animate-fade-in">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl space-y-4">
                                <div className="text-center">
                                    <h3 className="text-lg font-bold text-gray-800 mb-2">確認打卡</h3>
                                    <p className="text-gray-600 whitespace-pre-wrap leading-relaxed">
                                        {scheduleConfirmData.message}
                                    </p>
                                </div>
                                <div className="flex gap-3 pt-2">
                                    <button 
                                        onClick={() => setShowScheduleConfirmModal(false)}
                                        className="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition-colors"
                                    >
                                        取消
                                    </button>
                                    <button 
                                        onClick={() => {
                                            setShowScheduleConfirmModal(false);
                                            onClockIn('in', availableLocations);
                                        }}
                                        className="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors"
                                    >
                                        確認
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {toast && (
                        <div className={`fixed top-[10vh] left-1/2 -translate-x-1/2 z-[75] px-6 py-4 rounded-2xl shadow-xl flex items-center gap-3 transition-all transform duration-300 ${toast === '打卡完成' ? 'bg-green-600 scale-110 top-1/2 -translate-y-1/2' : 'bg-gray-800'}`}>
                           {toast === '打卡完成' && <CheckCircle className="w-8 h-8 text-white" />}
                           <span className={`${toast === '打卡完成' ? 'text-xl font-bold' : 'text-sm'} text-white`}>{toast}</span>
                        </div>
                    )}
                </div>
            );
        };

        // 5. Manager Dashboard
        const ManagerDashboard = ({ currentUser, communities, allAttendance, timeOffset, users = [] }) => {
            const communityLogs = allAttendance.filter(a => {
                // 1. Strict match on communityId (handle string/number differences)
                if (String(a.communityId) === String(currentUser.communityId)) return true;
                
                // 2. Fallback: Check if the user belongs to this community via users list
                if (users.length > 0 && a.userId) {
                    const u = users.find(user => user.id === a.userId);
                    if (u) {
                        // Check communityIds array
                        if (u.communityIds && u.communityIds.some(cid => String(cid) === String(currentUser.communityId))) {
                            return true;
                        }
                        // Check legacy communityId field
                        if (u.communityId && String(u.communityId) === String(currentUser.communityId)) {
                            return true;
                        }
                    }
                }
                return false;
            });
            const today = new Date(Date.now() + (timeOffset || 0)).toLocaleDateString('zh-TW', { timeZone: 'Asia/Taipei' });

            return (
                <div className="space-y-4 pb-20">
                    <div className="grid grid-cols-2 gap-3">
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                            <div className="text-gray-400 text-xs mb-1">今日打卡</div>
                            <div className="text-2xl font-bold text-gray-800">
                                {communityLogs.filter(l => l.timestamp && l.timestamp.seconds && new Date(l.timestamp.seconds * 1000).toLocaleDateString('zh-TW', { timeZone: 'Asia/Taipei' }) === today).length}
                                <span className="text-xs text-gray-400 font-normal ml-1">次</span>
                            </div>
                        </div>
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                            <div className="text-gray-400 text-xs mb-1">目前在勤</div>
                            <div className="text-2xl font-bold text-red-600">
                                {communityLogs.filter(l => l.type === 'in' && l.timestamp && l.timestamp.seconds && new Date(l.timestamp.seconds * 1000).toLocaleDateString('zh-TW', { timeZone: 'Asia/Taipei' }) === today).length}
                                <span className="text-xs text-gray-400 font-normal ml-1">人</span>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div className="p-4 border-b border-gray-50 bg-gray-50/50 flex justify-between items-center">
                            <h3 className="font-bold text-gray-700 text-sm">即時動態</h3>
                            <span className="text-[10px] px-2 py-1 bg-red-50 text-red-600 rounded-full font-bold">
                                {currentUser.communityName}
                            </span>
                        </div>
                        <div className="divide-y divide-gray-50">
                            {communityLogs.slice(0, 10).map(log => (
                                <div key={log.id} className="p-4 flex items-center justify-between hover:bg-gray-50 transition">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center overflow-hidden flex-shrink-0 border border-gray-100 ${log.type === 'in' ? 'bg-red-500' : 'bg-gray-400'}`}>
                                            {(function(){
                                                const logUser = users.find(u => u.id === log.userId);
                                                if (logUser && logUser.avatarUrl) {
                                                    return <img src={logUser.avatarUrl} className="w-full h-full object-cover" />;
                                                }
                                                return <span className="text-xs font-bold text-white">{log.userName.charAt(0)}</span>;
                                            })()}
                                        </div>
                                        <div>
                                            <div className="text-sm font-bold text-gray-800 flex items-center gap-2">
                                                {log.userName}
                                                {(function(){
                                                    const u = users.find(user => user.id === log.userId);
                                                    if (u) {
                                                        const isResigned = u.status === '離職';
                                                        return (
                                                            <div className="flex items-center gap-1">
                                                                {isResigned && <span className="text-[10px] px-1.5 py-0.5 bg-gray-100 text-gray-500 rounded border border-gray-200">離職</span>}
                                                                {u.startDate && <span className="text-[10px] text-gray-400 hidden sm:inline-block" title="在職起始">In: {u.startDate}</span>}
                                                                {u.resignDate && <span className="text-[10px] text-gray-400 hidden sm:inline-block" title="離職起始">Out: {u.resignDate}</span>}
                                                            </div>
                                                        );
                                                    }
                                                    return null;
                                                })()}
                                            </div>
                                            <div className="text-xs text-gray-400">
                                                {log.userRole} · {(function(){
                                                    const typeMap = {
                                                        'in': '上班',
                                                        'out': '下班',
                                                        'outing_start': '外出',
                                                        'outing_arrive': '抵達',
                                                        'outing_end': '離開',
                                                        'leave': '請假',
                                                        'late_in': '卡上',
                                                        'late_out': '卡下'
                                                    };
                                                    return typeMap[log.type] || '未知';
                                                })()}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-xs font-mono text-gray-600">
                                            {log.timestamp && log.timestamp.seconds ? new Date(log.timestamp.seconds * 1000).toLocaleTimeString('zh-TW', { timeZone: 'Asia/Taipei', hour12: false, hour: '2-digit', minute:'2-digit', second:'2-digit' }) : '--:--:--'}
                                        </div>
                                        {log.type === 'in' && <div className="flex items-center justify-end text-[10px] text-green-500 gap-0.5 mt-0.5"><CheckCircle className="w-2 h-2"/> 正常</div>}
                                    </div>
                                </div>
                            ))}
                            {communityLogs.length === 0 && (
                                <div className="p-8 text-center text-gray-400 text-sm">尚無今日資料</div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 6. HR Dashboard
        const HRDashboard = ({ currentUser, communities, allAttendance }) => {
            return (
                <div className="space-y-4 pb-20">
                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <h2 className="text-lg font-bold text-gray-800 mb-4">人事管理中心</h2>
                        <div className="flex gap-2 mb-6 overflow-x-auto pb-2 no-scrollbar flex-nowrap whitespace-nowrap">
                            <button className="flex-shrink-0 flex items-center gap-2 px-4 py-2 bg-gray-50 text-gray-600 rounded-2xl text-sm font-medium hover:bg-gray-100 transition border border-gray-200">
                                <FileText className="w-4 h-4" /> 月報表
                            </button>
                            <button className="flex-shrink-0 flex items-center gap-2 px-4 py-2 bg-gray-50 text-gray-600 rounded-2xl text-sm font-medium hover:bg-gray-100 transition border border-gray-200">
                                <AlertCircle className="w-4 h-4" /> 異常檢視
                            </button>
                            <button className="flex-shrink-0 flex items-center gap-2 px-4 py-2 bg-gray-50 text-gray-600 rounded-2xl text-sm font-medium hover:bg-gray-100 transition border border-gray-200">
                                <Calendar className="w-4 h-4" /> 請假審核
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Image Preview Modal
        const ImagePreviewModal = ({ url, onClose }) => {
            if (!url) return null;
            const imgSrc = typeof url === 'object' ? url.url : url;
            // Removed isLeave check to enforce 1:1 for all images as requested
            
            return (
                <div className="fixed inset-0 z-[80] bg-black/95 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                    <button 
                        onClick={onClose}
                        className="absolute top-4 right-4 p-2 bg-white/10 rounded-full text-white hover:bg-white/20 transition-colors z-50"
                    >
                        <X className="w-6 h-6" />
                    </button>
                    <div className="w-full max-w-md aspect-square bg-black flex items-center justify-center overflow-hidden rounded-lg shadow-2xl" onClick={e => e.stopPropagation()}>
                        <img 
                            src={imgSrc} 
                            alt="Preview" 
                            className="w-full h-full object-cover"
                        />
                    </div>
                </div>
            );
        };

        const subPagesMap = {
            overview: [
                { key: 'district', label: '例會' },
                { key: 'district_meeting', label: '區大' },
                { key: 'activity', label: '活動' },
                { key: 'presentation', label: '簡報' },
                { key: 'notification', label: '通知' },
                { key: 'general', label: '概況' }
            ],
            clock: [
                { key: 'work', label: '上下班' },
                { key: 'out', label: '外出' },
                { key: 'card', label: '卡班' },
                { key: 'leave', label: '請假' },
                { key: 'schedule', label: '班表' }
            ],
            function: [
                { key: 'patrol', label: '巡邏' },
                { key: 'training', label: '訓練' },
                { key: 'download', label: '下載' }
            ],
            cadre: [
                { key: 'map', label: '地圖' },
                { key: 'record', label: '紀錄' },
                { key: 'leave', label: '請假' },
                { key: 'schedule', label: '班表' },
                { key: 'approval', label: '簽呈' },
                { key: 'account', label: '帳號' },
                { key: 'report', label: '報表' },
                { key: 'notification', label: '通知' }
            ],
            application: [
                { key: 'signature', label: '簽呈' },
                { key: 'equipment', label: '設備' }
            ],
            settings: [
                { key: 'general', label: '一般' },
                { key: 'account', label: '帳號' },
                { key: 'community', label: '社區' },
                { key: 'system', label: '系統' }
            ]
        };

        // --- Main App Component ---
        // Schedule Reminder Component
        const ScheduleReminder = ({ schedules, attendance }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [timeType, setTimeType] = useState(''); // '上班' or '下班'
            const [timeStr, setTimeStr] = useState('');
            const lastTriggeredRef = useRef('');

            useEffect(() => {
                const checkTime = () => {
                    const now = new Date();
                    const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
                    const schedule = schedules[todayStr];

                    if (!schedule) return;

                    // Filter attendance for today
                    const todayAttendance = (attendance || []).filter(a => {
                        if (!a.timestamp) return false;
                        const d = a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                        const dStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                        return dStr === todayStr;
                    });

                    const parseTime = (t) => {
                        const [h, m] = t.split(':').map(Number);
                        const d = new Date(now);
                        d.setHours(h, m, 0, 0);
                        return d;
                    };

                    const checkTrigger = (tStr, type) => {
                        if (!tStr) return;

                        // Check if already attended
                        // For '上班', check if any 'in' record exists today
                        if (type === '上班') {
                             const hasClockIn = todayAttendance.some(a => ['in', 'late_in', 'outing_start', 'outing_arrive'].includes(a.type));
                             if (hasClockIn) {
                                 if (timeType === '上班') setIsOpen(false);
                                 return; // Already clocked in
                             }
                        }
                        // For '下班', check if any 'out' record exists today
                        if (type === '下班') {
                             const hasClockOut = todayAttendance.some(a => ['out', 'early_out', 'late_out'].includes(a.type));
                             if (hasClockOut) {
                                 if (timeType === '下班') setIsOpen(false);
                                 return; // Already clocked out
                             }
                        }

                        const targetTime = parseTime(tStr);
                        // Difference in minutes
                        const diff = (now - targetTime) / 1000 / 60;

                        // Modified Trigger Logic:
                        // Clock In: Trigger from 10 mins BEFORE start time
                        // Clock Out: Trigger from 10 mins AFTER end time
                        
                        let shouldTrigger = false;

                        if (type === '上班') {
                            // Trigger if within [Start - 10, Start + 20] window (30 mins window)
                            // "前10分鐘"
                            if (diff >= -10 && diff < 20) {
                                shouldTrigger = true;
                            }
                        } else if (type === '下班') {
                            // Trigger if within [End + 10, End + 40] window (30 mins window)
                            // "後10分鐘"
                            if (diff >= 10 && diff < 40) {
                                shouldTrigger = true;
                            }
                        }

                        if (shouldTrigger) {
                            const key = `${type}_${todayStr}_${tStr}`;
                            // Check if already triggered in this session
                            if (lastTriggeredRef.current !== key) {
                                setTimeType(type);
                                setTimeStr(tStr);
                                setIsOpen(true);
                                lastTriggeredRef.current = key;
                            }
                        }
                    };

                    if (schedule.startTime) checkTrigger(schedule.startTime, '上班');
                    if (schedule.endTime) checkTrigger(schedule.endTime, '下班');
                };

                const timer = setInterval(checkTime, 5000); // Check every 5 seconds
                checkTime(); // Check immediately on mount/update
                return () => clearInterval(timer);
            }, [schedules, attendance]); // Re-run if attendance updates

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 pointer-events-none">
                    <div className="bg-white rounded-2xl shadow-2xl border-4 border-red-100 p-6 w-72 pointer-events-auto relative animate-[bounce_0.5s_ease-out]">
                        <button 
                            onClick={() => setIsOpen(false)}
                            className="absolute -top-3 -right-3 bg-red-600 text-white rounded-full p-2 shadow-lg hover:bg-red-700 transition transform hover:scale-110"
                        >
                            <X className="w-5 h-5" />
                        </button>
                        <div className="flex flex-col items-center gap-4">
                            <div className="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center text-red-600 shadow-inner">
                                <Clock className="w-8 h-8 animate-pulse" />
                            </div>
                            <div className="text-center">
                                <h3 className="font-bold text-gray-800 text-xl">打卡提醒</h3>
                                <p className="text-gray-600 font-bold mt-2 text-base">
                                    今日班表 {timeType} 時間
                                </p>
                                <p className="text-4xl font-black text-red-600 font-mono my-2 tracking-wider">
                                    {timeStr}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [dbUser, setDbUser] = useState(null);
            const [view, setView] = useState('login');
            const [loading, setLoading] = useState(true);
            const [communities, setCommunities] = useState([]);
            const [usersList, setUsersList] = useState([]);
            const [attendanceList, setAttendanceList] = useState([]);
            const [makeupRequests, setMakeupRequests] = useState([]);
            const [myMakeupRequests, setMyMakeupRequests] = useState([]);
            const [myLeaves, setMyLeaves] = useState([]);
            const [leavesList, setLeavesList] = useState([]);
            const [schedulesList, setSchedulesList] = useState([]); // New state for leaves from 'leaves' collection
            const [myAttendance, setMyAttendance] = useState([]);
            const [fetchError, setFetchError] = useState('');
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [activeTab, setActiveTab] = useState(() => localStorage.getItem('last_active_tab') || 'home');
            const [overviewSubtab, setOverviewSubtab] = useState('district');
            const [overviewMeetingDate, setOverviewMeetingDate] = useState(new Date());
            const [overviewMeetingSelectedDate, setOverviewMeetingSelectedDate] = useState(new Date());
            const [overviewDutyFridays, setOverviewDutyFridays] = useState([]);
            const [overviewDutyModalOpen, setOverviewDutyModalOpen] = useState(false);
            const [overviewMeetingModalOpen, setOverviewMeetingModalOpen] = useState(false);
            const [completeMeetingModalOpen, setCompleteMeetingModalOpen] = useState(false);
            const [completeMeetingTarget, setCompleteMeetingTarget] = useState(null);
            const [completeMeetingForm, setCompleteMeetingForm] = useState({
                minutes: '',
                photos: []
            });
            const [overviewMeetingForm, setOverviewMeetingForm] = useState({
                communityId: '',
                type: '例會',
                date: '',
                time: '',
                participants: [],
                leaderId: '',
                description: '',
                otherParticipants: ''
            });
            const [overviewMeetings, setOverviewMeetings] = useState([]);

            const [meetingReminder, setMeetingReminder] = useState(null);

            const [showNotificationModal, setShowNotificationModal] = useState(false);
            const [notificationForm, setNotificationForm] = useState({ target: '', content: '' });
            const [notificationLoading, setNotificationLoading] = useState(false);
            const [notifications, setNotifications] = useState([]);
            
            // Notification Popup Logic
            const [activePopupNotification, setActivePopupNotification] = useState(null);
            const [ignoredNotificationIds, setIgnoredNotificationIds] = useState(new Set());
            const [dontShowAgain, setDontShowAgain] = useState(false);

            useEffect(() => {
                if (!notifications || !dbUser) {
                    if (activePopupNotification) setActivePopupNotification(null);
                    return;
                }
                
                // Find unread notifications targeting me
                const unread = notifications.filter(n => 
                    isNotificationTarget(n) && 
                    !(n.readBy || []).includes(dbUser.id) &&
                    !ignoredNotificationIds.has(n.id)
                );

                if (unread.length > 0) {
                    // Pick the latest one
                    const latest = unread[0];
                    if (!activePopupNotification || activePopupNotification.id !== latest.id) {
                         setActivePopupNotification(latest);
                         setDontShowAgain(false); 
                    }
                } else {
                    setActivePopupNotification(null);
                }
            }, [notifications, dbUser, ignoredNotificationIds, companies]);

            const handleClosePopup = async () => {
                if (!activePopupNotification) return;

                if (dontShowAgain) {
                    try {
                        const notifRef = doc(db, 'artifacts', appId, 'public', 'data', 'notifications', activePopupNotification.id);
                        await updateDoc(notifRef, {
                            readBy: arrayUnion(dbUser.id)
                        });
                    } catch (e) {
                        console.error("Error marking notification as read:", e);
                        setToast("更新狀態失敗");
                    }
                } else {
                    setIgnoredNotificationIds(prev => new Set(prev).add(activePopupNotification.id));
                }
                setActivePopupNotification(null);
            };

            const handleDeleteNotification = (id) => {
                setNotificationToDeleteId(id);
            };

            const confirmDeleteNotification = async () => {
                if (!notificationToDeleteId) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notifications', notificationToDeleteId));
                    setToast('通知已刪除');
                } catch (error) {
                    console.error('Error deleting notification:', error);
                    setToast('刪除失敗');
                } finally {
                    setNotificationToDeleteId(null);
                }
            };

            const handleEditNotification = (notif) => {
                setNotificationForm({
                    id: notif.id,
                    target: notif.target,
                    content: notif.content
                });
                setShowNotificationModal(true);
            };

            const handleNotificationSubmit = async () => {
                if (!notificationForm.target || !notificationForm.content) {
                    setToast('請填寫完整資訊');
                    return;
                }
                setNotificationLoading(true);
                try {
                    if (notificationForm.id) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notifications', notificationForm.id), {
                            target: notificationForm.target,
                            content: notificationForm.content,
                            updatedAt: serverTimestamp()
                        });
                        setToast('通知已更新');
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), {
                            target: notificationForm.target,
                            content: notificationForm.content,
                            senderName: '總公司',
                            senderId: dbUser?.id || 'unknown',
                            createdAt: serverTimestamp()
                        });
                        setToast('通知發送成功');
                    }
                    
                    setShowNotificationModal(false);
                    setNotificationForm({ target: '', content: '' });
                } catch (error) {
                    console.error('Error sending/updating notification:', error);
                    setToast('操作失敗，請重試');
                } finally {
                    setNotificationLoading(false);
                }
            };

            useEffect(() => {
                if (!dbUser) {
                    setNotifications([]);
                    return;
                }
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), orderBy('createdAt', 'desc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const list = [];
                    snapshot.forEach((doc) => {
                        list.push({ id: doc.id, ...doc.data() });
                    });
                    setNotifications(list);
                }, (error) => {
                    console.error("Error fetching notifications: ", error);
                });
                return () => unsubscribe();
            }, [dbUser]);

            useEffect(() => {
                if (!dbUser) {
                    setMeetingReminder(null);
                    return;
                }
                const today = new Date();
                const y = today.getFullYear();
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const d = String(today.getDate()).padStart(2, '0');
                const todayKey = `${y}-${m}-${d}`;
                const baseMeetings = Array.isArray(overviewMeetings) ? overviewMeetings : [];
                const districtMeetings = Array.isArray(overviewDistrictMeetings) ? overviewDistrictMeetings : [];
                const activityMeetings = Array.isArray(overviewActivities) ? overviewActivities : [];
                const presentationMeetings = Array.isArray(overviewPresentations) ? overviewPresentations : [];
                const meetings = [...baseMeetings, ...districtMeetings, ...activityMeetings, ...presentationMeetings];

                let newMeetingTarget = null;
                let dayOfTarget = null;

                for (let i = 0; i < meetings.length; i++) {
                    const meet = meetings[i];
                    if (!meet) continue;

                    // Filter Logic:
                    // Only notify if user is admin/manager OR user is a participant
                    const isAdminOrManager = dbUser && ['admin', 'manager'].includes(dbUser.role);
                    const isParticipant = dbUser && Array.isArray(meet.participants) && meet.participants.includes(dbUser.id);
                    
                    if (!isAdminOrManager && !isParticipant) {
                        continue;
                    }
                    
                    const isToday = meet.date === todayKey;
                    const isFuture = meet.date > todayKey;
                    const isValidTypeForDayOf = meet.type === '例會' || meet.type === '臨時會';

                    // 1. Check for New Meeting Notification (Priority 1)
                    if (isToday || isFuture) {
                        const ackKey = `meetingCreatedAck_${dbUser.id || currentUserId}_${meet.id}`;
                        if (!localStorage.getItem(ackKey)) {
                            newMeetingTarget = { ...meet, _notificationType: 'new' };
                            break; // Found high priority, stop looking
                        }
                    }

                    // 2. Check for Day-of Reminder (Priority 2) - only for 例會/臨時會
                    if (isValidTypeForDayOf && isToday && !dayOfTarget) {
                        const key = `meetingReminderClosed_${dbUser.id || currentUserId}_${meet.id}_${todayKey}`;
                        let count = 0;
                        try {
                            const stored = localStorage.getItem(key);
                            if (stored != null) {
                                const parsed = parseInt(stored, 10);
                                if (!isNaN(parsed)) count = parsed;
                            }
                        } catch {}
                        if (count < 2) {
                            dayOfTarget = { ...meet, _notificationType: 'day_of' };
                        }
                    }
                }

                if (newMeetingTarget) {
                    setMeetingReminder(newMeetingTarget);
                } else if (dayOfTarget) {
                    setMeetingReminder(dayOfTarget);
                } else {
                    setMeetingReminder(null);
                }
            }, [dbUser, overviewMeetings, overviewDistrictMeetings, overviewActivities, overviewPresentations, usersList]);
            const [overviewCompany, setOverviewCompany] = useState('台北公司');
            const [expandedNotificationIds, setExpandedNotificationIds] = useState([]);
            const [overviewMeetingDatesByCompany, setOverviewMeetingDatesByCompany] = useState({});
            const getOverviewMeetingBadgeCount = () => {
                const baseMeetings = Array.isArray(overviewMeetings) ? overviewMeetings : [];
                const today = new Date();
                const y = today.getFullYear();
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const d = String(today.getDate()).padStart(2, '0');
                const todayKey = `${y}-${m}-${d}`;
                const filtered = baseMeetings.filter(meet => {
                    if (!meet) return false;
                    if (meet.companyName !== overviewCompany) return false;
                    if (!(meet.type === '例會' || meet.type === '臨時會')) return false;
                    if (!meet.date || typeof meet.date !== 'string') return false;
                    return meet.date >= todayKey;
                });
                return filtered.length;
            };
            const getOverviewDistrictMeetingBadgeCount = () => {
                const list = Array.isArray(overviewDistrictMeetings) ? overviewDistrictMeetings : [];
                const today = new Date();
                const y = today.getFullYear();
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const d = String(today.getDate()).padStart(2, '0');
                const todayKey = `${y}-${m}-${d}`;
                const filtered = list.filter(meet => {
                    if (!meet) return false;
                    if (meet.companyName !== overviewCompany) return false;
                    if (!meet.date || typeof meet.date !== 'string') return false;
                    return meet.date >= todayKey;
                });
                return filtered.length;
            };
            const getOverviewActivityBadgeCount = () => {
                const list = Array.isArray(overviewActivities) ? overviewActivities : [];
                const today = new Date();
                const y = today.getFullYear();
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const d = String(today.getDate()).padStart(2, '0');
                const todayKey = `${y}-${m}-${d}`;
                const filtered = list.filter(meet => {
                    if (!meet) return false;
                    if (meet.companyName !== overviewCompany) return false;
                    if (!meet.date || typeof meet.date !== 'string') return false;
                    return meet.date >= todayKey;
                });
                return filtered.length;
            };
            const getOverviewPresentationBadgeCount = () => {
                const list = Array.isArray(overviewPresentations) ? overviewPresentations : [];
                const today = new Date();
                const y = today.getFullYear();
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const d = String(today.getDate()).padStart(2, '0');
                const todayKey = `${y}-${m}-${d}`;
                const filtered = list.filter(meet => {
                    if (!meet) return false;
                    if (meet.companyName !== overviewCompany) return false;
                    if (!meet.date || typeof meet.date !== 'string') return false;
                    return meet.date >= todayKey;
                });
                return filtered.length;
            };

            // District Meeting States
            const [overviewDistrictMeetingDatesByCompany, setOverviewDistrictMeetingDatesByCompany] = useState({});
            const [overviewDistrictMeetingDate, setOverviewDistrictMeetingDate] = useState(new Date());
            const [overviewDistrictMeetingSelectedDate, setOverviewDistrictMeetingSelectedDate] = useState(new Date());
            const [overviewDistrictMeetingModalOpen, setOverviewDistrictMeetingModalOpen] = useState(false);
            const [overviewDistrictMeetingForm, setOverviewDistrictMeetingForm] = useState({
                communityId: '',
                type: '區大',
                date: '',
                time: '',
                participants: [],
                leaderId: '',
                description: '',
                otherParticipants: ''
            });
            const [overviewDistrictMeetings, setOverviewDistrictMeetings] = useState([]);

            // Activity States
            const [overviewActivityDatesByCompany, setOverviewActivityDatesByCompany] = useState({});
            const [overviewActivityDate, setOverviewActivityDate] = useState(new Date());
            const [overviewActivitySelectedDate, setOverviewActivitySelectedDate] = useState(new Date());
            const [overviewActivityModalOpen, setOverviewActivityModalOpen] = useState(false);
            const [overviewActivityForm, setOverviewActivityForm] = useState({
                communityId: '',
                type: '活動',
                date: '',
                time: '',
                participants: [],
                leaderId: '',
                description: '',
                otherParticipants: ''
            });
            const [overviewActivities, setOverviewActivities] = useState([]);

            // Presentation States
            const [overviewPresentationDatesByCompany, setOverviewPresentationDatesByCompany] = useState({});
            const [overviewPresentationDate, setOverviewPresentationDate] = useState(new Date());
            const [overviewPresentationSelectedDate, setOverviewPresentationSelectedDate] = useState(new Date());
            const [overviewPresentationModalOpen, setOverviewPresentationModalOpen] = useState(false);
            const [overviewPresentationForm, setOverviewPresentationForm] = useState({
                communityId: '',
                type: '簡報',
                date: '',
                time: '',
                participants: [],
                leaderId: '',
                description: '',
                otherParticipants: ''
            });
            const [overviewPresentations, setOverviewPresentations] = useState([]);

            const [clockSubtab, setClockSubtab] = useState('work');
            const [clockScheduleDate, setClockScheduleDate] = useState(new Date()); // New State for Clock Tab Schedule
            const [clockScheduleSelectedDate, setClockScheduleSelectedDate] = useState(new Date()); // New State for Selected Date in Clock Schedule
            const [mySchedules, setMySchedules] = useState({}); // New State for My Schedules
            const [settingsSubtab, setSettingsSubtab] = useState('account');
            const [applicationSubtab, setApplicationSubtab] = useState('signature');
            const [functionSubtab, setFunctionSubtab] = useState('patrol');
            const [cadreSubtab, setCadreSubtab] = useState(() => localStorage.getItem('last_cadre_subtab') || 'map');
            const [cadreCompany, setCadreCompany] = useState(() => localStorage.getItem('last_cadre_company') || '台北');
            const [cadreRecordDate, setCadreRecordDate] = useState(() => {
                try {
                    return localStorage.getItem('last_cadre_record_date') || (function(){
                        const d = new Date();
                        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                    })();
                } catch {
                    const d = new Date();
                    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                }
            });

            // User Edit State
            const [editingUser, setEditingUser] = useState(null);
            const [isEditUserModalOpen, setIsEditUserModalOpen] = useState(false);
            const [editUserForm, setEditUserForm] = useState({});

            const [cadreMapSelectedUserId, setCadreMapSelectedUserId] = useState(() => {
                try {
                    return localStorage.getItem('last_selected_schedule_user_id') || null;
                } catch {
                    return null;
                }
            });
            const [cadreScheduleDate, setCadreScheduleDate] = useState(() => {
                try {
                    const saved = localStorage.getItem('last_selected_schedule_date');
                    return saved ? new Date(saved) : new Date();
                } catch {
                    return new Date();
                }
            });
            const [cadreScheduleSelectedDate, setCadreScheduleSelectedDate] = useState(new Date()); // New State for Selected Date in Cadre Schedule
            const [todaySchedules, setTodaySchedules] = useState({});
            const [checkInLocation, setCheckInLocation] = useState(null);
            const [isNightShift, setIsNightShift] = useState(false);
            const [showCompanyMenu, setShowCompanyMenu] = useState(false);
            const [roles, setRoles] = useState([]);
            const [companies, setCompanies] = useState([]);

            // Helper for Notification Targeting
            const isNotificationTarget = (notification) => {
                const target = notification.target;
                if (!target || !dbUser) return false;
                
                // If "All" is selected
                if (target.includes('全部')) return true;

                // Helper to get my company name
                // dbUser.companyId is primary company. 
                // If user has multiple companies, we might need to check companyIds array?
                // But for now, assuming primary company is enough for "Taipei/Taoyuan" distinction.
                // Or check all companies?
                // Let's stick to dbUser.companyId for simplicity as per existing logic usually.
                const myCompany = companies.find(c => c.id === dbUser.companyId);
                const myCompanyName = myCompany ? myCompany.name : '';

                if (target.includes('全台北公司') && myCompanyName.includes('台北')) return true;
                if (target.includes('全桃園公司') && myCompanyName.includes('桃園')) return true;

                return target.includes(dbUser.name);
            };

            const [areas, setAreas] = useState([]);
            const [showProfileModal, setShowProfileModal] = useState(false);
            const [showResetPasswordModal, setShowResetPasswordModal] = useState(false);
            const [resetPasswordForm, setResetPasswordForm] = useState({ newPassword: '', confirmPassword: '' });
            const [resetPasswordError, setResetPasswordError] = useState('');
            const [resetPasswordSaving, setResetPasswordSaving] = useState(false);
            const [showCameraModal, setShowCameraModal] = useState(false);
            const [clockType, setClockType] = useState('in');
            const [gpsStatus, setGpsStatus] = useState({ type: 'loading', message: 'GPS 偵測中...' });
            const [timeOffset, setTimeOffset] = useState(0);
            const [timeSynced, setTimeSynced] = useState(false);
            const [networkTime, setNetworkTime] = useState(null);
            const [mapPreviewTarget, setMapPreviewTarget] = useState(null);
            const [previewImageUrl, setPreviewImageUrl] = useState(null);
            const [showCommunityPortal, setShowCommunityPortal] = useState(false);
            const [availableClockInLocations, setAvailableClockInLocations] = useState([]);
            const computeAvailableClockInLocations = () => {
                if (!dbUser) return [];
                const result = [];
                const companyId = (dbUser.companyIds && dbUser.companyIds.length > 0) ? dbUser.companyIds[0] : dbUser.companyId;
                const userCompany = (companies || []).find(c => c.id === companyId);
                if (userCompany) {
                    result.push({ ...userCompany, type: 'company', lat: userCompany.lat, lng: userCompany.lng });
                }
                const commIds = dbUser.communityIds || (dbUser.communityId ? [dbUser.communityId] : []);
                const comms = (communities || []).filter(c => commIds.includes(c.id)).map(c => ({ ...c, type: 'community', lat: c.coordLat, lng: c.coordLng }));
                result.push(...comms);
                result.push({ id: 'custom', name: '自定義地點', type: 'custom' });
                return result;
            };
            useEffect(() => {
                const locs = computeAvailableClockInLocations();
                setAvailableClockInLocations(locs);
            }, [dbUser, companies, communities]);
            const [showDescriptionModal, setShowDescriptionModal] = useState(false);
            const [selectedDescription, setSelectedDescription] = useState('');
            const [showCadreLeaveModal, setShowCadreLeaveModal] = useState(false);
            const [editingCadreLeave, setEditingCadreLeave] = useState(null);
            const [cadreLeaveLoading, setCadreLeaveLoading] = useState(false);
            const [pendingOutingReason, setPendingOutingReason] = useState('');
            const [showApprovalModal, setShowApprovalModal] = useState(false);
            const [selectedApprovalLeave, setSelectedApprovalLeave] = useState(null);
            const [adminEditData, setAdminEditData] = useState(null);
            const [showAdminEditModal, setShowAdminEditModal] = useState(false);
            const [showReviewModal, setShowReviewModal] = useState(false);
            const [reviewData, setReviewData] = useState(null);
            const [reportModalType, setReportModalType] = useState(null);
            const [isReportMonthOpen, setIsReportMonthOpen] = useState(false);
            const [reportSelectedUserIds, setReportSelectedUserIds] = useState([]);
            const [adminEditLoading, setAdminEditLoading] = useState(false);
            const [showAdminDeleteModal, setShowAdminDeleteModal] = useState(false);
            const [adminDeleteTarget, setAdminDeleteTarget] = useState(null);
            const [notificationToDeleteId, setNotificationToDeleteId] = useState(null);
            const [toast, setToast] = useState('');
            const [showMakeupModal, setShowMakeupModal] = useState(false);
            const [makeupDefaultType, setMakeupDefaultType] = useState('in');
            const [makeupForm, setMakeupForm] = useState({ timeType: 'in', locationId: '', reasonType: 'forgot', reasonText: '' });
            const [makeupDateStr, setMakeupDateStr] = useState('');
            const [makeupSchedule, setMakeupSchedule] = useState(null);
            const [showMakeupEditModal, setShowMakeupEditModal] = useState(false);
            const [editingMakeupRequest, setEditingMakeupRequest] = useState(null);
            const [makeupEditForm, setMakeupEditForm] = useState({ startTime: '', endTime: '', locationId: '', reasonType: 'forgot', reasonRemark: '' });
            const [signatures, setSignatures] = useState([]);
            const [showSignatureModal, setShowSignatureModal] = useState(false);
            const [signatureForm, setSignatureForm] = useState({ type: '', content: '' });
            const [signatureLoading, setSignatureLoading] = useState(false);
            const [showManualClockModal, setShowManualClockModal] = useState(false);
            const [manualClockForm, setManualClockForm] = useState({ userId: '', locationName: '', type: 'in', date: '', time: '', shift: 'day' });

            useEffect(() => {
                if (signatureTypes.length > 0 && !signatureForm.type) {
                    setSignatureForm(prev => ({ ...prev, type: signatureTypes[0].name }));
                }
            }, [signatureTypes]);
            const [signatureError, setSignatureError] = useState('');
            const [signatureEditTarget, setSignatureEditTarget] = useState(null);
            
            const [signatureTypes, setSignatureTypes] = useState([]);
            const [confirmDelete, setConfirmDelete] = useState(null);

            useEffect(() => {
                if (!toast) return;
                const timer = setTimeout(() => {
                    setToast('');
                }, 3000);
                return () => clearTimeout(timer);
            }, [toast]);

            const handlePrintReport = () => {
                const el = document.getElementById('attendance-report');
                if (!el) return;
                window.print();
            };

            const handleExportExcel = () => {
                const el = document.getElementById('attendance-report');
                if (!el) return;
                const rows = Array.from(el.querySelectorAll('.divide-y > div.grid'));
                const header = ['日期','星期','上班時間','下班時間','判定工時','狀況','備註'];
                const data = rows.map(row => {
                    const cells = Array.from(row.children).map(c => (c.textContent || '').replace(/\s+/g, ' ').trim());
                    return [
                        cells[0] || '',
                        cells[1] || '',
                        cells[2] || '',
                        cells[3] || '',
                        cells[4] || '',
                        cells[5] || '',
                        cells[6] || ''
                    ];
                });
                const u = usersList.find(x => x.id === cadreMapSelectedUserId);
                const ym = (cadreRecordDate || '').split('-').slice(0,2).join('-');
                const filename = `${ym}_${u?.name || '報表'}_出缺勤月報表.csv`;
                const csv = [header].concat(data).map(r => r.map(v => `"${(v||'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
                const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            // Fetch Signatures
            // Auto-set Cadre Company
            useEffect(() => {
                if (!dbUser || !companies.length) return;
                
                 let userCompany = null;
                 if (dbUser.companyIds && dbUser.companyIds.length > 0) {
                     userCompany = companies.find(c => dbUser.companyIds.includes(c.id));
                 } else if (dbUser.companyId) {
                     userCompany = companies.find(c => c.id === dbUser.companyId);
                 }
                 
                 if (userCompany) {
                     if (cadreCompany === '台北' || !cadreCompany) {
                         setCadreCompany(userCompany.name);
                     }
                 }
            }, [dbUser, companies, cadreCompany]);

            useEffect(() => {
                if (!dbUser || !dbUser.id) return;
                
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'leaves'),
                    where('userId', '==', dbUser.id)
                );
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const list = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setMyLeaves(list);
                });
                return () => unsubscribe();
            }, [dbUser]);

            useEffect(() => {
                if (!dbUser || !dbUser.id) return;
                
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'signatures'),
                    where('userId', '==', dbUser.id)
                );
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const list = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    list.sort((a, b) => {
                        const t1 = a.createdAt?.seconds || 0;
                        const t2 = b.createdAt?.seconds || 0;
                        return t2 - t1;
                    });
                    setSignatures(list);
                });
                return () => unsubscribe();
            }, [dbUser]);

            const handleAddSignature = async () => {
                let content = signatureForm.content || '';
                if (signatureForm.type && signatureForm.type.includes('請假')) {
                    const date = signatureForm.leaveDate || '';
                    if (!date) {
                        setSignatureError('請輸入請假日期');
                        return;
                    }
                    const hasTimes = signatureForm.leaveStartTime && signatureForm.leaveEndTime;
                    const timeRange = hasTimes ? `${signatureForm.leaveStartTime}-${signatureForm.leaveEndTime}` : '';
                    const reason = signatureForm.leaveReason || '請假';
                    const note = signatureForm.note || '';
                    content = `請假 ${date} ${timeRange} 事由:${reason} 說明:${note}`.trim();
                } else {
                    if (!content.trim()) {
                        setSignatureError('請輸入內容');
                        return;
                    }
                }
                setSignatureLoading(true);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'signatures'), {
                        userId: dbUser.id,
                        userName: dbUser.name,
                        userAvatar: dbUser.avatarUrl || '',
                        type: signatureForm.type,
                        content,
                        status: 'pending',
                        createdAt: serverTimestamp(),
                        responses: []
                    });
                    setToast('簽呈已送出');
                    setShowSignatureModal(false);
                    setSignatureForm({ type: signatureTypes.length > 0 ? signatureTypes[0].name : '', content: '' });
                } catch (e) {
                    console.error(e);
                    setSignatureError(e.message);
                } finally {
                    setSignatureLoading(false);
                }
            };

            const [cadreSignatures, setCadreSignatures] = useState([]);

            // Fetch Cadre Signatures (All)
            useEffect(() => {
                if (activeTab !== 'cadre') return;
                
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'signatures'),
                    orderBy('createdAt', 'desc')
                );
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const list = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setCadreSignatures(list);
                });
                return () => unsubscribe();
            }, [activeTab]);

            const handleUpdateSignatureStatus = async (signatureId, newStatus) => {
                if (!signatureId) return;
                try {
                    const label = newStatus === 'approved' ? '核准' : '駁回';
                    const target = cadreSignatures.find(s => s.id === signatureId);
                    const typeLabel = target ? (signatureTypeMap[target.type] || target.type) : '';
                    const contentPreview = (target?.content || '').slice(0, 50);
                    const msg = `確定要${label}此簽呈？\n類型: ${typeLabel}\n內容: ${contentPreview}${(target?.content || '').length > 50 ? '...' : ''}`;
                    
                    if (!window.confirm(msg)) return;
                    
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'signatures', signatureId), {
                        status: newStatus,
                        reviewedBy: dbUser.id,
                        reviewedAt: serverTimestamp()
                    });
                    setToast(newStatus === 'approved' ? '已核准' : '已駁回');
                } catch (e) {
                    console.error(e);
                    setToast('更新失敗: ' + e.message);
                }
            };
            
            const handleResetSignature = async (signatureId) => {
                if (!window.confirm('確定要重新審核此簽呈嗎？\n狀態將重設為「待簽核」。')) return;
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'signatures', signatureId), {
                        status: 'pending',
                        reviewedBy: null,
                        reviewedAt: null
                    });
                    setToast('已重設為待簽核');
                } catch (e) {
                    console.error(e);
                    setToast('重設失敗: ' + e.message);
                }
            };

            const signatureTypeMap = {
                '請假': '請假申請',
                '加班': '加班申請',
                '費用': '費用報銷',
                '採購': '採購申請',
                '其他': '其他事項'
            };

            const openEditSignature = (sig) => {
                const defaultType = (signatureTypes && signatureTypes.length > 0) ? signatureTypes[0].name : '請假申請';
                setSignatureForm({ type: signatureTypeMap[sig.type] || sig.type || defaultType, content: sig.content || '' });
                setSignatureError('');
                setSignatureEditTarget(sig.id);
                setShowSignatureModal(true);
            };

            const handleEditSignatureConfirm = async () => {
                if (!signatureEditTarget) return;
                if (!signatureForm.content.trim()) {
                    setSignatureError('請輸入內容');
                    return;
                }
                setSignatureLoading(true);
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'signatures', signatureEditTarget), {
                        type: signatureForm.type,
                        content: signatureForm.content,
                        updatedAt: serverTimestamp()
                    });
                    setToast('簽呈已更新');
                    setShowSignatureModal(false);
                    setSignatureEditTarget(null);
                    const defaultType = (signatureTypes && signatureTypes.length > 0) ? signatureTypes[0].name : '請假申請';
                    setSignatureForm({ type: defaultType, content: '' });
                } catch (e) {
                    console.error(e);
                    setSignatureError(e.message);
                } finally {
                    setSignatureLoading(false);
                }
            };

            const requestDeleteSignature = (sig) => {
                const label = signatureTypeMap[sig.type] || sig.type || '簽呈';
                setConfirmDelete({ type: 'signature', id: sig.id, label: label });
            };

            // Fetch Today's Schedules for Cadre Map Status
            useEffect(() => {
                if (activeTab !== 'cadre' || cadreSubtab !== 'map') return;
                
                // Get today's date string YYYY-MM-DD (Local Time)
                const now = new Date();
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const d = String(now.getDate()).padStart(2, '0');
                const todayDateStr = `${y}-${m}-${d}`;

                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'schedules'),
                    where('date', '==', todayDateStr)
                );

                const unsub = onSnapshot(q, (snap) => {
                    const scheds = {};
                    snap.forEach(doc => {
                        const data = doc.data();
                        if (data.userId) {
                            scheds[data.userId] = data;
                        }
                    });
                    setTodaySchedules(scheds);
                });

                return () => unsub();
            }, [activeTab, cadreSubtab]);

            const hasSubPermission = (pageKey, subKey) => {
                if (!dbUser) return false;
                if (dbUser.role === 'admin') return true;
                const userRole = roles.find(r => r.id === dbUser.role);
                if (!userRole) return false;
                if (!userRole.permissions?.includes(pageKey)) return false;
                if (!userRole.subPermissions || !userRole.subPermissions[pageKey]) return true;
                return userRole.subPermissions[pageKey].includes(subKey);
            };
            
            // Schedule Modal State
            const [showScheduleModal, setShowScheduleModal] = useState(false);
            const [scheduleModalDate, setScheduleModalDate] = useState(null);
            const [scheduleForm, setScheduleForm] = useState(() => {
                try {
                    const saved = localStorage.getItem('last_schedule_form');
                    return saved ? JSON.parse(saved) : {
                        type: 'work',
                        startTime: '08:00',
                        endTime: '17:00'
                    };
                } catch {
                    return {
                        type: 'work',
                        startTime: '08:00',
                        endTime: '17:00'
                    };
                }
            });
            const [scheduleSaving, setScheduleSaving] = useState(false);
            const [userSchedules, setUserSchedules] = useState({});
            const [userAttendanceRecords, setUserAttendanceRecords] = useState([]);
            const [userLeaveRequests, setUserLeaveRequests] = useState([]);
            
            // Persist Schedule State
            useEffect(() => {
                localStorage.setItem('last_active_tab', activeTab);
            }, [activeTab]);

            useEffect(() => {
                localStorage.setItem('last_cadre_subtab', cadreSubtab);
            }, [cadreSubtab]);

            useEffect(() => {
                localStorage.setItem('last_cadre_company', cadreCompany);
            }, [cadreCompany]);

            useEffect(() => {
                localStorage.setItem('last_cadre_record_date', cadreRecordDate);
            }, [cadreRecordDate]);

            useEffect(() => {
                localStorage.setItem('last_schedule_form', JSON.stringify(scheduleForm));
            }, [scheduleForm]);

            useEffect(() => {
                try {
                    if (cadreMapSelectedUserId) {
                        localStorage.setItem('last_selected_schedule_user_id', cadreMapSelectedUserId);
                    } else {
                        localStorage.removeItem('last_selected_schedule_user_id');
                    }
                } catch {}
            }, [cadreMapSelectedUserId]);



            useEffect(() => {
                // Clear schedules immediately when user changes to prevent ghost data
                setUserSchedules({});

                if (!cadreMapSelectedUserId) {
                    return;
                }

                // Query ALL schedules for this user (avoids composite index issue and allows instant month switching)
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'schedules'),
                    where('userId', '==', cadreMapSelectedUserId)
                );

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const newSchedules = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        newSchedules[data.date] = data;
                    });
                    console.log('Schedules loaded:', Object.keys(newSchedules).length);
                    setUserSchedules(newSchedules);
                }, (error) => {
                    console.error('Error fetching schedules:', error);
                });

                return () => unsubscribe();
            }, [cadreMapSelectedUserId]);

            // Fetch My Schedules for Clock Tab
            useEffect(() => {
                if (!dbUser) return;
                
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'schedules'),
                    where('userId', '==', dbUser.id)
                );

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const newSchedules = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        newSchedules[data.date] = data;
                    });
                    setMySchedules(newSchedules);
                });

                return () => unsubscribe();
            }, [dbUser]);

            useEffect(() => {
                setUserAttendanceRecords([]);
                setUserLeaveRequests([]);
                
                if (!cadreMapSelectedUserId) return;

                // Fetch Attendance
                const qAttendance = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'attendance'),
                    where('userId', '==', cadreMapSelectedUserId)
                );

                const unsubAttendance = onSnapshot(qAttendance, (snapshot) => {
                    const records = [];
                    snapshot.forEach(doc => records.push({ id: doc.id, ...doc.data() }));
                    setUserAttendanceRecords(records);
                });

                // Fetch Leaves
                const qLeaves = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'leaves'),
                    where('userId', '==', cadreMapSelectedUserId)
                );

                const unsubLeaves = onSnapshot(qLeaves, (snapshot) => {
                    const records = [];
                    snapshot.forEach(doc => records.push({ id: doc.id, ...doc.data() }));
                    setUserLeaveRequests(records);
                });

                return () => {
                    unsubAttendance();
                    unsubLeaves();
                };
            }, [cadreMapSelectedUserId]);

            const handleSaveSchedule = async () => {
                if (!cadreMapSelectedUserId) {
                    alert('請先選擇帳號');
                    return;
                }
                setScheduleSaving(true);
                try {
                    const dateStr = scheduleModalDate;
                    const docId = `schedule_${cadreMapSelectedUserId}_${dateStr}`;

                    // If user clicked Delete button or set type to empty (handled by separate function, but check here if needed)
                    // For "Delete" action, we'll have a separate function handleDeleteSchedule
                    
                    const scheduleData = {
                        userId: cadreMapSelectedUserId,
                        date: dateStr,
                        type: scheduleForm.type,
                        updatedByName: (dbUser && dbUser.name) || '系統管理員',
                        updatedAt: serverTimestamp()
                    };

                    if (!['off','leave','holiday'].includes(scheduleForm.type)) {
                        scheduleData.startTime = scheduleForm.startTime;
                        scheduleData.endTime = scheduleForm.endTime;
                        scheduleData.crossDay = scheduleForm.crossDay || false;
                    }

                    // Update local state immediately (Optimistic UI)
                    setUserSchedules(prev => ({
                        ...prev,
                        [dateStr]: scheduleData
                    }));

                    // Use setDoc to overwrite or create
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'schedules', docId), scheduleData);
                    
                    setToast('排班已儲存');
                    setShowScheduleModal(false);
                } catch (error) {
                    console.error('Error saving schedule:', error);
                    alert('儲存失敗: ' + error.message);
                } finally {
                    setScheduleSaving(false);
                }
            };

            const handleDeleteSchedule = () => {
                if (!cadreMapSelectedUserId || !scheduleModalDate) return;
                const docId = `schedule_${cadreMapSelectedUserId}_${scheduleModalDate}`;
                setConfirmDelete({ type: 'schedule', id: docId, label: `${scheduleModalDate} 排班` });
                setShowScheduleModal(false);
            };

            const handleAutoSchedule = async () => {
                const targetUserId = cadreMapSelectedUserId ? String(cadreMapSelectedUserId).trim() : null;
                if (!targetUserId) {
                    alert('請先選擇帳號');
                    return;
                }
                if (!confirm('確定要自動排班嗎？\n\n這將會：\n1. 設定週一至週四為「上班」\n2. 設定週五為「特休」\n3. 跳過假日及國定假日\n\n現有排班將被覆蓋。')) return;

                setScheduleSaving(true);
                try {
                    const year = cadreScheduleDate.getFullYear();
                    const month = cadreScheduleDate.getMonth();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    
                    // Taiwan National Holidays
                    const holidays = [
                        '2025-01-01', '2025-01-25', '2025-01-26', '2025-01-27', '2025-01-28', '2025-01-29', '2025-01-30', '2025-01-31', '2025-02-01', '2025-02-02', '2025-02-28', '2025-04-03', '2025-04-04', '2025-04-05', '2025-04-06', '2025-05-01', '2025-05-30', '2025-05-31', '2025-06-01', '2025-10-04', '2025-10-05', '2025-10-06', '2025-10-10', '2025-10-11', '2025-10-12', '2025-12-25',
                        '2026-01-01', '2026-02-14', '2026-02-15', '2026-02-16', '2026-02-17', '2026-02-18', '2026-02-19', '2026-02-20', '2026-02-21', '2026-02-22', '2026-02-27', '2026-02-28', '2026-03-01', '2026-04-03', '2026-04-04', '2026-04-05', '2026-04-06', '2026-05-01', '2026-06-19', '2026-06-20', '2026-06-21', '2026-09-25', '2026-09-26', '2026-09-27', '2026-10-09', '2026-10-10', '2026-10-11', '2026-12-25'
                    ];

                    const promises = [];
                    const newSchedules = { ...userSchedules };
                    let updateCount = 0;

                    for (let d = 1; d <= daysInMonth; d++) {
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                        
                        if (holidays.includes(dateStr)) continue;

                        const date = new Date(year, month, d);
                        const day = date.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat

                        if (day === 0 || day === 6) continue;

                        let scheduleType = null;
                        if (day >= 1 && day <= 4) { // Mon-Thu
                            scheduleType = 'work';
                        } else if (day === 5) { // Fri
                            scheduleType = 'off';
                        }

                        if (scheduleType) {
                            const docId = `schedule_${targetUserId}_${dateStr}`;
                            const scheduleData = {
                                userId: targetUserId,
                                date: dateStr,
                                type: scheduleType,
                                updatedByName: (dbUser && dbUser.name) || '系統管理員',
                                updatedAt: new Date()
                            };
                            
                            if (scheduleType === 'work') {
                                if (isNightShift) {
                                    scheduleData.startTime = '12:00';
                                    scheduleData.endTime = '12:00';
                                    scheduleData.crossDay = true;
                                } else {
                                    scheduleData.startTime = '09:00';
                                    scheduleData.endTime = '17:30';
                                    scheduleData.crossDay = false;
                                }
                            }

                            promises.push(setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'schedules', docId), scheduleData));
                            newSchedules[dateStr] = scheduleData;
                            updateCount++;
                        }
                    }

                    if (updateCount > 0) {
                        await Promise.all(promises);
                        // setUserSchedules(newSchedules); // onSnapshot will handle this
                        setToast(`已自動設定 ${updateCount} 筆排班`);
                    } else {
                        setToast('本月份無需自動排班');
                    }
                } catch (error) {
                    console.error('Error auto scheduling:', error);
                    setToast('自動排班失敗: ' + (error.message || JSON.stringify(error)));
                } finally {
                    setScheduleSaving(false);
                }
            };

            const handleAdminDeleteRecord = (record) => {
                setAdminDeleteTarget(record);
                setShowAdminDeleteModal(true);
            };

            const confirmAdminDelete = async () => {
                if (!adminDeleteTarget) return;
                try {
                    // Check if it's a leave record from 'leaves' collection
                    const collectionName = (adminDeleteTarget.approvalStatus || adminDeleteTarget.leaveStartDate) ? 'leaves' : 'attendance';
                    
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, adminDeleteTarget.id));
                    
                    // If it was a leave, also remove related schedule
                    if (collectionName === 'leaves') {
                        const qSchedule = query(
                            collection(db, 'artifacts', appId, 'public', 'data', 'schedules'),
                            where('leaveId', '==', adminDeleteTarget.id)
                        );
                        const scheduleSnap = await getDocs(qSchedule);
                        for (const d of scheduleSnap.docs) {
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'schedules', d.id));
                        }
                    }

                    setToast('刪除成功');
                    setShowAdminDeleteModal(false);
                    setAdminDeleteTarget(null);
                } catch (err) {
                    console.error(err);
                    setToast('刪除失敗: ' + err.message);
                }
            };

                const handleAdminEditRecord = async (formData) => {
                if (!adminEditData) return;
                setAdminEditLoading(true);
                try {
                    const newDate = new Date(`${formData.date}T${formData.time}`);
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', adminEditData.id), {
                        type: formData.type,
                        timestamp: newDate,
                        checkInLocationName: formData.locationName || null,
                        address: formData.locationName || null,
                        isNightShift: formData.shift === 'night',
                        updatedAt: serverTimestamp()
                    });
                    
                    alert('修改成功');
                    setShowAdminEditModal(false);
                    setAdminEditData(null);
                } catch (e) {
                    console.error(e);
                    alert('修改失敗: ' + e.message);
                } finally {
                    setAdminEditLoading(false);
                }
            };

            const handleReviewApprove = async () => {
                if (!reviewData || !reviewData.modification) return;
                
                const mod = reviewData.modification;
                const typeMap = {
                    'in': '上班',
                    'out': '下班',
                    'outing_start': '外出',
                    'outing_arrive': '抵達',
                    'outing_end': '離開',
                    'late_in': '卡班上班',
                    'late_out': '卡班下班'
                };
                const msg = `確定要核准此修改？\n\n修改為: ${typeMap[mod.type] || mod.type}\n時間: ${mod.date} ${mod.time}\n原因: ${mod.reason || '無'}`;
                
                if (!window.confirm(msg)) return;

                try {
                    const newDate = new Date(`${mod.date}T${mod.time}`);
                    
                    // Capture original state if not already captured
                    const originalType = reviewData.modification.originalType || reviewData.type;
                    const originalTimestamp = reviewData.modification.originalTimestamp || reviewData.timestamp;

                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', reviewData.id), {
                        type: mod.type,
                        timestamp: newDate,
                        modification: {
                            ...mod,
                            status: 'approved',
                            reviewTime: new Date(),
                            reviewerName: dbUser.name,
                            originalType: originalType,
                            originalTimestamp: originalTimestamp
                        }
                    });
                    setToast('已核准修改');
                    setShowReviewModal(false);
                    setReviewData(null);
                } catch (e) {
                    console.error(e);
                    alert('核准失敗: ' + e.message);
                }
            };

            const handleReviewReject = async () => {
                if (!reviewData || !reviewData.modification) return;

                if (!window.confirm('確定要駁回此修改申請？')) return;

                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', reviewData.id), {
                        modification: {
                            ...reviewData.modification,
                            status: 'rejected',
                            reviewTime: new Date(),
                            reviewerName: dbUser.name
                        }
                    });
                    setToast('已駁回');
                    setShowReviewModal(false);
                    setReviewData(null);
                } catch (e) {
                    console.error(e);
                    alert('駁回失敗: ' + e.message);
                }
            };

            const handleQuickReject = async (r) => {
                if (!window.confirm('確定要駁回此修改申請？')) return;
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', r.id), {
                        modification: {
                            ...r.modification,
                            status: 'rejected',
                            reviewTime: new Date(),
                            reviewerName: dbUser.name
                        }
                    });
                    setToast('已駁回');
                } catch (e) {
                    console.error(e);
                    alert('駁回失敗: ' + e.message);
                }
            };

            const handleQuickApprove = async (r) => {
                const mod = r.modification;
                const typeMap = {
                    'in': '上班',
                    'out': '下班',
                    'outing_start': '外出',
                    'outing_arrive': '抵達',
                    'outing_end': '離開',
                    'late_in': '卡班上班',
                    'late_out': '卡班下班'
                };
                const msg = `確定要核准此修改？\n\n修改為: ${typeMap[mod.type] || mod.type}\n時間: ${mod.date} ${mod.time}\n原因: ${mod.reason || '無'}`;
                if (!window.confirm(msg)) return;
                
                try {
                    const newDate = new Date(`${mod.date}T${mod.time}`);
                    
                    // Capture original state if not already captured
                    const originalType = r.modification.originalType || r.type;
                    const originalTimestamp = r.modification.originalTimestamp || r.timestamp;

                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', r.id), {
                        type: mod.type,
                        timestamp: newDate,
                        modification: {
                            ...mod,
                            status: 'approved',
                            reviewTime: new Date(),
                            reviewerName: dbUser.name,
                            originalType: originalType,
                            originalTimestamp: originalTimestamp
                        }
                    });
                    setToast('已核准');
                } catch (e) {
                    console.error(e);
                    alert('核准失敗: ' + e.message);
                }
            };

            const handleResetModification = async (r) => {
                if (!r?.modification) return;
                if (!confirm('要將此修改重設為「待審核」嗎？')) return;
                try {
                    const updates = {
                        modification: {
                            ...r.modification,
                            status: 'pending',
                            reviewTime: null,
                            reviewerName: ''
                        }
                    };

                    // If we have original data stored, restore it
                    if (r.modification.originalType && r.modification.originalTimestamp) {
                        updates.type = r.modification.originalType;
                        updates.timestamp = r.modification.originalTimestamp;
                        
                        // Keep original values in modification object just in case? 
                        // Or maybe we don't need to clear them, but let's leave them for now or clear them?
                        // If we revert to pending, and then approve again, we might want to keep them or re-capture.
                        // Re-capturing in handleQuickApprove handles "not already captured", so it's fine.
                        // But if we restore, r.type becomes originalType.
                        // So next approval will see r.type as originalType.
                    }

                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', r.id), updates);
                    setToast('已重設為待審核');
                } catch (e) {
                    console.error(e);
                    alert('重設失敗: ' + e.message);
                }
            };

            // Helper to suppress network noise - Defined at component level for reuse
            const handleFetchError = (err, context) => {
                const msg = (err.message || '').toLowerCase();
                // Ignore common network/offline errors
                if (
                    msg.includes('offline') || 
                    msg.includes('network') || 
                    msg.includes('fetch') ||
                    msg.includes('aborted') ||
                    err.code === 'unavailable' ||
                    err.code === 'resource-exhausted' ||
                    err.name === 'FirebaseError' // Often wraps network issues
                ) {
                    return; 
                }
                // Only log critical application errors
                console.error(`Error fetching ${context}:`, err);
                // Only show UI error for permission issues
                if (msg.includes('permission') || err.code === 'permission-denied') {
                        setFetchError('資料讀取權限不足，請更新 Firestore 規則');
                }
            };

            useEffect(() => {
                const updateTime = () => {
                    const now = new Date();
                    setTimeOffset(0);
                    setNetworkTime(now);
                    setTimeSynced(true);
                };
                updateTime();
                const timer = setInterval(updateTime, 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                const deleteAdmin = async () => {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('email', '==', 'admin@sys.com'));
                    const snap = await getDocs(q);
                    snap.forEach(async (d) => {
                        await deleteDoc(d.ref);
                        // Silently deleted admin
                    });
                };
                deleteAdmin();
            }, []);
            const availablePages = [
                { key: 'home', label: '首頁' },
                { key: 'overview', label: '總覽' },
                { key: 'clock', label: '打卡' },
                { key: 'community', label: '社區' },
                { key: 'function', label: '功能' },
                { key: 'cadre', label: '幹部' },
                { key: 'application', label: '申請' },
                { key: 'settings', label: '設定' }
            ];
            
            const switchTab = (tab) => {
                setActiveTab(tab);
                if (tab === 'overview') {
                    setOverviewSubtab('district');
                }
                if (tab === 'settings') {
                    setSettingsSubtab('general');
                }
                if (tab === 'clock') {
                    setClockSubtab('work');
                }
                if (tab === 'cadre') {
                    setCadreSubtab('map');
                }
            };

            const handleOverviewCompanyChange = (name) => {
                if (name === overviewCompany) return;

                // Update Meeting Dates
                setOverviewMeetingDatesByCompany(prev => {
                    const prevKey = overviewCompany || 'default';
                    const updated = { ...prev, [prevKey]: overviewMeetingDate };
                    const nextDate = updated[name] || overviewMeetingDate;
                    setOverviewMeetingDate(nextDate);
                    return updated;
                });

                // Update District Meeting Dates
                setOverviewDistrictMeetingDatesByCompany(prev => {
                    const prevKey = overviewCompany || 'default';
                    const updated = { ...prev, [prevKey]: overviewDistrictMeetingDate };
                    const nextDate = updated[name] || overviewDistrictMeetingDate;
                    setOverviewDistrictMeetingDate(nextDate);
                    return updated;
                });

                // Update Activity Dates
                setOverviewActivityDatesByCompany(prev => {
                    const prevKey = overviewCompany || 'default';
                    const updated = { ...prev, [prevKey]: overviewActivityDate };
                    const nextDate = updated[name] || overviewActivityDate;
                    setOverviewActivityDate(nextDate);
                    return updated;
                });

                // Update Presentation Dates
                setOverviewPresentationDatesByCompany(prev => {
                    const prevKey = overviewCompany || 'default';
                    const updated = { ...prev, [prevKey]: overviewPresentationDate };
                    const nextDate = updated[name] || overviewPresentationDate;
                    setOverviewPresentationDate(nextDate);
                    return updated;
                });

                setOverviewCompany(name);
            };

            const changeOverviewMeetingMonth = (delta) => {
                setOverviewMeetingDatesByCompany(prev => {
                    const key = overviewCompany || 'default';
                    const baseDate = prev[key] || overviewMeetingDate;
                    const nextDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + delta, 1);
                    const updated = { ...prev, [key]: nextDate };
                    setOverviewMeetingDate(nextDate);
                    setOverviewMeetingSelectedDate(nextDate);
                    return updated;
                });
            };

            const openOverviewMeetingModal = () => {
                const d = overviewMeetingSelectedDate || overviewMeetingDate || new Date();
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const dateStr = `${y}-${m}-${day}`;
                setOverviewMeetingForm({
                    communityId: '',
                    type: '例會',
                    date: dateStr,
                    time: '',
                    participants: [],
                    leaderId: '',
                    description: '',
                    otherParticipants: ''
                });
                setOverviewMeetingModalOpen(true);
            };

            const handleOverviewMeetingFormChange = (field, value) => {
                setOverviewMeetingForm(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            const handleOverviewMeetingParticipantToggle = (userId, isChecked) => {
                setOverviewMeetingForm(prev => {
                    let nextParticipants = Array.isArray(prev.participants) ? [...prev.participants] : [];
                    if (isChecked) {
                        if (!nextParticipants.includes(userId)) {
                            nextParticipants.push(userId);
                        }
                    } else {
                        nextParticipants = nextParticipants.filter(id => id !== userId);
                    }
                    const nextLeader = nextParticipants.includes(prev.leaderId) ? prev.leaderId : '';
                    return {
                        ...prev,
                        participants: nextParticipants,
                        leaderId: nextLeader
                    };
                });
            };

            const handleSaveOverviewMeeting = async () => {
                if (!overviewMeetingForm.date) return;
                
                try {
                    const payload = {
                        companyName: overviewCompany,
                        communityId: overviewMeetingForm.communityId,
                        type: overviewMeetingForm.type,
                        date: overviewMeetingForm.date,
                        time: overviewMeetingForm.time,
                        participants: overviewMeetingForm.participants,
                        leaderId: overviewMeetingForm.leaderId,
                        description: overviewMeetingForm.description,
                        updatedBy: dbUser?.name || 'unknown',
                        updatedAt: serverTimestamp()
                    };

                    if (overviewMeetingForm.id) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'overview_meetings', overviewMeetingForm.id), payload);
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'overview_meetings'), {
                            ...payload,
                            creatorId: dbUser?.id,
                            creatorName: dbUser?.name || '未記錄',
                            createdAt: serverTimestamp()
                        });
                    }
                    setOverviewMeetingModalOpen(false);
                } catch (e) {
                    console.error('Save meeting error', e);
                    alert('儲存失敗');
                }
            };

            // District Meeting Handlers
            const changeOverviewDistrictMeetingMonth = (delta) => {
                setOverviewDistrictMeetingDatesByCompany(prev => {
                    const key = overviewCompany || 'default';
                    const baseDate = prev[key] || overviewDistrictMeetingDate;
                    const nextDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + delta, 1);
                    const updated = { ...prev, [key]: nextDate };
                    setOverviewDistrictMeetingDate(nextDate);
                    setOverviewDistrictMeetingSelectedDate(nextDate);
                    return updated;
                });
            };

            const openOverviewDistrictMeetingModal = () => {
                const d = overviewDistrictMeetingSelectedDate || overviewDistrictMeetingDate || new Date();
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const dateStr = `${y}-${m}-${day}`;
                setOverviewDistrictMeetingForm({
                    communityId: '',
                    type: '區大',
                    date: dateStr,
                    time: '',
                    participants: [],
                    leaderId: '',
                    description: '',
                    otherParticipants: ''
                });
                setOverviewDistrictMeetingModalOpen(true);
            };

            const handleOverviewDistrictMeetingFormChange = (field, value) => {
                setOverviewDistrictMeetingForm(prev => ({ ...prev, [field]: value }));
            };

            const handleOverviewDistrictMeetingParticipantToggle = (userId, isChecked) => {
                setOverviewDistrictMeetingForm(prev => {
                    let nextParticipants = Array.isArray(prev.participants) ? [...prev.participants] : [];
                    if (isChecked) {
                        if (!nextParticipants.includes(userId)) nextParticipants.push(userId);
                    } else {
                        nextParticipants = nextParticipants.filter(id => id !== userId);
                    }
                    const nextLeader = nextParticipants.includes(prev.leaderId) ? prev.leaderId : '';
                    return { ...prev, participants: nextParticipants, leaderId: nextLeader };
                });
            };

            const handleSaveOverviewDistrictMeeting = async () => {
                if (!overviewDistrictMeetingForm.date) return;
                try {
                    const payload = {
                        companyName: overviewCompany,
                        communityId: overviewDistrictMeetingForm.communityId,
                        type: overviewDistrictMeetingForm.type,
                        date: overviewDistrictMeetingForm.date,
                        time: overviewDistrictMeetingForm.time,
                        participants: overviewDistrictMeetingForm.participants,
                        leaderId: overviewDistrictMeetingForm.leaderId,
                        description: overviewDistrictMeetingForm.description,
                        updatedBy: dbUser?.name || 'unknown',
                        updatedAt: serverTimestamp()
                    };

                    if (overviewDistrictMeetingForm.id) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'overview_district_meetings', overviewDistrictMeetingForm.id), payload);
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'overview_district_meetings'), {
                            ...payload,
                            creatorId: dbUser?.id,
                            creatorName: dbUser?.name || '未記錄',
                            createdAt: serverTimestamp()
                        });
                    }
                    setOverviewDistrictMeetingModalOpen(false);
                } catch(e) {
                    console.error(e);
                    alert('儲存失敗');
                }
            };

            const handleEditOverviewDistrictMeeting = (meeting) => {
                setOverviewDistrictMeetingForm({
                    id: meeting.id,
                    communityId: meeting.communityId || '',
                    type: meeting.type || '區大',
                    date: meeting.date,
                    time: meeting.time,
                    participants: meeting.participants || [],
                    leaderId: meeting.leaderId || '',
                    description: meeting.description || ''
                });
                setOverviewDistrictMeetingModalOpen(true);
            };

            const handleDeleteOverviewDistrictMeeting = async (meetingId) => {
                if (confirm('確定要刪除此區大嗎？')) {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'overview_district_meetings', meetingId));
                    } catch(e) {
                        console.error(e);
                        alert('刪除失敗');
                    }
                }
            };

            // Activity Handlers
            const changeOverviewActivityMonth = (delta) => {
                setOverviewActivityDatesByCompany(prev => {
                    const key = overviewCompany || 'default';
                    const baseDate = prev[key] || overviewActivityDate;
                    const nextDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + delta, 1);
                    const updated = { ...prev, [key]: nextDate };
                    setOverviewActivityDate(nextDate);
                    setOverviewActivitySelectedDate(nextDate);
                    return updated;
                });
            };

            const openOverviewActivityModal = () => {
                const d = overviewActivitySelectedDate || overviewActivityDate || new Date();
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const dateStr = `${y}-${m}-${day}`;
                setOverviewActivityForm({
                    communityId: '',
                    type: '節日活動',
                    date: dateStr,
                    time: '',
                    participants: [],
                    leaderId: '',
                    description: '',
                    otherParticipants: ''
                });
                setOverviewActivityModalOpen(true);
            };

            const handleOverviewActivityFormChange = (field, value) => {
                setOverviewActivityForm(prev => ({ ...prev, [field]: value }));
            };

            const handleOverviewActivityParticipantToggle = (userId, isChecked) => {
                setOverviewActivityForm(prev => {
                    let nextParticipants = Array.isArray(prev.participants) ? [...prev.participants] : [];
                    if (isChecked) {
                        if (!nextParticipants.includes(userId)) nextParticipants.push(userId);
                    } else {
                        nextParticipants = nextParticipants.filter(id => id !== userId);
                    }
                    const nextLeader = nextParticipants.includes(prev.leaderId) ? prev.leaderId : '';
                    return { ...prev, participants: nextParticipants, leaderId: nextLeader };
                });
            };

            const handleSaveOverviewActivity = async () => {
                if (!overviewActivityForm.date) return;
                try {
                    const payload = {
                        companyName: overviewCompany,
                        communityId: overviewActivityForm.communityId,
                        type: overviewActivityForm.type,
                        date: overviewActivityForm.date,
                        time: overviewActivityForm.time,
                        participants: overviewActivityForm.participants,
                        leaderId: overviewActivityForm.leaderId,
                        description: overviewActivityForm.description,
                        updatedBy: dbUser?.name || 'unknown',
                        updatedAt: serverTimestamp()
                    };

                    if (overviewActivityForm.id) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'overview_activities', overviewActivityForm.id), payload);
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'overview_activities'), {
                            ...payload,
                            creatorId: dbUser?.id,
                            creatorName: dbUser?.name || '未記錄',
                            createdAt: serverTimestamp()
                        });
                    }
                    setOverviewActivityModalOpen(false);
                } catch(e) {
                    console.error(e);
                    alert('儲存失敗');
                }
            };

            const handleEditOverviewActivity = (meeting) => {
                setOverviewActivityForm({
                    id: meeting.id,
                    communityId: meeting.communityId || '',
                    type: meeting.type || '節日活動',
                    date: meeting.date,
                    time: meeting.time,
                    participants: meeting.participants || [],
                    leaderId: meeting.leaderId || '',
                    description: meeting.description || ''
                });
                setOverviewActivityModalOpen(true);
            };

            const handleDeleteOverviewActivity = async (meetingId) => {
                if (confirm('確定要刪除此活動嗎？')) {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'overview_activities', meetingId));
                    } catch(e) {
                        console.error(e);
                        alert('刪除失敗');
                    }
                }
            };

            // Presentation Handlers
            const changeOverviewPresentationMonth = (delta) => {
                setOverviewPresentationDatesByCompany(prev => {
                    const key = overviewCompany || 'default';
                    const baseDate = prev[key] || overviewPresentationDate;
                    const nextDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + delta, 1);
                    const updated = { ...prev, [key]: nextDate };
                    setOverviewPresentationDate(nextDate);
                    setOverviewPresentationSelectedDate(nextDate);
                    return updated;
                });
            };

            const openOverviewPresentationModal = () => {
                const d = overviewPresentationSelectedDate || overviewPresentationDate || new Date();
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const dateStr = `${y}-${m}-${day}`;
                setOverviewPresentationForm({
                    communityId: '',
                    type: '簡報',
                    date: dateStr,
                    time: '',
                    participants: [],
                    leaderId: '',
                    description: ''
                });
                setOverviewPresentationModalOpen(true);
            };

            const handleOverviewPresentationFormChange = (field, value) => {
                setOverviewPresentationForm(prev => ({ ...prev, [field]: value }));
            };

            const handleOverviewPresentationParticipantToggle = (userId, isChecked) => {
                setOverviewPresentationForm(prev => {
                    let nextParticipants = Array.isArray(prev.participants) ? [...prev.participants] : [];
                    if (isChecked) {
                        if (!nextParticipants.includes(userId)) nextParticipants.push(userId);
                    } else {
                        nextParticipants = nextParticipants.filter(id => id !== userId);
                    }
                    const nextLeader = nextParticipants.includes(prev.leaderId) ? prev.leaderId : '';
                    return { ...prev, participants: nextParticipants, leaderId: nextLeader };
                });
            };

            const handleSaveOverviewPresentation = async () => {
                if (!overviewPresentationForm.date) return;
                try {
                    const payload = {
                        companyName: overviewCompany,
                        communityId: overviewPresentationForm.communityId,
                        type: overviewPresentationForm.type,
                        date: overviewPresentationForm.date,
                        time: overviewPresentationForm.time,
                        participants: overviewPresentationForm.participants,
                        leaderId: overviewPresentationForm.leaderId,
                        description: overviewPresentationForm.description,
                        updatedBy: dbUser?.name || 'unknown',
                        updatedAt: serverTimestamp()
                    };

                    if (overviewPresentationForm.id) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'overview_presentations', overviewPresentationForm.id), payload);
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'overview_presentations'), {
                            ...payload,
                            creatorId: dbUser?.id,
                            creatorName: dbUser?.name || '未記錄',
                            createdAt: serverTimestamp()
                        });
                    }
                    setOverviewPresentationModalOpen(false);
                } catch(e) {
                    console.error(e);
                    alert('儲存失敗');
                }
            };

            const handleEditOverviewPresentation = (meeting) => {
                setOverviewPresentationForm({
                    id: meeting.id,
                    communityId: meeting.communityId || '',
                    type: meeting.type || '簡報',
                    date: meeting.date,
                    time: meeting.time,
                    participants: meeting.participants || [],
                    leaderId: meeting.leaderId || '',
                    description: meeting.description || ''
                });
                setOverviewPresentationModalOpen(true);
            };

            const handleDeleteOverviewPresentation = async (meetingId) => {
                if (confirm('確定要刪除此簡報嗎？')) {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'overview_presentations', meetingId));
                    } catch(e) {
                        console.error(e);
                        alert('刪除失敗');
                    }
                }
            };

             const handleCloseMeetingReminder = () => {
                 if (!dbUser || !meetingReminder) {
                     setMeetingReminder(null);
                     return;
                 }

                 // Handle 'New Meeting' notification acknowledgment
                 if (meetingReminder._notificationType === 'new') {
                     const ackKey = `meetingCreatedAck_${dbUser.id}_${meetingReminder.id}`;
                     try {
                         localStorage.setItem(ackKey, 'true');
                     } catch {}
                     setMeetingReminder(null);
                     return;
                 }

                 // Handle 'Day-of' reminder count logic
                 const today = new Date();
                 const y = today.getFullYear();
                 const m = String(today.getMonth() + 1).padStart(2, '0');
                 const d = String(today.getDate()).padStart(2, '0');
                 const todayKey = `${y}-${m}-${d}`;
                 const key = `meetingReminderClosed_${dbUser.id}_${meetingReminder.id}_${todayKey}`;
                 let count = 0;
                 try {
                     const stored = localStorage.getItem(key);
                     if (stored != null) {
                         const parsed = parseInt(stored, 10);
                         if (!isNaN(parsed)) count = parsed;
                     }
                 } catch {}
                 const next = count >= 2 ? 2 : count + 1;
                 try {
                     localStorage.setItem(key, String(next));
                 } catch {}
                 setMeetingReminder(null);
             };

            const handleEditOverviewMeeting = (meeting) => {
                setOverviewMeetingForm({
                    id: meeting.id,
                    communityId: meeting.communityId || '',
                    type: meeting.type || '例會',
                    date: meeting.date,
                    time: meeting.time,
                    participants: meeting.participants || [],
                    leaderId: meeting.leaderId || '',
                    description: meeting.description || ''
                });
                setOverviewMeetingModalOpen(true);
            };

            const handleDeleteOverviewMeeting = async (meetingId) => {
                if (confirm('確定要刪除此例會嗎？')) {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'overview_meetings', meetingId));
                    } catch(e) {
                        console.error(e);
                        alert('刪除失敗');
                    }
                }
            };
            
            const openCompleteOverviewMeetingModal = (meeting) => {
                setCompleteMeetingTarget(meeting);
                setCompleteMeetingForm({
                    minutes: meeting.minutes || '',
                    photos: Array.isArray(meeting.photos) ? meeting.photos : [],
                    isCompleted: meeting.completed || false
                });
                setCompleteMeetingModalOpen(true);
            };
            
            const handleCompleteMeetingFormChange = (field, value) => {
                setCompleteMeetingForm(prev => ({ ...prev, [field]: value }));
            };
            
            const handleCompletePhotoUpload = (fileList) => {
                const files = Array.from(fileList || []);
                if (files.length === 0) return;
                let results = [];
                let done = 0;
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        results.push({ name: file.name, dataUrl: e.target.result });
                        done += 1;
                        if (done === files.length) {
                            setCompleteMeetingForm(prev => ({
                                ...prev,
                                photos: [...(prev.photos || []), ...results]
                            }));
                        }
                    };
                    reader.readAsDataURL(file);
                });
            };
            
            const handleRemoveCompletePhoto = (index) => {
                setCompleteMeetingForm(prev => ({
                    ...prev,
                    photos: (prev.photos || []).filter((_, i) => i !== index)
                }));
            };
            
            const handleSaveCompleteOverviewMeeting = async () => {
                if (!completeMeetingTarget) return;
                
                try {
                    const payload = {
                        minutes: completeMeetingForm.minutes || '',
                        photos: Array.isArray(completeMeetingForm.photos) ? completeMeetingForm.photos : [],
                        completed: completeMeetingForm.isCompleted,
                        completedById: dbUser?.id,
                        completedByName: dbUser?.name || '未記錄',
                        completedAt: new Date().toISOString()
                    };

                    let collectionName = 'overview_meetings';
                    if (completeMeetingTarget.type === '區大' || completeMeetingTarget.type === '臨時區大') {
                        collectionName = 'overview_district_meetings';
                    } else if (completeMeetingTarget.type === '活動') {
                        collectionName = 'overview_activities';
                    } else if (completeMeetingTarget.type === '簡報') {
                        collectionName = 'overview_presentations';
                    }

                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, completeMeetingTarget.id), payload);

                    setCompleteMeetingModalOpen(false);
                    setCompleteMeetingTarget(null);
                } catch (e) {
                    console.error('Complete meeting error', e);
                    alert('儲存失敗');
                }
            };

            const hasPermission = (pageKey) => {
                if (!dbUser) return false;
                if (dbUser.role === 'admin') return true;
                const userRole = (roles || []).find(r => r.id === dbUser.role);
                return userRole?.permissions?.includes(pageKey) || false;
            };

            useEffect(() => {
                if (!dbUser) return;
                const allowed = availablePages.filter(p => hasPermission(p.key));
                if (allowed.length === 0) return;
                if (!allowed.some(p => p.key === activeTab)) {
                    setActiveTab(allowed[0].key);
                }
            }, [dbUser, roles, activeTab]);

            useEffect(() => {
                if (!navigator.geolocation) {
                    setGpsStatus({ type: 'error', message: '不支援 GPS' });
                    return;
                }

                let watchId = null;
                let isHighAccuracy = false;
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

                const startWatch = (highAccuracy, isFallback = false) => {
                    if (watchId !== null) navigator.geolocation.clearWatch(watchId);
                    
                    isHighAccuracy = highAccuracy;
                    console.log(`Starting GPS Watch (High Accuracy: ${highAccuracy}, Fallback: ${isFallback})`);

                    const options = highAccuracy ? {
                        enableHighAccuracy: true,
                        timeout: 20000,
                        maximumAge: 0
                    } : {
                        enableHighAccuracy: false,
                        timeout: 30000,
                        maximumAge: 60000
                    };

                    watchId = navigator.geolocation.watchPosition(
                        (pos) => {
                            const { accuracy } = pos.coords;
                            let source = 'GPS 衛星';
                            let type = 'success';
                            
                            if (accuracy > 100) {
                                source = 'Wi-Fi/基地台粗略';
                                type = 'warning';
                            } else if (accuracy > 30) {
                                source = 'Wi-Fi/行動網路';
                            }

                            setGpsStatus({ 
                                type: type, 
                                message: `${source}定位 (誤差 ${Math.round(accuracy)}m)` 
                            });
                        }, 
                        (err) => {
                            console.warn("GPS Watch Error:", err.code, err.message);
                            
                            // Retry Strategy
                            if (isHighAccuracy) {
                                // High Accuracy Failed
                                if (!isFallback) {
                                     // If we started with High (Mobile), fallback to Low
                                     console.log("High accuracy failed, falling back to Low Accuracy...");
                                     setGpsStatus({ type: 'loading', message: 'GPS 訊號弱，切換模式...' });
                                     startWatch(false, true);
                                     return;
                                }
                            } else {
                                // Low Accuracy Failed
                                if (!isMobile && !isFallback) {
                                    // Desktop started with Low. Try High as Auxiliary.
                                    console.log("Low accuracy failed on Desktop, trying High Accuracy...");
                                    setGpsStatus({ type: 'loading', message: '嘗試 GPS 定位...' });
                                    startWatch(true, true);
                                    return;
                                }
                            }

                            let msg = 'GPS 訊號異常';
                            if (err.code === 1) msg = '無 GPS 權限';
                            else if (err.code === 2) msg = '無法偵測位置';
                            else if (err.code === 3) msg = 'GPS 連線逾時';
                            
                            setGpsStatus({ type: 'error', message: msg });
                        }, 
                        options
                    );
                };

                // Priority: Mobile -> High Accuracy, Desktop -> Low Accuracy
                startWatch(isMobile);

                // Safety timeout is less relevant now as Low Accuracy is very reliable, 
                // but kept just in case
                const loadingTimeout = setTimeout(() => {
                    setGpsStatus(prev => {
                        if (prev.type === 'loading') {
                            // If stuck in loading (even Low Accuracy failed?), show error
                             return { type: 'error', message: '定位回應過慢，請確認網路' };
                        }
                        return prev;
                    });
                }, 15000);

                return () => {
                    if (watchId !== null) navigator.geolocation.clearWatch(watchId);
                    clearTimeout(loadingTimeout);
                };
            }, []);

            useEffect(() => {
                let mounted = true;
                const timer = setTimeout(() => {
                    if (mounted) setLoading(false);
                }, 3000);
                
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        }
                    } catch (e) {
                        console.error("Auth init error", e);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                    clearTimeout(timer);
                    if (u) {
                        (async () => {
                            try {
                                const q = query(
                                    collection(db, 'artifacts', appId, 'public', 'data', 'users'),
                                    where('email', '==', u.email || '')
                                );
                                const snap = await getDocs(q);
                                if (!snap.empty) {
                                    const data = { id: snap.docs[0].id, ...snap.docs[0].data() };
                                    data.status = data.status || '在職';
                                    if (data.status === '離職') {
                                        const today = new Date();
                                        today.setHours(0,0,0,0);
                                        let shouldBlock = true;
                                        if (data.resignDate) {
                                            const rDate = new Date(data.resignDate);
                                            // If resign date is in the future, allow login
                                            if (rDate > today) shouldBlock = false;
                                        }
                                        if (shouldBlock) {
                                            await signOut(auth);
                                            setDbUser(null);
                                            setView('login');
                                            return;
                                        }
                                    }
                                    const comm = communities.find(c => c.id === data.communityId);
                                    data.communityName = comm ? comm.name : (data.communityId === 'SYSTEM' ? '總部系統' : '未分配');
                                    setDbUser(data);
                                    setView('dashboard');
                                } else {
                                    setView('dashboard');
                                }
                            } catch {
                                setView('dashboard');
                            }
                        })();
                    } else {
                        setDbUser(null);
                        setView('login');
                    }
                });
                const onlineHandler = () => setIsOnline(true);
                const offlineHandler = () => setIsOnline(false);
                window.addEventListener('online', onlineHandler);
                window.addEventListener('offline', offlineHandler);
                return () => {
                    mounted = false;
                    unsubscribe();
                    clearTimeout(timer);
                    window.removeEventListener('online', onlineHandler);
                    window.removeEventListener('offline', offlineHandler);
                };
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubscribes = [];

                // Communities
                unsubscribes.push(onSnapshot(
                    collection(db, 'artifacts', appId, 'public', 'data', 'communities'),
                    (snap) => setCommunities(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
                    (err) => handleFetchError(err, 'communities_snap')
                ));

                // Roles
                unsubscribes.push(onSnapshot(
                    collection(db, 'artifacts', appId, 'public', 'data', 'roles'),
                    (snap) => {
                        const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        list.sort((a, b) => (a.order || 0) - (b.order || 0));
                        setRoles(list);
                    },
                    (err) => handleFetchError(err, 'roles_snap')
                ));

                return () => unsubscribes.forEach(u => u());
            }, [user]);

            // 1. Stable Data (Companies, Areas, Users, All Attendance)
            useEffect(() => {
                if (!user || !dbUser) return;
                
                const unsubscribes = [];
                const isManagerOrAdmin = ['admin', 'manager', 'hr', 'cadre'].includes(dbUser.role);
                
                // Always fetch reference data to prevent connection cycling
                const refCompanies = collection(db, 'artifacts', appId, 'public', 'data', 'companies');
                const refAreas = collection(db, 'artifacts', appId, 'public', 'data', 'areas');
                const refSignatureTypes = collection(db, 'artifacts', appId, 'public', 'data', 'signature_types');
                const refUsers = collection(db, 'artifacts', appId, 'public', 'data', 'users');

                unsubscribes.push(onSnapshot(refCompanies, 
                    (snap) => setCompanies(snap.docs.map(d => ({ id: d.id, ...d.data() }))), 
                    (e) => handleFetchError(e, 'companies_snap')
                ));
                unsubscribes.push(onSnapshot(refAreas, 
                    (snap) => setAreas(snap.docs.map(d => ({ id: d.id, ...d.data() }))), 
                    (e) => handleFetchError(e, 'areas_snap')
                ));
                unsubscribes.push(onSnapshot(refSignatureTypes,
                    (snap) => {
                        const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        list.sort((a, b) => (a.order || 0) - (b.order || 0));
                        setSignatureTypes(list);
                    },
                    (e) => console.log('signature_types fetch error', e)
                ));
                unsubscribes.push(onSnapshot(refUsers,  
                    (snap) => setUsersList(snap.docs.map(d => ({ id: d.id, ...d.data() }))), 
                    (e) => handleFetchError(e, 'users_snap')
                ));

                // All Attendance (Manager Only)
                // Check if user is admin/manager/hr/cadre OR has cadre permission via custom role
                const hasCadrePermission = (roles || []).find(r => r.id === dbUser.role)?.permissions?.includes('cadre');
                const shouldFetchAllAttendance = ['admin', 'manager', 'hr', 'cadre'].includes(dbUser.role) || hasCadrePermission;

                if (shouldFetchAllAttendance) {
                    // Removed dateLimit filter to allow fetching records with malformed timestamp (Map instead of Timestamp)
                    // This ensures records that were incorrectly saved (previous bug) can still be retrieved.
                    // We use limit(2000) to keep足夠資料供幹部檢視地圖與紀錄。

                    const qAll = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), 
                        orderBy('timestamp', 'desc'),
                        limit(2000)
                    );
                    
                    unsubscribes.push(onSnapshot(qAll, 
                        (snap) => setAttendanceList(snap.docs.map(d => ({ id: d.id, ...d.data() }))), 
                        (e) => handleFetchError(e, 'attendance_all_snap')
                    ));

                    // Fetch All Leaves (for Cadre/Admin/Manager/HR)
                    const qAllLeaves = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'leaves'),
                        orderBy('timestamp', 'desc'),
                        limit(2000)
                    );
                    unsubscribes.push(onSnapshot(qAllLeaves,
                        (snap) => setLeavesList(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
                        (e) => handleFetchError(e, 'leaves_all_snap')
                    ));

                    // Fetch Make-up Requests (for Cadre/Admin/Manager/HR)
                    const qMakeup = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'makeup_requests'),
                        orderBy('createdAt', 'desc')
                    );
                    unsubscribes.push(onSnapshot(qMakeup,
                        (snap) => setMakeupRequests(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
                        (e) => handleFetchError(e, 'makeup_requests_snap')
                    ));
                }

                // Fetch Overview Data
                const hasOverviewPerm = ['admin', 'manager', 'hr'].includes(dbUser.role) || 
                                      (roles || []).find(r => r.id === dbUser.role)?.permissions?.includes('overview');
                
                if (hasOverviewPerm) {
                    const qOverviewMeetings = query(collection(db, 'artifacts', appId, 'public', 'data', 'overview_meetings'));
                    unsubscribes.push(onSnapshot(qOverviewMeetings, (snap) => setOverviewMeetings(snap.docs.map(d => ({ id: d.id, ...d.data() })))));

                    const qOverviewDistrictMeetings = query(collection(db, 'artifacts', appId, 'public', 'data', 'overview_district_meetings'));
                    unsubscribes.push(onSnapshot(qOverviewDistrictMeetings, (snap) => setOverviewDistrictMeetings(snap.docs.map(d => ({ id: d.id, ...d.data() })))));

                    const qOverviewActivities = query(collection(db, 'artifacts', appId, 'public', 'data', 'overview_activities'));
                    unsubscribes.push(onSnapshot(qOverviewActivities, (snap) => setOverviewActivities(snap.docs.map(d => ({ id: d.id, ...d.data() })))));

                    const qOverviewPresentations = query(collection(db, 'artifacts', appId, 'public', 'data', 'overview_presentations'));
                    unsubscribes.push(onSnapshot(qOverviewPresentations, (snap) => setOverviewPresentations(snap.docs.map(d => ({ id: d.id, ...d.data() })))));
                }

                return () => unsubscribes.forEach(u => u());
            }, [user, dbUser, roles]);

            // Fetch Schedules for Report (Monthly)
            useEffect(() => {
                if (!dbUser || !cadreRecordDate) return;
                
                const hasCadrePermission = (roles || []).find(r => r.id === dbUser.role)?.permissions?.includes('cadre');
                const shouldFetch = ['admin', 'manager', 'hr', 'cadre'].includes(dbUser.role) || hasCadrePermission;
                if (!shouldFetch) return;

                const targetDate = new Date(cadreRecordDate);
                const targetYear = targetDate.getFullYear();
                const targetMonth = targetDate.getMonth();
                // Format YYYY-MM-DD
                const startOfMonthStr = `${targetYear}-${String(targetMonth+1).padStart(2,'0')}-01`;
                const lastDay = new Date(targetYear, targetMonth + 1, 0).getDate();
                const endOfMonthStr = `${targetYear}-${String(targetMonth+1).padStart(2,'0')}-${lastDay}`;

                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'schedules'),
                    where('date', '>=', startOfMonthStr),
                    where('date', '<=', endOfMonthStr)
                );

                const unsubscribe = onSnapshot(q, (snap) => {
                    setSchedulesList(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                }, (e) => console.error('Error fetching schedules list:', e));

                return () => unsubscribe();
            }, [dbUser, cadreRecordDate, roles]);

            // 2. Tab-Specific Data (My Attendance)
            useEffect(() => {
                if (!user || !dbUser) return;
                const unsubscribes = [];

                // My Attendance (Home and Clock)
                // Use a boolean check to avoid re-subscribing when switching between home and clock
                const shouldWatchMyAttendance = activeTab === 'home' || activeTab === 'clock';
                
                if (shouldWatchMyAttendance) {
                    const qMine = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), 
                        where('userId', '==', dbUser.id),
                        orderBy('timestamp', 'desc')
                    );
                    unsubscribes.push(onSnapshot(qMine, 
                        (snap) => setMyAttendance(snap.docs.map(d => ({ id: d.id, ...d.data() }))), 
                        (e) => handleFetchError(e, 'attendance_mine_snap')
                    ));

                    const qMineMakeup = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'makeup_requests'),
                        where('userId', '==', dbUser.id),
                        orderBy('createdAt', 'desc')
                    );
                    unsubscribes.push(onSnapshot(qMineMakeup,
                        (snap) => setMyMakeupRequests(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
                        (e) => handleFetchError(e, 'makeup_mine_snap')
                    ));
                }

                return () => unsubscribes.forEach(u => u());
            }, [user, dbUser, activeTab === 'home' || activeTab === 'clock']);

            // Auto-select first company when in Cadre tab
            useEffect(() => {
                if (activeTab === 'cadre' && companies.length > 0) {
                    const exists = companies.some(c => c.name === cadreCompany);
                    if (!exists) {
                        setCadreCompany(companies[0].name);
                    }
                }
            }, [activeTab, companies, cadreCompany]);

            

            const seedData = async () => {
                if (!user) return;
                const baseCommRef = collection(db, 'artifacts', appId, 'public', 'data', 'communities');
                const baseUserRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                const comm1 = await addDoc(baseCommRef, { name: '帝寶社區', address: '台北市仁愛路' });
                const comm2 = await addDoc(baseCommRef, { name: '信義之星', address: '台北市信義區' });
                // admin@sys.com removed
                await addDoc(baseUserRef, { name: '李經理', email: 'manager@comm.com', password: '123', role: 'manager', communityId: comm1.id });
                await addDoc(baseUserRef, { name: '陳人事', email: 'hr@comm.com', password: '123', role: 'hr', communityId: 'HQ' });
                await addDoc(baseUserRef, { name: '王保全', email: 'staff@comm.com', password: '123', role: 'staff', communityId: comm1.id });
            };

            const signInWithRetry = async (email, password) => {
                let i = 0;
                const delays = [500, 1000, 2000];
                while (true) {
                    try {
                        return await signInWithEmailAndPassword(auth, email, password);
                    } catch (e) {
                        if (e && e.code === 'auth/network-request-failed' && i < delays.length) {
                            await new Promise(r => setTimeout(r, delays[i++]));
                            continue;
                        }
                        throw e;
                    }
                }
            };



            const handleLogin = async (identifier, password, rememberMe = false) => {
                // setLoading(true); // Disable global loading to keep Login component mounted
                try {
                    let emailToUse = identifier;
                    
                    // Check if identifier is likely a phone number (no @)
                    if (identifier.indexOf('@') === -1) {
                        const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                        let qPhone = query(usersRef, where('phone', '==', identifier));
                        
                        try {
                            let snapshot = await getDocs(qPhone);
                            
                            // Retry with stripped format if empty (e.g. user typed 0912-345-678, db has 0912345678)
                            if (snapshot.empty) {
                                const stripped = identifier.replace(/[^0-9]/g, '');
                                if (stripped !== identifier && stripped.length > 0) {
                                    qPhone = query(usersRef, where('phone', '==', stripped));
                                    snapshot = await getDocs(qPhone);
                                }
                            }

                            if (snapshot.empty) {
                                throw new Error('找不到此手機號碼對應的帳號');
                            }
                            
                            const userDoc = snapshot.docs[0].data();
                            if ((userDoc.status || '在職') === '離職') {
                                const today = new Date();
                                today.setHours(0,0,0,0);
                                let shouldBlock = true;
                                if (userDoc.resignDate) {
                                    const rDate = new Date(userDoc.resignDate);
                                    // If resign date is in the future, allow login
                                    if (rDate > today) shouldBlock = false;
                                }
                                if (shouldBlock) {
                                    throw new Error('此帳號已離職，無法登入');
                                }
                            }
                            if (!userDoc.email) {
                                throw new Error('此帳號資料異常(無Email)，請聯繫管理員');
                            }
                            emailToUse = userDoc.email;
                        } catch (err) {
                            if (err.code === 'permission-denied') {
                                throw new Error('系統權限不足，無法在登入前查詢手機號碼。請直接使用 Email 登入，或聯繫管理員開啟權限。');
                            }
                            throw err;
                        }
                    }

                    await signInWithRetry(emailToUse, password);
                    const q = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'users'), 
                        where('email', '==', emailToUse)
                    );
                    const snap = await getDocs(q);
                    let userData;
                    if (!snap.empty) {
                        userData = { id: snap.docs[0].id, ...snap.docs[0].data() };
                    } else {
                        const baseUserRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                        const name = emailToUse.split('@')[0];
                        const defaultRole = 'staff';
                        const defaultCommunity = 'HQ';
                        const docRef = await addDoc(baseUserRef, { name, email: emailToUse, role: defaultRole, communityId: defaultCommunity, status: '在職' });
                        userData = { id: docRef.id, name, email: emailToUse, role: defaultRole, communityId: defaultCommunity, status: '在職' };
                    }
                    userData.status = userData.status || '在職';
                    if (userData.status === '離職') {
                        const today = new Date();
                        today.setHours(0,0,0,0);
                        let shouldBlock = true;
                        if (userData.resignDate) {
                            const rDate = new Date(userData.resignDate);
                            // If resign date is in the future, allow login
                            if (rDate > today) shouldBlock = false;
                        }
                        if (shouldBlock) {
                            await signOut(auth);
                            throw new Error('此帳號已離職，無法登入');
                        }
                    }
                    const comm = communities.find(c => c.id === userData.communityId);
                    userData.communityName = comm ? comm.name : (userData.communityId === 'SYSTEM' ? '總部系統' : '未分配');
                    setDbUser(userData);
                    // setView('dashboard'); // Moved to onLoginSuccess in Login component
                    if (rememberMe) {
                        try {
                            localStorage.setItem('remember_until', String(Date.now() + 48 * 60 * 60 * 1000));
                            localStorage.setItem('remember_user', JSON.stringify(userData));
                        } catch {}
                    }
                } catch (e) {
                    console.error(e);
                    throw e;
                } finally {
                    // setLoading(false);
                }
            };



            

            const handleLogout = async () => {
                setShowProfileModal(false);
                await signOut(auth);
                setDbUser(null);
                setView('login');
                try {
                    localStorage.removeItem('remember_until');
                    localStorage.removeItem('remember_user');
                } catch {}
            };

            const handleProfileAvatarUpload = async (file) => {
                if (!file || !dbUser) return;
                
                try {
                    // Create a reference to the file in Firebase Storage
                    const fileRef = storageRef(storage, `avatars/${dbUser.id}/${Date.now()}_${file.name}`);
                    
                    // Upload the file
                    await uploadBytes(fileRef, file);
                    
                    // Get the download URL
                    const downloadURL = await getDownloadURL(fileRef);
                    
                    // Update Firestore with the new URL
                     await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', dbUser.id), {
                        avatarUrl: downloadURL,
                        updatedAt: serverTimestamp()
                     });
                     
                     const newUser = { ...dbUser, avatarUrl: downloadURL };
                     setDbUser(newUser);
                     
                     // 如果有使用"記住我"，也要同步更新 localStorage
                     try {
                         if (localStorage.getItem('remember_user')) {
                             localStorage.setItem('remember_user', JSON.stringify(newUser));
                         }
                     } catch (e) {}
                     
                     alert('大頭照更新成功');
                } catch (e) {
                    console.error(e);
                    alert('更新大頭照失敗: ' + e.message);
                }
            };

            const handleResetPassword = async () => {
                if (!dbUser) return;
                setResetPasswordForm({ newPassword: '', confirmPassword: '' });
                setResetPasswordError('');
                setShowResetPasswordModal(true);
            };

            const handleSaveNewPassword = async () => {
                if (!resetPasswordForm.newPassword || !resetPasswordForm.confirmPassword) {
                    setResetPasswordError('請輸入新密碼及確認密碼');
                    return;
                }
                if (resetPasswordForm.newPassword !== resetPasswordForm.confirmPassword) {
                    setResetPasswordError('兩次輸入的密碼不一致');
                    return;
                }
                if (resetPasswordForm.newPassword.length < 6) {
                    setResetPasswordError('密碼長度至少需 6 碼');
                    return;
                }
                
                setResetPasswordSaving(true);
                setResetPasswordError('');
                try {
                    const user = auth.currentUser;
                    if (user) {
                        await updatePassword(user, resetPasswordForm.newPassword);
                        
                        if (dbUser && dbUser.id) {
                             const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', dbUser.id);
                             await updateDoc(userRef, {
                                 password: resetPasswordForm.newPassword,
                                 updatedAt: serverTimestamp()
                             });
                        }
                        
                        alert('密碼重設成功');
                        setShowResetPasswordModal(false);
                        setShowProfileModal(false);
                    } else {
                        setResetPasswordError('無法取得使用者資訊，請重新登入');
                    }
                } catch (error) {
                    console.error(error);
                    if (error.code === 'auth/requires-recent-login') {
                        setResetPasswordError('為確保安全，請重新登入後再試');
                    } else {
                        setResetPasswordError('密碼重設失敗: ' + error.message);
                    }
                } finally {
                    setResetPasswordSaving(false);
                }
            };

            const handleClockIn = (type, locations = [], extra = {}) => {
                setClockType(type);
                if (locations.length > 0) {
                    setAvailableClockInLocations(locations);
                }
                if ((type || '').startsWith('outing')) {
                    setPendingOutingReason(extra?.outingReason || '');
                } else {
                    setPendingOutingReason('');
                }
                setShowCameraModal(true);
            };

            const handleCameraConfirm = async (imageBlob, location, address) => {
                if (!user || !dbUser) {
                    alert('使用者狀態異常，請重新登入');
                    return;
                }
                
                const withTimeout = (promise, ms, msg) => {
                    return Promise.race([
                        promise,
                        new Promise((_, reject) => setTimeout(() => reject(new Error(msg)), ms))
                    ]);
                };

                // Separate Upload and Database logic for better error handling
                let photoUrl = '';

                // 1. Upload Step
                try {
                    const filename = `attendance/${dbUser.id}/${Date.now()}.jpg`;
                    const imgRef = storageRef(storage, filename);
                    
                    // Starting upload...
                    await withTimeout(
                        uploadBytes(imgRef, imageBlob), 
                        60000, 
                        '照片上傳逾時(60秒)，網路連線可能不穩定'
                    );
                    // Upload complete
                    
                    photoUrl = await withTimeout(
                        getDownloadURL(imgRef),
                        10000,
                        '取得照片連結逾時'
                    );
                } catch (e) {
                    console.error("Upload Error", e);
                    let msg = e.message;
                    if (e.code === 'storage/unauthorized') {
                        msg = '權限不足 (Storage Rules)，請聯絡管理員檢查 Firebase Storage 規則';
                    } else if (e.code === 'storage/retry-limit-exceeded') {
                        msg = '連線不穩，已達重試上限';
                    }
                    alert("【步驟1：照片上傳失敗】\n" + msg);
                    // setIsProcessing is not defined in App scope, handled by CameraModal if needed
                    return; // Stop here
                }

                // 2. Database Step
                try {
                    await withTimeout(
                        addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), {
                            userId: dbUser.id,
                            userName: dbUser.name,
                            userRole: dbUser.role,
                            communityId: checkInLocation ? checkInLocation.id : dbUser.communityId,
                            checkInLocationName: checkInLocation ? checkInLocation.name : (dbUser.communityName || ''),
                            type: clockType,
                            outingReason: (clockType || '').startsWith('outing') ? (pendingOutingReason || '') : '',
                            isNightShift: !!isNightShift,
                            timestamp: serverTimestamp(),
                            device: 'Web Browser',
                            location: `${location.lat}, ${location.lng}`,
                            address: address,
                            photoUrl: photoUrl
                        }),
                        15000,
                        '資料寫入逾時(15秒)'
                    );
                    
                    setShowCameraModal(false);
                    setToast('打卡完成');
                } catch (e) {
                    console.error("Database Error", e);
                    let msg = e.message;
                    if (e.code === 'permission-denied') {
                        msg = '權限不足 (Firestore Rules)，無法寫入資料庫';
                    }
                    alert("【步驟2：資料儲存失敗】\n" + msg);
                } finally {
                    // setIsProcessing is not defined in App scope
                }
            };

            const handleToggleNotificationExpand = async (id) => {
                setExpandedNotificationIds(prev => {
                    if (prev.includes(id)) {
                        return prev.filter(pid => pid !== id);
                    } else {
                        return [...prev, id];
                    }
                });

                const notif = notifications.find(n => n.id === id);
                if (notif && dbUser) {
                    const readBy = notif.readBy || [];
                    if (!readBy.includes(dbUser.id)) {
                        try {
                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notifications', id), {
                                readBy: arrayUnion(dbUser.id)
                            });
                        } catch (e) {
                            console.error("Error marking notification as read:", e);
                        }
                    }
                }
            };

            const handleLeaveSubmit = async (leaveData) => {
                if (!dbUser) return;
                
                try {
                    let photoUrl = '';
                    if (leaveData.photo) {
                        // If photo is a string, it means it's already a URL (from edit mode)
                        if (typeof leaveData.photo === 'string') {
                            photoUrl = leaveData.photo;
                        } else {
                            const filename = `leave/${dbUser.id}/${Date.now()}.jpg`;
                            const imgRef = storageRef(storage, filename);
                            await uploadBytes(imgRef, leaveData.photo);
                            photoUrl = await getDownloadURL(imgRef);
                        }
                    }

                    if (leaveData.id) {
                        // Update existing leave record in 'leaves' collection
                        const leaveRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaves', leaveData.id);
                        await updateDoc(leaveRef, {
                            leaveReason: leaveData.reason,
                            leaveStartDate: leaveData.startDate,
                            leaveEndDate: leaveData.endDate,
                            leaveDescription: leaveData.description,
                            photoUrl: photoUrl,
                            // Maintain existing timestamp and other fields
                        });
                        alert('請假申請已更新');
                    } else {
                        // Create new leave record in 'leaves' collection
                        const submitUser = (leaveData.userId && Array.isArray(usersList)) ? (usersList.find(u => u.id === leaveData.userId) || dbUser) : dbUser;
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leaves'), {
                            userId: submitUser.id,
                            userName: submitUser.name,
                            userRole: submitUser.role,
                            companyId: submitUser.companyId || '',
                            companyName: submitUser.companyName || '',
                            communityId: submitUser.communityId || '',
                            checkInLocationName: submitUser.communityName || '',
                            type: 'leave',
                            timestamp: serverTimestamp(),
                            createdAt: serverTimestamp(),
                            device: 'Web Browser',
                            // Leave specific fields
                            leaveReason: leaveData.reason,
                            leaveStartDate: leaveData.startDate,
                            leaveEndDate: leaveData.endDate,
                            leaveDescription: leaveData.description,
                            photoUrl: photoUrl,
                            approvalStatus: 'pending'
                        });
                        alert('請假申請已送出');
                    }
                } catch (e) {
                    console.error('Leave Submit/Update Error:', e);
                    alert('操作失敗：' + e.message);
                    throw e; // Propagate error to stop loading state in modal
                }
            };

            const handleUpdateLeaveStatus = async (status, record = null) => {
                const target = record || selectedApprovalLeave;
                if (!target) return;
                
                const label = status === 'approved' ? '核准' : status === 'rejected' ? '駁回' : '重設';
                const reason = target.leaveReason || '未填寫';
                const start = target.leaveStartDate || '';
                const end = target.leaveEndDate || '';
                const desc = target.leaveDescription || '';
                const msg = `確定要${label}此請假申請？\n事由: ${reason}\n期間: ${start} ~ ${end}\n說明: ${desc || '無'}`;
                if (!window.confirm(msg)) return;
                
                try {
                    // 1. Update Leave Record in 'leaves' collection
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leaves', target.id), {
                        approvalStatus: status,
                        approvalTime: serverTimestamp(),
                        approverId: dbUser.id,
                        approverName: dbUser.name
                    });

                    if (!record) {
                        setShowApprovalModal(false);
                        setSelectedApprovalLeave(null);
                    }
                    if (status === 'pending') {
                        alert('已恢復待核准請假狀態');
                    } else {
                        alert(`已${status === 'approved' ? '核准' : '拒絕'}此請假申請`);
                    }
                } catch (e) {
                    console.error(e);
                    alert('更新失敗: ' + e.message);
                }
            };

            const handleAddUser = async (userData) => {
                if (!user) return;

                // Create user in Firebase Auth using a secondary app instance to avoid signing out the current admin
                const secondaryAppName = `secondaryApp-${Date.now()}`;
                let secondaryApp;
                const passwordToUse = userData.password || '123456';

                try {
                    secondaryApp = initializeApp(firebaseConfig, secondaryAppName);
                    const secondaryAuth = getAuth(secondaryApp);
                    await createUserWithEmailAndPassword(secondaryAuth, userData.email, passwordToUse);
                    await signOut(secondaryAuth);
                } catch (error) {
                    console.error("Error creating auth user:", error);
                    if (error.code === 'auth/email-already-in-use') {
                         // Check if the user exists in Firestore to allow recovery from failed writes
                         try {
                             const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('email', '==', userData.email));
                             const snap = await getDocs(q);
                             if (snap.empty) {
                                 const shouldRepair = confirm('此 Email 已經註冊過帳號，但在資料庫中找不到資料（可能是上次建立時寫入失敗）。是否要補建立資料庫資料？');
                                 if (!shouldRepair) {
                                     if (secondaryApp) await deleteApp(secondaryApp);
                                     return;
                                 }
                                 // Fall through to Firestore write
                             } else {
                                 alert('該 Email 已經註冊過帳號，且資料庫中已存在。');
                                 if (secondaryApp) await deleteApp(secondaryApp);
                                 return;
                             }
                         } catch (checkErr) {
                             console.error("Error checking existing user:", checkErr);
                             alert('檢查帳號狀態時發生錯誤');
                             if (secondaryApp) await deleteApp(secondaryApp);
                             return;
                         }
                    } else {
                        alert(`建立帳號失敗: ${error.message}`);
                        if (secondaryApp) await deleteApp(secondaryApp);
                        return;
                    }
                } finally {
                    if (secondaryApp) {
                        try {
                            await deleteApp(secondaryApp);
                        } catch (e) { console.error(e); }
                    }
                }

                try {
                    const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), { ...userData, password: passwordToUse, updatedByName: (dbUser && dbUser.name) || '新增', updatedAt: serverTimestamp() });
                    
                    // Optimistic update for immediate UI feedback
                    setUsersList(prev => [...prev, { 
                        id: docRef.id, 
                        ...userData, 
                        password: passwordToUse, 
                        updatedByName: (dbUser && dbUser.name) || '新增', 
                        updatedAt: new Date() 
                    }]);
                } catch (firestoreError) {
                    console.error("Firestore write failed:", firestoreError);
                    alert(`儲存使用者資料到資料庫失敗: ${firestoreError.message}`);
                    // Note: Auth user was created but Firestore data failed. You might want to delete the auth user or handle this inconsistency.
                    return;
                }
            };

            const handleAddCommunity = async (name) => {
                if (!user) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'communities'), { name: name, updatedByName: (dbUser && dbUser.name) || '新增', updatedAt: serverTimestamp() });
            };

            const handleDeleteUser = async (userId) => {
                if (!window.confirm('確定要刪除此帳號嗎？此動作無法復原。')) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', userId));
                    alert('帳號已刪除');
                } catch (e) {
                    console.error(e);
                    alert('刪除失敗: ' + e.message);
                }
            };

            const handleEditUserClick = (user) => {
                setEditingUser(user);
                setEditUserForm({
                    name: user.name || '',
                    role: user.role || 'staff',
                    title: user.title || '',
                    phone: user.phone || '',
                    email: user.email || '',
                    companyId: user.companyId || '',
                    companyIds: user.companyIds || [],
                    status: user.status || '在職',
                    startDate: user.startDate || '',
                    resignDate: user.resignDate || ''
                });
                setIsEditUserModalOpen(true);
            };

            const handleUpdateUserSubmit = async () => {
                if (!editingUser) return;
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', editingUser.id), {
                        ...editUserForm,
                        updatedAt: serverTimestamp()
                    });
                    setIsEditUserModalOpen(false);
                    setEditingUser(null);
                    alert('帳號更新成功');
                } catch (e) {
                    console.error(e);
                    alert('更新失敗: ' + e.message);
                }
            };

            if (loading) return <Loading />;

            if (view === 'login') {
                return <Login onLogin={handleLogin} onLoginSuccess={() => setView('dashboard')} isOnline={isOnline} />;
            }

            return (
                <div className="min-h-screen bg-gray-100 flex flex-col font-sans">
                    <ScheduleReminder schedules={mySchedules} attendance={myAttendance} />
                    {/* Mobile Navbar */}
                    <header className="bg-white fixed top-0 left-0 right-0 z-50 border-b border-gray-100 h-[8vh]">
                        <div className="max-w-md mx-auto px-4 h-full flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="bg-red-600 w-[30px] h-[30px] rounded-lg flex items-center justify-center shadow-md shadow-red-200">
                                    <Clock className="text-white w-4 h-4" />
                                </div>
                                <span className="font-bold text-gray-800 tracking-tight text-xl">西北打卡系統</span>
                            </div>
                            
                            <div className="flex items-center gap-3">
                                <div className="text-right">
                                    <div className="text-xs font-bold text-gray-800">Hi~ {dbUser?.name}</div>
                                </div>
                                <button 
                                    onClick={() => setShowProfileModal(true)}
                                    className="relative w-10 h-10 rounded-full overflow-hidden border-2 border-gray-100 focus:outline-none focus:ring-2 focus:ring-red-500 transition"
                                >
                                    {dbUser?.avatarUrl ? (
                                        <img src={dbUser.avatarUrl} alt="avatar" className="w-full h-full object-cover" />
                                    ) : (
                                        <div className="w-full h-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-600">
                                            {dbUser?.name ? dbUser.name.charAt(0) : <Users className="w-5 h-5" />}
                                        </div>
                                    )}
                                </button>
                            </div>
                        </div>
                        {fetchError && (
                            <div className="bg-yellow-50 border-t border-yellow-200 text-yellow-800 text-xs px-4 py-2">
                                {fetchError}
                            </div>
                        )}
                    </header>

                    {showProfileModal && (
                        <div className="fixed inset-0 z-[100] bg-black/50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-xs rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up">
                                <div className="relative h-32 bg-gradient-to-r from-red-600 to-red-500">
                                    <div className="absolute top-3 w-full flex justify-center">
                                        <h3 className="text-lg font-bold text-white drop-shadow-md uppercase tracking-wider">
                                            個人資訊 {(function() {
                                                if (!dbUser) return '';
                                                const roleObj = (roles || []).find(r => r.id === dbUser.role);
                                                if (roleObj) return roleObj.name;
                                                const roleMap = {
                                                    'admin': '系統管理員',
                                                    'manager': '總幹事',
                                                    'hr': '人事',
                                                    'cadre': '幹部',
                                                    'staff': '員工',
                                                    'secretary': '秘書',
                                                    'cleaner': '清潔',
                                                    'mechanic': '機電',
                                                    'guard': '保全'
                                                };
                                                return roleMap[dbUser.role] || dbUser.role;
                                            })()}
                                        </h3>
                                    </div>
                                    <button onClick={() => setShowProfileModal(false)} className="absolute top-3 right-3 p-1 bg-black/20 text-white rounded-full hover:bg-black/40 transition">
                                        <X className="w-4 h-4" />
                                    </button>
                                </div>
                                <div className="px-6 pb-6">
                                    <div className="relative -mt-20 mb-4">
                                        <div className="flex justify-center">
                                            <div className="relative group">
                                                <div className="w-40 h-40 rounded-full border-4 border-white shadow-lg overflow-hidden bg-white">
                                                    {dbUser?.avatarUrl ? (
                                                        <img src={dbUser.avatarUrl} alt="avatar" className="w-full h-full object-cover" />
                                                    ) : (
                                                        <div className="w-full h-full bg-gray-100 flex items-center justify-center text-3xl font-bold text-gray-400">
                                                            {dbUser?.name ? dbUser.name.charAt(0) : '?'}
                                                        </div>
                                                    )}
                                                </div>
                                                <label className="absolute bottom-2 right-2 p-2 bg-gray-800 text-white rounded-full cursor-pointer shadow-md hover:bg-gray-700 transition transform hover:scale-105">
                                                    <input type="file" accept="image/*" className="hidden" onChange={(e) => handleProfileAvatarUpload(e.target.files?.[0])} />
                                                    <Edit className="w-4 h-4" />
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="text-center mb-6">
                                        <h2 className="text-xl font-bold text-gray-800">{dbUser?.name}</h2>
                                        <p className="text-xl text-gray-500">{dbUser?.title || '未設定職稱'}</p>
                                    </div>

                                    <div className="space-y-3">
                                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-2xl">
                                            <span className="text-sm font-bold text-gray-600">本月計點</span>
                                            <span className="text-lg font-bold text-gray-800">0</span>
                                        </div>
                                        
                                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-2xl">
                                            <span className="text-sm font-bold text-gray-600">通知</span>
                                            <label className="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" defaultChecked className="sr-only peer" />
                                                <div className="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600"></div>
                                            </label>
                                        </div>

                                        <button 
                                            onClick={handleResetPassword}
                                            className="w-full flex items-center justify-center gap-2 p-3 bg-gray-50 text-gray-700 font-bold rounded-2xl hover:bg-gray-100 transition text-sm"
                                        >
                                            <Shield className="w-4 h-4" /> 重設密碼
                                        </button>

                                        <button 
                                            onClick={handleLogout}
                                            className="w-full flex items-center justify-center gap-2 p-3 bg-red-600 text-white font-bold rounded-2xl hover:bg-red-700 transition text-sm shadow-md shadow-red-200"
                                        >
                                            <LogOut className="w-4 h-4" /> 登出系統
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showResetPasswordModal && (
                        <div className="fixed inset-0 z-[110] bg-black/50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-xs rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up p-6">
                                <h4 className="text-lg font-bold text-gray-800 mb-4 text-center">重設密碼</h4>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">新密碼</label>
                                        <input 
                                            type="password"
                                            className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100"
                                            value={resetPasswordForm.newPassword}
                                            onChange={e => setResetPasswordForm(prev => ({ ...prev, newPassword: e.target.value }))}
                                            placeholder="請輸入新密碼"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">確認新密碼</label>
                                        <input 
                                            type="password"
                                            className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100"
                                            value={resetPasswordForm.confirmPassword}
                                            onChange={e => setResetPasswordForm(prev => ({ ...prev, confirmPassword: e.target.value }))}
                                            placeholder="請再次輸入新密碼"
                                        />
                                    </div>
                                    {resetPasswordError && (
                                        <div className="text-xs text-red-600 text-center">{resetPasswordError}</div>
                                    )}
                                    <div className="flex gap-2 pt-2">
                                        <button 
                                            onClick={() => setShowResetPasswordModal(false)}
                                            className="flex-1 py-3 rounded-2xl bg-gray-100 text-gray-700 font-bold text-sm"
                                        >
                                            取消
                                        </button>
                                        <button 
                                            onClick={handleSaveNewPassword}
                                            disabled={resetPasswordSaving}
                                            className="flex-1 py-3 rounded-2xl bg-red-600 text-white font-bold text-sm disabled:opacity-50"
                                        >
                                            {resetPasswordSaving ? '儲存中...' : '確認修改'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="fixed top-[8vh] left-0 right-0 z-40 h-[8vh] bg-white border-b border-gray-100">
                        <div className="max-w-md mx-auto px-4 h-full flex items-center gap-2 overflow-x-auto no-scrollbar">
                            {activeTab === 'home' && (
                                <div className="w-full flex justify-center">
                                    <div className={`inline-flex items-center gap-2 px-4 py-2 rounded-full text-xs font-medium ${
                                        gpsStatus.type === 'success' ? 'bg-green-100 text-green-700' : 
                                        gpsStatus.type === 'loading' ? 'bg-yellow-100 text-yellow-700' :
                                        gpsStatus.type === 'warning' ? 'bg-blue-100 text-blue-700' :
                                        'bg-red-100 text-red-700'
                                    }`}>
                                        {gpsStatus.type === 'success' ? <CheckCircle className="w-3 h-3 text-green-600" /> :
                                         gpsStatus.type === 'loading' ? <RefreshCw className="w-3 h-3 animate-spin text-yellow-600" /> :
                                         gpsStatus.type === 'warning' ? <AlertCircle className="w-3 h-3 text-blue-600" /> :
                                         <AlertCircle className="w-3 h-3 text-red-600" />}
                                        {gpsStatus.message}
                                    </div>
                                </div>
                            )}
                            {activeTab === 'overview' && (
                                <div className="flex gap-2">
                                    {hasSubPermission('overview', 'district') && (
                                        <button 
                                            onClick={() => setOverviewSubtab('district')} 
                                            className={`relative px-3 py-2 text-xs font-bold rounded-2xl ${overviewSubtab === 'district' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}
                                        >
                                            <span>例會</span>
                                            {(function() {
                                                const count = getOverviewMeetingBadgeCount();
                                                if (!count) return null;
                                                return (
                                                    <span className="absolute -top-1 -right-1 min-w-[16px] h-4 px-1 rounded-full bg-blue-500 text-white text-[10px] flex items-center justify-center">
                                                        {count}
                                                    </span>
                                                );
                                            })()}
                                        </button>
                                    )}
                                    {hasSubPermission('overview', 'district_meeting') && (
                                        <button 
                                            onClick={() => setOverviewSubtab('district_meeting')} 
                                            className={`relative px-3 py-2 text-xs font-bold rounded-2xl ${overviewSubtab === 'district_meeting' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}
                                        >
                                            <span>區大</span>
                                            {(function() {
                                                const count = getOverviewDistrictMeetingBadgeCount();
                                                if (!count) return null;
                                                return (
                                                    <span className="absolute -top-1 -right-1 min-w-[16px] h-4 px-1 rounded-full bg-blue-500 text-white text-[10px] flex items-center justify-center">
                                                        {count}
                                                    </span>
                                                );
                                            })()}
                                        </button>
                                    )}
                                    {hasSubPermission('overview', 'activity') && (
                                        <button 
                                            onClick={() => setOverviewSubtab('activity')} 
                                            className={`relative px-3 py-2 text-xs font-bold rounded-2xl ${overviewSubtab === 'activity' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}
                                        >
                                            <span>活動</span>
                                            {(function() {
                                                const count = getOverviewActivityBadgeCount();
                                                if (!count) return null;
                                                return (
                                                    <span className="absolute -top-1 -right-1 min-w-[16px] h-4 px-1 rounded-full bg-blue-500 text-white text-[10px] flex items-center justify-center">
                                                        {count}
                                                    </span>
                                                );
                                            })()}
                                        </button>
                                    )}
                                    {hasSubPermission('overview', 'presentation') && (
                                        <button 
                                            onClick={() => setOverviewSubtab('presentation')} 
                                            className={`relative px-3 py-2 text-xs font-bold rounded-2xl ${overviewSubtab === 'presentation' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}
                                        >
                                            <span>簡報</span>
                                            {(function() {
                                                const count = getOverviewPresentationBadgeCount();
                                                if (!count) return null;
                                                return (
                                                    <span className="absolute -top-1 -right-1 min-w-[16px] h-4 px-1 rounded-full bg-blue-500 text-white text-[10px] flex items-center justify-center">
                                                        {count}
                                                    </span>
                                                );
                                            })()}
                                        </button>
                                    )}
                                    {hasSubPermission('overview', 'notification') && (
                                        <button 
                                            onClick={() => setOverviewSubtab('notification')} 
                                            className={`relative px-3 py-2 text-xs font-bold rounded-2xl ${overviewSubtab === 'notification' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}
                                        >
                                            <span>通知</span>
                                            {(function() {
                                                const myCount = notifications.filter(n => isNotificationTarget(n) && !(n.readBy || []).includes(dbUser?.id)).length;
                                                if (myCount > 0) {
                                                    return (
                                                        <span className="absolute -top-1 -right-1 min-w-[16px] h-4 px-1 rounded-full bg-blue-500 text-white text-[10px] flex items-center justify-center">
                                                            {myCount}
                                                        </span>
                                                    );
                                                }
                                                return null;
                                            })()}
                                        </button>
                                    )}
                                    {hasSubPermission('overview', 'general') && (
                                        <button 
                                            onClick={() => setOverviewSubtab('general')} 
                                            className={`px-3 py-2 text-xs font-bold rounded-2xl ${overviewSubtab === 'general' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}
                                        >
                                            概況
                                        </button>
                                    )}
                                </div>
                            )}
                            {activeTab === 'clock' && (
                                <div className="flex gap-2">
                                    {hasSubPermission('clock', 'work') && <button onClick={() => setClockSubtab('work')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${clockSubtab === 'work' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>上下班</button>}
                                    {hasSubPermission('clock', 'out') && <button onClick={() => setClockSubtab('out')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${clockSubtab === 'out' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>外出</button>}
                                    {hasSubPermission('clock', 'card') && <button onClick={() => setClockSubtab('card')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${clockSubtab === 'card' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>卡班</button>}
                                    {hasSubPermission('clock', 'leave') && <button onClick={() => setClockSubtab('leave')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${clockSubtab === 'leave' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>請假</button>}
                                    <button onClick={() => setClockSubtab('schedule')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${clockSubtab === 'schedule' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>班表</button>
                                </div>
                            )}

                            {activeTab === 'function' && (
                                <div className="flex gap-2">
                                    {hasSubPermission('function', 'patrol') && <button onClick={() => setFunctionSubtab('patrol')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${functionSubtab === 'patrol' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>巡邏</button>}
                                    {hasSubPermission('function', 'training') && <button onClick={() => setFunctionSubtab('training')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${functionSubtab === 'training' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>訓練</button>}
                                    {hasSubPermission('function', 'download') && <button onClick={() => setFunctionSubtab('download')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${functionSubtab === 'download' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>下載</button>}
                                </div>
                            )}
                            {activeTab === 'cadre' && (
                                <div className="flex gap-2">
                                    {hasSubPermission('cadre', 'map') && (
                                        <button 
                                            onClick={() => setCadreSubtab('map')} 
                                            className={`px-3 py-2 text-xs font-bold rounded-2xl ${cadreSubtab === 'map' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'} relative`}
                                        >
                                            地圖
                                            {(function(){
                                                // Check for abnormal records today
                                                const targetCompany = companies.find(c => c.name === cadreCompany);
                                                if (!targetCompany) return null;

                                                // Filter relevant users
                                                const targetRoleNames = ['系統管理員', '人事', '幹部', '員工'];
                                                const targetRoleIds = (roles || []).filter(r => targetRoleNames.includes(r.name)).map(r => r.id);
                                                const finalTargetRoles = ['admin', 'hr', 'cadre', 'staff', ...targetRoleIds];
                                                const companyUsers = usersList.filter(u => 
                                                    ((u.companyIds && u.companyIds.some(cid => String(cid) === String(targetCompany.id))) || String(u.companyId) === String(targetCompany.id)) && 
                                                    finalTargetRoles.includes(u.role)
                                                );

                                                if (companyUsers.length === 0) return null;

                                                const now = new Date();
                                                const isToday = (secs) => {
                                                    if (!secs) return false;
                                                    const d = new Date(secs * 1000);
                                                    return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth() && d.getDate() === now.getDate();
                                                };

                                                const calculateDistance = (lat1, lon1, lat2, lon2) => {
                                                    const R = 6371e3; 
                                                    const φ1 = lat1 * Math.PI / 180;
                                                    const φ2 = lat2 * Math.PI / 180;
                                                    const Δφ = (lat2 - lat1) * Math.PI / 180;
                                                    const Δλ = (lon2 - lon1) * Math.PI / 180;
                                                    const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
                                                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                                                    return R * c;
                                                };

                                                let abnormalCount = 0;

                                                companyUsers.forEach(u => {
                                                    const recs = attendanceList.filter(r => {
                                                        const secs = r.timestamp?.seconds || r.createdAt?.seconds;
                                                        if (!secs) return false;
                                                        if (r.userId !== u.id) return false;
                                                        if (!isToday(secs)) return false;
                                                        return ['in','out','late_in','late_out'].includes(r.type);
                                                    });
                                                    
                                                    if (recs.length > 0) {
                                                        // Sort by latest
                                                        recs.sort((a, b) => {
                                                            const aSecs = a.timestamp?.seconds || a.createdAt?.seconds || 0;
                                                            const bSecs = b.timestamp?.seconds || b.createdAt?.seconds || 0;
                                                            return bSecs - aSecs;
                                                        });
                                                        const lastRec = recs[0];
                                                        
                                                        let isAbnormal = false;
                                                        if (targetCompany && targetCompany.lat && targetCompany.lng) {
                                                            if (lastRec.location && lastRec.location.includes(',')) {
                                                                const [rLat, rLng] = lastRec.location.split(',').map(Number);
                                                                const dist = calculateDistance(targetCompany.lat, targetCompany.lng, rLat, rLng);
                                                                const radius = targetCompany.radius || 100;
                                                                if (dist > radius) isAbnormal = true;
                                                            } else {
                                                                isAbnormal = true;
                                                            }
                                                        } else {
                                                            isAbnormal = true;
                                                        }
                                                        
                                                        if (isAbnormal) abnormalCount++;
                                                    }
                                                });

                                                if (abnormalCount > 0) {
                                                    return (
                                                        <span className="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold leading-none px-1.5 py-1 rounded-full min-w-[18px] text-center">
                                                            {abnormalCount}
                                                        </span>
                                                    );
                                                }
                                                return null;
                                            })()}
                                        </button>
                                    )}
                                    {hasSubPermission('cadre', 'record') && (
                                        <button 
                                            onClick={() => setCadreSubtab('record')} 
                                            className={`px-3 py-2 text-xs font-bold rounded-2xl ${cadreSubtab === 'record' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'} relative`}
                                        >
                                            紀錄
                                            {(function(){
                                                const targetCompany = companies.find(c => c.name === cadreCompany);
                                                if (!targetCompany) return null;
                                                const companyUserIds = usersList.filter(u => 
                                                    ((u.companyIds && u.companyIds.some(cid => String(cid) === String(targetCompany.id))) || String(u.companyId) === String(targetCompany.id))
                                                ).map(u => u.id);
                                                const pendingMakeupCount = makeupRequests.filter(req => 
                                                    req.status === 'pending' && companyUserIds.includes(req.userId)
                                                ).length;
                                                const pendingModificationCount = attendanceList.filter(req => 
                                                    req.modification?.status === 'pending' && companyUserIds.includes(req.userId)
                                                ).length;
                                                const totalPending = pendingMakeupCount + pendingModificationCount;
                                                
                                                if (totalPending > 0) {
                                                    return (
                                                        <span className="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold leading-none px-1.5 py-1 rounded-full min-w-[18px] text-center">
                                                            {totalPending}
                                                        </span>
                                                    );
                                                }
                                                return null;
                                            })()}
                                        </button>
                                    )}
                                    {hasSubPermission('cadre', 'leave') && (
                                        <button 
                                            onClick={() => setCadreSubtab('leave')} 
                                            className={`px-3 py-2 text-xs font-bold rounded-2xl ${cadreSubtab === 'leave' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'} relative`}
                                        >
                                            請假
                                            {(function(){
                                                const targetCompany = companies.find(c => c.name === cadreCompany);
                                                if (!targetCompany) return null;
                                                const companyUserIds = usersList.filter(u => 
                                                    ((u.companyIds && u.companyIds.some(cid => String(cid) === String(targetCompany.id))) || String(u.companyId) === String(targetCompany.id))
                                                ).map(u => u.id);
                                                const pendingLeaveCount = (leavesList || []).filter(req => 
                                                    req.approvalStatus === 'pending' && companyUserIds.includes(req.userId)
                                                ).length;
                                                
                                                if (pendingLeaveCount > 0) {
                                                    return (
                                                        <span className="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold leading-none px-1.5 py-1 rounded-full min-w-[18px] text-center">
                                                            {pendingLeaveCount}
                                                        </span>
                                                    );
                                                }
                                                return null;
                                            })()}
                                        </button>
                                    )}
                                    {hasSubPermission('cadre', 'schedule') && <button onClick={() => setCadreSubtab('schedule')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${cadreSubtab === 'schedule' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>班表</button>}
                                    {hasSubPermission('cadre', 'approval') && (
                                        <button 
                                            onClick={() => setCadreSubtab('approval')} 
                                            className={`px-3 py-2 text-xs font-bold rounded-2xl ${cadreSubtab === 'approval' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'} relative`}
                                        >
                                            簽呈
                                            {(function(){
                                                const targetCompany = companies.find(c => c.name === cadreCompany);
                                                if (!targetCompany) return null;
                                                const companyUserIds = usersList.filter(u => 
                                                    ((u.companyIds && u.companyIds.some(cid => String(cid) === String(targetCompany.id))) || String(u.companyId) === String(targetCompany.id))
                                                ).map(u => u.id);
                                                const pendingSignatureCount = (cadreSignatures || []).filter(sig => 
                                                    sig.status === 'pending' && companyUserIds.includes(sig.userId)
                                                ).length;
                                                
                                                if (pendingSignatureCount > 0) {
                                                    return (
                                                        <span className="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold leading-none px-1.5 py-1 rounded-full min-w-[18px] text-center">
                                                            {pendingSignatureCount}
                                                        </span>
                                                    );
                                                }
                                                return null;
                                            })()}
                                        </button>
                                    )}
                                    {hasSubPermission('cadre', 'account') && <button onClick={() => setCadreSubtab('account')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${cadreSubtab === 'account' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>帳號</button>}
                                    {hasSubPermission('cadre', 'report') && <button onClick={() => setCadreSubtab('report')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${cadreSubtab === 'report' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>報表</button>}
                                    {hasSubPermission('cadre', 'notification') && <button onClick={() => setCadreSubtab('notification')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${cadreSubtab === 'notification' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>通知</button>}
                                </div>
                            )}

                            {activeTab === 'cadre' && (
                                <div className="absolute top-full left-0 right-0 h-[8vh] bg-white/80 backdrop-blur-sm flex items-center gap-3 overflow-x-auto px-4 no-scrollbar z-30 shadow-sm flex-nowrap whitespace-nowrap">
                                    {(function() {
                                        const targetCompany = companies.find(c => c.name === cadreCompany);
                                        if (!targetCompany) return null;
                                        
                                        // Filter: Company + Roles (admin, hr, cadre, staff)
                                        // Expand target roles to include custom roles with matching names
                                        const targetRoleNames = ['系統管理員', '人事', '幹部', '員工'];
                                        const targetRoleIds = (roles || []).filter(r => targetRoleNames.includes(r.name)).map(r => r.id);
                                        const finalTargetRoles = ['admin', 'hr', 'cadre', 'staff', ...targetRoleIds];

                                        const companyUsers = usersList.filter(u => 
                                            ((u.companyIds && u.companyIds.some(cid => String(cid) === String(targetCompany.id))) || String(u.companyId) === String(targetCompany.id)) && 
                                            finalTargetRoles.includes(u.role) &&
                                            (u.status || '在職') !== '離職'
                                        );
                                        
                                        if (companyUsers.length === 0) return <div className="text-xs text-gray-400">尚無人員</div>;

                                        return companyUsers.map(u => {
                                            const isSelected = cadreMapSelectedUserId === u.id;
                                            
                                            const schedule = todaySchedules[u.id];

                                            const nowCheck = new Date();
                                            const year = nowCheck.getFullYear();
                                            const month = nowCheck.getMonth();
                                            const day = nowCheck.getDate();
                                            const dayStart = new Date(year, month, day, 0, 0, 0);
                                            const dayEnd = new Date(year, month, day, 23, 59, 59);

                                            const todayLeaveInfo = (() => {
                                                  const parseRange = (l) => {
                                                      if ((l.type && l.type !== 'leave') || (l.approvalStatus && l.approvalStatus !== 'approved')) return null;
                                                      let s, e;
                                                    if (l.leaveStartDate) {
                                                        const sd = String(l.leaveStartDate).replace(/\//g, '-');
                                                        s = new Date(sd + (l.leaveStartTime ? 'T'+l.leaveStartTime : 'T00:00'));
                                                    } else if (l.startDate) {
                                                        const sd = String(l.startDate).replace(/\//g, '-');
                                                        s = new Date(sd);
                                                    } else if (l.leaveDate) {
                                                        const sd = String(l.leaveDate).replace(/\//g, '-');
                                                        s = new Date(sd + (l.leaveTime ? 'T'+l.leaveTime : 'T00:00'));
                                                    }
                                                    if (l.leaveEndDate) {
                                                        const ed = String(l.leaveEndDate).replace(/\//g, '-');
                                                        e = new Date(ed + (l.leaveEndTime ? 'T'+l.leaveEndTime : 'T23:59'));
                                                    } else if (l.endDate) {
                                                        const ed = String(l.endDate).replace(/\//g, '-');
                                                        e = new Date(ed);
                                                    } else if (s) {
                                                        e = new Date(s.getFullYear(), s.getMonth(), s.getDate(), 23, 59, 59);
                                                    }
                                                    if (!s || !e || isNaN(s) || isNaN(e)) return null;
                                                    return { s, e };
                                                };
                                                const listA = (attendanceList || []).filter(r => r.userId === u.id && r.type === 'leave' && r.approvalStatus === 'approved');
                                                const listB = (leavesList && leavesList.length > 0) 
                                                    ? leavesList.filter(r => r.userId === u.id && r.approvalStatus === 'approved')
                                                    : [];
                                                let totalHours = 0;
                                                for (const l of [...listA, ...listB]) {
                                                    const rng = parseRange(l);
                                                    if (!rng) continue;
                                                    if (rng.s <= dayEnd && rng.e >= dayStart) {
                                                        let os = rng.s > dayStart ? rng.s : dayStart;
                                                        let oe = rng.e < dayEnd ? rng.e : dayEnd;
                                                        if (schedule && (schedule.type === 'work' || schedule.type === 'duty' || schedule.type === 'card') && schedule.startTime && schedule.endTime) {
                                                            const [sh, sm] = String(schedule.startTime).split(':').map(x => parseInt(x, 10));
                                                            const [eh, em] = String(schedule.endTime).split(':').map(x => parseInt(x, 10));
                                                            const ss = new Date(year, month, day, Number(sh) || 0, Number(sm) || 0, 0, 0);
                                                            const se = new Date(year, month, day, Number(eh) || 0, Number(em) || 0, 0, 0);
                                                            if (os < ss) os = ss;
                                                            if (oe > se) oe = se;
                                                        }
                                                        const hours = Math.max(0, (oe.getTime() - os.getTime()) / 3600000);
                                                        totalHours += hours;
                                                    }
                                                }
                                                if (totalHours > 0) {
                                                    return { hours: Number(totalHours.toFixed(1)) };
                                                }
                                                return null;
                                            })();

                                            const userRecords = (attendanceList || []).filter(r => {
                                                if (r.userId !== u.id) return false;
                                                const seconds = r.timestamp?.seconds || r.createdAt?.seconds || Date.now() / 1000;
                                                const rDate = new Date(seconds * 1000);
                                                return rDate.toDateString() === new Date().toDateString();
                                            });
                                            
                                            // Sort records by time
                                            const sortedRecords = [...userRecords].sort((a, b) => {
                                                const tA = a.timestamp?.seconds || a.createdAt?.seconds || 0;
                                                const tB = b.timestamp?.seconds || b.createdAt?.seconds || 0;
                                                return tA - tB;
                                            });
                                            const lastRecord = sortedRecords[sortedRecords.length - 1];
                                            const hasClockedInToday = userRecords.some(r => r.type === 'in' || r.type === 'late_in');
                                            
                                            // Determine Status & Color
                                            let bgColorClass = 'bg-gray-100'; // Default fallback
                                            let animateClass = '';
                                            let isAbnormal = false;

                                            // 1. Abnormal Checks (Highest Priority)
                                            if (schedule) {
                                                const now = new Date();
                                                const nowMins = now.getHours() * 60 + now.getMinutes();

                                                // Check Late In (>30m)
                                                if ((schedule.type === 'work' || schedule.type === 'duty' || schedule.type === 'card') && schedule.startTime) {
                                                    const [sh, sm] = schedule.startTime.split(':').map(Number);
                                                    const schedStartMins = sh * 60 + sm;
                                                    // Check if any IN record exists (work or duty)
                                                    const hasIn = userRecords.some(r => r.type === 'in' || r.type === 'late_in');
                                                    
                                                    if (!hasIn && nowMins > schedStartMins + 30) {
                                                        isAbnormal = true;
                                                    }
                                                }

                                                // Check Early Out
                                                if ((schedule.type === 'work' || schedule.type === 'duty' || schedule.type === 'card') && schedule.endTime) {
                                                    // Check if any OUT record exists
                                                    const outRecord = userRecords.find(r => r.type === 'out' || r.type === 'late_out');
                                                    if (outRecord) {
                                                        const [eh, em] = schedule.endTime.split(':').map(Number);
                                                        const schedEndMins = eh * 60 + em;
                                                        
                                                        const seconds = outRecord.timestamp?.seconds || outRecord.createdAt?.seconds || 0;
                                                        const outDate = new Date(seconds * 1000);
                                                        const outMins = outDate.getHours() * 60 + outDate.getMinutes();
                                                        
                                                        // Check if early (and not crossDay)
                                                        if (!schedule.crossDay && outMins < schedEndMins) {
                                                            isAbnormal = true;
                                                        }
                                                    }
                                                }
                                            }

                                            if (isAbnormal) {
                                                bgColorClass = 'bg-red-200';
                                                animateClass = 'animate-bg-red-pulse';
                                            } else {
                                                // 2. Normal Status (Priority: Last Action > Schedule Type)
                                                if (lastRecord) {
                                                    const type = lastRecord.type;
                                                    if (type === 'in') {
                                                        bgColorClass = 'bg-green-100'; // 上班 -> 淺綠色
                                                    } else if (type === 'late_in') {
                                                        bgColorClass = 'bg-green-100'; // 卡上 -> 淺綠色
                                                    } else if (type === 'out') {
                                                        bgColorClass = 'bg-gray-800 text-white'; // 下班 -> 深灰色 (Add text-white for contrast)
                                                    } else if (type === 'late_out') {
                                                        bgColorClass = 'bg-gray-800 text-white'; // 卡下 -> 深灰色 (Add text-white for contrast)
                                                    } else if (type === 'outing_start' || type === 'outing_arrive' || type === 'outing_end') {
                                                        bgColorClass = 'bg-blue-100'; // 外出/抵達/離開 -> 淺藍色
                                                    } else if (type === 'leave') {
                                                        bgColorClass = 'bg-orange-100'; // 請假 -> 淺橘色
                                                    } else {
                                                        // Fallback for other types
                                                        bgColorClass = 'bg-green-50';
                                                    }
                                                } else {
                                                    // No records - Check Schedule Type
                                                    if (schedule) {
                                                        if (schedule.type === 'work') bgColorClass = 'bg-blue-50'; // 上班日 -> 淺藍色 (Default)
                                                        else if (schedule.type === 'duty' || schedule.type === 'card') bgColorClass = 'bg-yellow-50'; // 值班日 -> 淺黃色
                                                        else if (schedule.type === 'off') bgColorClass = 'bg-stone-200'; // 公休日 -> 棕色
                                                        else if (schedule.type === 'leave') bgColorClass = 'bg-orange-100'; // 請假日 -> 淺橘色
                                                        else if (schedule.type === 'comp_leave') bgColorClass = 'bg-indigo-100'; // 補休 -> 淺靛色
                                                    }
                                                }
                                            }

                                            return (
                                                <div 
                                                    key={u.id}
                                                    className={`flex-shrink-0 flex flex-col items-center gap-1 cursor-pointer group rounded-lg p-1 transition-colors ${bgColorClass} ${animateClass} ${
                                                        isSelected ? 'ring-2 ring-red-500' : ''
                                                    }`}
                                                    onClick={() => setCadreMapSelectedUserId(u.id)}
                                                >
                                                    <div 
                                                        className={`w-10 h-10 rounded-full overflow-hidden border-2 shadow-sm relative group-hover:scale-105 transition-transform ${
                                                            isSelected ? 'bg-white border-red-500' : 'bg-gray-200 border-white'
                                                        }`} 
                                                        title={hasClockedInToday ? u.name : `${u.name} (今日未打卡)`}
                                                    >
                                                        {u.avatarUrl ? (
                                                            <img src={u.avatarUrl} alt={u.name} className="w-full h-full object-cover" />
                                                        ) : (
                                                            <div className={`w-full h-full flex items-center justify-center font-bold text-xs ${isSelected ? 'text-red-600' : 'text-gray-500'}`}>
                                                                {u.name?.[0]}
                                                            </div>
                                                        )}
                                                    </div>
                                                    <span className={`text-[10px] font-medium max-w-[48px] truncate ${bgColorClass.includes('bg-gray-800') ? 'text-white' : (isSelected ? 'text-red-600 font-bold' : 'text-gray-600')}`}>
                                                        {todayLeaveInfo ? `請假-${todayLeaveInfo.hours}hr` : u.name}
                                                    </span>
                                                </div>
                                            );
                                        });
                                    })()}
                                </div>
                            )}
                            {activeTab === 'application' && (
                                <div className="flex gap-2">
                                    {hasSubPermission('application', 'signature') && <button onClick={() => setApplicationSubtab('signature')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${applicationSubtab === 'signature' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>簽呈</button>}
                                    {hasSubPermission('application', 'equipment') && <button onClick={() => setApplicationSubtab('equipment')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${applicationSubtab === 'equipment' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>設備</button>}
                                </div>
                            )}
                            {activeTab === 'hr' && (
                                <button className="px-3 py-2 text-xs font-bold rounded-2xl bg-red-50 text-red-600">報表</button>
                            )}
                            {activeTab === 'settings' && (
                                <div className="flex gap-2">
                                    {hasSubPermission('settings', 'general') && <button onClick={() => setSettingsSubtab('general')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${settingsSubtab === 'general' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>一般</button>}
                                    {hasSubPermission('settings', 'account') && <button onClick={() => setSettingsSubtab('account')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${settingsSubtab === 'account' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>帳號</button>}
                                    {hasSubPermission('settings', 'community') && <button onClick={() => setSettingsSubtab('community')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${settingsSubtab === 'community' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>社區</button>}
                                    {hasSubPermission('settings', 'system') && <button onClick={() => setSettingsSubtab('system')} className={`px-3 py-2 text-xs font-bold rounded-2xl ${settingsSubtab === 'system' ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700'}`}>系統</button>}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Main Content Area - Mobile Container */}
                    {meetingReminder && (
                        <div className="fixed inset-0 z-[999] flex items-end justify-center pointer-events-none">
                            <div className="w-full max-w-xs mb-6 px-4 pointer-events-auto">
                                <div className="bg-white rounded-2xl shadow-lg border border-gray-200 p-3 text-xs space-y-1 relative">
                                    <button 
                                        onClick={handleCloseMeetingReminder}
                                        className="absolute top-2 right-2 text-gray-400 hover:text-gray-600 transition-colors p-1"
                                    >
                                        <X className="w-4 h-4" />
                                    </button>
                                    <div className="font-bold text-gray-800 pr-6">
                                        {meetingReminder._notificationType === 'new' ? `新增${meetingReminder.type || '例會'}通知` : `${meetingReminder.type || '例會'}提醒`}
                                    </div>
                                    <div className="text-gray-700">
                                        {meetingReminder._notificationType === 'new' 
                                            ? `已新增於 ${meetingReminder.date} ${meetingReminder.time || ''} 的 ${meetingReminder.type || '例會'}`
                                            : `今天 ${meetingReminder.time || ''} 有 ${meetingReminder.type || '例會'}`
                                        }
                                    </div>
                                    <div className="text-gray-500">
                                        地點：{(() => {
                                            const comm = communities.find(c => c.id === meetingReminder.communityId);
                                            if (comm) return comm.name;
                                            if (meetingReminder.communityId && typeof meetingReminder.communityId === 'string') {
                                                return meetingReminder.communityId;
                                            }
                                            return '未指定';
                                        })()}
                                    </div>
                                    <button 
                                        onClick={handleCloseMeetingReminder}
                                        className="mt-2 w-full bg-gray-800 hover:bg-gray-900 text-white text-xs py-1.5 rounded-xl transition-colors"
                                    >
                                        我知道了
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    <main className={`absolute left-0 right-0 overflow-y-auto ${(activeTab === 'cadre') ? 'top-[24vh] h-[68vh]' : 'top-[16vh] h-[76vh]'}`}>
                        <div className={`w-full max-w-md mx-auto px-4 py-4 ${activeTab === 'cadre' ? 'pb-20' : ''}`}>
                        
                        {/* Role Based Views */}
                        {activeTab === 'home' && hasPermission('home') && (
                            <div className="space-y-6 mb-6">
                                <ErrorBoundary>
                                    <StaffDashboard 
                                        currentUser={dbUser} 
                                        onClockIn={handleClockIn} 
                                        onDeleteRecord={handleAdminDeleteRecord} 
                                        attendanceHistory={myAttendance.filter(r => r.type !== 'leave')}
                                        timeOffset={timeOffset}
                                        timeSynced={timeSynced}
                                        networkTime={networkTime}
                                        companies={companies}
                                        communities={communities}
                                        checkInLocation={checkInLocation}
                                        setCheckInLocation={setCheckInLocation}
                                        setMapPreviewTarget={setMapPreviewTarget}
                                        setPreviewImageUrl={setPreviewImageUrl}
                                        roles={roles}
                                        isNightShift={isNightShift}
                                        setIsNightShift={setIsNightShift}
                                    />
                                </ErrorBoundary>
                            </div>
                        )}

                        {activeTab === 'overview' && hasPermission('overview') && (
                            <div className="space-y-6 mb-6">
                                {overviewSubtab === 'general' && hasSubPermission('overview', 'general') && (
                                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                        <h2 className="text-lg font-bold text-gray-800 mb-4">總覽</h2>
                                        <div className="space-y-4">
                                            <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider">各社區概況</h3>
                                            {communities.map(c => (
                                                <div key={c.id} className="flex items-center justify-between p-4 bg-gray-50 rounded-2xl border border-gray-100">
                                                    <span className="text-sm font-bold text-gray-700">{c.name}</span>
                                                    <div className="flex gap-2 text-[10px] font-bold">
                                                        <span className="bg-white border border-gray-200 text-gray-600 px-2 py-1 rounded-2xl">正常 98%</span>
                                                        <span className="bg-red-50 text-red-600 px-2 py-1 rounded-2xl">異常 2%</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                {overviewSubtab === 'district' && hasSubPermission('overview', 'district') && (
                                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                        <div className="mb-4 p-3 bg-red-50 rounded-xl text-center">
                                            <span className="text-gray-600 font-bold mr-2">目前選擇公司:</span>
                                            <span className="text-red-600 font-bold">{overviewCompany}</span>
                                        </div>
                                        <div className="flex items-center justify-center mb-4">
                                            <button 
                                                onClick={() => changeOverviewMeetingMonth(-1)}
                                                className="p-1 rounded-full hover:bg-gray-100"
                                            >
                                                <ChevronLeft className="w-5 h-5 text-gray-600" />
                                            </button>
                                            <span className="font-bold text-gray-800 text-lg mx-3">
                                                {overviewMeetingDate.getFullYear()}年 {overviewMeetingDate.getMonth() + 1}月
                                            </span>
                                            <button 
                                                onClick={() => changeOverviewMeetingMonth(1)}
                                                className="p-1 rounded-full hover:bg-gray-100"
                                            >
                                                <ChevronRight className="w-5 h-5 text-gray-600" />
                                            </button>
                                        </div>
                                        <div className="grid grid-cols-7 gap-1 text-center mb-2">
                                            {['日', '一', '二', '三', '四', '五', '六'].map(d => (
                                                <div key={d} className="text-xs font-bold text-gray-400 py-2">{d}</div>
                                            ))}
                                        </div>
                                        <div className="grid grid-cols-7 gap-1">
                                            {(() => {
                                                const year = overviewMeetingDate.getFullYear();
                                                const month = overviewMeetingDate.getMonth();
                                                const daysInMonth = new Date(year, month + 1, 0).getDate();
                                                const firstDayOfWeek = new Date(year, month, 1).getDay();
                                                const days = [];

                                                const dateStatusMap = {};
                                                overviewMeetings
                                                    .filter(meet => 
                                                        meet.companyName === overviewCompany && 
                                                        (meet.type === '例會' || meet.type === '臨時會')
                                                    )
                                                    .forEach(meet => {
                                                        if (!meet.date) return;
                                                        if (!dateStatusMap[meet.date]) {
                                                            dateStatusMap[meet.date] = { count: 0, completedCount: 0 };
                                                        }
                                                        dateStatusMap[meet.date].count++;
                                                        if (meet.completed) {
                                                            dateStatusMap[meet.date].completedCount++;
                                                        }
                                                    });
                                                // Taiwan National Holidays (2025-2026)
                                                const holidays = [
                                                    '2025-01-01', '2025-01-25', '2025-01-26', '2025-01-27', '2025-01-28', '2025-01-29', '2025-01-30', '2025-01-31', '2025-02-01', '2025-02-02', 
                                                    '2025-02-28', 
                                                    '2025-04-03', '2025-04-04', '2025-04-05', '2025-04-06', 
                                                    '2025-05-01', 
                                                    '2025-05-30', '2025-05-31', '2025-06-01', 
                                                    '2025-10-04', '2025-10-05', '2025-10-06', 
                                                    '2025-10-10', '2025-10-11', '2025-10-12', 
                                                    '2025-12-25', 

                                                    '2026-01-01', 
                                                    '2026-02-14', '2026-02-15', '2026-02-16', '2026-02-17', '2026-02-18', '2026-02-19', '2026-02-20', '2026-02-21', '2026-02-22', 
                                                    '2026-02-27', '2026-02-28', '2026-03-01', 
                                                    '2026-04-03', '2026-04-04', '2026-04-05', '2026-04-06', 
                                                    '2026-05-01', 
                                                    '2026-06-19', '2026-06-20', '2026-06-21', 
                                                    '2026-09-25', '2026-09-26', '2026-09-27', 
                                                    '2026-10-09', '2026-10-10', '2026-10-11', 
                                                    '2026-12-25', 
                                                ];

                                                // Empty cells
                                                for (let i = 0; i < firstDayOfWeek; i++) {
                                                    days.push(<div key={`empty-${i}`} className="h-10"></div>);
                                                }

                                                // Days
                                                for (let d = 1; d <= daysInMonth; d++) {
                                                    const currentDate = new Date(year, month, d);
                                                    const isSelected =
                                                        overviewMeetingSelectedDate &&
                                                        overviewMeetingSelectedDate.getFullYear() === currentDate.getFullYear() &&
                                                        overviewMeetingSelectedDate.getMonth() === currentDate.getMonth() &&
                                                        overviewMeetingSelectedDate.getDate() === currentDate.getDate();
                                                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                                                    const isToday = new Date().toDateString() === currentDate.toDateString();
                                                    const isHoliday = holidays.includes(dateStr);
                                                    const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                                                    const status = dateStatusMap[dateStr];
                                                    const hasMeeting = !!status;
                                                    const isPast = currentDate.getTime() < new Date().setHours(0,0,0,0);

                                                    let cellClass = isHoliday || isWeekend ? 'bg-gray-100 text-gray-800' : 'hover:bg-gray-50 text-gray-700';
                                                    
                                                    if (hasMeeting) {
                                                        if (isPast) {
                                                            if (status.completedCount === status.count) {
                                                                cellClass = 'bg-green-600 text-white border border-green-700 shadow-sm hover:bg-green-700';
                                                            } else {
                                                                cellClass = 'bg-red-600 text-white border border-red-700 shadow-sm hover:bg-red-700';
                                                            }
                                                        } else {
                                                            cellClass = 'bg-blue-800 text-white border border-blue-900 shadow-sm hover:bg-blue-900';
                                                        }
                                                    } else if (isToday) {
                                                        cellClass = 'bg-blue-50 text-blue-600 border border-blue-200';
                                                    } else if (isSelected) {
                                                        cellClass = 'bg-red-50 text-red-600 border border-red-200';
                                                    }

                                                    days.push(
                                                        <div 
                                                            key={d} 
                                                            className={`rounded-xl flex items-center justify-center cursor-pointer transition-colors ${cellClass}`}
                                                            style={{ aspectRatio: '2 / 1' }}
                                                            onClick={() => setOverviewMeetingSelectedDate(currentDate)}
                                                        >
                                                            <span className={`text-sm font-bold ${isToday ? 'bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center' : ''}`}>
                                                                {d}
                                                            </span>
                                                        </div>
                                                    );
                                                }
                                                return days;
                                            })()}
                                        </div>
                                        <div className="mt-4 flex flex-wrap gap-2 justify-center">
                                            <div className="flex items-center gap-1 text-xs text-gray-500">
                                                <div className="w-3 h-3 rounded bg-green-100 border border-green-200"></div> 完成
                                            </div>
                                            <div className="flex items-center gap-1 text-xs text-gray-500">
                                                <div className="w-3 h-3 rounded bg-yellow-50 border border-yellow-200"></div> 未完
                                            </div>
                                            <div className="flex items-center gap-1 text-xs text-gray-500">
                                                <div className="w-3 h-3 rounded bg-red-50 border border-transparent"></div> 假日
                                            </div>
                                        </div>

                                        <div className="mt-4 p-4 rounded-xl bg-gray-50 border border-gray-100 text-sm text-left">
                                            <div className="flex justify-between items-center mb-3">
                                                <div className="font-bold text-gray-800 text-sm flex items-center gap-2">
                                                    <span>當日例會</span>
                                                    {overviewMeetingSelectedDate && (
                                                        <span className="text-gray-600">
                                                            {`${overviewMeetingSelectedDate.getFullYear()}年${String(overviewMeetingSelectedDate.getMonth() + 1).padStart(2, '0')}月${String(overviewMeetingSelectedDate.getDate()).padStart(2, '0')}日 (${['日','一','二','三','四','五','六'][overviewMeetingSelectedDate.getDay()]})`}
                                                        </span>
                                                    )}
                                                </div>
                                                <button
                                                    onClick={openOverviewMeetingModal}
                                                    className="px-3 py-1.5 rounded-xl bg-red-600 text-white text-xs font-bold hover:bg-red-700"
                                                >
                                                    + 新增
                                                </button>
                                            </div>
                                            {(function() {
                                                if (!overviewMeetingSelectedDate) {
                                                    return (
                                                        <div className="text-gray-400 text-xs">
                                                            請點選上方日曆中的日期以查看當日例會內容。
                                                        </div>
                                                    );
                                                }
                                                const y = overviewMeetingSelectedDate.getFullYear();
                                                const m = String(overviewMeetingSelectedDate.getMonth() + 1).padStart(2, '0');
                                                const day = String(overviewMeetingSelectedDate.getDate()).padStart(2, '0');
                                                const weekdayNames = ['日', '一', '二', '三', '四', '五', '六'];
                                                const w = weekdayNames[overviewMeetingSelectedDate.getDay()];
                                                const dateKey = `${y}-${m}-${day}`;
                                                const items = overviewMeetings.filter(meet => meet.companyName === overviewCompany && meet.date === dateKey);
                                                if (items.length === 0) {
                                                    return (
                                                        <div>
                                                            <div className="text-xs text-gray-500 italic">
                                                                目前尚未設定此日期的例會內容。
                                                            </div>
                                                        </div>
                                                    );
                                                }
                                                const company = companies.find(c => c.name === overviewCompany);
                                                const companyId = company ? company.id : null;
                                                const availableCommunities = companyId
                                                    ? communities.filter(comm => {
                                                        const ids = comm.companyIds || (comm.companyId ? [comm.companyId] : []);
                                                        return ids.some(id => String(id) === String(companyId));
                                                    })
                                                    : [];
                                                const communityMap = {};
                                                availableCommunities.forEach(comm => {
                                                    communityMap[comm.id] = comm;
                                                });
                                                const userMap = {};
                                                usersList.forEach(u => {
                                                    userMap[u.id] = u;
                                                });
                                                return (
                                                    <div className="space-y-3">
                                                        {items.map(item => {
                                                            const community = communityMap[item.communityId];
                                                            const leader = userMap[item.leaderId];
                                                            const participants = (item.participants || []).map(pid => userMap[pid]).filter(Boolean);
                                                            const canEdit = dbUser?.id === item.creatorId || dbUser?.role === 'admin';
                                                            const canComplete = dbUser?.role === 'admin' || (leader && String(leader.id) === String(dbUser?.id));
                                                            return (
                                                                <div key={item.id} className="p-3 rounded-xl bg-white border border-gray-200 text-xs space-y-1 relative group">
                                                                    <div className="flex justify-between items-center">
                                                                        <div className="font-bold text-gray-800">
                                                                            {item.type || '例會'}
                                                                        </div>
                                                                        <div className="text-gray-500">
                                                                            {item.time || '未設定時間'}
                                                                        </div>
                                                                    </div>
                                                                    <div className="text-gray-700">
                                                                        社區：{community ? community.name : (item.communityId || '未指定')}
                                                                    </div>
                                                                    <div className="text-gray-700 flex items-center gap-2">
                                                                        <span>主導：{leader ? leader.name : '未指定'}</span>
                                                                        {canComplete && (
                                                                    <button
                                                                        onClick={() => openCompleteOverviewMeetingModal(item)}
                                                                        className={`px-2 py-0.5 text-white rounded text-[11px] ${item.completed ? 'bg-green-600 hover:bg-green-700' : 'bg-orange-500 hover:bg-orange-600'}`}
                                                                    >
                                                                        {item.completed ? '已完成' : '是否完成?'}
                                                                    </button>
                                                                )}
                                                                    </div>
                                                                    <div className="text-gray-700">
                                                                        參加：{participants.length > 0 ? participants.map(p => p.name).join('、') : '未指定'}
                                                                    </div>
                                                                    {item.description && (
                                                                        <div className="text-gray-600 whitespace-pre-wrap">
                                                                            {item.description}
                                                                        </div>
                                                                    )}
                                                                    {item.minutes && (
                                                                        <div className="text-gray-700 whitespace-pre-wrap">
                                                                            會議紀錄：{item.minutes}
                                                                        </div>
                                                                    )}
                                                                    {Array.isArray(item.photos) && item.photos.length > 0 && (
                                                                        <div className="grid grid-cols-4 gap-2 mt-1">
                                                                            {item.photos.map((p, idx) => (
                                                                                <img
                                                                                    key={idx}
                                                                                    src={p.dataUrl || p}
                                                                                    alt="會議照片"
                                                                                    className="w-full h-20 object-cover rounded"
                                                                                />
                                                                            ))}
                                                                        </div>
                                                                    )}
                                                                    <div className="text-gray-400 text-[10px] pt-1 border-t border-gray-100 mt-1">
                                                                        建立 : {item.creatorName || '未記錄'}
                                                                    </div>
                                                                    {canEdit && (
                                                                        <div className="flex gap-2 mt-2 pt-2 border-t border-gray-100">
                                                                            <button 
                                                                                onClick={() => handleEditOverviewMeeting(item)}
                                                                                className="flex-1 bg-gray-50 hover:bg-gray-100 text-gray-600 py-1 rounded transition-colors"
                                                                            >
                                                                                編輯
                                                                            </button>
                                                                            <button 
                                                                                onClick={() => handleDeleteOverviewMeeting(item.id)}
                                                                                className="flex-1 bg-red-50 hover:bg-red-100 text-red-600 py-1 rounded transition-colors"
                                                                            >
                                                                                刪除
                                                                            </button>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                );
                                            })()}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'overview' && hasPermission('overview') && hasSubPermission('overview', 'district_meeting') && overviewSubtab === 'district_meeting' && (
                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                <div className="mb-4 p-3 bg-red-50 rounded-xl text-center">
                                    <span className="text-gray-600 font-bold mr-2">目前選擇公司:</span>
                                    <span className="text-red-600 font-bold">{overviewCompany}</span>
                                </div>
                                <div className="flex items-center justify-center mb-4">
                                    <button 
                                        onClick={() => changeOverviewDistrictMeetingMonth(-1)}
                                        className="p-1 rounded-full hover:bg-gray-100"
                                    >
                                        <ChevronLeft className="w-5 h-5 text-gray-600" />
                                    </button>
                                    <span className="font-bold text-gray-800 text-lg mx-3">
                                        {overviewDistrictMeetingDate.getFullYear()}年 {overviewDistrictMeetingDate.getMonth() + 1}月
                                    </span>
                                    <button 
                                        onClick={() => changeOverviewDistrictMeetingMonth(1)}
                                        className="p-1 rounded-full hover:bg-gray-100"
                                    >
                                        <ChevronRight className="w-5 h-5 text-gray-600" />
                                    </button>
                                </div>
                                <div className="grid grid-cols-7 gap-1 text-center mb-2">
                                    {['日', '一', '二', '三', '四', '五', '六'].map(d => (
                                        <div key={d} className="text-xs font-bold text-gray-400 py-2">{d}</div>
                                    ))}
                                </div>
                                <div className="grid grid-cols-7 gap-1">
                                    {(() => {
                                        const year = overviewDistrictMeetingDate.getFullYear();
                                        const month = overviewDistrictMeetingDate.getMonth();
                                        const daysInMonth = new Date(year, month + 1, 0).getDate();
                                        const firstDayOfWeek = new Date(year, month, 1).getDay();
                                        const days = [];
                                        const dateStatusMap = {};
                                        overviewDistrictMeetings
                                            .filter(meet => 
                                                meet.companyName === overviewCompany && 
                                                (meet.type === '區大' || meet.type === '臨時區大')
                                            )
                                            .forEach(meet => {
                                                if (!meet.date) return;
                                                if (!dateStatusMap[meet.date]) {
                                                    dateStatusMap[meet.date] = { count: 0, completedCount: 0 };
                                                }
                                                dateStatusMap[meet.date].count++;
                                                if (meet.completed) {
                                                    dateStatusMap[meet.date].completedCount++;
                                                }
                                            });
                                        const holidays = [
                                            '2025-01-01','2025-01-25','2025-01-26','2025-01-27','2025-01-28','2025-01-29','2025-01-30','2025-01-31','2025-02-01','2025-02-02',
                                            '2025-02-28',
                                            '2025-04-03','2025-04-04','2025-04-05','2025-04-06',
                                            '2025-05-01',
                                            '2025-05-30','2025-05-31','2025-06-01',
                                            '2025-10-04','2025-10-05','2025-10-06',
                                            '2025-10-10','2025-10-11','2025-10-12',
                                            '2025-12-25',
                                            '2026-01-01',
                                            '2026-02-14','2026-02-15','2026-02-16','2026-02-17','2026-02-18','2026-02-19','2026-02-20','2026-02-21','2026-02-22',
                                            '2026-02-27','2026-02-28','2026-03-01',
                                            '2026-04-03','2026-04-04','2026-04-05','2026-04-06',
                                            '2026-05-01',
                                            '2026-06-19','2026-06-20','2026-06-21',
                                            '2026-09-25','2026-09-26','2026-09-27',
                                            '2026-10-09','2026-10-10','2026-10-11',
                                            '2026-12-25',
                                        ];
                                        for (let i = 0; i < firstDayOfWeek; i++) days.push(<div key={`empty-${i}`} className="h-10"></div>);
                                        for (let d = 1; d <= daysInMonth; d++) {
                                            const currentDate = new Date(year, month, d);
                                            const isSelected =
                                                overviewDistrictMeetingSelectedDate &&
                                                overviewDistrictMeetingSelectedDate.getFullYear() === currentDate.getFullYear() &&
                                                overviewDistrictMeetingSelectedDate.getMonth() === currentDate.getMonth() &&
                                                overviewDistrictMeetingSelectedDate.getDate() === currentDate.getDate();
                                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                                            const isToday = new Date().toDateString() === currentDate.toDateString();
                                            const isHoliday = holidays.includes(dateStr);
                                            const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                                            const status = dateStatusMap[dateStr];
                                            const hasMeeting = !!status;
                                            const isPast = currentDate.getTime() < new Date().setHours(0,0,0,0);
                                            let cellClass = isHoliday || isWeekend ? 'bg-gray-100 text-gray-800' : 'hover:bg-gray-50 text-gray-700';
                                            if (hasMeeting) {
                                                if (isPast) {
                                                    if (status.completedCount === status.count) {
                                                        cellClass = 'bg-green-600 text-white border border-green-700 shadow-sm hover:bg-green-700';
                                                    } else {
                                                        cellClass = 'bg-red-600 text-white border border-red-700 shadow-sm hover:bg-red-700';
                                                    }
                                                } else {
                                                    cellClass = 'bg-blue-800 text-white border border-blue-900 shadow-sm hover:bg-blue-900';
                                                }
                                            } else if (isToday) cellClass = 'bg-blue-50 text-blue-600 border border-blue-200';
                                            else if (isSelected) cellClass = 'bg-red-50 text-red-600 border border-red-200';
                                            days.push(
                                                <div 
                                                    key={d} 
                                                    className={`rounded-xl flex items-center justify-center cursor-pointer transition-colors ${cellClass}`}
                                                    style={{ aspectRatio: '2 / 1' }}
                                                    onClick={() => setOverviewDistrictMeetingSelectedDate(currentDate)}
                                                >
                                                    <span className={`text-sm font-bold ${isToday ? 'bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center' : ''}`}>
                                                        {d}
                                                    </span>
                                                </div>
                                            );
                                        }
                                        return days;
                                    })()}
                                </div>
                                <div className="mt-4 p-4 rounded-xl bg-gray-50 border border-gray-100 text-sm text-left">
                                    <div className="flex justify-between items-center mb-3">
                                        <div className="font-bold text-gray-800 text-sm flex items-center gap-2">
                                            <span>當日區大</span>
                                            {overviewDistrictMeetingSelectedDate && (
                                                <span className="text-gray-600">
                                                    {`${overviewDistrictMeetingSelectedDate.getFullYear()}年${String(overviewDistrictMeetingSelectedDate.getMonth() + 1).padStart(2, '0')}月${String(overviewDistrictMeetingSelectedDate.getDate()).padStart(2, '0')}日 (${['日','一','二','三','四','五','六'][overviewDistrictMeetingSelectedDate.getDay()]})`}
                                                </span>
                                            )}
                                        </div>
                                        <button
                                            onClick={openOverviewDistrictMeetingModal}
                                            className="px-3 py-1.5 rounded-xl bg-red-600 text-white text-xs font-bold hover:bg-red-700"
                                        >
                                            + 新增
                                        </button>
                                    </div>
                                    {(function() {
                                        if (!overviewDistrictMeetingSelectedDate) {
                                            return <div className="text-gray-400 text-xs">請點選上方日曆中的日期以查看當日內容。</div>;
                                        }
                                        const y = overviewDistrictMeetingSelectedDate.getFullYear();
                                        const m = String(overviewDistrictMeetingSelectedDate.getMonth() + 1).padStart(2, '0');
                                        const day = String(overviewDistrictMeetingSelectedDate.getDate()).padStart(2, '0');
                                        const dateKey = `${y}-${m}-${day}`;
                                        const items = overviewDistrictMeetings.filter(meet => meet.companyName === overviewCompany && meet.date === dateKey);
                                        if (items.length === 0) {
                                            return <div><div className="text-xs text-gray-500 italic">目前尚未設定此日期的內容。</div></div>;
                                        }
                                        const company = companies.find(c => c.name === overviewCompany);
                                        const companyId = company ? company.id : null;
                                        const availableCommunities = companyId
                                            ? communities.filter(comm => {
                                                const ids = comm.companyIds || (comm.companyId ? [comm.companyId] : []);
                                                return ids.some(id => String(id) === String(companyId));
                                            })
                                            : [];
                                        const communityMap = {};
                                        availableCommunities.forEach(comm => { communityMap[comm.id] = comm; });
                                        const userMap = {};
                                        usersList.forEach(u => { userMap[u.id] = u; });
                                        return (
                                            <div className="space-y-3">
                                                {items.map(item => {
                                                    const community = communityMap[item.communityId];
                                                    const leader = userMap[item.leaderId];
                                                    const participants = (item.participants || []).map(pid => userMap[pid]).filter(Boolean);
                                                    const canEdit = dbUser?.id === item.creatorId || dbUser?.role === 'admin';
                                                    const canComplete = dbUser?.role === 'admin' || (leader && String(leader.id) === String(dbUser?.id));
                                                    return (
                                                        <div key={item.id} className="p-3 rounded-xl bg-white border border-gray-200 text-xs space-y-1 relative group">
                                                            <div className="flex justify-between items-center">
                                                                <div className="font-bold text-gray-800">
                                                                    {item.type || '區大'}
                                                                </div>
                                                                <div className="text-gray-500">
                                                                    {item.time || '未設定時間'}
                                                                </div>
                                                            </div>
                                                            <div className="text-gray-700">
                                                                社區：{community ? community.name : (item.communityId || '未指定')}
                                                            </div>
                                                            <div className="text-gray-700 flex items-center gap-2">
                                                                <span>主導：{leader ? leader.name : '未指定'}</span>
                                                                {canComplete && (
                                                                    <button
                                                                        onClick={() => openCompleteOverviewMeetingModal(item)}
                                                                        className={`px-2 py-0.5 text-white rounded text-[11px] ${item.completed ? 'bg-green-600 hover:bg-green-700' : 'bg-orange-500 hover:bg-orange-600'}`}
                                                                    >
                                                                        {item.completed ? '已完成' : '是否完成?'}
                                                                    </button>
                                                                )}
                                                            </div>
                                                            <div className="text-gray-700">
                                                                參加：{participants.length > 0 ? participants.map(p => p.name).join('、') : '未指定'}
                                                            </div>
                                                            {item.description && (
                                                                <div className="text-gray-600 whitespace-pre-wrap">
                                                                    {item.description}
                                                                </div>
                                                            )}
                                                            {item.minutes && (
                                                                <div className="text-gray-700 whitespace-pre-wrap">
                                                                    會議紀錄：{item.minutes}
                                                                </div>
                                                            )}
                                                            {Array.isArray(item.photos) && item.photos.length > 0 && (
                                                                <div className="grid grid-cols-4 gap-2 mt-1">
                                                                    {item.photos.map((p, idx) => (
                                                                        <img key={idx} src={p.dataUrl || p} alt="照片" className="w-full h-20 object-cover rounded" />
                                                                    ))}
                                                                </div>
                                                            )}
                                                            <div className="text-gray-400 text-[10px] pt-1 border-t border-gray-100 mt-1">
                                                                建立 : {item.creatorName || '未記錄'}
                                                            </div>
                                                            {canEdit && (
                                                                <div className="flex gap-2 mt-2 pt-2 border-t border-gray-100">
                                                                    <button 
                                                                        onClick={() => handleEditOverviewDistrictMeeting(item)}
                                                                        className="flex-1 bg-gray-50 hover:bg-gray-100 text-gray-600 py-1 rounded transition-colors"
                                                                    >
                                                                        編輯
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => handleDeleteOverviewDistrictMeeting(item.id)}
                                                                        className="flex-1 bg-red-50 hover:bg-red-100 text-red-600 py-1 rounded transition-colors"
                                                                    >
                                                                        刪除
                                                                    </button>
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        );
                                    })()}
                                </div>
                            </div>
                        )}

                        {activeTab === 'overview' && overviewSubtab === 'notification' && (
                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-gray-800 flex items-center">
                                        <Bell className="w-5 h-5 mr-2 text-red-600" /> 我的通知
                                    </h3>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-gray-50 text-gray-500 border-b">
                                            <tr>
                                                <th className="px-4 py-3 font-bold whitespace-nowrap w-[80px]">狀態</th>
                                                <th className="px-4 py-3 font-bold whitespace-nowrap">通知內容</th>
                                                <th className="px-4 py-3 font-bold whitespace-nowrap w-[100px]">通知人</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y text-gray-600">
                                            {notifications.filter(n => isNotificationTarget(n)).length === 0 ? (
                                                <tr>
                                                    <td colSpan="3" className="px-4 py-8 text-center text-gray-400">
                                                        尚無通知
                                                    </td>
                                                </tr>
                                            ) : (
                                                notifications.filter(n => isNotificationTarget(n)).map(notif => (
                                                    <tr key={notif.id} className="hover:bg-gray-50">
                                                        <td className="px-4 py-3 whitespace-nowrap text-xs font-bold align-top pt-4">
                                                            {(notif.readBy || []).includes(dbUser?.id) ? (
                                                                <span className="text-gray-400 bg-gray-100 px-2 py-1 rounded">已讀</span>
                                                            ) : (
                                                                <span className="text-red-600 bg-red-50 px-2 py-1 rounded">未讀</span>
                                                            )}
                                                        </td>
                                                        <td className="px-4 py-3 min-w-[200px] align-top">
                                                            <div className="flex items-start justify-between gap-2">
                                                                <div className={`flex-1 text-sm ${expandedNotificationIds.includes(notif.id) ? 'whitespace-pre-wrap' : 'truncate'}`}>
                                                                    {notif.content}
                                                                </div>
                                                                <button 
                                                                    onClick={() => handleToggleNotificationExpand(notif.id)}
                                                                    className="p-1 text-gray-400 hover:text-gray-600 rounded hover:bg-gray-100 flex-shrink-0 mt-[-4px]"
                                                                >
                                                                    <ChevronDown className={`w-5 h-5 transition-transform duration-200 ${expandedNotificationIds.includes(notif.id) ? 'rotate-180' : ''}`} />
                                                                </button>
                                                            </div>
                                                        </td>
                                                        <td className="px-4 py-3 whitespace-nowrap text-xs align-top pt-4">{notif.senderName}</td>
                                                    </tr>
                                                ))
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'overview' && hasPermission('overview') && hasSubPermission('overview', 'activity') && overviewSubtab === 'activity' && (
                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                <div className="mb-4 p-3 bg-red-50 rounded-xl text-center">
                                    <span className="text-gray-600 font-bold mr-2">目前選擇公司:</span>
                                    <span className="text-red-600 font-bold">{overviewCompany}</span>
                                </div>
                                <div className="flex items-center justify-center mb-4">
                                    <button 
                                        onClick={() => changeOverviewActivityMonth(-1)}
                                        className="p-1 rounded-full hover:bg-gray-100"
                                    >
                                        <ChevronLeft className="w-5 h-5 text-gray-600" />
                                    </button>
                                    <span className="font-bold text-gray-800 text-lg mx-3">
                                        {overviewActivityDate.getFullYear()}年 {overviewActivityDate.getMonth() + 1}月
                                    </span>
                                    <button 
                                        onClick={() => changeOverviewActivityMonth(1)}
                                        className="p-1 rounded-full hover:bg-gray-100"
                                    >
                                        <ChevronRight className="w-5 h-5 text-gray-600" />
                                    </button>
                                </div>
                                <div className="grid grid-cols-7 gap-1 text-center mb-2">
                                    {['日', '一', '二', '三', '四', '五', '六'].map(d => (
                                        <div key={d} className="text-xs font-bold text-gray-400 py-2">{d}</div>
                                    ))}
                                </div>
                                <div className="grid grid-cols-7 gap-1">
                                    {(() => {
                                        const year = overviewActivityDate.getFullYear();
                                        const month = overviewActivityDate.getMonth();
                                        const daysInMonth = new Date(year, month + 1, 0).getDate();
                                        const firstDayOfWeek = new Date(year, month, 1).getDay();
                                        const days = [];
                                        const dateStatusMap = {};
                                        overviewActivities
                                            .filter(meet => 
                                                meet.companyName === overviewCompany
                                            )
                                            .forEach(meet => {
                                                if (!meet.date) return;
                                                if (!dateStatusMap[meet.date]) {
                                                    dateStatusMap[meet.date] = { count: 0, completedCount: 0 };
                                                }
                                                dateStatusMap[meet.date].count++;
                                                if (meet.completed) {
                                                    dateStatusMap[meet.date].completedCount++;
                                                }
                                            });
                                        const holidays = [
                                            '2025-01-01','2025-01-25','2025-01-26','2025-01-27','2025-01-28','2025-01-29','2025-01-30','2025-01-31','2025-02-01','2025-02-02',
                                            '2025-02-28',
                                            '2025-04-03','2025-04-04','2025-04-05','2025-04-06',
                                            '2025-05-01',
                                            '2025-05-30','2025-05-31','2025-06-01',
                                            '2025-10-04','2025-10-05','2025-10-06',
                                            '2025-10-10','2025-10-11','2025-10-12',
                                            '2025-12-25',
                                            '2026-01-01',
                                            '2026-02-14','2026-02-15','2026-02-16','2026-02-17','2026-02-18','2026-02-19','2026-02-20','2026-02-21','2026-02-22',
                                            '2026-02-27','2026-02-28','2026-03-01',
                                            '2026-04-03','2026-04-04','2026-04-05','2026-04-06',
                                            '2026-05-01',
                                            '2026-06-19','2026-06-20','2026-06-21',
                                            '2026-09-25','2026-09-26','2026-09-27',
                                            '2026-10-09','2026-10-10','2026-10-11',
                                            '2026-12-25',
                                        ];
                                        for (let i = 0; i < firstDayOfWeek; i++) days.push(<div key={`empty-${i}`} className="h-10"></div>);
                                        for (let d = 1; d <= daysInMonth; d++) {
                                            const currentDate = new Date(year, month, d);
                                            const isSelected =
                                                overviewActivitySelectedDate &&
                                                overviewActivitySelectedDate.getFullYear() === currentDate.getFullYear() &&
                                                overviewActivitySelectedDate.getMonth() === currentDate.getMonth() &&
                                                overviewActivitySelectedDate.getDate() === currentDate.getDate();
                                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                                            const isToday = new Date().toDateString() === currentDate.toDateString();
                                            const isHoliday = holidays.includes(dateStr);
                                            const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                                            const status = dateStatusMap[dateStr];
                                            const hasMeeting = !!status;
                                            const isPast = currentDate.getTime() < new Date().setHours(0,0,0,0);
                                            let cellClass = isHoliday || isWeekend ? 'bg-gray-100 text-gray-800' : 'hover:bg-gray-50 text-gray-700';
                                            if (hasMeeting) {
                                                if (isPast) {
                                                    if (status.completedCount === status.count) {
                                                        cellClass = 'bg-green-600 text-white border border-green-700 shadow-sm hover:bg-green-700';
                                                    } else {
                                                        cellClass = 'bg-red-600 text-white border border-red-700 shadow-sm hover:bg-red-700';
                                                    }
                                                } else {
                                                    cellClass = 'bg-blue-800 text-white border border-blue-900 shadow-sm hover:bg-blue-900';
                                                }
                                            } else if (isToday) cellClass = 'bg-blue-50 text-blue-600 border border-blue-200';
                                            else if (isSelected) cellClass = 'bg-red-50 text-red-600 border border-red-200';
                                            days.push(
                                                <div 
                                                    key={d} 
                                                    className={`rounded-xl flex items-center justify-center cursor-pointer transition-colors ${cellClass}`}
                                                    style={{ aspectRatio: '2 / 1' }}
                                                    onClick={() => setOverviewActivitySelectedDate(currentDate)}
                                                >
                                                    <span className={`text-sm font-bold ${isToday ? 'bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center' : ''}`}>
                                                        {d}
                                                    </span>
                                                </div>
                                            );
                                        }
                                        return days;
                                    })()}
                                </div>
                                <div className="mt-4 p-4 rounded-xl bg-gray-50 border border-gray-100 text-sm text-left">
                                    <div className="flex justify-between items-center mb-3">
                                        <div className="font-bold text-gray-800 text-sm flex items-center gap-2">
                                            <span>當日活動</span>
                                            {overviewActivitySelectedDate && (
                                                <span className="text-gray-600">
                                                    {`${overviewActivitySelectedDate.getFullYear()}年${String(overviewActivitySelectedDate.getMonth() + 1).padStart(2, '0')}月${String(overviewActivitySelectedDate.getDate()).padStart(2, '0')}日 (${['日','一','二','三','四','五','六'][overviewActivitySelectedDate.getDay()]})`}
                                                </span>
                                            )}
                                        </div>
                                        <button
                                            onClick={openOverviewActivityModal}
                                            className="px-3 py-1.5 rounded-xl bg-red-600 text-white text-xs font-bold hover:bg-red-700"
                                        >
                                            + 新增
                                        </button>
                                    </div>
                                    {(function() {
                                        if (!overviewActivitySelectedDate) {
                                            return <div className="text-gray-400 text-xs">請點選上方日曆中的日期以查看當日內容。</div>;
                                        }
                                        const y = overviewActivitySelectedDate.getFullYear();
                                        const m = String(overviewActivitySelectedDate.getMonth() + 1).padStart(2, '0');
                                        const day = String(overviewActivitySelectedDate.getDate()).padStart(2, '0');
                                        const dateKey = `${y}-${m}-${day}`;
                                        const items = overviewActivities.filter(meet => meet.companyName === overviewCompany && meet.date === dateKey);
                                        if (items.length === 0) {
                                            return <div><div className="text-xs text-gray-500 italic">目前尚未設定此日期的內容。</div></div>;
                                        }
                                        const company = companies.find(c => c.name === overviewCompany);
                                        const companyId = company ? company.id : null;
                                        const availableCommunities = companyId
                                            ? communities.filter(comm => {
                                                const ids = comm.companyIds || (comm.companyId ? [comm.companyId] : []);
                                                return ids.some(id => String(id) === String(companyId));
                                            })
                                            : [];
                                        const communityMap = {};
                                        availableCommunities.forEach(comm => { communityMap[comm.id] = comm; });
                                        const userMap = {};
                                        usersList.forEach(u => { userMap[u.id] = u; });
                                        return (
                                            <div className="space-y-3">
                                                {items.map(item => {
                                                    const community = communityMap[item.communityId];
                                                    const leader = userMap[item.leaderId];
                                                    const participants = (item.participants || []).map(pid => userMap[pid]).filter(Boolean);
                                                    const canEdit = dbUser?.id === item.creatorId || dbUser?.role === 'admin';
                                                    const canComplete = dbUser?.role === 'admin' || (leader && String(leader.id) === String(dbUser?.id));
                                                    return (
                                                        <div key={item.id} className="p-3 rounded-xl bg-white border border-gray-200 text-xs space-y-1 relative group">
                                                            <div className="flex justify-between items-center">
                                                                <div className="font-bold text-gray-800">
                                                                    {item.type || '活動'}
                                                                </div>
                                                                <div className="text-gray-500">
                                                                    {item.time || '未設定時間'}
                                                                </div>
                                                            </div>
                                                            <div className="text-gray-700">
                                                                社區：{community ? community.name : (item.communityId || '未指定')}
                                                            </div>
                                                            <div className="text-gray-700 flex items-center gap-2">
                                                                <span>主導：{leader ? leader.name : '未指定'}</span>
                                                                {canComplete && (
                                                                    <button
                                                                        onClick={() => openCompleteOverviewMeetingModal(item)}
                                                                        className={`px-2 py-0.5 text-white rounded text-[11px] ${item.completed ? 'bg-green-600 hover:bg-green-700' : 'bg-orange-500 hover:bg-orange-600'}`}
                                                                    >
                                                                        {item.completed ? '已完成' : '是否完成?'}
                                                                    </button>
                                                                )}
                                                            </div>
                                                            <div className="text-gray-700">
                                                                參加：{participants.length > 0 ? participants.map(p => p.name).join('、') : '未指定'}
                                                            </div>
                                                            {item.description && (
                                                                <div className="text-gray-600 whitespace-pre-wrap">
                                                                    {item.description}
                                                                </div>
                                                            )}
                                                            {item.minutes && (
                                                                <div className="text-gray-700 whitespace-pre-wrap">
                                                                    會議紀錄：{item.minutes}
                                                                </div>
                                                            )}
                                                            {Array.isArray(item.photos) && item.photos.length > 0 && (
                                                                <div className="grid grid-cols-4 gap-2 mt-1">
                                                                    {item.photos.map((p, idx) => (
                                                                        <img key={idx} src={p.dataUrl || p} alt="照片" className="w-full h-20 object-cover rounded" />
                                                                    ))}
                                                                </div>
                                                            )}
                                                            <div className="text-gray-400 text-[10px] pt-1 border-t border-gray-100 mt-1">
                                                                建立 : {item.creatorName || '未記錄'}
                                                            </div>
                                                            {canEdit && (
                                                                <div className="flex gap-2 mt-2 pt-2 border-t border-gray-100">
                                                                    <button 
                                                                        onClick={() => handleEditOverviewActivity(item)}
                                                                        className="flex-1 bg-gray-50 hover:bg-gray-100 text-gray-600 py-1 rounded transition-colors"
                                                                    >
                                                                        編輯
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => handleDeleteOverviewActivity(item.id)}
                                                                        className="flex-1 bg-red-50 hover:bg-red-100 text-red-600 py-1 rounded transition-colors"
                                                                    >
                                                                        刪除
                                                                    </button>
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        );
                                    })()}
                                </div>
                            </div>
                        )}

                        {activeTab === 'overview' && hasPermission('overview') && hasSubPermission('overview', 'presentation') && overviewSubtab === 'presentation' && (
                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                <div className="mb-4 p-3 bg-red-50 rounded-xl text-center">
                                    <span className="text-gray-600 font-bold mr-2">目前選擇公司:</span>
                                    <span className="text-red-600 font-bold">{overviewCompany}</span>
                                </div>
                                <div className="flex items-center justify-center mb-4">
                                    <button 
                                        onClick={() => changeOverviewPresentationMonth(-1)}
                                        className="p-1 rounded-full hover:bg-gray-100"
                                    >
                                        <ChevronLeft className="w-5 h-5 text-gray-600" />
                                    </button>
                                    <span className="font-bold text-gray-800 text-lg mx-3">
                                        {overviewPresentationDate.getFullYear()}年 {overviewPresentationDate.getMonth() + 1}月
                                    </span>
                                    <button 
                                        onClick={() => changeOverviewPresentationMonth(1)}
                                        className="p-1 rounded-full hover:bg-gray-100"
                                    >
                                        <ChevronRight className="w-5 h-5 text-gray-600" />
                                    </button>
                                </div>
                                <div className="grid grid-cols-7 gap-1 text-center mb-2">
                                    {['日', '一', '二', '三', '四', '五', '六'].map(d => (
                                        <div key={d} className="text-xs font-bold text-gray-400 py-2">{d}</div>
                                    ))}
                                </div>
                                <div className="grid grid-cols-7 gap-1">
                                    {(() => {
                                        const year = overviewPresentationDate.getFullYear();
                                        const month = overviewPresentationDate.getMonth();
                                        const daysInMonth = new Date(year, month + 1, 0).getDate();
                                        const firstDayOfWeek = new Date(year, month, 1).getDay();
                                        const days = [];
                                        const dateStatusMap = {};
                                        overviewPresentations
                                            .filter(meet => 
                                                meet.companyName === overviewCompany && 
                                                meet.type === '簡報'
                                            )
                                            .forEach(meet => {
                                                if (!meet.date) return;
                                                if (!dateStatusMap[meet.date]) {
                                                    dateStatusMap[meet.date] = { count: 0, completedCount: 0 };
                                                }
                                                dateStatusMap[meet.date].count++;
                                                if (meet.completed) {
                                                    dateStatusMap[meet.date].completedCount++;
                                                }
                                            });
                                        const holidays = [
                                            '2025-01-01','2025-01-25','2025-01-26','2025-01-27','2025-01-28','2025-01-29','2025-01-30','2025-01-31','2025-02-01','2025-02-02',
                                            '2025-02-28',
                                            '2025-04-03','2025-04-04','2025-04-05','2025-04-06',
                                            '2025-05-01',
                                            '2025-05-30','2025-05-31','2025-06-01',
                                            '2025-10-04','2025-10-05','2025-10-06',
                                            '2025-10-10','2025-10-11','2025-10-12',
                                            '2025-12-25',
                                            '2026-01-01',
                                            '2026-02-14','2026-02-15','2026-02-16','2026-02-17','2026-02-18','2026-02-19','2026-02-20','2026-02-21','2026-02-22',
                                            '2026-02-27','2026-02-28','2026-03-01',
                                            '2026-04-03','2026-04-04','2026-04-05','2026-04-06',
                                            '2026-05-01',
                                            '2026-06-19','2026-06-20','2026-06-21',
                                            '2026-09-25','2026-09-26','2026-09-27',
                                            '2026-10-09','2026-10-10','2026-10-11',
                                            '2026-12-25',
                                        ];
                                        for (let i = 0; i < firstDayOfWeek; i++) days.push(<div key={`empty-${i}`} className="h-10"></div>);
                                        for (let d = 1; d <= daysInMonth; d++) {
                                            const currentDate = new Date(year, month, d);
                                            const isSelected =
                                                overviewPresentationSelectedDate &&
                                                overviewPresentationSelectedDate.getFullYear() === currentDate.getFullYear() &&
                                                overviewPresentationSelectedDate.getMonth() === currentDate.getMonth() &&
                                                overviewPresentationSelectedDate.getDate() === currentDate.getDate();
                                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                                            const isToday = new Date().toDateString() === currentDate.toDateString();
                                            const isHoliday = holidays.includes(dateStr);
                                            const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                                            const status = dateStatusMap[dateStr];
                                            const hasMeeting = !!status;
                                            const isPast = currentDate.getTime() < new Date().setHours(0,0,0,0);
                                            let cellClass = isHoliday || isWeekend ? 'bg-gray-100 text-gray-800' : 'hover:bg-gray-50 text-gray-700';
                                            if (hasMeeting) {
                                                if (isPast) {
                                                    if (status.completedCount === status.count) {
                                                        cellClass = 'bg-green-600 text-white border border-green-700 shadow-sm hover:bg-green-700';
                                                    } else {
                                                        cellClass = 'bg-red-600 text-white border border-red-700 shadow-sm hover:bg-red-700';
                                                    }
                                                } else {
                                                    cellClass = 'bg-blue-800 text-white border border-blue-900 shadow-sm hover:bg-blue-900';
                                                }
                                            } else if (isToday) cellClass = 'bg-blue-50 text-blue-600 border border-blue-200';
                                            else if (isSelected) cellClass = 'bg-red-50 text-red-600 border border-red-200';
                                            days.push(
                                                <div 
                                                    key={d} 
                                                    className={`rounded-xl flex items-center justify-center cursor-pointer transition-colors ${cellClass}`}
                                                    style={{ aspectRatio: '2 / 1' }}
                                                    onClick={() => setOverviewPresentationSelectedDate(currentDate)}
                                                >
                                                    <span className={`text-sm font-bold ${isToday ? 'bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center' : ''}`}>
                                                        {d}
                                                    </span>
                                                </div>
                                            );
                                        }
                                        return days;
                                    })()}
                                </div>
                                <div className="mt-4 p-4 rounded-xl bg-gray-50 border border-gray-100 text-sm text-left">
                                    <div className="flex justify-between items-center mb-3">
                                        <div className="font-bold text-gray-800 text-sm flex items-center gap-2">
                                            <span>當日簡報</span>
                                            {overviewPresentationSelectedDate && (
                                                <span className="text-gray-600">
                                                    {`${overviewPresentationSelectedDate.getFullYear()}年${String(overviewPresentationSelectedDate.getMonth() + 1).padStart(2, '0')}月${String(overviewPresentationSelectedDate.getDate()).padStart(2, '0')}日 (${['日','一','二','三','四','五','六'][overviewPresentationSelectedDate.getDay()]})`}
                                                </span>
                                            )}
                                        </div>
                                        <button
                                            onClick={openOverviewPresentationModal}
                                            className="px-3 py-1.5 rounded-xl bg-red-600 text-white text-xs font-bold hover:bg-red-700"
                                        >
                                            + 新增
                                        </button>
                                    </div>
                                    {(function() {
                                        if (!overviewPresentationSelectedDate) {
                                            return <div className="text-gray-400 text-xs">請點選上方日曆中的日期以查看當日內容。</div>;
                                        }
                                        const y = overviewPresentationSelectedDate.getFullYear();
                                        const m = String(overviewPresentationSelectedDate.getMonth() + 1).padStart(2, '0');
                                        const day = String(overviewPresentationSelectedDate.getDate()).padStart(2, '0');
                                        const dateKey = `${y}-${m}-${day}`;
                                        const items = overviewPresentations.filter(meet => meet.companyName === overviewCompany && meet.date === dateKey);
                                        if (items.length === 0) {
                                            return <div><div className="text-xs text-gray-500 italic">目前尚未設定此日期的內容。</div></div>;
                                        }
                                        const company = companies.find(c => c.name === overviewCompany);
                                        const companyId = company ? company.id : null;
                                        const availableCommunities = companyId
                                            ? communities.filter(comm => {
                                                const ids = comm.companyIds || (comm.companyId ? [comm.companyId] : []);
                                                return ids.some(id => String(id) === String(companyId));
                                            })
                                            : [];
                                        const communityMap = {};
                                        availableCommunities.forEach(comm => { communityMap[comm.id] = comm; });
                                        const userMap = {};
                                        usersList.forEach(u => { userMap[u.id] = u; });
                                        return (
                                            <div className="space-y-3">
                                                {items.map(item => {
                                                    const community = communityMap[item.communityId];
                                                    const leader = userMap[item.leaderId];
                                                    const participants = (item.participants || []).map(pid => userMap[pid]).filter(Boolean);
                                                    const canEdit = dbUser?.id === item.creatorId || dbUser?.role === 'admin';
                                                    const canComplete = dbUser?.role === 'admin' || (leader && String(leader.id) === String(dbUser?.id));
                                                    return (
                                                        <div key={item.id} className="p-3 rounded-xl bg-white border border-gray-200 text-xs space-y-1 relative group">
                                                            <div className="flex justify-between items-center">
                                                                <div className="font-bold text-gray-800">
                                                                    {item.type || '簡報'}
                                                                </div>
                                                                <div className="text-gray-500">
                                                                    {item.time || '未設定時間'}
                                                                </div>
                                                            </div>
                                                            <div className="text-gray-700">
                                                                社區：{community ? community.name : (item.communityId || '未指定')}
                                                            </div>
                                                            <div className="text-gray-700 flex items-center gap-2">
                                                                <span>主導：{leader ? leader.name : '未指定'}</span>
                                                                {canComplete && (
                                                                    <button
                                                                        onClick={() => openCompleteOverviewMeetingModal(item)}
                                                                        className={`px-2 py-0.5 text-white rounded text-[11px] ${item.completed ? 'bg-green-600 hover:bg-green-700' : 'bg-orange-500 hover:bg-orange-600'}`}
                                                                    >
                                                                        {item.completed ? '已完成' : '是否完成?'}
                                                                    </button>
                                                                )}
                                                            </div>
                                                            <div className="text-gray-700">
                                                                參加：{participants.length > 0 ? participants.map(p => p.name).join('、') : '未指定'}
                                                            </div>
                                                            {item.description && (
                                                                <div className="text-gray-600 whitespace-pre-wrap">
                                                                    {item.description}
                                                                </div>
                                                            )}
                                                            {item.minutes && (
                                                                <div className="text-gray-700 whitespace-pre-wrap">
                                                                    會議紀錄：{item.minutes}
                                                                </div>
                                                            )}
                                                            {Array.isArray(item.photos) && item.photos.length > 0 && (
                                                                <div className="grid grid-cols-4 gap-2 mt-1">
                                                                    {item.photos.map((p, idx) => (
                                                                        <img key={idx} src={p.dataUrl || p} alt="照片" className="w-full h-20 object-cover rounded" />
                                                                    ))}
                                                                </div>
                                                            )}
                                                            <div className="text-gray-400 text-[10px] pt-1 border-t border-gray-100 mt-1">
                                                                建立 : {item.creatorName || '未記錄'}
                                                            </div>
                                                            {canEdit && (
                                                                <div className="flex gap-2 mt-2 pt-2 border-t border-gray-100">
                                                                    <button 
                                                                        onClick={() => handleEditOverviewPresentation(item)}
                                                                        className="flex-1 bg-gray-50 hover:bg-gray-100 text-gray-600 py-1 rounded transition-colors"
                                                                    >
                                                                        編輯
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => handleDeleteOverviewPresentation(item.id)}
                                                                        className="flex-1 bg-red-50 hover:bg-red-100 text-red-600 py-1 rounded transition-colors"
                                                                    >
                                                                        刪除
                                                                    </button>
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        );
                                    })()}
                                </div>
                            </div>
                        )}

                        {activeTab === 'clock' && hasPermission('clock') && (
                            <div className="space-y-6 mb-6">
                                {clockSubtab === 'work' && hasSubPermission('clock', 'work') && (
                                    <StaffDashboard 
                                        currentUser={dbUser} 
                                        onClockIn={handleClockIn} 
                                        onDeleteRecord={handleAdminDeleteRecord}
                                        attendanceHistory={myAttendance.filter(r => ['in', 'out'].includes(r.type))}
                                        timeOffset={timeOffset}
                                        timeSynced={timeSynced}
                                        networkTime={networkTime}
                                        companies={companies}
                                        communities={communities}
                                        checkInLocation={checkInLocation}
                                        setCheckInLocation={setCheckInLocation}
                                        setMapPreviewTarget={setMapPreviewTarget}
                                        setPreviewImageUrl={setPreviewImageUrl}
                                        roles={roles}
                                        hideHeaderInfo={true}
                                        mode="work"
                                        isNightShift={isNightShift}
                                        setIsNightShift={setIsNightShift}
                                    />
                                )}
                                {clockSubtab === 'out' && hasSubPermission('clock', 'out') && (
                                    <StaffDashboard 
                                        currentUser={dbUser} 
                                        onClockIn={handleClockIn} 
                                        onDeleteRecord={handleAdminDeleteRecord}
                                        attendanceHistory={myAttendance.filter(r => ['outing_start', 'outing_arrive', 'outing_end'].includes(r.type))}
                                        timeOffset={timeOffset}
                                        timeSynced={timeSynced}
                                        networkTime={networkTime}
                                        companies={companies}
                                        communities={communities}
                                        checkInLocation={checkInLocation}
                                        setCheckInLocation={setCheckInLocation}
                                        setMapPreviewTarget={setMapPreviewTarget}
                                        setPreviewImageUrl={setPreviewImageUrl}
                                        roles={roles}
                                        hideHeaderInfo={true}
                                        mode="outing"
                                        isNightShift={isNightShift}
                                        setIsNightShift={setIsNightShift}
                                    />
                                )}
                                {clockSubtab === 'card' && hasSubPermission('clock', 'card') && (
                                    <StaffDashboard 
                                        currentUser={dbUser} 
                                        onClockIn={handleClockIn} 
                                        onDeleteRecord={handleAdminDeleteRecord}
                                        attendanceHistory={myAttendance.filter(r => ['late_in', 'late_out'].includes(r.type))}
                                        timeOffset={timeOffset}
                                        timeSynced={timeSynced}
                                        networkTime={networkTime}
                                        companies={companies}
                                        communities={communities}
                                        checkInLocation={checkInLocation}
                                        setCheckInLocation={setCheckInLocation}
                                        setMapPreviewTarget={setMapPreviewTarget}
                                        setPreviewImageUrl={setPreviewImageUrl}
                                        roles={roles}
                                        hideHeaderInfo={true}
                                        mode="card"
                                        isNightShift={isNightShift}
                                        setIsNightShift={setIsNightShift}
                                    />
                                )}
                                {clockSubtab === 'leave' && hasSubPermission('clock', 'leave') && (
                                    <StaffDashboard 
                                        currentUser={dbUser} 
                                        onClockIn={handleClockIn}
                                        onDeleteRecord={handleAdminDeleteRecord}
                                        onLeaveSubmit={handleLeaveSubmit}
                                        attendanceHistory={[]}
                                        timeOffset={timeOffset}
                                        timeSynced={timeSynced}
                                        networkTime={networkTime}
                                        companies={companies}
                                        communities={communities}
                                        checkInLocation={checkInLocation}
                                        setCheckInLocation={setCheckInLocation}
                                        setMapPreviewTarget={setMapPreviewTarget}
                                        setPreviewImageUrl={setPreviewImageUrl}
                                        roles={roles}
                                        hideHeaderInfo={true}
                                        mode="leave"
                                        isNightShift={isNightShift}
                                        setIsNightShift={setIsNightShift}
                                    />
                                )}
                                {clockSubtab === 'schedule' && (
                                    <div>
                                        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                                            <div className="flex items-center justify-between mb-4">
                                                <button 
                                                    onClick={() => setClockScheduleDate(new Date(clockScheduleDate.getFullYear(), clockScheduleDate.getMonth() - 1, 1))}
                                                    className="p-1 rounded-full hover:bg-gray-100"
                                                >
                                                    <ChevronLeft className="w-5 h-5 text-gray-600" />
                                                </button>
                                                <span className="font-bold text-gray-800 text-lg">
                                                    {clockScheduleDate.getFullYear()}年 {clockScheduleDate.getMonth() + 1}月
                                                </span>
                                                <button 
                                                    onClick={() => setClockScheduleDate(new Date(clockScheduleDate.getFullYear(), clockScheduleDate.getMonth() + 1, 1))}
                                                    className="p-1 rounded-full hover:bg-gray-100"
                                                >
                                                    <ChevronRight className="w-5 h-5 text-gray-600" />
                                                </button>
                                            </div>
                                            <div className="grid grid-cols-7 gap-1 text-center mb-2">
                                                {['日', '一', '二', '三', '四', '五', '六'].map(d => (
                                                    <div key={d} className="text-xs font-bold text-gray-400 py-2">{d}</div>
                                                ))}
                                            </div>
                                            <div className="grid grid-cols-7 gap-1">
                                                {(() => {
                                                    const year = clockScheduleDate.getFullYear();
                                                    const month = clockScheduleDate.getMonth();
                                                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                                                    const firstDayOfWeek = new Date(year, month, 1).getDay();
                                                    const days = [];
                                                    
                                                    // Taiwan National Holidays (2025-2026)
                                                    const holidays = [
                                                        '2025-01-01', '2025-01-25', '2025-01-26', '2025-01-27', '2025-01-28', '2025-01-29', '2025-01-30', '2025-01-31', '2025-02-01', '2025-02-02', 
                                                        '2025-02-28', 
                                                        '2025-04-03', '2025-04-04', '2025-04-05', '2025-04-06', 
                                                        '2025-05-01', 
                                                        '2025-05-30', '2025-05-31', '2025-06-01', 
                                                        '2025-10-04', '2025-10-05', '2025-10-06', 
                                                        '2025-10-10', '2025-10-11', '2025-10-12', 
                                                        '2025-12-25', 

                                                        '2026-01-01', 
                                                        '2026-02-14', '2026-02-15', '2026-02-16', '2026-02-17', '2026-02-18', '2026-02-19', '2026-02-20', '2026-02-21', '2026-02-22', 
                                                        '2026-02-27', '2026-02-28', '2026-03-01', 
                                                        '2026-04-03', '2026-04-04', '2026-04-05', '2026-04-06', 
                                                        '2026-05-01', 
                                                        '2026-06-19', '2026-06-20', '2026-06-21', 
                                                        '2026-09-25', '2026-09-26', '2026-09-27', 
                                                        '2026-10-09', '2026-10-10', '2026-10-11', 
                                                        '2026-12-25', 
                                                    ];

                                                    // Empty cells
                                                    for (let i = 0; i < firstDayOfWeek; i++) {
                                                        days.push(<div key={`empty-${i}`} className="h-10"></div>);
                                                    }

                                                    // Days
                                                    for (let d = 1; d <= daysInMonth; d++) {
                                                        const currentDate = new Date(year, month, d);
                                                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                                                        const isToday = new Date().toDateString() === currentDate.toDateString();
                                                        const isPastDateGrid = currentDate < new Date(new Date().setHours(0,0,0,0));
                                                        const isHoliday = holidays.includes(dateStr);
                                                        const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                                                        const schedule = mySchedules[dateStr];

                                                        let cellClass = isHoliday || isWeekend ? 'bg-gray-100 text-gray-800' : 'hover:bg-gray-50 text-gray-700';
                                                        
                                                        // Check for Approved Leave (range-based)
                                                        const dayStart = new Date(year, month, d, 0, 0, 0);
                                                        const dayEnd = new Date(year, month, d, 23, 59, 59);
                                                        const isApprovedLeaveOnDay = (() => {
                                                            const parseRange = (l) => {
                                                                if ((l.type && l.type !== 'leave') || (l.approvalStatus && l.approvalStatus !== 'approved')) return null;
                                                                let s, e;
                                                                const combine = (d, t, defT) => {
                                                                    if (!d) return null;
                                                                    let dStr = String(d).replace(/\//g, '-');
                                                                    if (dStr.includes('T') || (dStr.includes(' ') && dStr.includes(':'))) {
                                                                        const tryDate = new Date(dStr);
                                                                        if (!isNaN(tryDate.getTime())) return tryDate;
                                                                    }
                                                                    const tStr = t || defT;
                                                                    return new Date(`${dStr}T${tStr}`);
                                                                };
                                                                if (l.leaveStartDate) {
                                                                    s = combine(l.leaveStartDate, l.leaveStartTime, '00:00:00');
                                                                } else if (l.startDate) {
                                                                    s = combine(l.startDate, l.startTime, '00:00:00');
                                                                } else if (l.leaveDate) {
                                                                    s = combine(l.leaveDate, l.leaveTime, '00:00:00');
                                                                }
                                                                if (l.leaveEndDate) {
                                                                    e = combine(l.leaveEndDate, l.leaveEndTime, '23:59:59');
                                                                } else if (l.endDate) {
                                                                    e = combine(l.endDate, l.endTime, '23:59:59');
                                                                } else if (s) {
                                                                    e = new Date(s.getFullYear(), s.getMonth(), s.getDate(), 23, 59, 59);
                                                                }
                                                                if (!s || !e || isNaN(s) || isNaN(e)) return null;
                                                                return { s, e };
                                                            };
                                                            const listA = (myAttendance || []).filter(r => r.type === 'leave' && r.approvalStatus === 'approved');
                                                            const listB = (leavesList && leavesList.length > 0) 
                                                                ? leavesList.filter(r => r.userId === dbUser?.id && r.approvalStatus === 'approved')
                                                                : (myLeaves || []).filter(r => r.approvalStatus === 'approved');
                                                            for (const l of [...listA, ...listB]) {
                                                                const rng = parseRange(l);
                                                                if (!rng) continue;
                                                                if (rng.s <= dayEnd && rng.e >= dayStart) return true;
                                                            }
                                                            return false;
                                                        })();

                                                    const leaveInfo = (() => {
                                                        const parseRange = (l) => {
                                                            if ((l.type && l.type !== 'leave') || (l.approvalStatus && l.approvalStatus !== 'approved')) return null;
                                                            let s, e;
                                                            const combine = (d, t, defT) => {
                                                                if (!d) return null;
                                                                let dStr = String(d).replace(/\//g, '-');
                                                                if (dStr.includes('T') || (dStr.includes(' ') && dStr.includes(':'))) {
                                                                    const tryDate = new Date(dStr);
                                                                    if (!isNaN(tryDate.getTime())) return tryDate;
                                                                }
                                                                const tStr = t || defT;
                                                                return new Date(`${dStr}T${tStr}`);
                                                            };
                                                            if (l.leaveStartDate) {
                                                                s = combine(l.leaveStartDate, l.leaveStartTime, '00:00:00');
                                                            } else if (l.startDate) {
                                                                s = combine(l.startDate, l.startTime, '00:00:00');
                                                            } else if (l.leaveDate) {
                                                                s = combine(l.leaveDate, l.leaveTime, '00:00:00');
                                                            }
                                                            if (l.leaveEndDate) {
                                                                e = combine(l.leaveEndDate, l.leaveEndTime, '23:59:59');
                                                            } else if (l.endDate) {
                                                                e = combine(l.endDate, l.endTime, '23:59:59');
                                                            } else if (s) {
                                                                e = new Date(s.getFullYear(), s.getMonth(), s.getDate(), 23, 59, 59);
                                                            }
                                                            if (!s || !e || isNaN(s) || isNaN(e)) return null;
                                                            return { s, e };
                                                        };
                                                        const listA = (myAttendance || []).filter(r => r.type === 'leave' && r.approvalStatus === 'approved');
                                                        const listB = (leavesList && leavesList.length > 0) 
                                                            ? leavesList.filter(r => r.userId === dbUser?.id && r.approvalStatus === 'approved')
                                                            : (myLeaves || []).filter(r => r.approvalStatus === 'approved');
                                                        let totalHours = 0;
                                                        let minStart = null;
                                                        let maxEnd = null;
                                                        for (const l of [...listA, ...listB]) {
                                                            const rng = parseRange(l);
                                                            if (!rng) continue;
                                                            if (rng.s <= dayEnd && rng.e >= dayStart) {
                                                                let os = rng.s > dayStart ? rng.s : dayStart;
                                                                let oe = rng.e < dayEnd ? rng.e : dayEnd;
                                                                if (schedule && (schedule.type === 'work' || schedule.type === 'duty') && schedule.startTime && schedule.endTime) {
                                                                    const [sh, sm] = String(schedule.startTime).split(':').map(x => parseInt(x, 10));
                                                                    const [eh, em] = String(schedule.endTime).split(':').map(x => parseInt(x, 10));
                                                                    const ss = new Date(year, month, d, Number(sh) || 0, Number(sm) || 0, 0, 0);
                                                                    const se = new Date(year, month, d, Number(eh) || 0, Number(em) || 0, 0, 0);
                                                                    if (os < ss) os = ss;
                                                                    if (oe > se) oe = se;
                                                                }
                                                                const hours = Math.max(0, (oe.getTime() - os.getTime()) / 3600000);
                                                                totalHours += hours;
                                                                if (!minStart || os < minStart) minStart = os;
                                                                if (!maxEnd || oe > maxEnd) maxEnd = oe;
                                                            }
                                                        }
                                                        if (totalHours > 0) {
                                                            const fmt = (dt) => `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
                                                            let period = '';
                                                            let sequence = 'full';
                                                            let ratio = 1;

                                                            if (minStart && maxEnd) {
                                                                if (schedule && schedule.startTime && schedule.endTime) {
                                                                    const [sh, sm] = String(schedule.startTime).split(':').map(x => parseInt(x, 10));
                                                                    const [eh, em] = String(schedule.endTime).split(':').map(x => parseInt(x, 10));
                                                                    const ss = new Date(year, month, d, Number(sh) || 0, Number(sm) || 0, 0, 0);
                                                                    const se = new Date(year, month, d, Number(eh) || 0, Number(em) || 0, 0, 0);
                                                                    const schedHours = Math.max(0, (se.getTime() - ss.getTime()) / 3600000);
                                                                    
                                                                    if (schedHours > 0) {
                                                                        ratio = totalHours / schedHours;
                                                                        if (Math.abs(Number(totalHours.toFixed(1)) - Number(schedHours.toFixed(1))) < 0.01 || ratio >= 0.99) {
                                                                            period = '全日';
                                                                            sequence = 'full';
                                                                        } else {
                                                                            period = `${fmt(minStart)}~${fmt(maxEnd)}`;
                                                                            const startsAtStart = Math.abs(minStart.getTime() - ss.getTime()) < 60000;
                                                                            const endsAtEnd = Math.abs(maxEnd.getTime() - se.getTime()) < 60000;
                                                                            
                                                                            if (startsAtStart && !endsAtEnd) {
                                                                                sequence = 'leave_work';
                                                                            } else {
                                                                                sequence = 'work_leave';
                                                                            }
                                                                        }
                                                                    } else {
                                                                         period = `${fmt(minStart)}~${fmt(maxEnd)}`;
                                                                    }
                                                                } else {
                                                                    period = `${fmt(minStart)}~${fmt(maxEnd)}`;
                                                                }
                                                            }
                                                            return { hours: Number(totalHours.toFixed(1)), period, sequence, ratio };
                                                        }
                                                        return null;
                                                    })();

                                                    let cellStyle = {};
                                                    if (leaveInfo) {
                                                        if (leaveInfo.sequence === 'full') {
                                                            cellClass = 'bg-orange-100 text-orange-700 border border-orange-200';
                                                        } else {
                                                            const pct = Math.min(100, Math.max(0, leaveInfo.ratio * 100));
                                                            // leave_work: Leave (Orange) top, Work (Green) bottom
                                                            // work_leave: Work (Green) top, Leave (Orange) bottom
                                                            // Orange: #ffedd5, Green: #dcfce7
                                                            if (leaveInfo.sequence === 'leave_work') {
                                                                cellStyle = { background: `linear-gradient(to bottom, #ffedd5 ${pct}%, #dcfce7 ${pct}%)` };
                                                            } else {
                                                                const workPct = 100 - pct;
                                                                cellStyle = { background: `linear-gradient(to bottom, #dcfce7 ${workPct}%, #ffedd5 ${workPct}%)` };
                                                            }
                                                            cellClass = 'text-gray-700 border border-gray-200';
                                                        }
                                                    } else if (schedule) {
                                                                if (schedule.type === 'work') cellClass = 'bg-blue-100 text-blue-700 border border-blue-200';
                                                                else if (schedule.type === 'duty') cellClass = 'bg-purple-100 text-purple-700 border border-purple-200';
                                                                else if (schedule.type === 'card') cellClass = 'bg-green-100 text-green-700 border border-green-200';
                                                                else if (schedule.type === 'off') cellClass = 'bg-gray-100 text-gray-400 border border-gray-200';
                                                            }

                                                    let attendanceStatus = null;
                                                    let statusType = null;
                                                    if (schedule && (schedule.type === 'work' || schedule.type === 'duty') && !leaveInfo) {
                                                        const dayRecords = myAttendance.filter(r => {
                                                            const t = r.checkInTime ? new Date(r.checkInTime) : (r.timestamp?.seconds ? new Date(r.timestamp.seconds * 1000) : null);
                                                            if (!t) return false;
                                                            return t.getFullYear() === year && t.getMonth() === month && t.getDate() === d;
                                                        });
                                                        const tFrom = (r) => r.checkInTime ? new Date(r.checkInTime) : (r.timestamp?.seconds ? new Date(r.timestamp.seconds * 1000) : null);
                                                        const inRecords = dayRecords.filter(r => ['in','work_in','late_in'].includes(r.type));
                                                        const outRecords = dayRecords.filter(r => ['out','work_out','late_out'].includes(r.type));
                                                        const inTimes = inRecords.map(tFrom).filter(Boolean).sort((a,b)=>a-b);
                                                        const outTimes = outRecords.map(tFrom).filter(Boolean).sort((a,b)=>a-b);
                                                        const inTime = inTimes[0] || null;
                                                        const outTime = outTimes.length ? outTimes[outTimes.length-1] : null;
                                                        let isLate = false, isEarly = false;
                                                        if (inTime && schedule.startTime) {
                                                            const [sh, sm] = String(schedule.startTime).split(':').map(x => parseInt(x, 10));
                                                            const st = new Date(year, month, d, Number(sh) || 0, Number(sm) || 0, 0, 0);
                                                            isLate = inTime > st || inRecords.some(r => r.type === 'late_in');
                                                        }
                                                        if (outTime && schedule.endTime) {
                                                            const [eh, em] = String(schedule.endTime).split(':').map(x => parseInt(x, 10));
                                                            const et = new Date(year, month, d, Number(eh) || 0, Number(em) || 0, 0, 0);
                                                            isEarly = outTime < et || dayRecords.some(r => r.type === 'leave_early');
                                                        }
                                                        if (isLate || isEarly) {
                                                            cellClass = 'bg-red-100 text-red-700 border border-red-200';
                                                            attendanceStatus = 'abnormal';
                                                            statusType = 'late_or_early';
                                                        } else if (inTime && outTime) {
                                                            cellClass = 'bg-green-100 text-green-700 border border-green-200';
                                                            attendanceStatus = 'normal';
                                                        } else if (!inTime && !outTime && isPastDateGrid) {
                                                            cellClass = 'bg-red-100 text-red-700 border border-red-200';
                                                            attendanceStatus = 'abnormal';
                                                            statusType = 'absent';
                                                        }
                                                    }

                                                            days.push(
                                                                <div 
                                                                    key={d}
                                                                    onClick={() => setClockScheduleSelectedDate(currentDate)}
                                                                    style={cellStyle}
                                                                    className={`h-14 rounded-lg flex flex-col items-center justify-center relative transition-colors cursor-pointer ${cellClass} ${isToday ? 'ring-2 ring-red-500' : ''} ${clockScheduleSelectedDate && clockScheduleSelectedDate.toDateString() === currentDate.toDateString() ? 'ring-2 ring-blue-500 z-10' : ''}`}
                                                                >
                                                                    <span className={`text-xs font-bold ${isHoliday || isWeekend ? 'text-red-500' : ''}`}>{d}</span>
                                                            {leaveInfo ? (
                                                                <span className="text-[10px] scale-90 font-bold w-[115%] text-center leading-none">
                                                                    {leaveInfo.sequence === 'full' ? '請假' : 
                                                                     leaveInfo.sequence === 'leave_work' ? '請假、上班' : 
                                                                     leaveInfo.sequence === 'work_leave' ? '上班、請假' : '請假'}
                                                                    {leaveInfo.hours ? ` ${leaveInfo.hours}h` : ''}
                                                                </span>
                                                            ) : schedule ? (
                                                                <div className="flex flex-col items-center w-full">
                                                                    <span className="text-[10px] scale-90 font-bold truncate w-full text-center px-1">
                                                                        {attendanceStatus === 'normal' ? '正常' : 
                                                                         attendanceStatus === 'abnormal' ? (statusType === 'absent' ? '異常-曠職' : '異常') :
                                                                         schedule.type === 'work' ? '上班' : 
                                                                         schedule.type === 'duty' ? '值班' : 
                                                                         schedule.type === 'card' ? '卡班' : '特休'}
                                                                            </span>
                                                                            {schedule.type !== 'off' && (
                                                                                <span className="text-[9px] scale-75 opacity-80 leading-none">
                                                                                    {schedule.startTime}-{schedule.endTime}
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                    ) : (
                                                                        <span className="text-[9px] text-gray-300 scale-75">假日</span>
                                                                    )}
                                                                </div>
                                                            );
                                                    }
                                                    return days;
                                                })()}
                                            </div>
                                            <div className="mt-4 flex flex-wrap gap-2 justify-between items-center">
                                                <div className="flex flex-wrap gap-2 justify-center">
                                                    <div className="flex items-center gap-1 text-xs text-gray-500">
                                                        <div className="w-3 h-3 rounded bg-blue-100 border border-blue-200"></div> 上班
                                                    </div>
                                                    <div className="flex items-center gap-1 text-xs text-gray-500">
                                                        <div className="w-3 h-3 rounded bg-purple-100 border border-purple-200"></div> 值班
                                                    </div>
                                                    <div className="flex items-center gap-1 text-xs text-gray-500">
                                                        <div className="w-3 h-3 rounded bg-orange-100 border border-orange-200"></div> 請假
                                                    </div>
                                                    <div className="flex items-center gap-1 text-xs text-gray-500">
                                                        <div className="w-3 h-3 rounded bg-gray-100 border border-gray-200"></div> 休假
                                                    </div>
                                                </div>
                                                <button 
                                                    onClick={() => {
                                                        const year = clockScheduleDate.getFullYear();
                                                        const month = clockScheduleDate.getMonth();
                                                        const daysInMonth = new Date(year, month + 1, 0).getDate();
                                                        const fridays = [];
                                                        const userCompanyId = dbUser?.companyId;

                                                        for (let d = 1; d <= daysInMonth; d++) {
                                                            const date = new Date(year, month, d);
                                                            if (date.getDay() === 5) { // Friday
                                                                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                                                                
                                                                const targetCompanyUsers = usersList.filter(u => String(u.companyId) === String(userCompanyId) && (u.status || '在職') !== '離職');
                                                                const targetCompanyUserIds = new Set(targetCompanyUsers.map(u => u.id));

                                                                const usersOnDuty = [];
                                                                (schedulesList || []).forEach(s => {
                                                                    if (s.date === dateStr && s.type === 'duty' && targetCompanyUserIds.has(s.userId)) {
                                                                        const user = targetCompanyUsers.find(u => u.id === s.userId);
                                                                        if (user) usersOnDuty.push(user);
                                                                    }
                                                                });
                                                                
                                                                fridays.push({ date: dateStr, users: usersOnDuty });
                                                            }
                                                        }
                                                        setOverviewDutyFridays(fridays);
                                                        setOverviewDutyModalOpen(true);
                                                    }}
                                                    className="px-3 py-1 rounded-full border border-purple-200 bg-purple-50 text-purple-700 text-xs font-bold hover:bg-purple-100 transition-colors flex items-center gap-1"
                                                >
                                                    <i className="fas fa-user-clock"></i> 值班名單
                                                </button>
                                            </div>
                                        </div>

                                        {clockScheduleSelectedDate && (() => {
                                            const year = clockScheduleSelectedDate.getFullYear();
                                            const month = clockScheduleSelectedDate.getMonth();
                                            const date = clockScheduleSelectedDate.getDate();
                                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                                            const dayOfWeek = ['日', '一', '二', '三', '四', '五', '六'][clockScheduleSelectedDate.getDay()];
                                            
                                            const schedule = mySchedules[dateStr];
                                            
                                            const attendance = myAttendance.filter(r => {
                                                const t = r.checkInTime ? new Date(r.checkInTime) : (r.timestamp?.seconds ? new Date(r.timestamp.seconds * 1000) : null);
                                                if (!t) return false;
                                                return t.getFullYear() === year && t.getMonth() === month && t.getDate() === date;
                                            }).sort((a,b) => {
                                                const tA = a.checkInTime ? new Date(a.checkInTime) : (a.timestamp?.seconds ? new Date(a.timestamp.seconds * 1000) : new Date(0));
                                                const tB = b.checkInTime ? new Date(b.checkInTime) : (b.timestamp?.seconds ? new Date(b.timestamp.seconds * 1000) : new Date(0));
                                                return tA - tB;
                                            });
                                            
                                            const dayLeaves = (() => {
                                                const parseRange = (l) => {
                                                    if ((l.type && l.type !== 'leave') || (l.approvalStatus && !['approved', 'pending'].includes(l.approvalStatus))) return null;
                                                    let s, e;
                                                    
                                                    // Helper to combine date and time
                                                    const combine = (d, t, defT) => {
                                                        if (!d) return null;
                                                        let dStr = String(d).replace(/\//g, '-');
                                                        
                                                        // Check if dStr already has time component (e.g., '2026-01-06T15:00' or '2026-01-06 15:00')
                                                        if (dStr.includes('T') || (dStr.includes(' ') && dStr.includes(':'))) {
                                                            const tryDate = new Date(dStr);
                                                            if (!isNaN(tryDate.getTime())) {
                                                                return tryDate;
                                                            }
                                                        }
                                                        
                                                        const tStr = t || defT;
                                                        return new Date(`${dStr}T${tStr}`);
                                                    };

                                                    if (l.leaveStartDate) {
                                                        s = combine(l.leaveStartDate, l.leaveStartTime, '00:00:00');
                                                    } else if (l.startDate) {
                                                        s = combine(l.startDate, l.startTime, '00:00:00');
                                                    } else if (l.leaveDate) {
                                                        s = combine(l.leaveDate, l.leaveTime, '00:00:00');
                                                    }

                                                    if (l.leaveEndDate) {
                                                        e = combine(l.leaveEndDate, l.leaveEndTime, '23:59:59');
                                                    } else if (l.endDate) {
                                                        e = combine(l.endDate, l.endTime, '23:59:59');
                                                    } else if (s) {
                                                        e = new Date(s.getFullYear(), s.getMonth(), s.getDate(), 23, 59, 59);
                                                    }

                                                    if (!s || !e || isNaN(s.getTime()) || isNaN(e.getTime())) return null;
                                                    return { s, e };
                                                };

                                                const listA = (myAttendance || []).filter(r => r.type === 'leave' && ['approved', 'pending'].includes(r.approvalStatus));
                                                const listB = (leavesList && leavesList.length > 0) 
                                                    ? leavesList.filter(r => r.userId === dbUser?.id && ['approved', 'pending'].includes(r.approvalStatus))
                                                    : (myLeaves || []).filter(r => ['approved', 'pending'].includes(r.approvalStatus));
                                                
                                                const dayStart = new Date(year, month, date, 0, 0, 0);
                                                const dayEnd = new Date(year, month, date, 23, 59, 59);

                                                const results = [];
                                                // Deduplicate by ID if possible
                                                const seenIds = new Set();
                                                
                                                for (const l of [...listA, ...listB]) {
                                                    if (l.id && seenIds.has(l.id)) continue;
                                                    if (l.id) seenIds.add(l.id);

                                                    const rng = parseRange(l);
                                                    if (!rng) continue;
                                                    
                                                    // Check overlap: start <= dayEnd AND end >= dayStart
                                                    if (rng.s <= dayEnd && rng.e >= dayStart) {
                                                        results.push(l);
                                                    }
                                                }
                                                return results;
                                            })();
                                            const isPastDate = clockScheduleSelectedDate < new Date(new Date().setHours(0,0,0,0));

                                            return (
                                                <div className="mt-4 bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                                                    <h3 className="font-bold text-gray-800 text-lg mb-3 flex items-center gap-2">
                                                    <Calendar className="w-5 h-5 text-blue-600" />
                                                        {year}年{month+1}月{date}日 (星期{dayOfWeek})
                                                    </h3>
                                                    
                                                    <div className="space-y-3">
                                                        <div className="bg-gray-50 p-3 rounded-xl">
                                                            <div className="text-xs font-bold text-gray-400 mb-1">班表排程</div>
                                                            {schedule ? (
                                                                <div className="flex w-full py-2">
                                                                    <div className="flex-1 flex flex-col items-center border-r border-gray-200">
                                                                        <span className={`text-xs font-bold mb-1 ${
                                                                            schedule.type === 'work' ? 'text-blue-600' :
                                                                            schedule.type === 'duty' ? 'text-purple-600' :
                                                                            schedule.type === 'card' ? 'text-green-600' :
                                                                            'text-gray-500'
                                                                        }`}>
                                                                            {schedule.type === 'work' ? '班表上班' : 
                                                                             schedule.type === 'duty' ? '班表值班' : 
                                                                             schedule.type === 'card' ? '卡班上班' : '特休'}
                                                                        </span>
                                                                        {schedule.type !== 'off' && (
                                                                            <span className="font-mono font-bold text-xl text-gray-700">
                                                                                {schedule.startTime}
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                    <div className="flex-1 flex flex-col items-center">
                                                                        <span className={`text-xs font-bold mb-1 ${
                                                                            schedule.type === 'work' ? 'text-blue-600' :
                                                                            schedule.type === 'duty' ? 'text-purple-600' :
                                                                            schedule.type === 'card' ? 'text-green-600' :
                                                                            'text-gray-500'
                                                                        }`}>
                                                                            {schedule.type === 'work' ? '班表下班' : 
                                                                             schedule.type === 'duty' ? '班表簽退' : 
                                                                             schedule.type === 'card' ? '卡班下班' : ''}
                                                                        </span>
                                                                        {schedule.type !== 'off' && (
                                                                            <span className="font-mono font-bold text-xl text-gray-700">
                                                                                {schedule.endTime}
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            ) : (
                                                                 <div className="text-sm text-gray-500 font-bold">無排班資料</div>
                                                            )}
                                                        </div>

                                                        <div className="bg-gray-50 p-3 rounded-xl">
                                                            <div className="text-xs font-bold text-gray-400 mb-1">打卡紀錄</div>
                                                            {attendance.length > 0 ? (
                                                                <div className="grid grid-cols-2 gap-4">
                                                                    <div className="space-y-2">
                                                                        <div className="text-xs text-gray-400 text-center border-b border-gray-200 pb-1 mb-2">上班/簽到</div>
                                                                        {(() => {
                                                                            // Priority 1: Work In types
                                                                            let target = attendance.find(r => ['in', 'work_in', 'duty_in', 'late_in'].includes(r.type));
                                                                            // Priority 2: Card In (if no Work In)
                                                                            if (!target) {
                                                                                target = attendance.find(r => r.type === 'card_in');
                                                                            }
                                                                            
                                                                            if (!target) return null;
                                                                            
                                                                            const record = target;
                                                                            return (
                                                                                <div className={`w-full flex flex-col items-center justify-center text-sm p-2 rounded-lg border shadow-sm h-[56px] ${(() => {
                                                                                    const t = record.checkInTime ? new Date(record.checkInTime) : (record.timestamp?.seconds ? new Date(record.timestamp.seconds * 1000) : null);
                                                                                    const isSched = !!(schedule && (schedule.type === 'work' || schedule.type === 'duty'));
                                                                                    let isLate = false;
                                                                                    if (t && isSched && schedule.startTime) {
                                                                                        const [sh, sm] = String(schedule.startTime).split(':').map(x => parseInt(x, 10));
                                                                                        const st = new Date(year, month, date, Number(sh) || 0, Number(sm) || 0, 0, 0);
                                                                                        isLate = t > st;
                                                                                    }
                                                                                    return (['late_in'].includes(record.type) || isLate) ? 'bg-red-50 border-red-100' : 'bg-green-50 border-green-100';
                                                                                })()}`}>
                                                                                    <span className="font-mono font-bold text-gray-800 text-lg">
                                                                                        {(() => {
                                                                                            const t = record.checkInTime ? new Date(record.checkInTime) : (record.timestamp?.seconds ? new Date(record.timestamp.seconds * 1000) : null);
                                                                                            return t ? t.toLocaleTimeString('zh-TW', {hour12: false, hour:'2-digit', minute:'2-digit', second:'2-digit'}) : '--:--:--';
                                                                                        })()}
                                                                                    </span>
                                                                                </div>
                                                                            );
                                                                        })()}
                                                                        {(() => {
                                                                            const isWorkDay = schedule && (schedule.type === 'work' || schedule.type === 'duty');
                                                                            const hasIn = attendance.some(r => ['in', 'work_in', 'duty_in', 'late_in', 'card_in'].includes(r.type));
                                                                            


                                                                            if (!hasIn && isPastDate && isWorkDay) {
                                                                                const locs = availableClockInLocations || [];
                                                                                const defaultLocId = (checkInLocation && locs.some(l=>l.id===checkInLocation.id)) ? checkInLocation.id : (locs[0]?.id || '');
                                                                                const defaultTime = schedule?.startTime || '09:00';
                                                                                return (
                                                                                    <button
                                                                                        className="w-full text-sm p-2 rounded-lg border shadow-sm bg-blue-600 text-white hover:bg-blue-700 transition-colors flex items-center justify-center"
                                                                                        onClick={() => {
                                                                                            setMakeupDefaultType('in');
                                                                                            setMakeupForm(prev => ({ ...prev, timeType: 'in', locationId: defaultLocId, customTime: defaultTime }));
                                                                                            setMakeupDateStr(dateStr);
                                                                                            setMakeupSchedule(schedule);
                                                                                            setShowMakeupModal(true);
                                                                                        }}
                                                                                    >
                                                                                        申請上班補打卡
                                                                                    </button>
                                                                                );
                                                                            }
                                                                            return null;
                                                                        })()}
                                                                    </div>
                                                                    <div className="space-y-2">
                                                                        <div className="text-xs text-gray-400 text-center border-b border-gray-200 pb-1 mb-2">下班/簽退</div>
                                                                        {(() => {
                                                                            // Priority 1: Work Out types (find last match)
                                                                            const workOuts = attendance.filter(r => ['out', 'work_out', 'duty_out', 'late_out', 'leave_early'].includes(r.type));
                                                                            let target = workOuts.length > 0 ? workOuts[workOuts.length - 1] : null;
                                                                            
                                                                            if (!target) {
                                                                                const cardOuts = attendance.filter(r => r.type === 'card_out');
                                                                                target = cardOuts.length > 0 ? cardOuts[cardOuts.length - 1] : null;
                                                                            }
                                                                            
                                                                            if (!target) return null;
                                                                            
                                                                            const record = target;
                                                                            return (
                                                                                <div className={`w-full flex flex-col items-center justify-center text-sm p-2 rounded-lg border shadow-sm h-[56px] ${(() => {
                                                                                    const t = record.checkInTime ? new Date(record.checkInTime) : (record.timestamp?.seconds ? new Date(record.timestamp.seconds * 1000) : null);
                                                                                    const isSched = !!(schedule && (schedule.type === 'work' || schedule.type === 'duty'));
                                                                                    let isEarly = false;
                                                                                    if (t && isSched && schedule.endTime) {
                                                                                        const [eh, em] = String(schedule.endTime).split(':').map(x => parseInt(x, 10));
                                                                                        const et = new Date(year, month, date, Number(eh) || 0, Number(em) || 0, 0, 0);
                                                                                        isEarly = t < et;
                                                                                    }
                                                                                    return (['leave_early'].includes(record.type) || isEarly) ? 'bg-red-50 border-red-100' : 'bg-green-50 border-green-100';
                                                                                })()}`}>

                                                                                    <div className="flex flex-col items-center">
                                                                                        <span className="font-mono font-bold text-gray-800 text-lg">
                                                                                            {(() => {
                                                                                                const t = record.checkInTime ? new Date(record.checkInTime) : (record.timestamp?.seconds ? new Date(record.timestamp.seconds * 1000) : null);
                                                                                                if (!t) return '--:--:--';
                                                                                                
                                                                                                const rY = t.getFullYear();
                                                                                                const rM = String(t.getMonth() + 1).padStart(2, '0');
                                                                                                const rD = String(t.getDate()).padStart(2, '0');
                                                                                                const rDateStr = `${rY}-${rM}-${rD}`;
                                                                                                
                                                                                                const isCrossDay = rDateStr !== dateStr;

                                                                                                if (isCrossDay) {
                                                                                                    return `${rM}-${rD} ${t.toLocaleTimeString('zh-TW', {hour12: false, hour:'2-digit', minute:'2-digit', second:'2-digit'})}`;
                                                                                                }
                                                                                                return t.toLocaleTimeString('zh-TW', {hour12: false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
                                                                                            })()}
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                            );
                                                                        })()}
                                                                        {(() => {
                                                                            const isWorkDay = schedule && (schedule.type === 'work' || schedule.type === 'duty');
                                            const hasOut = attendance.some(r => ['out', 'work_out', 'duty_out', 'late_out', 'card_out', 'leave_early'].includes(r.type));
                                            
                                            if (!hasOut && isPastDate && isWorkDay && dayLeaves.length === 0) {
                                                                                const locs = availableClockInLocations || [];
                                                                                const defaultLocId = (checkInLocation && locs.some(l=>l.id===checkInLocation.id)) ? checkInLocation.id : (locs[0]?.id || '');
                                                                                const defaultTime = schedule?.endTime || '18:00';
                                                                                return (
                                                                                    <button
                                                                                        className="w-full text-sm p-2 rounded-lg border shadow-sm bg-blue-600 text-white hover:bg-blue-700 transition-colors flex items-center justify-center"
                                                                                        onClick={() => {
                                                                                            setMakeupDefaultType('out');
                                                                                            setMakeupForm(prev => ({ ...prev, timeType: 'out', locationId: defaultLocId, customTime: defaultTime }));
                                                                                            setMakeupDateStr(dateStr);
                                                                                            setMakeupSchedule(schedule);
                                                                                            setShowMakeupModal(true);
                                                                                        }}
                                                                                    >
                                                                                        申請下班補打卡
                                                                                    </button>
                                                                                );
                                                                            }
                                                                            return null;
                                                                        })()}
                                                                    </div>
                                                                </div>
                                                                    ) : (
                                                                (() => {
                                                                    // Check if Make-up button is needed
                                                                    const isPastDate = clockScheduleSelectedDate < new Date(new Date().setHours(0,0,0,0));
                                                                    const isWorkDay = schedule && (schedule.type === 'work' || schedule.type === 'duty');
                                                                    
                                                                    if (isPastDate && isWorkDay) {
                                                                        const dayInReqs = myMakeupRequests.filter(r => r.userId === dbUser.id && r.date === dateStr && r.target !== 'out').sort((a,b)=> (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                                                                        const dayOutReqs = myMakeupRequests.filter(r => r.userId === dbUser.id && r.date === dateStr && r.target === 'out').sort((a,b)=> (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                                                                        const latestIn = dayInReqs[0];
                                                                        const latestOut = dayOutReqs[0];
                                                                        return (
                                                                            <div className="grid grid-cols-2 gap-2">
                                                                                <div className="w-full">
                                                                                    {latestIn ? (
                                                                                        latestIn.status === 'pending' ? (
                                                                                            <button disabled className="w-full py-3 bg-gray-100 text-gray-700 rounded-xl font-bold border border-gray-200 cursor-not-allowed flex items-center justify-center">
                                                                                                <ClipboardList className="w-5 h-5 mr-2" />
                                                                                                已送出資料
                                                                                            </button>
                                                                                        ) : latestIn.status === 'approved' ? (
                                                                                            <div className="flex items-center justify-center p-4 bg-green-50 rounded-xl border border-green-200 text-green-700 font-bold">
                                                                                                核准 {latestIn.startTime || ''}
                                                                                            </div>
                                                                                        ) : (
                                                                                            <button disabled className="w-full py-3 bg-gray-100 text-gray-700 rounded-xl font-bold border border-gray-200 cursor-not-allowed flex items-center justify-center">
                                                                                                <ClipboardList className="w-5 h-5 mr-2" />
                                                                                                已送出資料
                                                                                            </button>
                                                                                        )
                                                                                    ) : (
                                                                                        <button
                                                                                            onClick={() => { 
                                                                                                setMakeupDefaultType('in'); 
                                                                                                const locs = availableClockInLocations || [];
                                                                                                const defaultLocId = (checkInLocation && locs.some(l=>l.id===checkInLocation.id)) ? checkInLocation.id : (locs[0]?.id || '');
                                                                                                const defaultTime = schedule?.startTime || '09:00';
                                                                                                setMakeupForm(prev => ({ ...prev, timeType: 'in', locationId: defaultLocId, customTime: defaultTime }));
                                                                                                setMakeupDateStr(dateStr);
                                                                                                setMakeupSchedule(schedule);
                                                                                                setShowMakeupModal(true);
                                                                                            }}
                                                                                            className="w-full text-sm p-2 rounded-lg border shadow-sm h-[56px] bg-blue-600 text-white hover:bg-blue-700 transition-colors flex items-center justify-center"
                                                                                        >
                                                                                            <ClipboardList className="w-5 h-5 mr-2" />
                                                                                            申請上班補打卡
                                                                                        </button>
                                                                                    )}
                                                                                </div>
                                                                                <div className="w-full">
                                                                                    {latestOut ? (
                                                                                        latestOut.status === 'pending' ? (
                                                                                            <button disabled className="w-full py-3 bg-gray-100 text-gray-700 rounded-xl font-bold border border-gray-200 cursor-not-allowed flex items-center justify-center">
                                                                                                <ClipboardList className="w-5 h-5 mr-2" />
                                                                                                已送出資料
                                                                                            </button>
                                                                                        ) : latestOut.status === 'approved' ? (
                                                                                            <div className="flex items-center justify-center p-4 bg-green-50 rounded-xl border border-green-200 text-green-700 font-bold">
                                                                                                核准 {latestOut.endTime || ''}
                                                                                            </div>
                                                                                        ) : (
                                                                                            <button disabled className="w-full py-3 bg-gray-100 text-gray-700 rounded-xl font-bold border border-gray-200 cursor-not-allowed flex items-center justify-center">
                                                                                                <ClipboardList className="w-5 h-5 mr-2" />
                                                                                                已送出資料
                                                                                            </button>
                                                                                        )
                                                                                    ) : (
                                                                                        <button
                                                                                            onClick={() => { 
                                                                                                setMakeupDefaultType('out'); 
                                                                                                const locs = availableClockInLocations || [];
                                                                                                const defaultLocId = (checkInLocation && locs.some(l=>l.id===checkInLocation.id)) ? checkInLocation.id : (locs[0]?.id || '');
                                                                                                const defaultTime = schedule?.endTime || '18:00';
                                                                                                setMakeupForm(prev => ({ ...prev, timeType: 'out', locationId: defaultLocId, customTime: defaultTime }));
                                                                                                setMakeupDateStr(dateStr);
                                                                                                setMakeupSchedule(schedule);
                                                                                                setShowMakeupModal(true);
                                                                                            }}
                                                                                            className="w-full text-sm p-2 rounded-lg border shadow-sm h-[56px] bg-blue-600 text-white hover:bg-blue-700 transition-colors flex items-center justify-center"
                                                                                        >
                                                                                            <ClipboardList className="w-5 h-5 mr-2" />
                                                                                            申請下班補打卡
                                                                                        </button>
                                                                                    )}
                                                                                </div>
                                                                            </div>
                                                                        );

                                                                        return (
                                                                            <div className="grid grid-cols-2 gap-2">
                                                                                <button
                                                                                    onClick={() => { 
                                                                                        setMakeupDefaultType('in'); 
                                                                                        const locs = availableClockInLocations || [];
                                                                                        const defaultLocId = (checkInLocation && locs.some(l=>l.id===checkInLocation.id)) ? checkInLocation.id : (locs[0]?.id || '');
                                                                                        const defaultTime = schedule?.startTime || '09:00';
                                                                                        setMakeupForm(prev => ({ ...prev, timeType: 'in', locationId: defaultLocId, customTime: defaultTime }));
                                                                                        setMakeupDateStr(dateStr);
                                                                                        setMakeupSchedule(schedule);
                                                                                        setShowMakeupModal(true);
                                                                                    }}
                                                                                    className="w-full text-sm p-2 rounded-lg border shadow-sm h-[56px] bg-blue-600 text-white hover:bg-blue-700 transition-colors flex items-center justify-center"
                                                                                >
                                                                                    <ClipboardList className="w-5 h-5 mr-2" />
                                                                                    申請上班補打卡
                                                                                </button>
                                                                                <button
                                                                                    onClick={() => { 
                                                                                        setMakeupDefaultType('out'); 
                                                                                        const locs = availableClockInLocations || [];
                                                                                        const defaultLocId = (checkInLocation && locs.some(l=>l.id===checkInLocation.id)) ? checkInLocation.id : (locs[0]?.id || '');
                                                                                        const defaultTime = schedule?.endTime || '18:00';
                                                                                        setMakeupForm(prev => ({ ...prev, timeType: 'out', locationId: defaultLocId, customTime: defaultTime }));
                                                                                        setMakeupDateStr(dateStr);
                                                                                        setMakeupSchedule(schedule);
                                                                                        setShowMakeupModal(true);
                                                                                    }}
                                                                                    className="w-full text-sm p-2 rounded-lg border shadow-sm h-[56px] bg-blue-600 text-white hover:bg-blue-700 transition-colors flex items-center justify-center"
                                                                                >
                                                                                    <ClipboardList className="w-5 h-5 mr-2" />
                                                                                    申請下班補打卡
                                                                                </button>
                                                                            </div>
                                                                        );
                                                                    }

                                                                    return <div className="text-sm text-gray-400 font-bold">尚無打卡紀錄</div>;
                                                                })()
                                                            )}
                                                        </div>

                                                        {(() => {
                                                            const hasPending = dayLeaves.some(l => l.approvalStatus === 'pending');
                                                            const containerClass = hasPending ? "bg-red-50 border-red-100" : "bg-orange-50 border-orange-100";
                                                            const titleClass = hasPending ? "text-red-400" : "text-orange-400";
                                                            
                                                            return (
                                                                <div className={`p-3 rounded-xl border ${containerClass}`}>
                                                                    <div className={`text-xs font-bold ${titleClass} mb-1`}>請假紀錄</div>
                                                                    <div className="space-y-2">
                                                                        {dayLeaves.length > 0 ? (
                                                                            dayLeaves.map((l, idx) => {
                                                                                const isPending = l.approvalStatus === 'pending';
                                                                                const textClass = isPending ? "text-red-700" : "text-orange-700";
                                                                                const subTextClass = isPending ? "text-red-600" : "text-orange-600";
                                                                                const borderClass = isPending ? "border-red-200" : "border-orange-200";
        
                                                                                return (
                                                                                    <div key={idx} className={`border-b ${borderClass} last:border-0 pb-2 last:pb-0`}>
                                                                                        <div className={`font-bold ${textClass}`}>
                                                                                            {l.leaveType || '請假'}-{isPending ? '待核准' : '已核准'} {l.leaveDuration ? `(${l.leaveDuration}小時)` : ''}
                                                                                        </div>
                                                                                        <div className={`text-xs ${subTextClass} mt-1`}>
                                                                                            {(() => {
                                                                                                if (l.leaveStartDate && l.leaveEndDate) {
                                                                                                    return `${l.leaveStartDate} ${l.leaveStartTime || ''} ~ ${l.leaveEndDate} ${l.leaveEndTime || ''}`;
                                                                                                } else if (l.startDate && l.endDate) {
                                                                                                    return `${l.startDate} ${l.startTime || ''} ~ ${l.endDate} ${l.endTime || ''}`;
                                                                                                } else if (l.leaveDate) {
                                                                                                    return `${l.leaveDate} ${l.leaveTime || ''} (單日)`;
                                                                                                }
                                                                                                return '';
                                                                                            })()}
                                                                                        </div>
                                                                                        {l.reason && <div className={`text-xs ${subTextClass} mt-1`}>{l.reason}</div>}
                                                                                    </div>
                                                                                );
                                                                            })
                                                                        ) : (
                                                                            <div className="text-sm text-orange-300 font-bold text-center py-2">無請假紀錄</div>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            );
                                                        })()}
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </div>
                                )}
                                </div>
                            )}

                        {activeTab === 'community' && (
                            <div className="w-full h-[70vh] rounded-2xl overflow-hidden shadow-sm border border-gray-100 bg-white">
                                <iframe 
                                    src="https://nw-com.github.io/nw-checkin-all/" 
                                    className="w-full h-full border-0"
                                    title="Community Page"
                                />
                            </div>
                        )}

                        {dbUser?.role === 'manager' && (
                            <div className="space-y-6">
                                <div className="flex items-center justify-between">
                                    <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                        <Briefcase className="w-5 h-5 text-red-600" />
                                        管理概覽
                                    </h2>
                                    <span className="text-xs text-gray-400 bg-white px-2 py-1 rounded-2xl border">經理權限</span>
                                </div>

                                <div className="pt-4 border-t border-gray-200">
                                    <h3 className="text-xs font-bold text-gray-400 uppercase mb-3">團隊動態</h3>
                                    <ErrorBoundary>
                                        <ManagerDashboard 
                                            currentUser={dbUser} 
                                            communities={communities} 
                                            allAttendance={attendanceList}
                                            timeOffset={timeOffset}
                                            users={usersList}
                                        />
                                    </ErrorBoundary>
                                </div>
                            </div>
                        )}

                        {activeTab === 'hr' && hasPermission('hr') && (
                            <div className="space-y-6">
                                <ErrorBoundary>
                                    <HRDashboard 
                                        currentUser={dbUser} 
                                        communities={communities} 
                                        allAttendance={attendanceList}
                                    />
                                </ErrorBoundary>
                            </div>
                        )}

                        {activeTab === 'function' && hasPermission('function') && (
                            <div className="space-y-6">
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                    {functionSubtab === 'patrol' && hasSubPermission('function', 'patrol') && (
                                        <div>
                                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                <Briefcase className="w-5 h-5 mr-2 text-red-600" /> 巡邏管理
                                            </h3>
                                            <div className="text-center py-8 text-gray-400">
                                                尚無巡邏資料
                                            </div>
                                        </div>
                                    )}
                                    {functionSubtab === 'training' && hasSubPermission('function', 'training') && (
                                        <div>
                                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                <Briefcase className="w-5 h-5 mr-2 text-red-600" /> 教育訓練
                                            </h3>
                                            <div className="text-center py-8 text-gray-400">
                                                尚無訓練課程
                                            </div>
                                        </div>
                                    )}
                                    {functionSubtab === 'download' && hasSubPermission('function', 'download') && (
                                        <div>
                                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                <Briefcase className="w-5 h-5 mr-2 text-red-600" /> 文件下載
                                            </h3>
                                            <div className="text-center py-8 text-gray-400">
                                                尚無可下載文件
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'cadre' && (
                            <div className="space-y-6">
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                    <div className="mb-4 p-3 bg-red-50 rounded-xl text-center">
                                        <span className="text-gray-600 font-bold mr-2">目前選擇公司:</span>
                                        <span className="text-red-600 font-bold">{cadreCompany}</span>
                                    </div>
                                    
                                    {cadreSubtab === 'leave' && hasSubPermission('cadre', 'leave') && (
                                        <div className="mb-4">
                                            <button
                                                className="w-full px-3 py-3 bg-orange-100 text-orange-700 rounded-xl text-xs font-bold hover:bg-orange-200 transition-colors border border-orange-200"
                                                onClick={() => {
                                                    setEditingCadreLeave(null);
                                                    setShowCadreLeaveModal(true);
                                                }}
                                            >
                                                手動請假
                                            </button>
                                        </div>
                                    )}

                                    {cadreSubtab === 'map' && hasSubPermission('cadre', 'map') && (
                                        <div>
                                            {(function() {
                                                const targetCompany = companies.find(c => c.name === cadreCompany);
                                                
                                                let displayLocation = null;
                                                let companyUsers = [];

                                                if (targetCompany) {
                                                    // 1. Set Company Center (Default)
                                                    if (targetCompany.lat && targetCompany.lng) {
                                                        displayLocation = { lat: targetCompany.lat, lng: targetCompany.lng };
                                                    }

                                                    // 2. Prepare users list with location
                                                    if (usersList.length > 0) {
                                                        // Filter: Company + Roles (admin, hr, cadre, staff)
                                                        // Expand target roles to include custom roles with matching names
                                                        const targetRoleNames = ['系統管理員', '人事', '幹部', '員工'];
                                                        const targetRoleIds = roles.filter(r => targetRoleNames.includes(r.name)).map(r => r.id);
                                                        const finalTargetRoles = ['admin', 'hr', 'cadre', 'staff', ...targetRoleIds];
                                                        
                                                        const companyMembers = usersList.filter(u => 
                                                            ((u.companyIds && u.companyIds.some(cid => String(cid) === String(targetCompany.id))) || 
                                                            String(u.companyId) === String(targetCompany.id)) &&
                                                            finalTargetRoles.includes(u.role) &&
                                                            (u.status === '在職' || !u.status)
                                                        );
                                                        
                                                        companyUsers = companyMembers.map(u => {
                                                            // 僅取當日最新打卡紀錄
                                                            // Determine Status
                                                            const now = new Date();
                                                            const schedule = todaySchedules[u.id];
                                                            
                                                            const isRecordToday = (ts) => {
                                                                if (!ts) return false;
                                                                const d = new Date(ts * 1000);
                                                                return d.getFullYear() === now.getFullYear() && 
                                                                       d.getMonth() === now.getMonth() && 
                                                                       d.getDate() === now.getDate();
                                                            };

                                                            const lastRec = attendanceList.find(r => r.userId === u.id && isRecordToday(r.timestamp?.seconds || r.createdAt?.seconds));
                                                            
                                                            let statusText = '今日尚未打卡';
                                                            let statusClass = 'text-red-600';
                                                            let statusBgClass = 'bg-white/95';

                                                            if (schedule?.type === 'off') {
                                                                statusText = '今日特休';
                                                                statusClass = 'text-amber-700';
                                                                statusBgClass = 'bg-stone-200/95';
                                                            } else if (schedule?.type === 'leave') {
                                                                statusText = '今日請假';
                                                                statusClass = 'text-orange-500';
                                                                statusBgClass = 'bg-orange-100/95';
                                                            } else {
                                                                if (lastRec) {
                                                                    const typeMap = {
                                                                        'in': '上班',
                                                                        'out': '下班',
                                                                        'outing_start': '外出',
                                                                        'outing_arrive': '抵達',
                                                                        'outing_end': '離開',
                                                                        'leave': '請假',
                                                                        'late_in': '卡上',
                                                                        'late_out': '卡下'
                                                                    };
                                                                    const typeText = typeMap[lastRec.type] || lastRec.type;
                                                                    const locName = lastRec.checkInLocationName || lastRec.address || '';
                                                                    
                                                                    statusText = `${typeText} ${locName}`.trim();
                                                                    
                                                                    if (['in', 'late_in'].includes(lastRec.type)) {
                                                                        statusClass = 'text-green-600';
                                                                        statusBgClass = 'bg-green-100/95';
                                                                    } else if (['out', 'late_out'].includes(lastRec.type)) {
                                                                        statusClass = 'text-red-600';
                                                                        statusBgClass = 'bg-gray-800/95';
                                                                    } else if (['outing_start', 'outing_arrive', 'outing_end'].includes(lastRec.type)) {
                                                                        statusClass = 'text-blue-600';
                                                                        statusBgClass = 'bg-blue-100/95';
                                                                    } else if (lastRec.type === 'leave') {
                                                                        statusClass = 'text-orange-500';
                                                                        statusBgClass = 'bg-orange-100/95';
                                                                    } else {
                                                                        statusClass = 'text-gray-600';
                                                                        statusBgClass = 'bg-white/95';
                                                                    }
                                                                } else {
                                                                    // No record, check schedule for bg
                                                                    if (schedule?.type === 'work') statusBgClass = 'bg-blue-50/95';
                                                                    else if (schedule?.type === 'duty' || schedule?.type === 'card') statusBgClass = 'bg-yellow-50/95';
                                                                }
                                                            }

                                                            const userData = {
                                                                id: u.id,
                                                                avatarUrl: u.avatarUrl,
                                                                name: u.name,
                                                                statusText,
                                                                statusClass,
                                                                statusBgClass,
                                                                scheduleType: schedule?.type,
                                                                phone: u.phone
                                                            };

                                                            // Calculate Reference Location (Valid Range)
                                                            let refLat, refLng, refRadius;
                                                            if (lastRec) {
                                                                const locName = lastRec.checkInLocationName || lastRec.address || '';
                                                                const targetCommunity = communities.find(c => c.name === locName);
                                                                if (targetCommunity && targetCommunity.coordLat && targetCommunity.coordLng) {
                                                                    refLat = parseFloat(targetCommunity.coordLat);
                                                                    refLng = parseFloat(targetCommunity.coordLng);
                                                                    refRadius = targetCommunity.radiusMeters || 100;
                                                                } else if (targetCompany && targetCompany.lat && targetCompany.lng) {
                                                                    refLat = targetCompany.lat;
                                                                    refLng = targetCompany.lng;
                                                                    refRadius = targetCompany.radius || 100;
                                                                }
                                                            } else {
                                                                // Default to Company
                                                                if (targetCompany && targetCompany.lat && targetCompany.lng) {
                                                                    refLat = targetCompany.lat;
                                                                    refLng = targetCompany.lng;
                                                                    refRadius = targetCompany.radius || 100;
                                                                }
                                                            }
                                                            if (refLat != null && refLng != null) {
                                                                userData.refLat = refLat;
                                                                userData.refLng = refLng;
                                                                userData.refRadius = refRadius;
                                                            }

                                                            // 僅當 lastRec 有座標且為當日，才顯示地圖位置
                                                            if (lastRec && lastRec.location && lastRec.location.includes(',')) {
                                                                const parts = lastRec.location.split(',');
                                                                userData.lat = parseFloat(parts[0]);
                                                                userData.lng = parseFloat(parts[1]);
                                                                userData.time = (lastRec.timestamp?.seconds || lastRec.createdAt?.seconds || Date.now() / 1000) * 1000;
                                                                userData.locationName = lastRec.checkInLocationName || targetCompany.name;
                                                            }
                                                            
                                                            return userData;
                                                        });
                                                    }
                                                }

                                                return (
                                                    <div className="space-y-4">
                                                        <div className="w-full aspect-square bg-gray-100 rounded-2xl overflow-hidden relative shadow-inner">
                                                            {displayLocation ? (
                                                                <CompanyMapPreview 
                                                                    lat={displayLocation.lat} 
                                                                    lng={displayLocation.lng} 
                                                                    radius={targetCompany?.radius || 100}
                                                                    users={companyUsers.filter(u => u.lat && u.lng)}
                                                                    externalSelectedUserId={cadreMapSelectedUserId}
                                                                    onUserSelect={(u) => setCadreMapSelectedUserId(u ? u.id : null)}
                                                                />
                                                            ) : (
                                                                <div className="w-full h-full flex flex-col items-center justify-center text-gray-400 p-4 text-center">
                                                                    <MapPin className="w-8 h-8 mb-2 text-gray-300" />
                                                                    <div>{targetCompany ? '該公司尚未設定座標' : `找不到 ${cadreCompany} 公司資料`}</div>
                                                                    <div className="text-xs mt-1 text-gray-300">請確認後台設定</div>
                                                                </div>
                                                            )}
                                                        </div>

                                                        {(function(){ return null; })()}

                                                        {(function(){
                                                            const now = new Date();
                                                            const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
                                                            const isToday = (secs) => {
                                                                if (!secs) return false;
                                                                const d = new Date(secs * 1000);
                                                                return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth() && d.getDate() === now.getDate();
                                                            };

                                                            // Haversine formula for distance calculation (meters)
                                                            const calculateDistance = (lat1, lon1, lat2, lon2) => {
                                                                const R = 6371e3; // Earth radius in meters
                                                                const φ1 = lat1 * Math.PI / 180;
                                                                const φ2 = lat2 * Math.PI / 180;
                                                                const Δφ = (lat2 - lat1) * Math.PI / 180;
                                                                const Δλ = (lon2 - lon1) * Math.PI / 180;

                                                                const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                                                                        Math.cos(φ1) * Math.cos(φ2) *
                                                                        Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
                                                                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

                                                                return R * c;
                                                            };

                                                            const companyUserIds = (companyUsers || []).map(u => u.id);
                                                            const companyUserIdsSet = new Set(companyUserIds);
                                                            const scheduledUserIds = new Set();
                                                            (schedulesList || []).forEach(s => {
                                                                if (!['work', 'duty'].includes(s.type)) return;
                                                                if (s.date !== todayStr) return;
                                                                if (!companyUserIdsSet.has(s.userId)) return;
                                                                scheduledUserIds.add(s.userId);
                                                            });

                                                            // Calculate Leave Users
                                                            const usersWithLeave = new Set();
                                                            (leavesList || []).forEach(r => {
                                                                if (r.approvalStatus !== 'approved') return;
                                                                
                                                                const rStartDate = r.leaveStartDate ? r.leaveStartDate.split('T')[0] : (r.leaveDate || (() => {
                                                                    const d = new Date((r.timestamp?.seconds || Date.now() / 1000) * 1000);
                                                                    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                                                                })());
                                                                
                                                                const rEndDate = r.leaveEndDate ? r.leaveEndDate.split('T')[0] : rStartDate;
                                                                
                                                                if (rStartDate <= todayStr && todayStr <= rEndDate) {
                                                                    usersWithLeave.add(r.userId);
                                                                }
                                                            });

                                                            // Filter out leave users from scheduled count
                                                            const leaveCount = Array.from(usersWithLeave).filter(uid => scheduledUserIds.has(uid)).length;
                                                            const expectedCount = Math.max(0, scheduledUserIds.size - leaveCount);


                                                            let normalCount = 0;
                                                            let abnormalCount = 0;

                                                            const clockedInUsers = (companyUsers || []).map(u => {
                                                                const recs = attendanceList.filter(r => {
                                                                    const secs = r.timestamp?.seconds || r.createdAt?.seconds;
                                                                    if (!secs) return false;
                                                                    if (r.userId !== u.id) return false;
                                                                    if (!isToday(secs)) return false;
                                                                    return ['in','out','late_in','late_out'].includes(r.type);
                                                                });
                                                                if (recs.length === 0) return null;
                                                                recs.sort((a, b) => {
                                                                    const aSecs = a.timestamp?.seconds || a.createdAt?.seconds || 0;
                                                                    const bSecs = b.timestamp?.seconds || b.createdAt?.seconds || 0;
                                                                    return bSecs - aSecs;
                                                                });
                                                                const lastRec = recs[0];
                                                                const lastSecs = lastRec.timestamp?.seconds || lastRec.createdAt?.seconds || 0;
                                                                
                                                                // Pre-calculate status for statistics
                                                                let isAbnormal = false;
                                                                const locName = lastRec.checkInLocationName || lastRec.address || '';
                                                                const targetCommunity = communities.find(c => c.name === locName);
                                                                let refLat, refLng, refRadius;
                                                                if (targetCommunity && targetCommunity.coordLat && targetCommunity.coordLng) {
                                                                    refLat = parseFloat(targetCommunity.coordLat);
                                                                    refLng = parseFloat(targetCommunity.coordLng);
                                                                    refRadius = targetCommunity.radiusMeters || 100;
                                                                } else if (targetCompany && targetCompany.lat && targetCompany.lng) {
                                                                    refLat = targetCompany.lat;
                                                                    refLng = targetCompany.lng;
                                                                    refRadius = targetCompany.radius || 100;
                                                                }
                                                                if (refLat != null && refLng != null) {
                                                                    if (lastRec.location && lastRec.location.includes(',')) {
                                                                        const [rLat, rLng] = lastRec.location.split(',').map(Number);
                                                                        const dist = calculateDistance(refLat, refLng, rLat, rLng);
                                                                        if (dist > refRadius) isAbnormal = true;
                                                                    } else {
                                                                        isAbnormal = true;
                                                                    }
                                                                } else {
                                                                    isAbnormal = true;
                                                                }
                                                                
                                                                if (isAbnormal) abnormalCount++;
                                                                else normalCount++;

                                                                return { user: u, secs: lastSecs, record: lastRec, isAbnormal };
                                                            }).filter(Boolean).sort((a, b) => b.secs - a.secs);

                                                            const clockedInCount = clockedInUsers.length;

                                                            const notClockedInCount = Math.max(0, expectedCount - clockedInCount);

                                                            if (clockedInUsers.length === 0 && notClockedInCount === 0) return null;
                                                            
                                                            const typeMap = {
                                                                'in': '上班', 'out': '下班', 'outing_start': '外出',
                                                                'outing_arrive': '抵達', 'outing_end': '離開',
                                                                'late_in': '卡上', 'late_out': '卡下',
                                                                'leave': '請假'
                                                            };

                                                            return (
                                                            <div className="bg-white rounded-2xl shadow-sm p-3">
                                                                    <div className="text-xs font-bold text-gray-500 mb-1">
                                                                        {(() => {
                                                                            const d = new Date();
                                                                            const y = d.getFullYear();
                                                                            const m = String(d.getMonth() + 1).padStart(2, '0');
                                                                            const day = String(d.getDate()).padStart(2, '0');
                                                                            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                                                                            const w = weekdays[d.getDay()];
                                                                            return `今日${y}-${m}-${day}(星期${w})最新打卡紀錄`;
                                                                        })()}
                                                                    </div>
                                                                    <div className="text-xs font-bold text-gray-500 mb-1">
                                                                        本日應上班 : {expectedCount}
                                                                    </div>
                                                                    {(function() {
                                                                        if (scheduledUserIds.size === 0) return null;

                                                                        const scheduledUsers = Array.from(scheduledUserIds).map(uid => {
                                                                            if (usersWithLeave.has(uid)) return null;
                                                                            const user = (companyUsers || []).find(u => u.id === uid);
                                                                            if (!user) return null;
                                                                            const sched = (schedulesList || []).find(s => s.userId === uid && s.date === todayStr && ['work', 'duty'].includes(s.type));
                                                                            return { user, scheduleType: sched?.type || 'work' };
                                                                        }).filter(Boolean).sort((a, b) => {
                                                                            const an = a.user.name || '';
                                                                            const bn = b.user.name || '';
                                                                            return an.localeCompare(bn, 'zh-Hant');
                                                                        });
                                                                        return (
                                                                            <div className="mt-1 mb-2 border border-gray-100 rounded-xl p-2 bg-gray-50">
                                                                                <div className="text-xs font-bold text-gray-500 mb-1">
                                                                                    今日上班/值班人員清單
                                                                                </div>
                                                                                <div className="flex flex-wrap gap-2">
                                                                                    {scheduledUsers.map(({ user, scheduleType }) => (
                                                                                        <div
                                                                                            key={user.id}
                                                                                            className={`px-2 py-1 rounded-full border border-gray-200 text-[11px] ${clockedInUsers.some(u => u.user.id === user.id) ? 'bg-green-100' : 'bg-white'} text-gray-700 flex items-center gap-1`}
                                                                                        >
                                                                                            <span className="font-bold">{user.name}</span>
                                                                                            <span className={scheduleType === 'work' ? 'text-blue-600' : 'text-yellow-600'}>
                                                                                                {scheduleType === 'work' ? '上班' : '值班'}
                                                                                            </span>
                                                                                        </div>
                                                                                    ))}
                                                                                </div>
                                                                            </div>
                                                                        );
                                                                    })()}
                                                                    <div className="text-xs font-bold text-gray-500 mb-2 flex items-center flex-wrap gap-1">
                                                                        <span className="text-gray-800">已打卡 : {clockedInCount}</span>
                                                                        <span className="text-gray-400">(</span>
                                                                        <span className="text-green-600">正常 : {normalCount}</span>
                                                                        <span className="text-gray-300">|</span>
                                                                        <span className="text-red-600">異常 : {abnormalCount}</span>
                                                                        <span className="text-gray-400">)</span>
                                                                        <span className="text-red-600 ml-1">未打卡 : {notClockedInCount}</span>
                                                                        <span className="text-gray-400">(</span>
                                                                        <span className="text-red-600">異常 : {notClockedInCount}</span>
                                                                        <span className="text-gray-300">|</span>
                                                                        <span className="text-red-600">請假 : {leaveCount}</span>
                                                                        <span className="text-gray-400">)</span>
                                                                    </div>
                                                                    <div className="flex flex-col gap-2">
                                                                        {clockedInUsers.map(({user: u, secs, record, isAbnormal}) => {
                                                                            const timeStr = new Date(secs * 1000).toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                                                                            const locationName = record.checkInLocationName || record.address || '未顯示位置';
                                                                            const typeText = typeMap[record.type] || record.type;
                                                                            
                                                                            // Status logic (re-use calculation or stored flag)
                                                                            let statusText = '正常';
                                                                            let statusClass = 'text-green-600 bg-green-50';
                                                                            
                                                                            if (isAbnormal) {
                                                                                const locName2 = record.checkInLocationName || record.address || '';
                                                                                const targetCommunity2 = communities.find(c => c.name === locName2);
                                                                                let refLat2, refLng2, refRadius2;
                                                                                if (targetCommunity2 && targetCommunity2.coordLat && targetCommunity2.coordLng) {
                                                                                    refLat2 = parseFloat(targetCommunity2.coordLat);
                                                                                    refLng2 = parseFloat(targetCommunity2.coordLng);
                                                                                    refRadius2 = targetCommunity2.radiusMeters || 100;
                                                                                } else if (targetCompany && targetCompany.lat && targetCompany.lng) {
                                                                                    refLat2 = targetCompany.lat;
                                                                                    refLng2 = targetCompany.lng;
                                                                                    refRadius2 = targetCompany.radius || 100;
                                                                                }
                                                                                if (refLat2 != null && refLng2 != null) {
                                                                                    if (record.location && record.location.includes(',')) {
                                                                                        const [rLat, rLng] = record.location.split(',').map(Number);
                                                                                        const dist = calculateDistance(refLat2, refLng2, rLat, rLng);
                                                                                        statusText = `異常-距離過遠(${Math.round(dist)}m)`;
                                                                                    } else {
                                                                                        statusText = '異常-無打卡座標';
                                                                                    }
                                                                                } else {
                                                                                    statusText = '異常-無座標設定';
                                                                                }
                                                                                statusClass = 'text-red-600 bg-red-50';
                                                                            }

                                                                            return (
                                                                                <div key={u.id} className={`flex flex-col p-3 rounded-xl border border-gray-100 shadow-sm w-full gap-2 ${isAbnormal ? 'bg-red-50' : 'bg-white'}`}>
                                                                                    <div className={`flex items-center gap-2 border-b pb-2 ${isAbnormal ? 'border-red-100' : 'border-gray-50'}`}>
                                                                                        <div className="w-8 h-8 rounded-full bg-gray-200 overflow-hidden border border-gray-100 shrink-0">
                                                                                            {u.avatarUrl ? (
                                                                                                <img src={u.avatarUrl} alt={u.name} className="w-full h-full object-cover" />
                                                                                            ) : (
                                                                                                <div className="w-full h-full flex items-center justify-center font-bold text-gray-500 text-xs select-none">
                                                                                                    {u.name?.[0]}
                                                                                                </div>
                                                                                            )}
                                                                                        </div>
                                                                                        <div className="font-bold text-sm text-gray-800">{u.name}</div>
                                                                                    </div>
                                                                                    <div className="grid grid-cols-2 gap-x-2 gap-y-1 text-xs">
                                                                                        <div className="text-gray-500">打卡位置: <span className="text-gray-800">{locationName}</span></div>
                                                                                        <div className="text-gray-500">打卡時間: <span className="text-gray-800 font-mono">{timeStr}</span></div>
                                                                                        <div className="text-gray-500">打卡: <span className="font-bold text-blue-600">{typeText}</span></div>
                                                                                        <div className="text-gray-500">狀態: <span className={`px-1.5 py-0.5 rounded ${statusClass} font-bold`}>{statusText}</span></div>
                                                                                    </div>
                                                                                </div>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                </div>
                                                            );
                                                        })()}

                                                        {(function(){ return null; })()}


                                                    </div>
                                                );
                                            })()}
                                        </div>
                                    )}
                                    {cadreSubtab === 'record' && hasSubPermission('cadre', 'record') && (function() {
                                        const targetCompany = companies.find(c => c.name === cadreCompany);
                                        const companyUserIds = targetCompany ? usersList
                                            .filter(u => (u.companyIds && u.companyIds.some(cid => String(cid) === String(targetCompany.id))) || String(u.companyId) === String(targetCompany.id))
                                            .map(u => u.id) : [];

                                        const records = targetCompany ? attendanceList.filter(r => {
                                            if (!companyUserIds.includes(r.userId)) return false;
                                            if (cadreMapSelectedUserId && r.userId !== cadreMapSelectedUserId) return false;
                                            if (r.type === 'leave') return false;


                                            
                                            // Handle various timestamp formats: Timestamp object, Date object, or Map-like object
                                            let seconds;
                                            if (r.timestamp?.seconds) {
                                                seconds = r.timestamp.seconds;
                                            } else if (r.timestamp instanceof Date) {
                                                seconds = Math.floor(r.timestamp.getTime() / 1000);
                                            } else if (r.createdAt?.seconds) {
                                                seconds = r.createdAt.seconds;
                                            } else {
                                                seconds = Date.now() / 1000;
                                            }
                                            
                                            const rDate = new Date(seconds * 1000);
                                            const recordDate = `${rDate.getFullYear()}-${String(rDate.getMonth()+1).padStart(2,'0')}-${String(rDate.getDate()).padStart(2,'0')}`;
                                            return recordDate === cadreRecordDate;
                                        }) : [];
                                        
                                        // Calculate today string for comparison
                                        const now = new Date();
                                        const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
                                        const isToday = cadreRecordDate === todayStr;

                                        return (
                                        <div>
                                            <div className="mb-4">
                                                <button 
                                                    onClick={() => {
                                                        const d = new Date();
                                                        const dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                                                        const timeStr = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                                                        setManualClockForm(prev => ({ ...prev, date: dateStr, time: timeStr, type: 'in' }));
                                                        setShowManualClockModal(true);
                                                    }}
                                                    className="w-full px-3 py-3 bg-yellow-50 text-black rounded-xl text-xs font-bold hover:bg-yellow-100 transition-colors border border-gray-200"
                                                >
                                                    手動打卡
                                                </button>
                                            </div>
                                            <h3 className="font-bold text-gray-800 mb-4 text-sm flex items-center justify-between">
                                                <div className="flex items-center gap-2">
                                                    <button 
                                                        onClick={() => {
                                                            const d = new Date(cadreRecordDate);
                                                            d.setDate(d.getDate() - 1);
                                                            setCadreRecordDate(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`);
                                                        }} 
                                                        className="p-1 rounded-full hover:bg-gray-100 text-gray-500"
                                                    >
                                                        <ChevronLeft className="w-5 h-5" />
                                                    </button>
                                                    <span>{isToday ? '今日打卡紀錄' : `${cadreRecordDate.replace(/-/g, '/')} 打卡紀錄`}</span>
                                                    <button 
                                                        onClick={() => {
                                                            const d = new Date(cadreRecordDate);
                                                            d.setDate(d.getDate() + 1);
                                                            setCadreRecordDate(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`);
                                                        }}
                                                        disabled={isToday}
                                                        className={`p-1 rounded-full hover:bg-gray-100 text-gray-500 ${isToday ? 'opacity-30 cursor-not-allowed' : ''}`}
                                                    >
                                                        <ChevronRight className="w-5 h-5" />
                                                    </button>
                                                </div>
                                                <span className="text-sm text-gray-400 font-normal">共 {records.length} 筆</span>
                                            </h3>

                                            

                                            {showManualClockModal && (
                                                <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center">
                                                    <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6 max-h-[90vh] overflow-y-auto">
                                                        <h4 className="text-lg font-bold text-gray-800 mb-4">手動打卡</h4>
                                                        {(function(){
                                                            const targetCompany = companies.find(c => c.name === cadreCompany);
                                                            const companyUserIds = targetCompany ? usersList
                                                                .filter(u => (u.companyIds && u.companyIds.some(cid => String(cid) === String(targetCompany.id))) || String(u.companyId) === String(targetCompany.id))
                                                                .map(u => u.id) : [];
                                                            const excludedRoleCodes = ['manager','secretary','cleaner','mechanic','guard'];
                                                            const excludedRoleNames = ['管理層','總幹事','秘書','清潔','機電','保全'];
                                                            const filteredUsers = usersList.filter(u => {
                                                                const inCompany = companyUserIds.includes(u.id);
                                                                if (!inCompany) return false;
                                                                if (excludedRoleCodes.includes(u.role)) return false;
                                                                const rName = (roles.find(r => r.id === u.role)?.name) || '';
                                                                if (excludedRoleNames.includes(rName)) return false;
                                                                return true;
                                                            });
                                                            const typeOptions = [
                                                                { value: 'in', label: '上班' },
                                                                { value: 'out', label: '下班' },
                                                                { value: 'outing_start', label: '外出' },
                                                                { value: 'outing_arrive', label: '抵達' },
                                                                { value: 'outing_end', label: '離開' },
                                                                { value: 'late_in', label: '卡上' },
                                                                { value: 'late_out', label: '卡下' },
                                                            ];
                                                            return (
                                                                <div className="space-y-3">
                                                                    <div>
                                                                        <label className="block text-xs font-bold text-gray-500 mb-1">姓名</label>
                                                                        <select 
                                                                            className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100"
                                                                            value={manualClockForm.userId}
                                                                            onChange={e => {
                                                                                const uid = e.target.value;
                                                                                const user = usersList.find(u => u.id === uid);
                                                                                let firstLoc = '';
                                                                                if (user) {
                                                                                    const companyId = (user.companyIds && user.companyIds.length > 0) ? user.companyIds[0] : user.companyId;
                                                                                    const companyName = companies.find(c => c.id === companyId)?.name || '';
                                                                                    const commIds = user.communityIds || (user.communityId ? [user.communityId] : []);
                                                                                    const commNames = communities.filter(c => commIds.includes(c.id)).map(c => c.name);
                                                                                    const locs = [companyName, ...commNames].filter(Boolean);
                                                                                    firstLoc = locs[0] || '';
                                                                                }
                                                                                setManualClockForm(prev => ({ ...prev, userId: uid, locationName: firstLoc }));
                                                                            }}
                                                                        >
                                                                            <option value="">選擇人員</option>
                                                                            {filteredUsers.map(u => (
                                                                                <option key={u.id} value={u.id}>{u.name}</option>
                                                                            ))}
                                                                        </select>
                                                                    </div>
                                                                    <div>
                                                                        <label className="block text-xs font-bold text-gray-500 mb-1">打卡位置</label>
                                                                        {(function(){
                                                                            const user = usersList.find(u => u.id === manualClockForm.userId);
                                                                            const companyId = user ? ((user.companyIds && user.companyIds.length > 0) ? user.companyIds[0] : user.companyId) : '';
                                                                            const companyName = companies.find(c => c.id === companyId)?.name || '';
                                                                            const commIds = user ? (user.communityIds || (user.communityId ? [user.communityId] : [])) : [];
                                                                            const comms = communities.filter(c => commIds.includes(c.id)).map(c => c.name);
                                                                            const options = [companyName, ...comms].filter(Boolean);
                                                                            return (
                                                                                <select 
                                                                                    className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100"
                                                                                    value={manualClockForm.locationName}
                                                                                    onChange={e => setManualClockForm(prev => ({ ...prev, locationName: e.target.value }))}
                                                                                >
                                                                                    <option value="">{options.length ? '選擇地點' : '請先選擇姓名'}</option>
                                                                                    {options.map(n => <option key={n} value={n}>{n}</option>)}
                                                                                </select>
                                                                            );
                                                                        })()}
                                                                    </div>
                                                                    <div>
                                                                        <label className="block text-xs font-bold text-gray-500 mb-1">打卡項目</label>
                                                                        <select 
                                                                            className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100"
                                                                            value={manualClockForm.type}
                                                                            onChange={e => setManualClockForm(prev => ({ ...prev, type: e.target.value }))}
                                                                        >
                                                                            {typeOptions.map(opt => (
                                                                                <option key={opt.value} value={opt.value}>{opt.label}</option>
                                                                            ))}
                                                                        </select>
                                                                    </div>
                                                                    <div>
                                                                        <label className="block text-xs font-bold text-gray-500 mb-1">班別</label>
                                                                        <div className="inline-flex text-[11px] font-bold rounded-lg overflow-hidden border border-gray-200 bg-gray-50">
                                                                            <button
                                                                                type="button"
                                                                                onClick={() => setManualClockForm(prev => ({ ...prev, shift: 'day' }))}
                                                                                className={`px-2 py-1 ${
                                                                                    manualClockForm.shift !== 'night'
                                                                                        ? 'bg-blue-600 text-white'
                                                                                        : 'text-gray-600 bg-gray-50'
                                                                                }`}
                                                                            >
                                                                                日班
                                                                            </button>
                                                                            <button
                                                                                type="button"
                                                                                onClick={() => setManualClockForm(prev => ({ ...prev, shift: 'night' }))}
                                                                                className={`px-2 py-1 ${
                                                                                    manualClockForm.shift === 'night'
                                                                                        ? 'bg-indigo-600 text-white'
                                                                                        : 'text-gray-600 bg-gray-50'
                                                                                }`}
                                                                            >
                                                                                夜班
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <div className="grid grid-cols-2 gap-2">
                                                                        <div>
                                                                            <label className="block text-xs font-bold text-gray-500 mb-1">打卡日期</label>
                                                                            <input 
                                                                                type="date"
                                                                                className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100"
                                                                                value={manualClockForm.date}
                                                                                onChange={e => setManualClockForm(prev => ({ ...prev, date: e.target.value }))}
                                                                            />
                                                                        </div>
                                                                        <div>
                                                                            <label className="block text-xs font-bold text-gray-500 mb-1">打卡時間</label>
                                                                            <input 
                                                                                type="time"
                                                                                className="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-red-100"
                                                                                value={manualClockForm.time}
                                                                                onChange={e => setManualClockForm(prev => ({ ...prev, time: e.target.value }))}
                                                                            />
                                                                        </div>
                                                                    </div>
                                                                    <div className="flex justify-end gap-2 mt-4">
                                                                        <button 
                                                                            onClick={()=>{ setShowManualClockModal(false); }}
                                                                            className="px-3 py-2 rounded-2xl bg-gray-100 text-gray-700"
                                                                        >
                                                                            取消
                                                                        </button>
                                                                        <button 
                                                                            onClick={async()=>{ 
                                                                                try {
                                                                                    const user = usersList.find(u => u.id === manualClockForm.userId);
                                                                                    if (!user) { alert('請選擇姓名'); return; }
                                                                                    if (!manualClockForm.date || !manualClockForm.time) { alert('請輸入日期與時間'); return; }
                                                                                    const dt = new Date(`${manualClockForm.date}T${manualClockForm.time}:00`);
                                                                                    const companyId = (user.companyIds && user.companyIds.length > 0) ? user.companyIds[0] : user.companyId || '';
                                                                                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), {
                                                                                        userId: user.id,
                                                                                        userName: user.name,
                                                                                        companyId,
                                                                                        type: manualClockForm.type,
                                                                                        checkInLocationName: manualClockForm.locationName || '',
                                                                                        checkInTime: dt.toISOString(),
                                                                                        timestamp: dt,
                                                                                        isNightShift: manualClockForm.shift === 'night',
                                                                                        createdAt: serverTimestamp()
                                                                                    });
                                                                                    setToast('已新增手動打卡');
                                                                                    setShowManualClockModal(false);
                                                                                } catch (e) {
                                                                                    alert('新增失敗: ' + (e.message || e.code));
                                                                                }
                                                                            }}
                                                                            className="px-3 py-2 rounded-2xl bg-red-600 text-white"
                                                                        >
                                                                            儲存
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })()}
                                                    </div>
                                                </div>
                                            )}


                                            
                                            {cadreMapSelectedUserId && (
                                                <div className="mb-4 flex items-center justify-between bg-blue-50 p-3 rounded-xl text-blue-700 text-sm">
                                                    <div className="flex items-center gap-2">
                                                        <Users className="w-4 h-4" />
                                                        <span>已篩選人員: <span className="font-bold">{usersList.find(u => u.id === cadreMapSelectedUserId)?.name || '未知'}</span></span>
                                                    </div>
                                                    <button 
                                                        onClick={() => setCadreMapSelectedUserId(null)}
                                                        className="px-3 py-1 bg-white border border-blue-200 rounded-lg text-xs font-bold hover:bg-blue-50 transition shadow-sm"
                                                    >
                                                        清除篩選
                                                    </button>
                                                </div>
                                            )}

                                            <div className="space-y-3 pb-24">
                                                {!targetCompany ? (
                                                    <div className="text-center text-gray-400 py-8">請選擇公司</div>
                                                ) : (
                                                    <>
                                                        {(function(){
                                                            const pendingMakeups = makeupRequests.filter(req => 
                                                                req.status === 'pending' && 
                                                                companyUserIds.includes(req.userId)
                                                            );
                                                            
                                                            if (pendingMakeups.length === 0) return null;

                                                            return (
                                                                <div className="mb-6 space-y-3">
                                                                    <div className="flex items-center gap-2 px-1">
                                                                        <ClipboardList className="w-5 h-5 text-yellow-600" />
                                                                        <h3 className="font-bold text-gray-800">待核准補打卡 ({pendingMakeups.length})</h3>
                                                                    </div>
                                                                    {pendingMakeups.map(req => {
                                                                        const user = usersList.find(u => u.id === req.userId) || {};
                                                                        return (
                                                                            <div key={req.id} className="p-3 bg-white border border-gray-100 rounded-2xl shadow-sm">
                                                                                <div className="flex items-start gap-3">
                                                                                    <div className="w-10 h-10 rounded-full bg-gray-200 flex-shrink-0 overflow-hidden border border-gray-100">
                                                                                        {user.avatarUrl ? (
                                                                                            <img src={user.avatarUrl} className="w-full h-full object-cover" />
                                                                                        ) : (
                                                                                            <div className="w-full h-full flex items-center justify-center font-bold text-gray-500">
                                                                                                {req.userName?.[0]}
                                                                                            </div>
                                                                                        )}
                                                                                    </div>
                                                                                    <div className="flex-1 min-w-0">
                                                                                        <div className="font-bold text-gray-800">{req.userName}</div>
                                                                                        <div className="text-xs font-bold text-gray-700 mt-1">
                                                                                            補{req.target === 'out' ? '下班' : '上班'}打卡: {req.date} ({req.target === 'out' ? '下班' : '上班'})
                                                                                        </div>
                                                                                        <div className="text-xs text-gray-600 mt-0.5">
                                                                                            補卡時間: {req.target === 'out' ? req.endTime : req.startTime}
                                                                                        </div>
                                                                                        <div className="text-[11px] text-gray-600 mt-0.5">
                                                                                            打卡位置: {req.checkInLocationName || '-'}
                                                                                        </div>
                                                                                        <div className="text-[11px] text-gray-600 mt-0.5">
                                                                                            未打卡原因: {req.reasonType === 'other' ? (req.reasonRemark || '其他') : '忘記打卡'}
                                                                                        </div>
                                                                                    </div>
                                                                                    <div className="flex flex-col gap-2 ml-auto">
                                                                                        <button 
                                                                                            onClick={() => {
                                                                                                setEditingMakeupRequest(req);
                                                                                                setMakeupEditForm({
                                                                                                    startTime: req.startTime || '09:00',
                                                                                                    endTime: req.endTime || '18:00',
                                                                                                    locationId: req.locationId || '',
                                                                                                    reasonType: req.reasonType || 'forgot',
                                                                                                    reasonRemark: req.reasonRemark || ''
                                                                                                });
                                                                                                setShowMakeupEditModal(true);
                                                                                            }}
                                                                                            className="w-12 h-12 rounded-lg bg-orange-50 text-orange-600 flex items-center justify-center border border-orange-100 hover:opacity-90 transition-opacity"
                                                                                            title="編輯"
                                                                                        >
                                                                                            <Edit className="w-5 h-5" />
                                                                                        </button>
                                                                                        <button 
                                                                                            onClick={async () => {
                                                                                                if (!confirm('確認刪除此補打卡申請？')) return;
                                                                                                try {
                                                                                                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'makeup_requests', req.id));
                                                                                                } catch (e) {
                                                                                                    console.error(e);
                                                                                                    alert('刪除失敗: ' + e.message);
                                                                                                }
                                                                                            }}
                                                                                            className="w-12 h-12 rounded-lg flex items-center justify-center border transition-opacity bg-red-50 text-red-500 border-red-100 hover:opacity-90"
                                                                                            title="刪除"
                                                                                        >
                                                                                            <Trash2 className="w-5 h-5" />
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                                <div className="mt-3 flex gap-2">
                                                                                    <button
                                                                                        onClick={async () => {
                                                                                            const targetText = req.target === 'out' ? '下班' : '上班';
                                                                                            if (!confirm(`確認核准 ${req.userName} 的補打卡申請？\n系統將自動補入 ${req.date} 的${targetText}打卡紀錄。`)) return;
                                                                                            try {
                                                                                                const batch = writeBatch(db);
                                                                                                
                                                                                                // 1. Update Request
                                                                                                const reqRef = doc(db, 'artifacts', appId, 'public', 'data', 'makeup_requests', req.id);
                                                                                                batch.update(reqRef, { 
                                                                                                    status: 'approved',
                                                                                                    approvedBy: dbUser.name,
                                                                                                    approvedAt: serverTimestamp()
                                                                                                });

                                                                                                // 2. Create Record based on target
                                                                                                if (req.target !== 'out') {
                                                                                                    const inTime = new Date(`${req.date}T${req.startTime}:00`);
                                                                                                    const inRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'));
                                                                                                    batch.set(inRef, {
                                                                                                        userId: req.userId,
                                                                                                        userName: req.userName,
                                                                                                        companyId: req.userCompanyId,
                                                                                                        type: req.scheduleType === 'duty' ? 'duty_in' : 'work_in',
                                                                                                        checkInTime: inTime.toISOString(),
                                                                                                        timestamp: inTime,
                                                                                                        createdAt: serverTimestamp(),
                                                                                                        modification: { status: 'approved', approver: dbUser.name, reason: '補打卡申請核准' }
                                                                                                    });
                                                                                                }

                                                                                                if (req.target === 'out') {
                                                                                                    const outTime = new Date(`${req.date}T${req.endTime}:00`);
                                                                                                    
                                                                                                    const outRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'));
                                                                                                    batch.set(outRef, {
                                                                                                        userId: req.userId,
                                                                                                        userName: req.userName,
                                                                                                        companyId: req.userCompanyId,
                                                                                                        type: req.scheduleType === 'duty' ? 'duty_out' : 'work_out',
                                                                                                        checkInTime: outTime.toISOString(),
                                                                                                        timestamp: outTime,
                                                                                                        createdAt: serverTimestamp(),
                                                                                                        modification: { status: 'approved', approver: dbUser.name, reason: '補打卡申請核准' }
                                                                                                    });
                                                                                                }

                                                                                                await batch.commit();
                                                                                                alert('已核准並補入打卡紀錄');
                                                                                            } catch (err) {
                                                                                                console.error(err);
                                                                                                alert('核准失敗: ' + err.message);
                                                                                            }
                                                                                        }}
                                                                                        className="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-bold hover:bg-gray-200 transition-colors"
                                                                                    >
                                                                                        核准
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={async () => {
                                                                                            if (!confirm('確認拒絕此申請？')) return;
                                                                                            try {
                                                                                                const reqRef = doc(db, 'artifacts', appId, 'public', 'data', 'makeup_requests', req.id);
                                                                                                await updateDoc(reqRef, { 
                                                                                                    status: 'rejected',
                                                                                                    rejectedBy: dbUser.name,
                                                                                                    rejectedAt: serverTimestamp()
                                                                                                });
                                                                                            } catch (err) {
                                                                                                console.error(err);
                                                                                                alert('操作失敗: ' + err.message);
                                                                                            }
                                                                                        }}
                                                                                        className="flex-1 py-2 bg-white border border-gray-200 text-gray-700 rounded-lg text-sm font-bold hover:bg-gray-50 transition-colors"
                                                                                    >
                                                                                        拒絕
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            );
                                                        })()}

                                                        {(function(){
                                                            const pendingModifications = attendanceList.filter(req => 
                                                                req.modification?.status === 'pending' && 
                                                                companyUserIds.includes(req.userId)
                                                            );
                                                            
                                                            if (pendingModifications.length === 0) return null;

                                                            return (
                                                                <div className="mb-6 space-y-3">
                                                                    <div className="flex items-center gap-2 px-1">
                                                                        <Edit className="w-5 h-5 text-yellow-600" />
                                                                        <h3 className="font-bold text-gray-800">待核准修改 ({pendingModifications.length})</h3>
                                                                    </div>
                                                                    <div className="flex flex-col gap-3">
                                                                    {pendingModifications.map(r => {
                                                                        const user = usersList.find(u => u.id === r.userId) || {};
                                                                        // Safe time parsing
                                                                        let seconds;
                                                                        if (r.checkInTime) {
                                                                            seconds = new Date(r.checkInTime).getTime() / 1000;
                                                                        } else if (r.timestamp?.seconds) {
                                                                            seconds = r.timestamp.seconds;
                                                                        } else if (r.timestamp instanceof Date) {
                                                                            seconds = Math.floor(r.timestamp.getTime() / 1000);
                                                                        } else {
                                                                            seconds = Date.now() / 1000;
                                                                        }
                                                                        
                                                                        const rDate = new Date(seconds * 1000);
                                                                        const dateStr = `${rDate.getFullYear()}-${String(rDate.getMonth()+1).padStart(2,'0')}-${String(rDate.getDate()).padStart(2,'0')}`;
                                                                        const timeStr = rDate.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                                                                        const modifiedTime = r.modification?.time || '無修改時間';
                                                                        
                                                                        const typeMap = {
                                                                            'in': { text: '上班', class: 'bg-green-100 text-green-700' },
                                                                            'work_in': { text: '上班', class: 'bg-green-100 text-green-700' },
                                                                            'duty_in': { text: '上班', class: 'bg-green-100 text-green-700' },
                                                                            'card_in': { text: '卡上', class: 'bg-green-100 text-green-700' },
                                                                            'late_in': { text: '卡上', class: 'bg-green-100 text-green-700' },
                                                                            'out': { text: '下班', class: 'bg-red-100 text-red-700' },
                                                                            'work_out': { text: '下班', class: 'bg-red-100 text-red-700' },
                                                                            'duty_out': { text: '下班', class: 'bg-red-100 text-red-700' },
                                                                            'card_out': { text: '卡下', class: 'bg-red-100 text-red-700' },
                                                                            'late_out': { text: '卡下', class: 'bg-red-100 text-red-700' },
                                                                            'leave_early': { text: '早退', class: 'bg-red-100 text-red-700' },
                                                                            'outing_start': { text: '外出', class: 'bg-blue-100 text-blue-700' },
                                                                            'outing_arrive': { text: '抵達', class: 'bg-blue-100 text-blue-700' },
                                                                            'outing_end': { text: '離開', class: 'bg-blue-100 text-blue-700' },
                                                                            'leave': { text: '請假', class: 'bg-orange-100 text-orange-700' }
                                                                        };
                                                                        const config = typeMap[r.type] || { text: '未知', class: 'bg-gray-100 text-gray-500' };
                                                                        
                                                                        let finalText = config.text;
                                                                        if (['outing_start', 'outing_arrive', 'outing_end'].includes(r.type) && (r.checkInLocationName || r.address)) {
                                                                            finalText += ` ${r.checkInLocationName || r.address}`;
                                                                        }

                                                                        return (
                                                                            <div key={r.id} className="p-3 bg-yellow-50 border border-yellow-200 rounded-2xl shadow-sm">
                                                                                <div className="flex items-start gap-3">
                                                                                    <div className="w-10 h-10 rounded-full bg-gray-200 flex-shrink-0 overflow-hidden border border-gray-100">
                                                                                        {user.avatarUrl ? (
                                                                                            <img src={user.avatarUrl} className="w-full h-full object-cover" />
                                                                                        ) : (
                                                                                            <div className="w-full h-full flex items-center justify-center font-bold text-gray-500">
                                                                                                {user.name?.[0]}
                                                                                            </div>
                                                                                        )}
                                                                                    </div>
                                                                                    <div className="flex-1 min-w-0">
                                                                                        <div className="font-bold text-gray-800">{user.name}</div>
                                                                                        <div className={`text-xs font-bold mt-1 px-1.5 py-0.5 rounded-lg w-fit ${config.class}`}>
                                                                                            {finalText}
                                                                                        </div>
                                                                                        <div className="text-xs font-bold text-gray-700 mt-1">
                                                                                            申請修改: {dateStr}
                                                                                        </div>
                                                                                        <div className="text-xs font-bold text-blue-600 mt-0.5">
                                                                                            修改時間: {modifiedTime}
                                                                                        </div>
                                                                                        <div className="text-xs text-gray-600 mt-0.5">
                                                                                            原始時間: {timeStr}
                                                                                        </div>
                                                                                        <div className="text-[11px] text-gray-600 mt-0.5">
                                                                                            原因: {r.modification?.reason || '無'}
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                                <div className="mt-3 flex gap-2">
                                                                                    <button 
                                                                                        onClick={() => handleQuickApprove(r)}
                                                                                        className="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-bold hover:bg-gray-200 transition-colors"
                                                                                    >
                                                                                        核准
                                                                                    </button>
                                                                                    <button 
                                                                                        onClick={() => handleQuickReject(r)}
                                                                                        className="flex-1 py-2 bg-white border border-gray-200 text-gray-700 rounded-lg text-sm font-bold hover:bg-gray-50 transition-colors"
                                                                                    >
                                                                                        拒絕
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                    </div>
                                                                </div>
                                                            );
                                                        })()}

                                                        {records.length === 0 ? (
                                                            <div className="text-center py-12 text-gray-400 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-200">
                                                                本日尚無打卡紀錄
                                                            </div>
                                                        ) : (
                                                            records.map(r => {
                                                        const user = usersList.find(u => u.id === r.userId) || {};
                                                        
                                                        // Safe time parsing
                                                        let seconds;
                                                        if (r.timestamp?.seconds) {
                                                            seconds = r.timestamp.seconds;
                                                        } else if (r.timestamp instanceof Date) {
                                                            seconds = Math.floor(r.timestamp.getTime() / 1000);
                                                        } else {
                                                            seconds = Date.now() / 1000;
                                                        }
                                                        const recordDateObj = new Date(seconds * 1000);
                                                        const timeStr = recordDateObj.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                                                        
                                                        const dateStr = `${recordDateObj.getFullYear()}-${String(recordDateObj.getMonth() + 1).padStart(2,'0')}-${String(recordDateObj.getDate()).padStart(2,'0')}`;
                                                        const schedule = schedulesList.find(s => s.userId === r.userId && s.date === dateStr);
                                                        const isNightShiftDisplay = !!(r.isNightShift || (schedule && (schedule.startTime === '12:00' || schedule.crossDay === true)));
                                                        
                                                        return (
                                                            <div key={r.id} className={`p-3 bg-white border rounded-2xl shadow-sm flex items-start gap-3 ${
                                                                r.modification?.status === 'approved' ? 'border-green-500' :
                                                                r.modification?.status === 'rejected' ? 'border-red-500' :
                                                                r.modification?.status === 'pending' ? 'border-orange-500' :
                                                                'border-gray-100'
                                                            }`}>
                                                                <div className="w-10 h-10 rounded-full bg-gray-200 flex-shrink-0 overflow-hidden border border-gray-100">
                                                                    {user.avatarUrl ? (
                                                                        <img src={user.avatarUrl} className="w-full h-full object-cover" />
                                                                    ) : (
                                                                        <div className="w-full h-full flex items-center justify-center font-bold text-gray-500">
                                                                            {user.name?.[0]}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                                <div className="flex-1 min-w-0">
                                                                    <div className="flex justify-between items-center">
                                                                        <div>
                                                                            <div className="font-bold text-gray-800 flex items-center gap-2">
                                                                                {r.userName}
                                                                                {(function(){
                                                    const typeMap = {
                                                        'in': { text: '上班', class: 'bg-green-100 text-green-700' },
                                                        'work_in': { text: '上班', class: 'bg-green-100 text-green-700' },
                                                        'duty_in': { text: '上班', class: 'bg-green-100 text-green-700' },
                                                        'card_in': { text: '卡上', class: 'bg-green-100 text-green-700' },
                                                        'late_in': { text: '卡上', class: 'bg-green-100 text-green-700' },
                                                        'out': { text: '下班', class: 'bg-red-100 text-red-700' },
                                                        'work_out': { text: '下班', class: 'bg-red-100 text-red-700' },
                                                        'duty_out': { text: '下班', class: 'bg-red-100 text-red-700' },
                                                        'card_out': { text: '卡下', class: 'bg-red-100 text-red-700' },
                                                        'late_out': { text: '卡下', class: 'bg-red-100 text-red-700' },
                                                        'leave_early': { text: '早退', class: 'bg-red-100 text-red-700' },
                                                        'outing_start': { text: '外出', class: 'bg-blue-100 text-blue-700' },
                                                        'outing_arrive': { text: '抵達', class: 'bg-blue-100 text-blue-700' },
                                                        'outing_end': { text: '離開', class: 'bg-blue-100 text-blue-700' },
                                                        'leave': { text: '請假', class: 'bg-orange-100 text-orange-700' }
                                                    };
                                                    const config = typeMap[r.type] || { text: '未知', class: 'bg-gray-100 text-gray-500' };
                                                    
                                                    let finalText = config.text;
                                                    if (['outing_start', 'outing_arrive', 'outing_end'].includes(r.type) && (r.checkInLocationName || r.address)) {
                                                        finalText += ` ${r.checkInLocationName || r.address}`;
                                                    }

                                                    return (
                                                        <>
                                                            <span className={`text-[10px] px-1.5 py-0.5 rounded-lg ${config.class}`}>
                                                                {finalText}
                                                            </span>
                                                            {isNightShiftDisplay && (
                                                                <span className="text-[10px] px-1.5 py-0.5 rounded-lg bg-indigo-100 text-indigo-700">
                                                                    夜班
                                                                </span>
                                                            )}
                                                        </>
                                                    );
                                                })()}
                                                                                {r.modification?.status === 'approved' && (
                                                                                    <span className="text-[10px] px-1.5 py-0.5 rounded-lg ml-1 bg-green-100 text-green-700">核准</span>
                                                                                )}
                                                                                {r.modification?.status === 'rejected' && (
                                                                                    <span className="text-[10px] px-1.5 py-0.5 rounded-lg ml-1 bg-red-100 text-red-700">拒絕</span>
                                                                                )}
                                                                                {r.modification?.status === 'pending' && (
                                                                                    <span className="text-[10px] px-1.5 py-0.5 rounded-lg ml-1 bg-yellow-100 text-yellow-700">待核准</span>
                                                                                )}
                                                                            </div>
                                                                            {r.modification ? (
                                                                                <>
                                                                                    <div className="text-sm font-bold text-blue-600 mt-0.5 flex items-center gap-1">
                                                                                        <Clock className="w-3 h-3" /> 修改時間: {r.modification.time}
                                                                                    </div>
                                                                                    <div className="text-sm text-gray-500 mt-0.5 flex items-center gap-1">
                                                                                        <Clock className="w-3 h-3" /> 原始時間: {(function(){
                                                                                            if (r.modification.status === 'approved' && r.modification.originalTimestamp) {
                                                                                                const ot = r.modification.originalTimestamp;
                                                                                                const s = ot.seconds || (ot instanceof Date ? ot.getTime()/1000 : 0);
                                                                                                if (s) return new Date(s * 1000).toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                                                                                            }
                                                                                            return timeStr;
                                                                                        })()}
                                                                                    </div>
                                                                                </>
                                                                            ) : (
                                                                                <div className="text-sm text-gray-500 mt-0.5 flex items-center gap-1">
                                                                                    <Clock className="w-3 h-3" /> {timeStr}
                                                                                </div>
                                                                            )}
                                                                            <div className="text-sm text-gray-500 mt-0.5 flex items-center gap-1">
                                                                                <MapPin className="w-3 h-3" /> {r.checkInLocationName || r.address || '未記錄'}
                                                                            </div>
                                                                        </div>
                                                                    <div className="flex gap-2">
                                                                            <div className="flex gap-2 items-end">
                                                                                <div className="flex flex-col gap-2">
                                                                                    {(function(){
                                                                                        const loc = (function(){
                                                                                            const raw = r.location;
                                                                                            if (!raw) return null;
                                                                                            if (typeof raw === 'string') {
                                                                                                const parts = raw.split(',');
                                                                                                if (parts.length >= 2) {
                                                                                                    const lat = parseFloat((parts[0] || '').trim());
                                                                                                    const lng = parseFloat((parts[1] || '').trim());
                                                                                                    if (Number.isFinite(lat) && Number.isFinite(lng)) return { lat, lng };
                                                                                                }
                                                                                                return null;
                                                                                            }
                                                                                            if (Array.isArray(raw) && raw.length >= 2) {
                                                                                                const lat = parseFloat(raw[0]);
                                                                                                const lng = parseFloat(raw[1]);
                                                                                                if (Number.isFinite(lat) && Number.isFinite(lng)) return { lat, lng };
                                                                                                return null;
                                                                                            }
                                                                                            if (typeof raw === 'object') {
                                                                                                const lat = parseFloat(raw.lat ?? raw.latitude);
                                                                                                const lng = parseFloat(raw.lng ?? raw.longitude);
                                                                                                if (Number.isFinite(lat) && Number.isFinite(lng)) return { lat, lng };
                                                                                            }
                                                                                            return null;
                                                                                        })();

                                                                                        const fallbackMapImgUrl = loc
                                                                                            ? `https://maps.googleapis.com/maps/api/staticmap?center=${loc.lat},${loc.lng}&zoom=15&size=100x100&maptype=roadmap&markers=color:red%7C${loc.lat},${loc.lng}&key=AIzaSyAzhLdWtycJgfz8UsXWlji63DkXpA4kmyY`
                                                                                            : null;

                                                                                        let mapImgUrl = fallbackMapImgUrl;
                                                                                        if (loc && Array.isArray(usersList)) {
                                                                                            const iconOwner = usersList.find(u => u.id === r.userId) || null;
                                                                                            const iconSrc = (iconOwner && iconOwner.avatarUrl && /^https?:\/\//i.test(iconOwner.avatarUrl)) ? iconOwner.avatarUrl : null;
                                                                                            if (iconSrc) {
                                                                                                const iconUrl = encodeURIComponent(iconSrc);
                                                                                                const withIcon = `https://maps.googleapis.com/maps/api/staticmap?center=${loc.lat},${loc.lng}&zoom=15&size=100x100&maptype=roadmap&markers=icon:${iconUrl}%7C${loc.lat},${loc.lng}&key=AIzaSyAzhLdWtycJgfz8UsXWlji63DkXpA4kmyY`;
                                                                                                if (withIcon.length <= 1800) mapImgUrl = withIcon;
                                                                                            }
                                                                                        }

                                                                                        return (
                                                                                            <button 
                                                                                                onClick={() => {
                                                                                                    if (loc) {
                                                                                                        setMapPreviewTarget({
                                                                                                            lat: loc.lat,
                                                                                                            lng: loc.lng,
                                                                                                            name: r.userName + ' - ' + (r.address || '打卡位置'),
                                                                                                            radius: 10
                                                                                                        });
                                                                                                    } else {
                                                                                                        alert('無座標資訊: ' + (r.address || ''));
                                                                                                    }
                                                                                                }}
                                                                                                className="w-12 h-12 rounded-lg bg-gray-100 text-gray-500 flex items-center justify-center border border-gray-200 hover:opacity-90 transition-opacity overflow-hidden p-0"
                                                                                            >
                                                                                                {mapImgUrl ? (
                                                                                                    <img
                                                                                                        src={mapImgUrl}
                                                                                                        className="w-full h-full object-cover"
                                                                                                        alt="地圖"
                                                                                                        onError={(e) => {
                                                                                                            if (fallbackMapImgUrl && e.currentTarget.src !== fallbackMapImgUrl) {
                                                                                                                e.currentTarget.src = fallbackMapImgUrl;
                                                                                                            }
                                                                                                        }}
                                                                                                    />
                                                                                                ) : (
                                                                                                    <MapPin className="w-5 h-5" />
                                                                                                )}
                                                                                            </button>
                                                                                        );
                                                                                    })()}
                                                                                    
                                                                                    <button 
                                                                                        onClick={() => {
                                                                                            setAdminEditData(r);
                                                                                            setShowAdminEditModal(true);
                                                                                        }}
                                                                                        className="w-12 h-12 rounded-lg bg-blue-50 text-blue-500 flex items-center justify-center border border-blue-100 hover:opacity-90 transition-opacity"
                                                                                    >
                                                                                        <Edit className="w-5 h-5" />
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                            
                                                                            <div className="flex flex-col gap-2">
                                                                                {r.photoUrl ? (
                                                                                    <div className="w-12 h-12 rounded-lg bg-gray-100 overflow-hidden cursor-pointer border border-gray-200 hover:opacity-90 transition-opacity" onClick={() => setPreviewImageUrl({ url: r.photoUrl })}>
                                                                                        <img src={r.photoUrl} className="w-full h-full object-cover" />
                                                                                    </div>
                                                                                ) : (
                                                                                    <div className="w-12 h-12"></div>
                                                                                )}
                                                                                
                                                                                <button 
                                                                                    onClick={() => handleAdminDeleteRecord(r)}
                                                                                    className="w-12 h-12 rounded-lg bg-red-50 text-red-500 flex items-center justify-center border border-red-100 hover:opacity-90 transition-opacity"
                                                                                >
                                                                                    <Trash2 className="w-5 h-5" />
                                                                                </button>
                                                                            </div>
                                                                    </div>
                                                                </div>
                                                                
                                                                {r.modification?.status === 'pending' && (
                                                                    <div className="flex gap-3 border-t border-gray-100 pt-3">
                                                                        <button 
                                                                            onClick={() => handleQuickReject(r)}
                                                                            className="flex-1 py-2 bg-white border border-gray-200 text-gray-700 rounded-lg text-sm font-bold hover:bg-gray-50 transition-colors"
                                                                        >
                                                                            拒絕
                                                                        </button>
                                                                        <button 
                                                                            onClick={() => handleQuickApprove(r)}
                                                                            className="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-bold hover:bg-gray-200 transition-colors"
                                                                        >
                                                                            核准
                                                                        </button>
                                                                    </div>
                                                                )}
                                                                {r.modification?.status !== 'pending' && r.modification?.reviewerName && (
                                                                    <>
                                                                        <div className="flex gap-3 border-t border-gray-100 pt-3">
                                                                            <button 
                                                                                onClick={() => handleResetModification(r)}
                                                                                className="flex-1 py-2 bg-yellow-50 text-yellow-700 rounded-lg text-xs font-bold hover:bg-yellow-100 transition-colors"
                                                                            >
                                                                                重新審核
                                                                            </button>
                                                                            <button 
                                                                                onClick={() => handleAdminDeleteRecord(r)}
                                                                                className="flex-1 py-2 bg-red-50 text-red-600 rounded-lg text-xs font-bold hover:bg-red-100 transition-colors"
                                                                            >
                                                                                刪除
                                                                            </button>
                                                                        </div>
                                                                        <div className="text-right text-xs text-gray-400 mt-2">
                                                                            審核人: {r.modification.reviewerName}
                                                                        </div>
                                                                    </>
                                                                )}
                                                                </div>
                                                            </div>
                                                        );
                                                    })
                                                )}
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                        );
                                    })()}
                                    {cadreSubtab === 'leave' && hasSubPermission('cadre', 'leave') && (function() {
                                        const targetCompany = companies.find(c => c.name === cadreCompany);
                                        const companyUserIds = targetCompany ? usersList
                                            .filter(u => (u.companyIds && u.companyIds.some(cid => String(cid) === String(targetCompany.id))) || String(u.companyId) === String(targetCompany.id))
                                            .map(u => u.id) : [];

                                        const currentMonth = cadreRecordDate.substring(0, 7); // YYYY-MM

                                        const records = targetCompany ? leavesList.filter(r => {
                                            if (!companyUserIds.includes(r.userId)) return false;
                                            if (cadreMapSelectedUserId && r.userId !== cadreMapSelectedUserId) return false;
                                            
                                            const rDateStr = r.leaveStartDate ? r.leaveStartDate.split('T')[0] : (r.leaveDate || (() => {
                                                const d = new Date((r.timestamp?.seconds || Date.now() / 1000) * 1000);
                                                return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                                            })());
                                            
                                            if (!rDateStr.startsWith(currentMonth)) return false;

                                            return true;
                                        }) : [];
                                        
                                        const now = new Date();
                                        const thisMonthStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                                        const isThisMonth = currentMonth === thisMonthStr;

                                        return (
                                        <div>
                                            <h3 className="font-bold text-gray-800 mb-4 text-sm flex items-center justify-between">
                                                <div className="flex items-center gap-2">
                                                    <button 
                                                        onClick={() => {
                                                            const d = new Date(cadreRecordDate);
                                                            d.setDate(1);
                                                            d.setMonth(d.getMonth() - 1);
                                                            setCadreRecordDate(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`);
                                                        }} 
                                                        className="p-1 rounded-full hover:bg-gray-100 text-gray-500"
                                                    >
                                                        <ChevronLeft className="w-5 h-5" />
                                                    </button>
                                                    <span>{isThisMonth ? '本月請假紀錄' : `${currentMonth.replace(/-/g, '/')} 請假紀錄`}</span>
                                                    <button 
                                                        onClick={() => {
                                                            const d = new Date(cadreRecordDate);
                                                            d.setDate(1);
                                                            d.setMonth(d.getMonth() + 1);
                                                            setCadreRecordDate(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`);
                                                        }}
                                                        disabled={isThisMonth}
                                                        className={`p-1 rounded-full hover:bg-gray-100 text-gray-500 ${isThisMonth ? 'opacity-30 cursor-not-allowed' : ''}`}
                                                    >
                                                        <ChevronRight className="w-5 h-5" />
                                                    </button>
                                                </div>
                                                <span className="text-sm text-gray-400 font-normal">共 {records.length} 筆</span>
                                            </h3>
                                            
                                            {cadreMapSelectedUserId && (
                                                <div className="mb-4 flex items-center justify-between bg-blue-50 p-3 rounded-xl text-blue-700 text-sm">
                                                    <div className="flex items-center gap-2">
                                                        <Users className="w-4 h-4" />
                                                        <span>已篩選人員: <span className="font-bold">{usersList.find(u => u.id === cadreMapSelectedUserId)?.name || '未知'}</span></span>
                                                    </div>
                                                    <button 
                                                        onClick={() => setCadreMapSelectedUserId(null)}
                                                        className="px-3 py-1 bg-white border border-blue-200 rounded-lg text-xs font-bold hover:bg-blue-50 transition shadow-sm"
                                                    >
                                                        清除篩選
                                                    </button>
                                                </div>
                                            )}

                                            <div className="space-y-3 pb-24">
                                                {!targetCompany ? (
                                                    <div className="text-center text-gray-400 py-8">請選擇公司</div>
                                                ) : records.length === 0 ? (
                                                    <div className="text-center py-12 text-gray-400 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-200">
                                                        本月尚無請假紀錄
                                                    </div>
                                                ) : (
                                                    records.map(r => {
                                                        const user = usersList.find(u => u.id === r.userId) || {};
                                                        
                                                        return (
                                                            <div key={r.id} className="p-4 bg-white rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                                                                <div className="flex items-center justify-between mb-3">
                                                                    <div className="flex items-center gap-3">
                                                                        <div className="w-10 h-10 rounded-full bg-gray-200 flex-shrink-0 overflow-hidden border border-gray-100">
                                                                            {user.avatarUrl ? <img src={user.avatarUrl} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center font-bold text-gray-500">{user.name?.[0]}</div>}
                                                                        </div>
                                                                        <div>
                                                                            <div className="font-bold text-gray-800 text-sm flex items-center gap-2">
                                                                                {r.userName}
                                                                                <span className="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">{r.leaveReason || '請假'}</span>
                                                                            </div>
                                                                            <div className="text-xs text-gray-400">
                                                                                申請日期 : {new Intl.DateTimeFormat('zh-TW', {
                                                                                    timeZone: 'Asia/Taipei',
                                                                                    year: 'numeric', month: '2-digit', day: '2-digit',
                                                                                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                                                                                    hour12: false
                                                                                }).format(new Date((r.timestamp?.seconds || Date.now()/1000) * 1000)).replace(/\//g, '/')}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <span className={`text-xs px-2 py-1 rounded-lg font-bold flex items-center gap-1 ${
                                                                        r.approvalStatus === 'approved' ? 'bg-green-100 text-green-700' :
                                                                        r.approvalStatus === 'rejected' ? 'bg-red-100 text-red-700' :
                                                                        'bg-orange-100 text-orange-700'
                                                                    }`}>
                                                                        {r.approvalStatus === 'approved' ? (
                                                                            <>
                                                                                請假
                                                                                <span className="text-[9px] bg-white bg-opacity-50 px-1 rounded ml-1">已核准</span>
                                                                            </>
                                                                        ) : r.approvalStatus === 'rejected' ? '已駁回' : '待核准'}
                                                                    </span>
                                                                </div>

                                                                <div className="text-sm text-gray-500 mb-2">
                                                                    <div className="flex items-center gap-1 mb-1">
                                                                        <Clock className="w-3 h-3" /> 
                                                                        期間 : {r.leaveStartDate ? `${r.leaveStartDate.replace('T', ' ').replace(/-/g, '/')} ~ ${r.leaveEndDate ? r.leaveEndDate.replace('T', ' ').replace(/-/g, '/') : ''}` : `${(r.leaveDate || '').replace(/-/g, '/')} ${r.leaveTime}`}
                                                                    </div>
                                                                    <div className="pl-5 text-xs text-gray-500 space-y-1 mt-1">
                                                                        {(function() {
                                                                            let dates = [];
                                                                            if (r.leaveStartDate && r.leaveEndDate) {
                                                                                const sStr = r.leaveStartDate.split(/[T ]/)[0];
                                                                                const eStr = r.leaveEndDate.split(/[T ]/)[0];
                                                                                const s = new Date(sStr);
                                                                                const e = new Date(eStr);
                                                                                for(let d = new Date(s); d <= e; d.setDate(d.getDate()+1)) {
                                                                                    dates.push(new Date(d));
                                                                                }
                                                                            } else if (r.leaveDate) {
                                                                                dates.push(new Date(r.leaveDate));
                                                                            }
                                                                            
                                                                            if (dates.length === 0) return null;

                                                                            const nationalHolidays = [
                                                                                '2025-01-01','2025-01-25','2025-01-26','2025-01-27','2025-01-28','2025-01-29','2025-01-30','2025-01-31','2025-02-01','2025-02-02',
                                                                                '2025-02-28','2025-04-03','2025-04-04','2025-04-05','2025-04-06','2025-05-01','2025-05-30','2025-05-31','2025-06-01',
                                                                                '2025-10-04','2025-10-05','2025-10-06','2025-10-10','2025-10-11','2025-10-12','2025-12-25',
                                                                                '2026-01-01','2026-01-02','2026-02-14','2026-02-15','2026-02-16','2026-02-17','2026-02-18','2026-02-19','2026-02-20','2026-02-21','2026-02-22',
                                                                                '2026-02-27','2026-02-28','2026-03-01','2026-04-03','2026-04-04','2026-04-05','2026-04-06','2026-05-01',
                                                                                '2026-06-19','2026-06-20','2026-06-21','2026-09-25','2026-09-26','2026-09-27','2026-10-09','2026-10-10','2026-10-11','2026-12-25'
                                                                            ];

                                                                            let totalDays = 0;
                                                                            let totalHours = 0;

                                                                            const items = dates.map(dateObj => {
                                                                                const dateStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${String(dateObj.getDate()).padStart(2,'0')}`;
                                                                                const schedule = schedulesList.find(s => s.userId === r.userId && s.date === dateStr);
                                                                                
                                                                                let type = 'work';
                                                                                let hours = 0;
                                                                                let timeRangeStr = '';
                                                                                
                                                                                if (schedule) {
                                                                                    type = schedule.type;
                                                                                    if (['work', 'duty', 'card'].includes(type) && schedule.startTime && schedule.endTime) {
                                                                                        const [sH, sM] = schedule.startTime.split(':').map(Number);
                                                                                        const [eH, eM] = schedule.endTime.split(':').map(Number);
                                                                                        // Use local time construction to avoid timezone issues
                                                                                        const [dy, dm, dd] = dateStr.split('-').map(Number);
                                                                                        let sDate = new Date(dy, dm-1, dd, sH, sM);
                                                                                        let eDate = new Date(dy, dm-1, dd, eH, eM);
                                                                                        
                                                                                        if (eDate < sDate) eDate.setDate(eDate.getDate() + 1);
                                                                                        
                                                                                        // Default scheduled hours
                                                                                        hours = (eDate - sDate) / (1000 * 60 * 60);

                                                                                        // Refine hours if leave start/end are specified (overlap calculation)
                                                                                        let lStart, lEnd;
                                                                                        
                                                                                        // Helper to parse "YYYY-MM-DD HH:mm:ss" or "YYYY-MM-DDTHH:mm:ss" to local Date
                                                                                        const parseLocal = (str) => {
                                                                                            if(!str) return null;
                                                                                            const [dStr, tStr] = str.split(/[T ]/);
                                                                                            if(!dStr || !tStr) return null;
                                                                                            const [y,m,d] = dStr.split('-').map(Number);
                                                                                            const [h,min,s] = tStr.split(':').map(Number);
                                                                                            return new Date(y, m-1, d, h, min, s||0);
                                                                                        };

                                                                                        if (r.leaveStartDate && r.leaveEndDate) {
                                                                                            lStart = parseLocal(r.leaveStartDate);
                                                                                            lEnd = parseLocal(r.leaveEndDate);
                                                                                        } else if (r.leaveDate) {
                                                                                            // Try to parse time range from leaveTime or use leaveEndTime
                                                                                            let sTime = r.leaveTime;
                                                                                            let eTime = r.leaveEndTime;
                                                                                            
                                                                                            if (sTime && sTime.includes('~') && !eTime) {
                                                                                                const parts = sTime.split('~').map(s => s.trim());
                                                                                                sTime = parts[0];
                                                                                                eTime = parts[1];
                                                                                            }
                                                                                            
                                                                                            if (sTime && eTime) {
                                                                                                const [ly, lm, ld] = r.leaveDate.split('-').map(Number);
                                                                                                const [lsh, lsm] = sTime.split(':').map(Number);
                                                                                                const [leh, lem] = eTime.split(':').map(Number);
                                                                                                lStart = new Date(ly, lm-1, ld, lsh, lsm);
                                                                                                lEnd = new Date(ly, lm-1, ld, leh, lem);
                                                                                            }
                                                                                        }

                                                                                        if (lStart && lEnd) {
                                                                                            // Calculate effective leave start/end for this day
                                                                                            // This day's schedule: [sDate, eDate]
                                                                                            // Leave range: [lStart, lEnd]
                                                                                            
                                                                                            const overlapStart = new Date(Math.max(sDate.getTime(), lStart.getTime()));
                                                                                            const overlapEnd = new Date(Math.min(eDate.getTime(), lEnd.getTime()));
                                                                                            
                                                                                            if (overlapEnd > overlapStart) {
                                                                                                hours = (overlapEnd - overlapStart) / (1000 * 60 * 60);
                                                                                                
                                                                                                const fmt = (d) => `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                                                                                                timeRangeStr = `${fmt(overlapStart)}~${fmt(overlapEnd)}`;
                                                                                            } else {
                                                                                                // No overlap with working hours
                                                                                                hours = 0;
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                } else {
                                                                                    if (nationalHolidays.includes(dateStr)) type = 'holiday';
                                                                                    else {
                                                                                        const w = dateObj.getDay();
                                                                                        if (w === 0 || w === 6) type = 'holiday';
                                                                                        else if (w === 5) type = 'off';
                                                                                        else type = 'work';
                                                                                    }
                                                                                }
                                                                                
                                                                                if (type === 'off' || type === 'holiday') return null;
                                                                                // If calculated hours is 0 (e.g. leave time outside work hours), maybe skip or show 0?
                                                                                // Usually if it's a work day but leave is outside work hours, it shouldn't count as leave hours.
                                                                                if (hours <= 0) return null;

                                                                                totalDays++;
                                                                                totalHours += hours;

                                                                                return (
                                                                                    <div key={dateStr} className="flex items-center gap-2">
                                                                                        <span>{dateStr.replace(/-/g, '/')}</span>
                                                                                        {hours > 0 && <span>{hours.toFixed(1)} hr</span>}
                                                                                        {timeRangeStr && <span className="text-gray-500 text-xs">({timeRangeStr})</span>}
                                                                                    </div>
                                                                                );
                                                                            }).filter(Boolean);

                                                                            if (items.length === 0) return null;

                                                                            return (
                                                                                <>
                                                                                    <div className="font-bold text-gray-600 mb-1">實際請假日期</div>
                                                                                    {items}
                                                                                    <div className="border-t border-gray-200 mt-2 pt-1 font-bold text-gray-600">
                                                                                        總天數及總工時 : 共 {totalDays} 天, {totalHours.toFixed(1)} hr
                                                                                    </div>
                                                                                </>
                                                                            );
                                                                        })()}
                                                                    </div>
                                                                </div>

                                                                {r.leaveDescription && (
                                                                    <div className="bg-gray-50 p-3 rounded-lg text-sm text-gray-700 mb-4 whitespace-pre-wrap">
                                                                        {r.leaveDescription}
                                                                    </div>
                                                                )}

                                                                {r.photoUrl && (
                                                                    <div className="w-full h-48 bg-gray-100 rounded-lg overflow-hidden mb-4 cursor-pointer border border-gray-200" onClick={() => setPreviewImageUrl(r.photoUrl)}>
                                                                         <img src={r.photoUrl} className="w-full h-full object-cover" />
                                                                    </div>
                                                                )}

                                                                {(r.approvalStatus === 'pending' || !r.approvalStatus) && (
                                                                    <div className="flex gap-3 border-t border-gray-100 pt-3">
                                                                        <button 
                                                                            onClick={() => handleUpdateLeaveStatus('rejected', r)}
                                                                            className="flex-1 py-2 bg-white border border-gray-200 text-gray-700 rounded-lg text-sm font-bold hover:bg-gray-50 transition-colors"
                                                                        >
                                                                            拒絕
                                                                        </button>
                                                                        <button 
                                                                            onClick={() => handleUpdateLeaveStatus('approved', r)}
                                                                            className="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-bold hover:bg-gray-200 transition-colors"
                                                                        >
                                                                            核准
                                                                        </button>
                                                                    </div>
                                                                )}
                                                                
                                                                {r.approvalStatus && r.approvalStatus !== 'pending' && (
                                                                    <div className="flex gap-3 border-t border-gray-100 pt-3">
                                                                         <button 
                                                                            onClick={() => handleUpdateLeaveStatus('pending', r)}
                                                                            className="flex-1 py-2 bg-yellow-50 text-yellow-700 rounded-lg text-xs font-bold hover:bg-yellow-100 transition-colors"
                                                                        >
                                                                            重新審核
                                                                        </button>
                                                                        <button 
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                handleAdminDeleteRecord(r);
                                                                            }}
                                                                            className="flex-1 py-2 bg-red-50 text-red-600 rounded-lg text-xs font-bold hover:bg-red-100 transition-colors"
                                                                        >
                                                                            刪除
                                                                        </button>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })
                                                )}
                                            </div>
                                        </div>
                                        );
                                    })()}
                                    {cadreSubtab === 'schedule' && hasSubPermission('cadre', 'schedule') && (
                                        <div>
                                            
                                            {cadreMapSelectedUserId && (
                                                <div className="mb-4 flex items-center justify-between bg-blue-50 p-3 rounded-xl text-blue-700 text-sm">
                                                    <div className="flex items-center gap-2">
                                                        <Users className="w-4 h-4" />
                                                        <span>帳號: <span className="font-bold">{usersList.find(u => u.id === cadreMapSelectedUserId)?.name || '未知'}</span></span>
                                                    </div>
                                                    <button 
                                                        onClick={() => setCadreMapSelectedUserId(null)}
                                                        className="px-3 py-1 bg-white border border-blue-200 rounded-lg text-xs font-bold hover:bg-blue-50 transition shadow-sm"
                                                    >
                                                        取消選取
                                                    </button>
                                                </div>
                                            )}

                                            <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                                                <div className="flex items-center justify-between mb-4">
                                                    <button 
                                                        onClick={() => setCadreScheduleDate(new Date(cadreScheduleDate.getFullYear(), cadreScheduleDate.getMonth() - 1, 1))}
                                                        className="p-1 rounded-full hover:bg-gray-100"
                                                    >
                                                        <ChevronLeft className="w-5 h-5 text-gray-600" />
                                                    </button>
                                                    <span className="font-bold text-gray-800 text-lg">
                                                        {cadreScheduleDate.getFullYear()}年 {cadreScheduleDate.getMonth() + 1}月
                                                    </span>
                                                    <button 
                                                        onClick={() => setCadreScheduleDate(new Date(cadreScheduleDate.getFullYear(), cadreScheduleDate.getMonth() + 1, 1))}
                                                        className="p-1 rounded-full hover:bg-gray-100"
                                                    >
                                                        <ChevronRight className="w-5 h-5 text-gray-600" />
                                                    </button>
                                                </div>
                                                <div className="grid grid-cols-7 gap-1 text-center mb-2">
                                                    {['日', '一', '二', '三', '四', '五', '六'].map(d => (
                                                        <div key={d} className="text-xs font-bold text-gray-400 py-2">{d}</div>
                                                    ))}
                                                </div>
                                                <div className="grid grid-cols-7 gap-1">
                                                    {(() => {
                                                        const year = cadreScheduleDate.getFullYear();
                                                        const month = cadreScheduleDate.getMonth();
                                                        const daysInMonth = new Date(year, month + 1, 0).getDate();
                                                        const firstDayOfWeek = new Date(year, month, 1).getDay();
                                                        const days = [];
                                                        
                                                        // Taiwan National Holidays (2025-2026)
                                                        const holidays = [
                                                            // 2025
                                                            '2025-01-01', '2025-01-25', '2025-01-26', '2025-01-27', '2025-01-28', '2025-01-29', '2025-01-30', '2025-01-31', '2025-02-01', '2025-02-02', 
                                                            '2025-02-28', 
                                                            '2025-04-03', '2025-04-04', '2025-04-05', '2025-04-06', 
                                                            '2025-05-01', 
                                                            '2025-05-30', '2025-05-31', '2025-06-01', 
                                                            '2025-10-04', '2025-10-05', '2025-10-06', 
                                                            '2025-10-10', '2025-10-11', '2025-10-12', 
                                                            '2025-12-25', 

                                                            // 2026
                                                            '2026-01-01', 
                                                            '2026-02-14', '2026-02-15', '2026-02-16', '2026-02-17', '2026-02-18', '2026-02-19', '2026-02-20', '2026-02-21', '2026-02-22', 
                                                            '2026-02-27', '2026-02-28', '2026-03-01', 
                                                            '2026-04-03', '2026-04-04', '2026-04-05', '2026-04-06', 
                                                            '2026-05-01', 
                                                            '2026-06-19', '2026-06-20', '2026-06-21', 
                                                            '2026-09-25', '2026-09-26', '2026-09-27', 
                                                            '2026-10-09', '2026-10-10', '2026-10-11', 
                                                            '2026-12-25', 
                                                        ];

                                                        // Empty cells
                                                        for (let i = 0; i < firstDayOfWeek; i++) {
                                                            days.push(<div key={`empty-${i}`} className="h-12"></div>);
                                                        }

                                                        // Days
                                                        for (let d = 1; d <= daysInMonth; d++) {
                                                            const currentDate = new Date(year, month, d);
                                                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                                                            const isToday = new Date().toDateString() === currentDate.toDateString();
                                                            const isHoliday = holidays.includes(dateStr);
                                                            const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                                                            const schedule = userSchedules[dateStr];

                                                            let cellClass = isHoliday || isWeekend ? 'bg-gray-100 text-gray-800' : 'hover:bg-gray-50 text-gray-700';
                                                            let cellStyle = {};
                                                            
                                                            const isFridayOff = currentDate.getDay() === 5 && (!schedule || schedule.type === 'off');
                                                            const isWorkingDay = !isHoliday && !isWeekend && !(schedule && (schedule.type === 'off' || schedule.type === 'rest' || schedule.type === 'holiday')) && !isFridayOff;

                                                            const isApprovedActualLeave = (function() {
                                                                if (!isWorkingDay) return false;
                                                                const dayStart = new Date(year, month, d, 0, 0, 0);
                                                                const dayEnd = new Date(year, month, d, 23, 59, 59);
                                                                for (const l of userLeaveRequests) {
                                                                    if (l.approvalStatus !== 'approved') continue;
                                                                    let s = l.leaveStartDate ? new Date(String(l.leaveStartDate).replace('T',' ')) : (l.leaveDate ? new Date(l.leaveDate) : null);
                                                                    let e = l.leaveEndDate ? new Date(String(l.leaveEndDate).replace('T',' ')) : (s ? new Date(s) : null);
                                                                    if (!s || !e || isNaN(s) || isNaN(e)) continue;
                                                                    s = new Date(s.getFullYear(), s.getMonth(), s.getDate(), 0, 0, 0);
                                                                    e = new Date(e.getFullYear(), e.getMonth(), e.getDate(), 23, 59, 59);
                                                                    if (s <= dayEnd && e >= dayStart) return true;
                                                                }
                                                                return false;
                                                            })();

                                                            // Determine segments for gradient
                                                            let segments = [];
                                                            if (isHoliday || isWeekend) {
                                                                segments.push({ type: 'holiday', ratio: 1 });
                                                                cellClass = 'bg-gray-100 text-gray-800';
                                                            } else if (schedule && (schedule.type === 'work' || schedule.type === 'duty')) {
                                                                const dayStart = new Date(year, month, d, 0, 0, 0);
                                                                const dayEnd = new Date(year, month, d, 23, 59, 59);
                                                                const [sh, sm] = (schedule.startTime || '09:00').split(':').map(n=>parseInt(n,10));
                                                                const [eh, em] = (schedule.endTime || '17:30').split(':').map(n=>parseInt(n,10));
                                                                const schedStart = new Date(year, month, d, sh||0, sm||0, 0);
                                                                const schedEnd = new Date(year, month, d, eh||0, em||0, 0);
                                                                
                                                                // Find approved leave for this day
                                                                const approvedLeave = (userLeaveRequests || []).find(l => {
                                                                    if (l.approvalStatus !== 'approved') return false;
                                                                    let s = l.leaveStartDate ? new Date(String(l.leaveStartDate).replace('T',' ')) : (l.leaveDate ? new Date(l.leaveDate + (l.leaveTime ? ' ' + l.leaveTime : ' 00:00')) : null);
                                                                    let e = l.leaveEndDate ? new Date(String(l.leaveEndDate).replace('T',' ')) : (s ? new Date(s) : null);
                                                                    if (!s || !e || isNaN(s) || isNaN(e)) return false;
                                                                    s = new Date(s.getFullYear(), s.getMonth(), s.getDate(), s.getHours(), s.getMinutes(), 0);
                                                                    e = new Date(e.getFullYear(), e.getMonth(), e.getDate(), e.getHours(), e.getMinutes(), 0);
                                                                    return s <= dayEnd && e >= dayStart;
                                                                });

                                                                if (approvedLeave) {
                                                                    let ls = approvedLeave.leaveStartDate ? new Date(String(approvedLeave.leaveStartDate).replace('T',' ')) : (approvedLeave.leaveDate ? new Date(approvedLeave.leaveDate + (approvedLeave.leaveTime ? ' ' + approvedLeave.leaveTime : ' 00:00')) : dayStart);
                                                                    let le = approvedLeave.leaveEndDate ? new Date(String(approvedLeave.leaveEndDate).replace('T',' ')) : (approvedLeave.leaveEndDate ? new Date(approvedLeave.leaveEndDate) : dayEnd);
                                                                    ls = new Date(ls.getFullYear(), ls.getMonth(), ls.getDate(), ls.getHours(), ls.getMinutes(), 0);
                                                                    le = new Date(le.getFullYear(), le.getMonth(), le.getDate(), le.getHours(), le.getMinutes(), 0);
                                                                    
                                                                    const clampStart = ls < schedStart ? schedStart : ls;
                                                                    const clampEnd = le > schedEnd ? schedEnd : le;
                                                                    
                                                                    if (clampStart < clampEnd) {
                                                                        // Calculate durations in minutes
                                                                        const totalMins = (schedEnd - schedStart) / 60000;
                                                                        const leaveMins = (clampEnd - clampStart) / 60000;
                                                                        
                                                                        if (clampStart > schedStart) {
                                                                             // Work then Leave
                                                                             const workMins = (clampStart - schedStart) / 60000;
                                                                             segments.push({ type: schedule.type, ratio: workMins / totalMins });
                                                                             segments.push({ type: 'leave', ratio: leaveMins / totalMins });
                                                                             if (clampEnd < schedEnd) {
                                                                                 // Leave then Work (sandwich)
                                                                                 const workMins2 = (schedEnd - clampEnd) / 60000;
                                                                                 segments.push({ type: schedule.type, ratio: workMins2 / totalMins });
                                                                             }
                                                                        } else {
                                                                             // Leave then Work (or full leave)
                                                                             segments.push({ type: 'leave', ratio: leaveMins / totalMins });
                                                                             if (clampEnd < schedEnd) {
                                                                                 const workMins = (schedEnd - clampEnd) / 60000;
                                                                                 segments.push({ type: schedule.type, ratio: workMins / totalMins });
                                                                             }
                                                                        }
                                                                    } else {
                                                                        segments.push({ type: schedule.type, ratio: 1 });
                                                                    }
                                                                } else {
                                                                    segments.push({ type: schedule.type, ratio: 1 });
                                                                }
                                                            } else if (schedule && schedule.type === 'off') {
                                                                segments.push({ type: 'off', ratio: 1 });
                                                            } else {
                                                                // Default or no schedule
                                                                if (isApprovedActualLeave) segments.push({ type: 'leave', ratio: 1 });
                                                            }

                                                            // Apply styles based on segments
                                                            if (segments.length > 0) {
                                                                const colors = {
                                                                    work: 'rgb(219, 234, 254)', // blue-100
                                                                    duty: 'rgb(254, 249, 195)', // yellow-100
                                                                    leave: 'rgb(255, 237, 213)', // orange-100
                                                                    holiday: 'rgb(243, 244, 246)', // gray-100
                                                                    off: 'rgb(87, 83, 78)', // stone-600 (for bg)
                                                                };
                                                                if (segments.length === 1) {
                                                                    if (segments[0].type === 'off') {
                                                                        cellClass = 'bg-stone-500 text-white border border-stone-600';
                                                                    } else if (segments[0].type === 'leave') {
                                                                        cellClass = 'bg-orange-100 text-orange-700 border border-orange-200';
                                                                    } else if (segments[0].type === 'work') {
                                                                        cellClass = 'bg-blue-100 text-blue-700 border border-blue-200';
                                                                    } else if (segments[0].type === 'duty') {
                                                                        cellClass = 'bg-yellow-100 text-yellow-700 border border-yellow-200';
                                                                    } else {
                                                                        cellClass = 'bg-gray-100 text-gray-800';
                                                                    }
                                                                } else {
                                                                    // Gradient
                                                                    let gradientStops = [];
                                                                    let currentPos = 0;
                                                                    segments.forEach(seg => {
                                                                        const color = colors[seg.type] || colors.work;
                                                                        const endPos = currentPos + (seg.ratio * 100);
                                                                        gradientStops.push(`${color} ${currentPos}%`);
                                                                        gradientStops.push(`${color} ${endPos}%`);
                                                                        currentPos = endPos;
                                                                    });
                                                                    cellStyle = { background: `linear-gradient(to bottom, ${gradientStops.join(', ')})` };
                                                                    cellClass = 'text-gray-800 border border-gray-200'; // Base style
                                                                }
                                                            }

                                                            // Selection Ring
                                                            if (cadreScheduleSelectedDate && cadreScheduleSelectedDate.toDateString() === currentDate.toDateString()) {
                                                                cellClass += ' ring-2 ring-blue-600 z-10';
                                                            } else if (isToday) {
                                                                cellClass += ' ring-2 ring-red-600';
                                                            }
                                                                
                                                                days.push(
                                                                    <div 
                                                                        key={d} 
                                                                        onClick={() => {
                                                                            if (!cadreMapSelectedUserId) {
                                                                                alert('請先選擇要排班的帳號');
                                                                                return;
                                                                            }
                                                                            setCadreScheduleSelectedDate(currentDate);
                                                                        }}
                                                                        style={cellStyle}
                                                                        className={`aspect-square flex items-center justify-center rounded-lg text-sm font-bold cursor-pointer transition-all ${cellClass}`}
                                                                    >
                                                                        {d}
                                                                        {(isHoliday || isWeekend) && <span className="absolute text-[9px] mt-6">假日</span>}
                                                                    </div>
                                                                );
                                                            }
                                                            return days;
                                                        })()}
                                                    </div>
                                                    <div className="mt-4 flex flex-wrap gap-2 justify-center">
                                                        <div className="flex items-center gap-1 text-xs text-gray-500">
                                                            <div className="w-3 h-3 rounded bg-blue-100 border border-blue-200"></div> 上班
                                                        </div>
                                                        <div className="flex items-center gap-1 text-xs text-gray-500">
                                                            <div className="w-3 h-3 rounded bg-yellow-100 border border-yellow-200"></div> 值班
                                                        </div>
                                                        <div className="flex items-center gap-1 text-xs text-gray-500">
                                                            <div className="w-3 h-3 rounded bg-orange-100 border border-orange-200"></div> 請假
                                                        </div>
                                                        <div className="flex items-center gap-1 text-xs text-gray-500">
                                                            <div className="w-3 h-3 rounded bg-stone-500 border border-stone-600"></div> 休假
                                                        </div>
                                                    </div>

                                                    <div className="mt-4 flex justify-end items-center gap-4">
                                                        <label className="flex items-center gap-2 cursor-pointer select-none">
                                                            <input 
                                                                type="checkbox" 
                                                                checked={isNightShift} 
                                                                onChange={(e) => setIsNightShift(e.target.checked)}
                                                                className="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300"
                                                            />
                                                            <span className="text-gray-700 font-bold text-sm">夜班人員</span>
                                                        </label>
                                                        <button
                                                            onClick={handleAutoSchedule}
                                                            disabled={scheduleSaving}
                                                            className="px-4 py-2 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 flex items-center gap-2"
                                                        >
                                                            <Calendar className="w-4 h-4" />
                                                            自動排班
                                                        </button>
                                                    </div>
                                                </div>

                                            {/* Detail View Below Calendar */}
                                            {cadreScheduleSelectedDate && cadreMapSelectedUserId && (function() {
                                                const year = cadreScheduleSelectedDate.getFullYear();
                                                const month = cadreScheduleSelectedDate.getMonth();
                                                const date = cadreScheduleSelectedDate.getDate();
                                                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                                                const dayOfWeek = ['日', '一', '二', '三', '四', '五', '六'][cadreScheduleSelectedDate.getDay()];
                                                
                                                const schedule = userSchedules[dateStr];
                                                
                                                // Check for approved leave
                                                const leave = (userLeaveRequests || []).find(l => {
                                                    if (l.approvalStatus !== 'approved') return false;
                                                    let s = l.leaveStartDate ? new Date(String(l.leaveStartDate).replace('T',' ')) : (l.leaveDate ? new Date(l.leaveDate + (l.leaveTime ? ' ' + l.leaveTime : ' 00:00')) : null);
                                                    let e = l.leaveEndDate ? new Date(String(l.leaveEndDate).replace('T',' ')) : (s ? new Date(s) : null);
                                                    if (!s || !e || isNaN(s) || isNaN(e)) return false;
                                                    const dayStart = new Date(year, month, date, 0, 0, 0);
                                                    const dayEnd = new Date(year, month, date, 23, 59, 59);
                                                    s = new Date(s.getFullYear(), s.getMonth(), s.getDate(), s.getHours(), s.getMinutes(), 0);
                                                    e = new Date(e.getFullYear(), e.getMonth(), e.getDate(), e.getHours(), e.getMinutes(), 0);
                                                    return s <= dayEnd && e >= dayStart;
                                                });
                                                
                                                const isHoliday = ['2026-01-01','2026-02-14','2026-02-15','2026-02-16','2026-02-17','2026-02-18','2026-02-19','2026-02-20','2026-02-21','2026-02-22','2026-02-27','2026-02-28','2026-03-01','2026-04-03','2026-04-04','2026-04-05','2026-04-06','2026-05-01','2026-06-19','2026-06-20','2026-06-21','2026-09-25','2026-09-26','2026-09-27','2026-10-09','2026-10-10','2026-10-11','2026-12-25'].includes(dateStr);
                                                const isWeekend = cadreScheduleSelectedDate.getDay() === 0 || cadreScheduleSelectedDate.getDay() === 6;

                                                return (
                                                    <div className="mt-4 bg-white rounded-2xl shadow-sm border border-gray-100 p-4 animate-fadeIn">
                                                        <div className="flex items-center justify-between mb-3">
                                                            <h3 className="font-bold text-gray-800 text-lg flex items-center gap-2">
                                                                <Calendar className="w-5 h-5 text-blue-600" />
                                                                {year}年{month+1}月{date}日 (星期{dayOfWeek})
                                                            </h3>
                                                            <button 
                                                                onClick={() => {
                                                                    setScheduleModalDate(dateStr);
                                                                    if (leave) {
                                                                        setScheduleForm({ type: 'leave' });
                                                                    } else if (schedule) {
                                                                        setScheduleForm({
                                                                            type: schedule.type,
                                                                            startTime: schedule.startTime || '09:00',
                                                                            endTime: schedule.endTime || '17:30',
                                                                            crossDay: schedule.crossDay || false
                                                                        });
                                                                    } else if (isHoliday || isWeekend) {
                                                                        setScheduleForm({ type: 'holiday' });
                                                                    } else {
                                                                        setScheduleForm({ type: 'work', startTime: '09:00', endTime: '17:30', crossDay: false });
                                                                    }
                                                                    setShowScheduleModal(true);
                                                                }}
                                                                className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700 transition-colors shadow-sm"
                                                            >
                                                                編輯排班
                                                            </button>
                                                        </div>
                                                        
                                                        <div className="space-y-3">
                                                            {/* Schedule Info */}
                                                            <div className="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                                                <div className="text-xs font-bold text-gray-400 mb-2">排班內容</div>
                                                                {schedule ? (
                                                                    <div className="flex items-center gap-4">
                                                                        <div className={`px-3 py-1 rounded-lg text-sm font-bold ${
                                                                            schedule.type === 'work' ? 'bg-blue-100 text-blue-700' :
                                                                            schedule.type === 'duty' ? 'bg-yellow-100 text-yellow-700' :
                                                                            schedule.type === 'off' ? 'bg-stone-500 text-white' : 'bg-gray-200 text-gray-700'
                                                                        }`}>
                                                                            {schedule.type === 'work' ? '上班' : schedule.type === 'duty' ? '值班' : schedule.type === 'off' ? '休假' : '其他'}
                                                                        </div>
                                                                        {schedule.type !== 'off' && (
                                                                            <div className="font-mono font-bold text-gray-700 text-lg">
                                                                                {schedule.startTime} ~ {schedule.endTime}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                ) : (isHoliday || isWeekend) ? (
                                                                    <div className="text-sm font-bold text-gray-500">假日</div>
                                                                ) : (
                                                                <div className="text-sm text-gray-400">尚無排班</div>
                                                                )}
                                                            </div>
                                                            {(function(){
                                                                const dayStart = new Date(year, month, date, 0, 0, 0);
                                                                const dayEnd = new Date(year, month, date, 23, 59, 59);
                                                                const dayRecords = (attendanceList || []).filter(r => {
                                                                    if (String(r.userId) !== String(cadreMapSelectedUserId)) return false;
                                                                    let seconds;
                                                                    if (r.checkInTime) {
                                                                        const t = new Date(r.checkInTime);
                                                                        seconds = isNaN(t) ? (r.timestamp?.seconds || (Date.now()/1000)) : (t.getTime()/1000);
                                                                    } else if (r.timestamp?.seconds) {
                                                                        seconds = r.timestamp.seconds;
                                                                    } else if (r.timestamp instanceof Date) {
                                                                        seconds = Math.floor(r.timestamp.getTime() / 1000);
                                                                    } else if (r.createdAt?.seconds) {
                                                                        seconds = r.createdAt.seconds;
                                                                    } else {
                                                                        seconds = Date.now() / 1000;
                                                                    }
                                                                    const dt = new Date(seconds * 1000);
                                                                    return dt >= dayStart && dt <= dayEnd;
                                                                }).filter(r => r.type === 'in' || r.type === 'out').sort((a, b) => {
                                                                    const sa = (a.timestamp?.seconds) || (a.createdAt?.seconds) || (Date.now()/1000);
                                                                    const sb = (b.timestamp?.seconds) || (b.createdAt?.seconds) || (Date.now()/1000);
                                                                    return sa - sb;
                                                                });
                                                                return (
                                                                    <div className="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                                                        <div className="text-xs font-bold text-gray-400 mb-2">本日打卡紀錄</div>
                                                                        {dayRecords.length === 0 ? (
                                                                            <div className="text-sm text-gray-400">尚無打卡</div>
                                                                        ) : (
                                                                            <div className="space-y-2">
                                                                                {dayRecords.map(r => {
                                                                                    let seconds;
                                                                                    if (r.checkInTime) {
                                                                                        const t = new Date(r.checkInTime);
                                                                                        seconds = isNaN(t) ? (r.timestamp?.seconds || (Date.now()/1000)) : (t.getTime()/1000);
                                                                                    } else if (r.timestamp?.seconds) {
                                                                                        seconds = r.timestamp.seconds;
                                                                                    } else if (r.timestamp instanceof Date) {
                                                                                        seconds = Math.floor(r.timestamp.getTime() / 1000);
                                                                                    } else if (r.createdAt?.seconds) {
                                                                                        seconds = r.createdAt.seconds;
                                                                                    } else {
                                                                                        seconds = Date.now() / 1000;
                                                                                    }
                                                                                    const timeStr = new Date(seconds * 1000).toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                                                                                    const isIn = r.type === 'in';
                                                                                    return (
                                                                                        <div key={r.id} className="flex items-center gap-3">
                                                                                            <div className={`px-2 py-0.5 rounded-full text-[10px] font-bold ${isIn ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                                                                {isIn ? '上班' : '下班'}
                                                                                            </div>
                                                                                            <div className="font-mono font-bold text-gray-700">
                                                                                                {timeStr}
                                                                                            </div>
                                                                                        </div>
                                                                                    );
                                                                                })}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                );
                                                            })()}

                                                            {/* Leave Info */}
                                                            {leave && (
                                                                <div className="bg-orange-50 p-3 rounded-xl border border-orange-100">
                                                                    <div className="text-xs font-bold text-orange-400 mb-2">請假紀錄</div>
                                                                    <div className="flex items-center justify-between">
                                                                        <div>
                                                                            <div className="font-bold text-orange-700 text-lg mb-1">
                                                                                {leave.leaveReason || '請假'}
                                                                            </div>
                                                                            <div className="text-xs text-orange-600 font-mono">
                                                                                {leave.leaveStartDate ? 
                                                                                    `${leave.leaveStartDate.split('T')[1].substring(0,5)} ~ ${leave.leaveEndDate.split('T')[1].substring(0,5)}` : 
                                                                                    `${leave.leaveTime} (全日)`}
                                                                            </div>
                                                                        </div>
                                                                        <span className="px-2 py-1 bg-white bg-opacity-50 rounded text-xs text-orange-600 font-bold border border-orange-200">
                                                                            已核准
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })()}
                                        </div>
                                    )}
                                    {cadreSubtab === 'approval' && hasSubPermission('cadre', 'approval') && (
                                        <div>


                                            <div className="space-y-3 pb-24">
                                                {(function() {
                                                    const targetCompany = companies.find(c => c.name === cadreCompany);
                                                    if (!targetCompany) return <div className="text-center text-gray-400 py-8">請選擇公司</div>;

                                                    // Filter signatures by company users
                                                    const companyUserIds = usersList
                                                        .filter(u => (u.companyIds && u.companyIds.some(cid => String(cid) === String(targetCompany.id))) || String(u.companyId) === String(targetCompany.id))
                                                        .map(u => u.id);

                                                    const displaySignatures = cadreSignatures.filter(s => {
                                                        if (!companyUserIds.includes(s.userId)) return false;
                                                        


                                                        return true;
                                                    });
                                                    
                                                    if (displaySignatures.length === 0) {
                                                        return (
                                                            <div className="text-center py-12 text-gray-400 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-200">
                                                                尚無簽呈申請
                                                            </div>
                                                        );
                                                    }

                                                    return displaySignatures.map(sig => {
                                                        const user = usersList.find(u => u.id === sig.userId) || {};
                                                        return (
                                                            <div key={sig.id} className="p-4 bg-white border border-gray-100 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                                                                <div className="flex justify-between items-start mb-3">
                                                                    <div className="flex items-center gap-3">
                                                                        <div className="w-10 h-10 rounded-full bg-gray-200 overflow-hidden">
                                                                            {user.avatarUrl ? <img src={user.avatarUrl} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center font-bold text-gray-500">{user.name?.[0]}</div>}
                                                                        </div>
                                                                        <div>
                                                                            <div className="font-bold text-gray-800 text-sm flex items-center gap-2">
                                                                                {user.name}
                                                                                <span className="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">{signatureTypeMap[sig.type] || sig.type}</span>
                                                                            </div>
                                                                            <div className="text-xs text-gray-400">
                                                                                {sig.createdAt?.seconds ? new Date(sig.createdAt.seconds * 1000).toLocaleString('zh-TW') : ''}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <span className={`text-xs px-2 py-1 rounded-lg font-bold flex items-center gap-1 ${
                                                                        sig.status === 'approved' ? 'bg-green-100 text-green-700' :
                                                                        sig.status === 'rejected' ? 'bg-red-100 text-red-700' :
                                                                        'bg-yellow-100 text-yellow-700'
                                                                    }`}>
                                                                        {sig.status === 'approved' ? (
                                                                            (sig.type && (sig.type.includes('請假') || sig.type.includes('leave'))) ? (
                                                                                <>
                                                                                    請假
                                                                                    <span className="text-[9px] bg-white bg-opacity-50 px-1 rounded ml-1">已核准</span>
                                                                                </>
                                                                            ) : '已核准'
                                                                        ) : sig.status === 'rejected' ? '已駁回' : '待簽核'}
                                                                    </span>
                                                                </div>
                                                                
                                                                <div className="bg-gray-50 p-3 rounded-lg text-sm text-gray-700 mb-4 whitespace-pre-wrap">
                                                                    {sig.content}
                                                                </div>

                                                                {sig.status === 'pending' && (
                                                                    <div className="flex gap-3 border-t border-gray-100 pt-3">
                                                                        <button 
                                                                            onClick={() => handleUpdateSignatureStatus(sig.id, 'rejected')}
                                                                            className="flex-1 py-2 bg-white border border-gray-200 text-gray-700 rounded-lg text-sm font-bold hover:bg-gray-50 transition-colors"
                                                                        >
                                                                            拒絕
                                                                        </button>
                                                                        <button 
                                                                            onClick={() => handleUpdateSignatureStatus(sig.id, 'approved')}
                                                                            className="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-bold hover:bg-gray-200 transition-colors"
                                                                        >
                                                                            核准
                                                                        </button>
                                                                    </div>
                                                                )}
                                                                
                                                                {sig.status !== 'pending' && sig.reviewedBy && (
                                                                    <>
                                                                        <div className="flex gap-3 border-t border-gray-100 pt-3">
                                                                            <button 
                                                                                onClick={() => handleResetSignature(sig.id)}
                                                                                className="flex-1 py-2 bg-yellow-50 text-yellow-700 rounded-lg text-xs font-bold hover:bg-yellow-100 transition-colors"
                                                                            >
                                                                                重新審核
                                                                            </button>
                                                                            <button 
                                                                                onClick={() => requestDeleteSignature(sig)}
                                                                                className="flex-1 py-2 bg-red-50 text-red-600 rounded-lg text-xs font-bold hover:bg-red-100 transition-colors"
                                                                            >
                                                                                刪除
                                                                            </button>
                                                                        </div>
                                                                        <div className="text-right text-xs text-gray-400 mt-2">
                                                                            審核人: {usersList.find(u => u.id === sig.reviewedBy)?.name || '未知'}
                                                                        </div>
                                                                    </>
                                                                )}
                                                            </div>
                                                        );
                                                    });
                                                })()}
                                            </div>
                                        </div>
                                    )}
                                    {cadreSubtab === 'account' && hasSubPermission('cadre', 'account') && (
                                        <div>
                                            

                                            
                                            {cadreMapSelectedUserId && (
                                                <div className="mb-4 flex items-center justify-between bg-blue-50 p-3 rounded-xl text-blue-700 text-sm">
                                                    <div className="flex items-center gap-2">
                                                        <Users className="w-4 h-4" />
                                                        <span>已篩選人員: <span className="font-bold">{usersList.find(u => u.id === cadreMapSelectedUserId)?.name || '未知'}</span></span>
                                                    </div>
                                                    <button 
                                                        onClick={() => setCadreMapSelectedUserId(null)}
                                                        className="px-3 py-1 bg-white border border-blue-200 rounded-lg text-xs font-bold hover:bg-blue-50 transition shadow-sm"
                                                    >
                                                        清除篩選
                                                    </button>
                                                </div>
                                            )}

                                            <div className="space-y-3">
                                                {(function() {
                                                    const targetCompany = companies.find(c => c.name === cadreCompany);
                                                    if (!targetCompany) return <div className="text-center text-gray-400">請選擇公司</div>;

                                                    // Filter: Company - Show all users EXCEPT excluded roles
                                                    const excludedRoles = ['manager', 'secretary', 'cleaner', 'mechanic', 'guard'];
                                                    
                                                    const filteredUsers = usersList.filter(u => {
                                                        const inCompany = ((u.companyIds && u.companyIds.some(cid => String(cid) === String(targetCompany.id))) || String(u.companyId) === String(targetCompany.id));
                                                        if (!inCompany) return false;
                                                        if (excludedRoles.includes(u.role)) return false;
                                                        if (cadreMapSelectedUserId && u.id !== cadreMapSelectedUserId) return false;



                                                        return true;
                                                    }).sort((a, b) => {
                                                        const getRolePriority = (u) => {
                                                            if (u.role === 'admin') return 1;
                                                            const rName = roles.find(r => r.id === u.role)?.name;
                                                            if (rName === '管理層') return 2;
                                                            if (rName === '人事') return 3;
                                                            if (rName === '幹部') return 4;
                                                            if (rName === '員工') return 5;
                                                            return 99;
                                                        };
                                                        return getRolePriority(a) - getRolePriority(b);
                                                    });

                                                    if (filteredUsers.length === 0) return <div className="text-center text-gray-400">尚無符合條件的帳號</div>;

                                                    return filteredUsers.map(u => (
                                                        <div key={u.id} className="p-3 bg-gray-50 rounded-2xl flex items-center gap-3">
                                                            <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-600 overflow-hidden">
                                                                {u.avatarUrl ? <img src={u.avatarUrl} className="w-full h-full object-cover" /> : (u.name?.[0] || '?')}
                                                            </div>
                                                            <div className="flex-1">
                                                                <div className="font-bold text-gray-800 flex items-center gap-2">
                                                                    {u.name}
                                                                    <span className={`text-xs px-2 py-0.5 rounded-full ${u.role === 'admin' ? 'bg-purple-100 text-purple-600' : 'bg-red-100 text-red-600'}`}>
                                                                        {u.role === 'admin' ? '系統管理員' : (roles.find(r => r.id === u.role)?.name || u.role)}
                                                                    </span>
                                                                    {u.status === '離職' ? (
                                                                        <span className="text-xs px-2 py-0.5 rounded-full bg-gray-200 text-gray-600">離職</span>
                                                                    ) : (
                                                                        <span className="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-600">在職</span>
                                                                    )}
                                                                </div>
                                                                <div className="text-xs text-gray-500">{u.title || '未設定職稱'}</div>
                                                                <div className="flex gap-2 mt-1 text-[10px] text-gray-400">
                                                                    {u.startDate && <span>入: {u.startDate}</span>}
                                                                    {u.resignDate && <span>離: {u.resignDate}</span>}
                                                                </div>
                                                            </div>
                                                            <div className="text-right text-xs text-gray-500 flex flex-col items-end gap-1">
                                                                <div>{u.email}</div>
                                                                <div>{u.phone}</div>
                                                                <div className="flex gap-2 mt-1">
                                                                    {u.role !== 'admin' && (
                                                                        <>
                                                                            <button 
                                                                                onClick={() => handleEditUserClick(u)}
                                                                                className="px-2 py-1 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-100 transition-colors"
                                                                            >
                                                                                編輯
                                                                            </button>
                                                                            <button 
                                                                                onClick={() => handleDeleteUser(u.id)}
                                                                                className="px-2 py-1 bg-red-50 text-red-600 rounded-lg text-xs font-bold hover:bg-red-100 transition-colors"
                                                                            >
                                                                                刪除
                                                                            </button>
                                                                        </>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ));
                                                })()}
                                            </div>
                                        </div>
                                    )}
                                    {cadreSubtab === 'notification' && hasSubPermission('cadre', 'notification') && (
                                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="text-lg font-bold text-gray-800 flex items-center">
                                                    <Bell className="w-5 h-5 mr-2 text-red-600" /> 通知列表
                                                </h3>
                                                <button 
                                                    onClick={() => setShowNotificationModal(true)}
                                                    className="px-3 py-1.5 bg-red-50 text-red-600 text-xs font-bold rounded-lg hover:bg-red-100 transition-colors"
                                                >
                                                    + 新增
                                                </button>
                                            </div>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-left text-sm">
                                                    <thead className="bg-gray-50 text-gray-500 border-b">
                                                        <tr>
                                                            <th className="px-4 py-3 font-bold whitespace-nowrap">日期時間</th>
                                                            <th className="px-4 py-3 font-bold whitespace-nowrap">通知對象</th>
                                                            <th className="px-4 py-3 font-bold whitespace-nowrap">通知內容</th>
                                                            <th className="px-4 py-3 font-bold whitespace-nowrap">通知人</th>
                                                            <th className="px-4 py-3 font-bold whitespace-nowrap">操作</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y text-gray-600">
                                                        {notifications.length === 0 ? (
                                                            <tr>
                                                                <td colSpan="5" className="px-4 py-8 text-center text-gray-400">
                                                                    尚無通知紀錄
                                                                </td>
                                                            </tr>
                                                        ) : (
                                                            notifications.map(notif => (
                                                                <tr key={notif.id} className="hover:bg-gray-50">
                                                                    <td className="px-4 py-3 whitespace-nowrap text-xs">
                                                                        {notif.createdAt?.seconds ? new Date(notif.createdAt.seconds * 1000).toLocaleString('zh-TW') : ''}
                                                                    </td>
                                                                    <td className="px-4 py-3 whitespace-nowrap font-bold text-gray-800">{notif.target}</td>
                                                                    <td className="px-4 py-3 min-w-[200px]">{notif.content}</td>
                                                                    <td className="px-4 py-3 whitespace-nowrap text-xs">{notif.senderName}</td>
                                                                    <td className="px-4 py-3 whitespace-nowrap">
                                                                        <div className="flex items-center gap-1">
                                                                            <button 
                                                                                onClick={() => handleEditNotification(notif)}
                                                                                className="p-1.5 text-blue-500 hover:bg-blue-50 rounded-lg transition-colors"
                                                                                title="編輯"
                                                                            >
                                                                                <Edit className="w-4 h-4" />
                                                                            </button>
                                                                            <button 
                                                                                onClick={() => handleDeleteNotification(notif.id)}
                                                                                className="p-1.5 text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                                                                                title="刪除"
                                                                            >
                                                                                <Trash2 className="w-4 h-4" />
                                                                            </button>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            ))
                                                        )}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}
                                    {cadreSubtab === 'report' && hasSubPermission('cadre', 'report') && (
                                        <>
                                            {cadreMapSelectedUserId && (
                                                <div className="mb-4 flex items-center justify-between bg-blue-50 p-3 rounded-xl text-blue-700 text-sm">
                                                    <div className="flex items-center gap-2">
                                                        <Users className="w-4 h-4" />
                                                        <span>已篩選人員: <span className="font-bold">{usersList.find(u => u.id === cadreMapSelectedUserId)?.name || '未知'}</span></span>
                                                    </div>
                                                    <button 
                                                        onClick={() => setCadreMapSelectedUserId(null)}
                                                        className="px-3 py-1 bg-white border border-blue-200 rounded-lg text-xs font-bold hover:bg-blue-50 transition shadow-sm"
                                                    >
                                                        清除篩選
                                                    </button>
                                                </div>
                                            )}
                                            <div className="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar flex-nowrap whitespace-nowrap">
                                                {cadreMapSelectedUserId ? (
                                                    <>
                                                        <button onClick={() => setReportModalType('attendance')} className="px-3 py-2 bg-red-50 text-red-600 rounded-2xl text-xs font-bold min-w-[60px]">出勤</button>
                                                        <button onClick={() => setReportModalType('outing')} className="px-3 py-2 bg-red-50 text-red-600 rounded-2xl text-xs font-bold min-w-[60px]">外出</button>
                                                        <button onClick={() => setReportModalType('duty')} className="px-3 py-2 bg-red-50 text-red-600 rounded-2xl text-xs font-bold min-w-[60px]">卡班</button>
                                                        <button onClick={() => setReportModalType('leave')} className="px-3 py-2 bg-red-50 text-red-600 rounded-2xl text-xs font-bold min-w-[60px]">請假</button>
                                                    </>
                                                ) : (
                                                    <button onClick={() => setReportModalType('attendance')} className="px-3 py-2 bg-red-50 text-red-600 rounded-2xl text-xs font-bold min-w-[60px]">報表</button>
                                                )}
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'application' && hasPermission('application') && (
                            <div className="space-y-6">
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                    {applicationSubtab === 'signature' && hasSubPermission('application', 'signature') && (
                                        <div>
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="text-lg font-bold text-gray-800 flex items-center">
                                                    <FileText className="w-5 h-5 mr-2 text-red-600" /> 電子簽呈
                                                </h3>
                                                <button 
                                                    onClick={() => {
                                                        setSignatureError('');
                                                        const defaultType = (signatureTypes && signatureTypes.length > 0) ? signatureTypes[0].name : '請假申請';
                                                        setSignatureForm({ type: defaultType, content: '' });
                                                        setSignatureEditTarget(null);
                                                        setShowSignatureModal(true);
                                                    }}
                                                    className="px-3 py-1.5 bg-red-50 text-red-600 text-xs font-bold rounded-lg hover:bg-red-100 transition-colors"
                                                >
                                                    + 新增
                                                </button>
                                            </div>
                                            
                                            <div className="space-y-3">
                                                {signatures.length === 0 ? (
                                                    <div className="text-center py-8 text-gray-400">尚無簽呈紀錄</div>
                                                ) : (
                                                    signatures.map(sig => (
                                                        <div key={sig.id} className="p-3 bg-white border rounded-2xl shadow-sm flex items-start gap-3 border-gray-100 hover:shadow-sm transition-shadow">
                                                            <div className="w-10 h-10 rounded-full bg-gray-200 flex-shrink-0 overflow-hidden border border-gray-100">
                                                                {sig.userAvatar ? (
                                                                    <img src={sig.userAvatar} className="w-full h-full object-cover" />
                                                                ) : (
                                                                    <div className="w-full h-full flex items-center justify-center font-bold text-gray-500">{sig.userName?.[0]}</div>
                                                                )}
                                                            </div>
                                                            <div className="flex-1 min-w-0">
                                                                <div className="flex justify-between items-center">
                                                                    <div>
                                                                        <div className="font-bold text-gray-800 flex items-center gap-2">
                                                                            {sig.userName}
                                                                            <span className={`text-[10px] px-1.5 py-0.5 rounded-lg flex items-center gap-1 ${
                                                                                sig.status === 'approved' ? 'bg-green-100 text-green-700' :
                                                                                sig.status === 'rejected' ? 'bg-red-100 text-red-700' :
                                                                                'bg-yellow-100 text-yellow-700'
                                                                            }`}>
                                                                                {sig.status === 'approved' ? (
                                                                                    (sig.type && (sig.type.includes('請假') || sig.type.includes('leave'))) ? (
                                                                                        <>
                                                                                            請假
                                                                                            <span className="text-[9px] bg-white bg-opacity-50 px-1 rounded ml-1">已核准</span>
                                                                                        </>
                                                                                    ) : '已核准'
                                                                                ) : sig.status === 'rejected' ? '已駁回' : '待簽核'}
                                                                            </span>
                                                                        </div>
                                                                        <div className="text-sm text-gray-500 mt-0.5 flex items-center gap-1">
                                                                            <span className="text-xs font-bold text-gray-700">{signatureTypeMap[sig.type] || sig.type}</span>
                                                                        </div>
                                                                        <div className="text-[10px] text-gray-400 mt-0.5">
                                                                            {sig.createdAt?.seconds ? new Date(sig.createdAt.seconds * 1000).toLocaleDateString('zh-TW') : ''}
                                                                        </div>
                                                                    </div>
                                                                    <div className="flex gap-2">
                                                                        <div className="flex flex-col gap-2">
                                                                            {sig.status === 'pending' ? (
                                                                                <button 
                                                                                    onClick={() => openEditSignature(sig)} 
                                                                                    className="w-12 h-12 rounded-lg bg-blue-50 text-blue-500 flex items-center justify-center border border-blue-100 hover:opacity-90 transition-opacity"
                                                                                    title="編輯"
                                                                                >
                                                                                    <Edit className="w-5 h-5" />
                                                                                </button>
                                                                            ) : <div className="w-12 h-12"></div>}
                                                                        </div>
                                                                        <div className="flex flex-col gap-2">
                                                                            <button 
                                                                                onClick={(e) => {
                                                                                    if (sig.status === 'approved') return;
                                                                                    e.stopPropagation();
                                                                                    requestDeleteSignature(sig);
                                                                                }}
                                                                                disabled={sig.status === 'approved'}
                                                                                className={`w-12 h-12 rounded-lg flex items-center justify-center border transition-opacity ${
                                                                                    sig.status === 'approved' 
                                                                                        ? 'bg-gray-50 text-gray-500 border-gray-100 opacity-50 cursor-not-allowed' 
                                                                                        : 'bg-red-50 text-red-500 border-red-100 hover:opacity-90'
                                                                                }`}
                                                                                title="刪除"
                                                                            >
                                                                                <Trash2 className="w-5 h-5" />
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <p className="text-sm text-gray-600 mt-2 whitespace-pre-wrap line-clamp-3">{sig.content}</p>
                                                            </div>
                                                        </div>
                                                    ))
                                                )}
                                            </div>
                                        </div>
                                    )}
                                    {applicationSubtab === 'equipment' && hasSubPermission('application', 'equipment') && (
                                        <div>
                                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                <FileText className="w-5 h-5 mr-2 text-red-600" /> 設備申請
                                            </h3>
                                            <div className="text-center py-8 text-gray-400">
                                                尚無設備申請紀錄
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {dbUser && activeTab === 'settings' && hasPermission('settings') && (
                            <div className="space-y-6">
                                <AdminDashboard 
                                    user={user}
                                    currentUser={dbUser} 
                                    users={usersList} 
                                    communities={communities}
                                    roles={roles}
                                    companies={companies}
                                    areas={areas}
                                    signatureTypes={signatureTypes}
                                    pages={availablePages}
                                    onAddUser={handleAddUser}
                                    onAddCommunity={handleAddCommunity}
                                    subtab={settingsSubtab}
                                    setActiveTab={setActiveTab}
                                    setCadreSubtab={setCadreSubtab}
                                    setCadreMapSelectedUserId={setCadreMapSelectedUserId}
                                    subPagesMap={subPagesMap}
                                    hasSubPermission={hasSubPermission}
                                />
                            </div>
                        )}
                        </div>
                    </main>

                    {/* Overview Meeting Company Selection Bar - Only visible on Overview / District */}
                    {activeTab === 'overview' && overviewSubtab === 'district' && (
                        <div className="fixed bottom-[8vh] left-0 right-0 z-40 bg-white bg-opacity-80 border-t border-gray-100 shadow-lg transform transition-transform duration-300">
                            <div className="max-w-md mx-auto px-4 py-3 flex items-center justify-center gap-3">
                                <div className="flex gap-2">
                                    {['台北公司', '桃園公司'].map(name => {
                                        const len = name.length;
                                        let displayName = name;
                                        if (len === 4) {
                                            displayName = <>{name.slice(0, 2)}<br/>{name.slice(2)}</>;
                                        } else if (len === 5) {
                                            displayName = <>{name.slice(0, 2)}<br/>{name.slice(2)}</>;
                                        } else if (len === 6) {
                                            displayName = <>{name.slice(0, 3)}<br/>{name.slice(3)}</>;
                                        }

                                        return (
                                            <button 
                                                key={name}
                                                onClick={() => handleOverviewCompanyChange(name)}
                                                className={`w-[40px] h-[40px] flex items-center justify-center text-xs leading-tight font-bold rounded-2xl transition-colors shadow-md ${
                                                    overviewCompany === name 
                                                        ? 'bg-red-600 text-white' 
                                                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                }`}
                                            >
                                                {displayName}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Overview District Meeting Company Selection Bar */}
                    {activeTab === 'overview' && overviewSubtab === 'district_meeting' && (
                        <div className="fixed bottom-[8vh] left-0 right-0 z-40 bg-white bg-opacity-80 border-t border-gray-100 shadow-lg transform transition-transform duration-300">
                            <div className="max-w-md mx-auto px-4 py-3 flex items-center justify-center gap-3">
                                <div className="flex gap-2">
                                    {['台北公司', '桃園公司'].map(name => {
                                        const len = name.length;
                                        let displayName = name;
                                        if (len === 4) {
                                            displayName = <>{name.slice(0, 2)}<br/>{name.slice(2)}</>;
                                        } else if (len === 5) {
                                            displayName = <>{name.slice(0, 2)}<br/>{name.slice(2)}</>;
                                        } else if (len === 6) {
                                            displayName = <>{name.slice(0, 3)}<br/>{name.slice(3)}</>;
                                        }

                                        return (
                                            <button 
                                                key={name}
                                                onClick={() => handleOverviewCompanyChange(name)}
                                                className={`w-[40px] h-[40px] flex items-center justify-center text-xs leading-tight font-bold rounded-2xl transition-colors shadow-md ${
                                                    overviewCompany === name 
                                                        ? 'bg-red-600 text-white' 
                                                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                }`}
                                            >
                                                {displayName}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Overview Activity Company Selection Bar */}
                    {activeTab === 'overview' && overviewSubtab === 'activity' && (
                        <div className="fixed bottom-[8vh] left-0 right-0 z-40 bg-white bg-opacity-80 border-t border-gray-100 shadow-lg transform transition-transform duration-300">
                            <div className="max-w-md mx-auto px-4 py-3 flex items-center justify-center gap-3">
                                <div className="flex gap-2">
                                    {['台北公司', '桃園公司'].map(name => {
                                        const len = name.length;
                                        let displayName = name;
                                        if (len === 4) {
                                            displayName = <>{name.slice(0, 2)}<br/>{name.slice(2)}</>;
                                        } else if (len === 5) {
                                            displayName = <>{name.slice(0, 2)}<br/>{name.slice(2)}</>;
                                        } else if (len === 6) {
                                            displayName = <>{name.slice(0, 3)}<br/>{name.slice(3)}</>;
                                        }

                                        return (
                                            <button 
                                                key={name}
                                                onClick={() => handleOverviewCompanyChange(name)}
                                                className={`w-[40px] h-[40px] flex items-center justify-center text-xs leading-tight font-bold rounded-2xl transition-colors shadow-md ${
                                                    overviewCompany === name 
                                                        ? 'bg-red-600 text-white' 
                                                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                }`}
                                            >
                                                {displayName}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Overview Presentation Company Selection Bar */}
                    {activeTab === 'overview' && overviewSubtab === 'presentation' && (
                        <div className="fixed bottom-[8vh] left-0 right-0 z-40 bg-white bg-opacity-80 border-t border-gray-100 shadow-lg transform transition-transform duration-300">
                            <div className="max-w-md mx-auto px-4 py-3 flex items-center justify-center gap-3">
                                <div className="flex gap-2">
                                    {['台北公司', '桃園公司'].map(name => {
                                        const len = name.length;
                                        let displayName = name;
                                        if (len === 4) {
                                            displayName = <>{name.slice(0, 2)}<br/>{name.slice(2)}</>;
                                        } else if (len === 5) {
                                            displayName = <>{name.slice(0, 2)}<br/>{name.slice(2)}</>;
                                        } else if (len === 6) {
                                            displayName = <>{name.slice(0, 3)}<br/>{name.slice(3)}</>;
                                        }

                                        return (
                                            <button 
                                                key={name}
                                                onClick={() => handleOverviewCompanyChange(name)}
                                                className={`w-[40px] h-[40px] flex items-center justify-center text-xs leading-tight font-bold rounded-2xl transition-colors shadow-md ${
                                                    overviewCompany === name 
                                                        ? 'bg-red-600 text-white' 
                                                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                }`}
                                            >
                                                {displayName}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Cadre Company Selection Bar - Only visible on Cadre tab */}
                    {activeTab === 'cadre' && (
                        <div className="fixed bottom-[8vh] left-0 right-0 z-40 bg-white bg-opacity-80 border-t border-gray-100 shadow-lg transform transition-transform duration-300">
                            <div className="max-w-md mx-auto px-4 py-3 flex items-center justify-center gap-3">
                                <div className="flex gap-2">
                                    {[...companies].sort((a, b) => {
                                        const order = ['台北公司', '桃園公司'];
                                        const idxA = order.indexOf(a.name);
                                        const idxB = order.indexOf(b.name);
                                        if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                                        if (idxA !== -1) return -1;
                                        if (idxB !== -1) return 1;
                                        return a.name.localeCompare(b.name);
                                    }).map(company => {
                                        const name = company.name || '';
                                        const len = name.length;
                                        let displayName = name;
                                        
                                        if (len === 4) {
                                            displayName = <>{name.slice(0, 2)}<br/>{name.slice(2)}</>;
                                        } else if (len === 5) {
                                            displayName = <>{name.slice(0, 2)}<br/>{name.slice(2)}</>;
                                        } else if (len === 6) {
                                            displayName = <>{name.slice(0, 3)}<br/>{name.slice(3)}</>;
                                        }

                                        return (
                                            <button 
                                                key={company.id}
                                                onClick={() => {
                                                    setCadreCompany(name);
                                                    setCadreMapSelectedUserId(null);
                                                }}
                                                className={`w-[40px] h-[40px] flex items-center justify-center text-xs leading-tight font-bold rounded-2xl transition-colors shadow-md ${
                                                    cadreCompany === name 
                                                        ? 'bg-red-600 text-white' 
                                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                                }`}
                                            >
                                                {displayName}
                                            </button>
                                        );
                                    })}
                                    {companies.length === 0 && (
                                        <div className="text-xs text-gray-400 italic">尚無公司資料</div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="fixed bottom-0 left-0 right-0 z-50 h-[8vh] bg-white border-t border-gray-100">
                        <div className="max-w-md mx-auto h-full px-4 flex items-center">
                            {hasPermission('home') && (
                                <div className="flex-1 flex justify-center">
                                    <button
                                        onClick={() => switchTab('home')}
                                        className={`flex flex-col items-center font-bold text-xs ${activeTab === 'home' ? 'text-red-600' : 'text-gray-600'}`}
                                    >
                                        <Home className="w-5 h-5 mb-1" /> 首頁
                                    </button>
                                </div>
                            )}
                            {hasPermission('overview') && (
                                <div className="flex-1 flex justify-center">
                                    <button
                                        onClick={() => switchTab('overview')}
                                        className={`relative flex flex-col items-center font-bold text-xs ${activeTab === 'overview' ? 'text-red-600' : 'text-gray-600'}`}
                                    >
                                        <BarChart3 className="w-5 h-5 mb-1" /> 總覽
                                        {(function() {
                                            const count = (typeof getOverviewMeetingBadgeCount === 'function' ? getOverviewMeetingBadgeCount() : 0) + 
                                                          (typeof getOverviewDistrictMeetingBadgeCount === 'function' ? getOverviewDistrictMeetingBadgeCount() : 0) + 
                                                          (typeof getOverviewActivityBadgeCount === 'function' ? getOverviewActivityBadgeCount() : 0) + 
                                                          (typeof getOverviewPresentationBadgeCount === 'function' ? getOverviewPresentationBadgeCount() : 0) +
                                                          (notifications ? notifications.filter(n => isNotificationTarget(n) && !(n.readBy || []).includes(dbUser?.id)).length : 0);
                                            if (count > 0) {
                                                return (
                                                    <span className="absolute top-0 right-0 w-2 h-2 rounded-full bg-blue-500"></span>
                                                );
                                            }
                                            return null;
                                        })()}
                                    </button>
                                </div>
                            )}
                            {hasPermission('clock') && (
                                <div className="flex-1 flex justify-center">
                                    <button
                                        onClick={() => switchTab('clock')}
                                        className={`flex flex-col items-center font-bold text-xs ${activeTab === 'clock' ? 'text-red-600' : 'text-gray-600'}`}
                                    >
                                        <ClipboardList className="w-5 h-5 mb-1" /> 打卡
                                    </button>
                                </div>
                            )}
                            {hasPermission('community') && (
                                <div className="flex-1 flex justify-center">
                                    <button
                                        onClick={() => setShowCommunityPortal(true)}
                                        className={`flex flex-col items-center font-bold text-xs ${activeTab === 'community' ? 'text-red-600' : 'text-gray-600'}`}
                                    >
                                        <Building2 className="w-5 h-5 mb-1" /> 社區
                                    </button>
                                </div>
                            )}
                            {hasPermission('function') && (
                                <div className="flex-1 flex justify-center">
                                    <button
                                        onClick={() => switchTab('function')}
                                        className={`flex flex-col items-center font-bold text-xs ${activeTab === 'function' ? 'text-red-600' : 'text-gray-600'}`}
                                    >
                                        <Briefcase className="w-5 h-5 mb-1" /> 功能
                                    </button>
                                </div>
                            )}
                            {hasPermission('cadre') && (
                                <div className="flex-1 flex justify-center">
                                    <button
                                        onClick={() => switchTab('cadre')}
                                        className={`relative flex flex-col items-center font-bold text-xs ${activeTab === 'cadre' ? 'text-red-600' : 'text-gray-600'}`}
                                    >
                                        <Shield className="w-5 h-5 mb-1" /> 幹部
                                        {(function() {
                                            const targetCompany = companies.find(c => c.name === cadreCompany);
                                            if (!targetCompany) return null;

                                            // Common user filter
                                            const targetRoleNames = ['系統管理員', '人事', '幹部', '員工'];
                                            const targetRoleIds = (roles || []).filter(r => targetRoleNames.includes(r.name)).map(r => r.id);
                                            const finalTargetRoles = ['admin', 'hr', 'cadre', 'staff', ...targetRoleIds];
                                            const companyUsers = usersList.filter(u => 
                                                ((u.companyIds && u.companyIds.some(cid => String(cid) === String(targetCompany.id))) || String(u.companyId) === String(targetCompany.id)) && 
                                                finalTargetRoles.includes(u.role)
                                            );
                                            
                                            if (companyUsers.length === 0) return null;
                                            const companyUserIds = companyUsers.map(u => u.id);

                                            // 1. Map (Abnormal)
                                            let abnormalCount = 0;
                                            if (hasSubPermission('cadre', 'map')) {
                                                const now = new Date();
                                                const isToday = (secs) => {
                                                    if (!secs) return false;
                                                    const d = new Date(secs * 1000);
                                                    return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth() && d.getDate() === now.getDate();
                                                };
                                                const calculateDistance = (lat1, lon1, lat2, lon2) => {
                                                    const R = 6371e3; 
                                                    const φ1 = lat1 * Math.PI / 180;
                                                    const φ2 = lat2 * Math.PI / 180;
                                                    const Δφ = (lat2 - lat1) * Math.PI / 180;
                                                    const Δλ = (lon2 - lon1) * Math.PI / 180;
                                                    const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
                                                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                                                    return R * c;
                                                };

                                                companyUsers.forEach(u => {
                                                    const recs = attendanceList.filter(r => {
                                                        const secs = r.timestamp?.seconds || r.createdAt?.seconds;
                                                        if (!secs) return false;
                                                        if (r.userId !== u.id) return false;
                                                        if (!isToday(secs)) return false;
                                                        return ['in','out','late_in','late_out'].includes(r.type);
                                                    });
                                                    
                                                    if (recs.length > 0) {
                                                        recs.sort((a, b) => {
                                                            const aSecs = a.timestamp?.seconds || a.createdAt?.seconds || 0;
                                                            const bSecs = b.timestamp?.seconds || b.createdAt?.seconds || 0;
                                                            return bSecs - aSecs;
                                                        });
                                                        const lastRec = recs[0];
                                                        
                                                        let isAbnormal = false;
                                                        if (targetCompany && targetCompany.lat && targetCompany.lng) {
                                                            if (lastRec.location && lastRec.location.includes(',')) {
                                                                const [rLat, rLng] = lastRec.location.split(',').map(Number);
                                                                const dist = calculateDistance(targetCompany.lat, targetCompany.lng, rLat, rLng);
                                                                const radius = targetCompany.radius || 100;
                                                                if (dist > radius) isAbnormal = true;
                                                            } else {
                                                                isAbnormal = true;
                                                            }
                                                        } else {
                                                            isAbnormal = true;
                                                        }
                                                        
                                                        if (isAbnormal) abnormalCount++;
                                                    }
                                                });
                                            }

                                            // 2. Record (Pending)
                                            let totalPending = 0;
                                            if (hasSubPermission('cadre', 'record')) {
                                                const pendingMakeupCount = (makeupRequests || []).filter(req => 
                                                    req.status === 'pending' && companyUserIds.includes(req.userId)
                                                ).length;
                                                const pendingModificationCount = (attendanceList || []).filter(req => 
                                                    req.modification?.status === 'pending' && companyUserIds.includes(req.userId)
                                                ).length;
                                                totalPending = pendingMakeupCount + pendingModificationCount;
                                            }

                                            // 3. Leave (Pending)
                                            let pendingLeaveCount = 0;
                                            if (hasSubPermission('cadre', 'leave')) {
                                                pendingLeaveCount = (leavesList || []).filter(req => 
                                                    req.approvalStatus === 'pending' && companyUserIds.includes(req.userId)
                                                ).length;
                                            }

                                            // 4. Approval (Pending)
                                            let pendingSignatureCount = 0;
                                            if (hasSubPermission('cadre', 'approval')) {
                                                pendingSignatureCount = (cadreSignatures || []).filter(sig => 
                                                    sig.status === 'pending' && companyUserIds.includes(sig.userId)
                                                ).length;
                                            }

                                            const totalCount = abnormalCount + totalPending + pendingLeaveCount + pendingSignatureCount;

                                            if (totalCount > 0) {
                                                return (
                                                    <span className="absolute top-0 right-0 w-2 h-2 rounded-full bg-red-600"></span>
                                                );
                                            }
                                            return null;
                                        })()}
                                    </button>
                                </div>
                            )}
                            {hasPermission('application') && (
                                <div className="flex-1 flex justify-center">
                                    <button
                                        onClick={() => switchTab('application')}
                                        className={`flex flex-col items-center font-bold text-xs ${activeTab === 'application' ? 'text-red-600' : 'text-gray-600'}`}
                                    >
                                        <FileText className="w-5 h-5 mb-1" /> 申請
                                    </button>
                                </div>
                            )}
                            {hasPermission('settings') && (
                                <div className="flex-1 flex justify-center">
                                    <button
                                        onClick={() => switchTab('settings')}
                                        className={`flex flex-col items-center font-bold text-xs ${activeTab === 'settings' ? 'text-red-600' : 'text-gray-600'}`}
                                    >
                                        <Settings className="w-5 h-5 mb-1" /> 設定
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>

                    {showCommunityPortal && (
                        <div className="fixed inset-0 z-[90] bg-black/80" onClick={() => setShowCommunityPortal(false)}>
                            <div className="absolute inset-0" onClick={(e) => e.stopPropagation()}>
                                <button 
                                    onClick={() => setShowCommunityPortal(false)} 
                                    className="absolute top-4 right-4 z-10 p-2 bg-white rounded-full shadow-lg hover:bg-gray-100"
                                    title="關閉"
                                >
                                    <X className="w-5 h-5" />
                                </button>
                                <iframe 
                                    src="https://nw-com.github.io/nw-checkin-all/" 
                                    className="w-full h-full border-0 bg-white"
                                    allow="clipboard-read; clipboard-write; geolocation; camera; microphone"
                                ></iframe>
                            </div>
                        </div>
                    )}

                    {mapPreviewTarget && (
                        <div className="fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-4" onClick={()=>setMapPreviewTarget(null)}>
                            <div className="bg-white rounded-2xl shadow-xl w-full max-w-md aspect-square overflow-hidden flex flex-col relative" onClick={e=>e.stopPropagation()}>
                                <div className="absolute top-4 right-4 z-10">
                                    <button onClick={()=>setMapPreviewTarget(null)} className="p-2 bg-white rounded-full shadow-lg hover:bg-gray-100">
                                        <X className="w-5 h-5" />
                                    </button>
                                </div>
                                <div className="flex-1 w-full h-full relative">
                                    <CompanyMapPreview 
                                        lat={mapPreviewTarget.lat} 
                                        lng={mapPreviewTarget.lng} 
                                        radius={mapPreviewTarget.radius} 
                                    />
                                    <div className="absolute bottom-4 left-4 bg-white/90 px-3 py-2 rounded-xl shadow-lg text-xs font-bold text-gray-700 pointer-events-none">
                                        <div className="text-sm mb-1">{mapPreviewTarget.name}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {confirmDelete && (
                        <div className="fixed inset-0 z-[70] bg-black/40 flex items-center justify-center">
                            <div className="bg-white rounded-2xl shadow-xl w-[90%] max-w-sm p-6 max-h-[90vh] overflow-y-auto">
                                <div className="text-sm text-gray-700 mb-4">確認刪除{confirmDelete.type==='role'?'角色':confirmDelete.type==='company'?'公司':confirmDelete.type==='area'?'區域':confirmDelete.type==='signatureType'?'簽呈類型':confirmDelete.type==='signature'?'簽呈':confirmDelete.type==='community'?'社區':'人員'}「{confirmDelete.label}」？</div>
                                <div className="flex justify-end gap-2">
                                    <button onClick={()=>setConfirmDelete(null)} className="px-3 py-2 rounded-2xl bg-gray-100 text-gray-700">取消</button>
                                    <button onClick={async()=>{ try { 
                                        if (confirmDelete.type==='role') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roles', confirmDelete.id)); } 
                                        else if (confirmDelete.type==='company') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'companies', confirmDelete.id)); } 
                                        else if (confirmDelete.type==='area') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'areas', confirmDelete.id)); } 
                                        else if (confirmDelete.type==='signatureType') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'signature_types', confirmDelete.id)); } 
                                        else if (confirmDelete.type==='signature') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'signatures', confirmDelete.id)); } 
                                        else if (confirmDelete.type==='community') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'communities', confirmDelete.id)); } 
                                        else if (confirmDelete.type==='user') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', confirmDelete.id)); } 
                                        else if (confirmDelete.type==='schedule') { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'schedules', confirmDelete.id)); } 
                                        setConfirmDelete(null); 
                                        setToast('刪除成功'); 
                                    } catch(e) { console.error(e); setConfirmDelete(null); setToast('刪除失敗'); } }} className="px-3 py-2 rounded-2xl bg-red-600 text-white">刪除</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showDescriptionModal && (
                        <div className="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4" onClick={() => setShowDescriptionModal(false)}>
                            <div className="bg-white rounded-2xl w-full max-w-sm p-6" onClick={e => e.stopPropagation()}>
                                <h3 className="font-bold text-lg mb-4 text-gray-800">說明內容</h3>
                                <div className="bg-gray-50 p-4 rounded-xl text-gray-600 min-h-[100px] whitespace-pre-wrap">
                                    {selectedDescription}
                                </div>
                                <div className="mt-4 flex justify-end">
                                    <button 
                                        onClick={() => setShowDescriptionModal(false)}
                                        className="px-4 py-2 bg-gray-100 text-gray-600 rounded-xl font-bold"
                                    >
                                        關閉
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <CameraModal 
                        isOpen={showCameraModal} 
                        onClose={() => setShowCameraModal(false)}
                        onConfirm={handleCameraConfirm}
                        type={clockType}
                        userName={dbUser?.name}
                        userAvatar={dbUser?.avatarUrl}
                        workSite={communities.find(c => c.id === dbUser?.communityId)}
                        checkInLocationName={checkInLocation ? checkInLocation.name : (dbUser?.communityName || '')}
                        availableLocations={availableClockInLocations}
                        checkInLocation={checkInLocation}
                        setCheckInLocation={setCheckInLocation}
                    />

                    {showMakeupModal && (
                        <div className="fixed inset-0 z-[70] bg-black/50 flex items-center justify-center p-4" onClick={() => setShowMakeupModal(false)}>
                            <div className="bg-white rounded-2xl w-full max-w-md p-6" onClick={e => e.stopPropagation()}>
                                <h3 className="font-bold text-lg mb-4 text-gray-800">
                                    申請 {makeupDateStr} {(makeupForm.timeType === 'out' ? '下班' : '上班')} 補打卡
                                </h3>
                                <div className="space-y-4">
                                    <div>
                                        <div className="text-xs font-bold text-gray-500 mb-1">打卡位置</div>
                                        <select
                                            value={makeupForm.locationId}
                                            onChange={(e) => setMakeupForm(prev => ({ ...prev, locationId: e.target.value }))}
                                            className="w-full px-3 py-2 border rounded-xl text-sm"
                                        >
                                            <option value="">請選擇位置</option>
                                            {(availableClockInLocations || []).map(loc => (
                                                <option key={loc.id} value={loc.id}>{loc.name || loc.id}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <div className="text-xs font-bold text-gray-500 mb-1">打卡時間</div>
                                        <input
                                            type="time"
                                            value={makeupForm.customTime || ''}
                                            onChange={(e) => setMakeupForm(prev => ({ ...prev, customTime: e.target.value }))}
                                            className="w-full px-3 py-2 border rounded-xl text-sm"
                                        />
                                    </div>
                                    <div>
                                        <div className="text-xs font-bold text-gray-500 mb-1">未打卡原因</div>
                                        <div className="grid grid-cols-2 gap-2 mb-2">
                                            <button
                                                onClick={() => setMakeupForm(prev => ({ ...prev, reasonType: 'forgot' }))}
                                                className={`px-3 py-2 rounded-xl text-sm font-bold ${makeupForm.reasonType === 'forgot' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}`}
                                            >
                                                忘記打卡
                                            </button>
                                            <button
                                                onClick={() => setMakeupForm(prev => ({ ...prev, reasonType: 'other' }))}
                                                className={`px-3 py-2 rounded-xl text-sm font-bold ${makeupForm.reasonType === 'other' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}`}
                                            >
                                                其他
                                            </button>
                                        </div>
                                        {makeupForm.reasonType === 'other' && (
                                            <input
                                                value={makeupForm.reasonText}
                                                onChange={(e) => setMakeupForm(prev => ({ ...prev, reasonText: e.target.value }))}
                                                placeholder="請輸入自定義原因"
                                                className="w-full px-3 py-2 border rounded-xl text-sm"
                                            />
                                        )}
                                    </div>
                                </div>
                                <div className="mt-6 flex justify-end gap-2">
                                    <button
                                        onClick={() => setShowMakeupModal(false)}
                                        className="px-4 py-2 bg-gray-100 text-gray-700 rounded-xl font-bold"
                                    >
                                        取消
                                    </button>
                                    <button
                                        onClick={async () => {
                                            if (!dbUser) return;
                                            try {
                                                const loc = availableClockInLocations.find(l => l.id === makeupForm.locationId) || null;
                                                const chosenTime = makeupForm.customTime || (makeupForm.timeType === 'out' ? (makeupSchedule?.endTime || '18:00') : (makeupSchedule?.startTime || '09:00'));
                                                const isIn = makeupForm.timeType !== 'out';
                                                const reqData = {
                                                    userId: dbUser.id,
                                                    userName: dbUser.name || 'Unknown',
                                                    userCompanyId: dbUser.companyId || '',
                                                    date: makeupDateStr,
                                                    scheduleType: makeupSchedule?.type || 'work',
                                                    startTime: isIn ? chosenTime : (makeupSchedule?.startTime || '09:00'),
                                                    endTime: isIn ? (makeupSchedule?.endTime || '18:00') : chosenTime,
                                                    target: makeupForm.timeType,
                                                    locationId: loc?.id || '',
                                                    checkInLocationName: loc?.name || '',
                                                    address: loc?.address || '',
                                                    reasonType: makeupForm.reasonType,
                                                    reasonRemark: makeupForm.reasonType === 'other' ? (makeupForm.reasonText || '') : '',
                                                    status: 'pending',
                                                    createdAt: serverTimestamp(),
                                                    type: 'makeup'
                                                };
                                                // Optimistic update for immediate UI feedback
                                                setMyMakeupRequests(prev => [
                                                    { id: `temp_${Date.now()}`, ...reqData, createdAt: { seconds: Math.floor(Date.now()/1000) } },
                                                    ...prev
                                                ]);
                                                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'makeup_requests'), reqData);
                                                setShowMakeupModal(false);
                                                alert('已送出補打卡申請');
                                            } catch (err) {
                                                console.error(err);
                                                alert('申請失敗: ' + err.message);
                                            }
                                        }}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-xl font-bold"
                                    >
                                        確認送出
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <ImagePreviewModal 
                        url={previewImageUrl} 
                        onClose={() => setPreviewImageUrl(null)}
                    />

                    <LeaveRequestModal 
                        isOpen={showCadreLeaveModal} 
                        onClose={() => { setShowCadreLeaveModal(false); setEditingCadreLeave(null); }}
                        defaultCompany={cadreCompany || '所屬公司'}
                        initialData={editingCadreLeave}
                        users={(function(){
                            const targetCompany = companies.find(c => c.name === cadreCompany);
                            if (!targetCompany) return [];
                            return usersList.filter(u => {
                                if ((u.status || '在職') === '離職') return false;
                                const ids = u.companyIds || (u.companyId ? [u.companyId] : []);
                                return ids.some(cid => String(cid) === String(targetCompany.id));
                            });
                        })()}
                        onSubmit={async (data) => {
                            setCadreLeaveLoading(true);
                            try {
                                await handleLeaveSubmit(data);
                                setShowCadreLeaveModal(false);
                                setEditingCadreLeave(null);
                            } catch (e) {
                                console.error(e);
                            } finally {
                                setCadreLeaveLoading(false);
                            }
                        }}
                        loading={cadreLeaveLoading}
                    />

                    <ApprovalModal 
                        isOpen={showApprovalModal}
                        onClose={() => setShowApprovalModal(false)}
                        onApprove={() => handleUpdateLeaveStatus('approved')}
                        onReject={() => handleUpdateLeaveStatus('rejected')}
                        onReset={() => handleUpdateLeaveStatus('pending')}
                        leaveData={selectedApprovalLeave}
                    />

                    <ModificationReviewModal 
                        isOpen={showReviewModal}
                        onClose={() => { setShowReviewModal(false); setReviewData(null); }}
                        record={reviewData}
                        onApprove={handleReviewApprove}
                        onReject={handleReviewReject}
                    />

                    {showMakeupEditModal && editingMakeupRequest && (
                        <div className="fixed inset-0 z-[100] bg-black/50 flex items-center justify-center p-4" onClick={() => { setShowMakeupEditModal(false); setEditingMakeupRequest(null); }}>
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-xl animate-fade-in-up" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-gray-800 mb-4">編輯補{editingMakeupRequest?.target === 'out' ? '下班' : '上班'}打卡申請</h3>
                                <div className="space-y-4">
                                    <div>
                                        <div className="text-xs font-bold text-gray-500 mb-1">打卡位置</div>
                                        <select
                                            value={makeupEditForm.locationId}
                                            onChange={(e) => setMakeupEditForm(prev => ({ ...prev, locationId: e.target.value }))}
                                            className="w-full px-3 py-2 border rounded-xl text-sm"
                                        >
                                            <option value="">請選擇位置</option>
                                            {(availableClockInLocations || []).map(loc => (
                                                <option key={loc.id} value={loc.id}>{loc.name || loc.id}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        {editingMakeupRequest?.target === 'out' ? (
                                            <>
                                                <div className="text-xs font-bold text-gray-500 mb-1">補下班打卡時間</div>
                                                <input
                                                    type="time"
                                                    value={makeupEditForm.endTime || ''}
                                                    onChange={(e) => setMakeupEditForm(prev => ({ ...prev, endTime: e.target.value }))}
                                                    className="w-full px-3 py-2 border rounded-xl text-sm"
                                                />
                                            </>
                                        ) : (
                                            <>
                                                <div className="text-xs font-bold text-gray-500 mb-1">補上班打卡時間</div>
                                                <input
                                                    type="time"
                                                    value={makeupEditForm.startTime || ''}
                                                    onChange={(e) => setMakeupEditForm(prev => ({ ...prev, startTime: e.target.value }))}
                                                    className="w-full px-3 py-2 border rounded-xl text-sm"
                                                />
                                            </>
                                        )}
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <div className="text-xs font-bold text-gray-500 mb-1">未打卡原因</div>
                                            <select
                                                value={makeupEditForm.reasonType}
                                                onChange={(e) => setMakeupEditForm(prev => ({ ...prev, reasonType: e.target.value }))}
                                                className="w-full px-3 py-2 border rounded-xl text-sm"
                                            >
                                                <option value="forgot">忘記打卡</option>
                                                <option value="other">其他</option>
                                            </select>
                                        </div>
                                        {makeupEditForm.reasonType === 'other' && (
                                            <div>
                                                <div className="text-xs font-bold text-gray-500 mb-1">說明</div>
                                                <input
                                                    type="text"
                                                    value={makeupEditForm.reasonRemark || ''}
                                                    onChange={(e) => setMakeupEditForm(prev => ({ ...prev, reasonRemark: e.target.value }))}
                                                    className="w-full px-3 py-2 border rounded-xl text-sm"
                                                />
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div className="mt-6 flex gap-2 justify-end">
                                    <button 
                                        onClick={() => { setShowMakeupEditModal(false); setEditingMakeupRequest(null); }}
                                        className="px-4 py-2 bg-gray-100 text-gray-700 rounded-xl font-bold"
                                    >
                                        取消
                                    </button>
                                    <button 
                                        onClick={async () => {
                                            if (!editingMakeupRequest) return;
                                            try {
                                                const loc = availableClockInLocations.find(l => l.id === makeupEditForm.locationId) || null;
                                                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'makeup_requests', editingMakeupRequest.id), {
                                                    startTime: makeupEditForm.startTime || editingMakeupRequest.startTime,
                                                    endTime: makeupEditForm.endTime || editingMakeupRequest.endTime,
                                                    locationId: makeupEditForm.locationId || editingMakeupRequest.locationId,
                                                    checkInLocationName: loc?.name || editingMakeupRequest.checkInLocationName || '',
                                                    address: loc?.address || editingMakeupRequest.address || '',
                                                    reasonType: makeupEditForm.reasonType || editingMakeupRequest.reasonType,
                                                    reasonRemark: makeupEditForm.reasonType === 'other' ? (makeupEditForm.reasonRemark || '') : ''
                                                });
                                                setShowMakeupEditModal(false);
                                                setEditingMakeupRequest(null);
                                            } catch (e) {
                                                console.error(e);
                                                alert('更新失敗: ' + e.message);
                                            }
                                        }}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-xl font-bold"
                                    >
                                        儲存
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <AttendanceEditModal 
                        isOpen={showAdminEditModal} 
                        onClose={() => { setShowAdminEditModal(false); setAdminEditData(null); }}
                        record={adminEditData}
                        mode="edit"
                        onSubmit={handleAdminEditRecord}
                        loading={adminEditLoading}
                        availableLocations={[
                            ...companies.map(c => ({ type: 'company', id: c.id, name: c.name })),
                            ...communities.map(c => ({ type: 'community', id: c.id, name: c.name }))
                        ]}
                    />

                    <NotificationModal 
                        isOpen={showNotificationModal}
                        onClose={() => setShowNotificationModal(false)}
                        onConfirm={handleNotificationSubmit}
                        form={notificationForm}
                        setForm={setNotificationForm}
                        loading={notificationLoading}
                        users={usersList}
                        companies={companies}
                    />

                    {/* Notification Popup */}
                    {activePopupNotification && (
                        <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[9999] bg-white rounded-xl shadow-2xl border border-gray-100 w-80 overflow-hidden">
                            <div className="bg-red-600 text-white px-4 py-2 flex justify-between items-center">
                                <h3 className="font-bold text-sm flex items-center">
                                    <Bell className="w-4 h-4 mr-2" />
                                    新通知
                                </h3>
                                <button 
                                    onClick={() => handleClosePopup()}
                                    className="text-white hover:text-red-100"
                                >
                                    <X className="w-4 h-4" />
                                </button>
                            </div>
                            <div className="p-4">
                                <div className="text-xs text-gray-400 mb-1 flex justify-between">
                                    <span>{activePopupNotification.senderName}</span>
                                    <span>{activePopupNotification.createdAt && activePopupNotification.createdAt.seconds ? new Date(activePopupNotification.createdAt.seconds * 1000).toLocaleString() : ''}</span>
                                </div>
                                <div className="text-sm text-gray-800 whitespace-pre-wrap mb-4 max-h-[200px] overflow-y-auto">
                                    {activePopupNotification.content}
                                </div>
                                <div className="flex items-center justify-between pt-3 border-t border-gray-100">
                                    <label className="flex items-center cursor-pointer select-none">
                                        <input 
                                            type="checkbox" 
                                            checked={dontShowAgain} 
                                            onChange={(e) => setDontShowAgain(e.target.checked)}
                                            className="w-4 h-4 text-red-600 rounded border-gray-300 focus:ring-red-500"
                                        />
                                        <span className="ml-2 text-xs text-gray-600">不再顯示</span>
                                    </label>
                                    <button 
                                        onClick={() => handleClosePopup()}
                                        className="px-3 py-1 bg-gray-100 text-gray-700 text-xs font-bold rounded-lg hover:bg-gray-200 transition-colors"
                                    >
                                        關閉
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}


                    {reportModalType && (
                        <div className="fixed inset-0 z-[100] bg-gray-100 flex flex-col animate-fade-in">
                            <div className="bg-white p-4 shadow-sm flex-shrink-0 relative">
                                <div className="flex items-start justify-between">
                                    <div className="flex flex-col gap-3 w-full">

                                        <div className="flex items-center gap-3">
                                            {(function(){
                                                const u = usersList.find(x => x.id === cadreMapSelectedUserId);
                                                if (!u) return null;
                                                return (
                                                    <>
                                                        <div className="w-8 h-8 rounded-full bg-gray-200 overflow-hidden border border-gray-100">
                                                            {u.avatarUrl ? (
                                                                <img src={u.avatarUrl} className="w-full h-full object-cover" />
                                                            ) : (
                                                                <div className="w-full h-full flex items-center justify-center font-bold text-gray-500 text-sm">{u.name?.[0] || '人'}</div>
                                                            )}
                                                        </div>
                                                        <span className="text-base font-bold text-gray-800">{u.name}</span>
                                                    </>
                                                );
                                            })()}
                                        </div>
                                        <div className="flex items-center gap-2 flex-wrap">
                                            <span className="text-lg font-bold text-gray-800">
                                                {reportModalType === 'attendance' && '出勤報表'}
                                                {reportModalType === 'outing' && '外出報表'}
                                                {reportModalType === 'duty' && '卡班報表'}
                                                {reportModalType === 'leave' && '請假報表'}
                                            </span>
                                            <button 
                                                onClick={() => setIsReportMonthOpen(v => !v)} 
                                                className="text-sm font-normal text-gray-500 hover:underline inline-flex items-center"
                                                title="選擇月份"
                                            >
                                                {cadreRecordDate.split('-').slice(0, 2).join('-')}
                                                <ChevronDown className="w-4 h-4 ml-1" />
                                            </button>
                                            <button onClick={handlePrintReport} className="px-3 py-1.5 bg-gray-100 rounded-xl text-gray-700 text-sm font-bold">
                                                列印
                                            </button>
                                            <button onClick={handleExportExcel} className="px-3 py-1.5 bg-gray-100 rounded-xl text-gray-700 text-sm font-bold">
                                                匯出(Excel)
                                            </button>
                                        </div>
                                    </div>
                                    <button onClick={() => { setReportModalType(null); setIsReportMonthOpen(false); }} className="p-2 bg-gray-100 rounded-full text-gray-600">
                                        <X className="w-5 h-5" />
                                    </button>
                                </div>
                                
                                {isReportMonthOpen && (
                                    <div className="absolute left-4 top-full mt-2 bg-white border border-gray-200 rounded-xl shadow-lg p-2 z-[101] w-[160px] max-h-64 overflow-y-auto">
                                        {(function(){
                                            const now = new Date();
                                            const selectedUserId = cadreMapSelectedUserId;
                                            const source = reportModalType === 'leave' 
                                                ? leavesList.filter(r => !selectedUserId || r.userId === selectedUserId)
                                                : attendanceList.filter(r => !selectedUserId || r.userId === selectedUserId);
                                            const monthsSet = new Set();
                                            if (reportModalType === 'leave') {
                                                source.forEach(r => {
                                                    const s = r.leaveStartDate ? new Date(r.leaveStartDate) : null;
                                                    const e = r.leaveEndDate ? new Date(r.leaveEndDate) : null;
                                                    if (s && !isNaN(s)) monthsSet.add(`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,'0')}`);
                                                    if (e && !isNaN(e)) monthsSet.add(`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,'0')}`);
                                                });
                                            } else {
                                                source.forEach(r => {
                                                    const d = new Date((r.timestamp?.seconds || 0) * 1000);
                                                    if (!isNaN(d)) {
                                                        const m = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                                                        monthsSet.add(m);
                                                    }
                                                });
                                            }
                                            let months = Array.from(monthsSet).filter(m => {
                                                const [y, mo] = m.split('-').map(Number);
                                                const dt = new Date(y, mo-1, 1);
                                                return dt <= new Date(now.getFullYear(), now.getMonth(), 1);
                                            }).sort((a,b) => b.localeCompare(a));
                                            
                                            if (months.length === 0) {
                                                const arr = [];
                                                const start = new Date(now.getFullYear(), now.getMonth(), 1);
                                                for (let i=0;i<12;i++){
                                                    const d = new Date(start);
                                                    d.setMonth(start.getMonth()-i);
                                                    arr.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`);
                                                }
                                                months = arr;
                                            }
                                            
                                            const currentYM = cadreRecordDate.split('-').slice(0,2).join('-');
                                            return months.map(m => (
                                                <button 
                                                    key={m} 
                                                    onClick={() => { setCadreRecordDate(`${m}-01`); setIsReportMonthOpen(false); }}
                                                    className={`w-full text-left px-3 py-1.5 rounded-lg text-sm ${m === currentYM ? 'bg-gray-100 font-bold' : 'hover:bg-gray-50'}`}
                                                >
                                                    {m}
                                                </button>
                                            ));
                                        })()}
                                    </div>
                                )}
                            </div>
                            <style>
                                {`@page { size: A4; margin: 10mm; }
                                @media print {
                                    body * { visibility: hidden; }
                                    #attendance-report, #attendance-report * { visibility: visible; }
                                    #attendance-report {
                                        position: static;
                                        left: auto;
                                        top: auto;
                                        width: 100%;
                                        max-width: none;
                                        overflow: visible;
                                        page-break-inside: avoid;
                                        font-size: 8pt;
                                        line-height: 1.1;
                                        background: #fff !important;
                                        box-shadow: none !important;
                                        border: none !important;
                                        padding: 0 !important;
                                        border-radius: 0 !important;
                                        margin-top: -4mm !important;
                                    }
                                    #attendance-report .text-lg { font-size: 10pt !important; }
                                    #attendance-report .text-md { font-size: 9pt !important; }
                                    #attendance-report .text-sm { font-size: 8pt !important; }
                                    #attendance-report .text-xs { font-size: 7pt !important; }
                                    #attendance-report .min-w\\[720px\\] { min-width: auto !important; width: 100% !important; }
                                    #attendance-report .grid.grid-cols-10 { grid-template-columns: 10mm 10mm 20mm 25mm 25mm 25mm 15mm 15mm 15mm 30mm !important; }
                                    #attendance-report .px-3 { padding-left: 2mm !important; padding-right: 2mm !important; }
                                    #attendance-report .py-2 { padding-top: 0 !important; padding-bottom: 0 !important; }
                                    #attendance-report .text-center.py-1 { padding-top: 0 !important; padding-bottom: 0 !important; }
                                    #attendance-report .text-center.pb-3 { padding-bottom: 1mm !important; }
                                    #attendance-report .grid.grid-cols-10.text-xs.font-bold > div { height: 7mm !important; display: flex; align-items: center; white-space: nowrap; }
                                    #attendance-report .divide-y > .grid > div { height: 7mm !important; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; display: flex; align-items: center; }
                                    #attendance-report .divide-y > .grid > div > div { display: inline !important; margin-right: 2mm !important; }
                                    #attendance-report .divide-y > .grid { page-break-inside: avoid; }
                                    #attendance-report .bg-gray-50 { background: #ffffff !important; }
                                    #attendance-report .bg-orange-100 { background: #fff6e5 !important; }
                                    #attendance-report .bg-gray-200 { background: #f5f5f5 !important; }
                                }`}
                            </style>
                            <div className="flex-1 overflow-y-auto p-4">
                                {(function(){
                                    const targetDate = new Date(cadreRecordDate);
                                    const targetYear = targetDate.getFullYear();
                                    const targetMonth = targetDate.getMonth();
                                    
                                    if (reportModalType === 'leave') {
                                        if (!cadreMapSelectedUserId) {
                                            return (
                                                <div className="flex flex-col items-center justify-center h-full text-gray-400">
                                                    <ClipboardList className="w-12 h-12 mb-4 opacity-20" />
                                                    <p>請先在左側列表選取人員</p>
                                                </div>
                                            );
                                        }
                                        const user = usersList.find(u => u.id === cadreMapSelectedUserId);
                                        const monthStart = new Date(targetYear, targetMonth, 1, 0, 0, 0);
                                        const monthEnd = new Date(targetYear, targetMonth + 1, 0, 23, 59, 59);
                                        const weekMap = ['日','一','二','三','四','五','六'];
                                        const holidays = [
                                            // 2025
                                            '2025-01-01', '2025-01-25', '2025-01-26', '2025-01-27', '2025-01-28', '2025-01-29', '2025-01-30', '2025-01-31', '2025-02-01', '2025-02-02',
                                            '2025-02-28', '2025-04-03', '2025-04-04', '2025-04-05', '2025-04-06', '2025-05-01', '2025-05-30', '2025-05-31', '2025-06-01', '2025-10-04', '2025-10-05', '2025-10-06', '2025-10-10', '2025-10-11', '2025-10-12', '2025-12-25',
                                            // 2026
                                            '2026-01-01', '2026-01-02', '2026-02-14', '2026-02-15', '2026-02-16', '2026-02-17', '2026-02-18', '2026-02-19', '2026-02-20', '2026-02-21', '2026-02-22',
                                            '2026-02-27', '2026-02-28', '2026-03-01', '2026-04-03', '2026-04-04', '2026-04-05', '2026-04-06', '2026-05-01', '2026-06-19', '2026-06-20', '2026-06-21', '2026-09-25', '2026-09-26', '2026-09-27', '2026-10-09', '2026-10-10', '2026-10-11', '2026-12-25'
                                        ];
                                        const normalizeDateStr = (v) => {
                                            if (!v) return null;
                                            const s = String(v).replace(/\//g, '-');
                                            if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(`${s}T00:00:00`);
                                            const d = new Date(s);
                                            return isNaN(d) ? null : d;
                                        };
                                        const parseLeaveRange = (l) => {
                                            let s = l.leaveStartDate ? normalizeDateStr(l.leaveStartDate) : null;
                                            let e = l.leaveEndDate ? normalizeDateStr(l.leaveEndDate) : null;
                                            if (!s) {
                                                if (l.leaveDate) {
                                                    const dstr = String(l.leaveDate).replace(/\//g, '-');
                                                    const tstr = l.leaveTime ? String(l.leaveTime) : '00:00';
                                                    const dt = new Date(`${dstr}T${tstr}`);
                                                    s = isNaN(dt) ? null : dt;
                                                } else if (l.timestamp && l.timestamp.seconds) {
                                                    const d = new Date(l.timestamp.seconds * 1000);
                                                    s = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0);
                                                }
                                            }
                                            if (!e) {
                                                if (l.leaveDate) {
                                                    const dstr = String(l.leaveDate).replace(/\//g, '-');
                                                    const tstr = l.leaveTime ? String(l.leaveTime) : '23:59';
                                                    const dt = new Date(`${dstr}T${tstr}`);
                                                    e = isNaN(dt) ? null : dt;
                                                } else if (s) {
                                                    e = new Date(s.getFullYear(), s.getMonth(), s.getDate(), 23, 59, 59);
                                                }
                                            }
                                            return { s, e };
                                        };
                                        const monthLeaves = leavesList.filter(l => {
                                            if (l.userId !== cadreMapSelectedUserId) return false;
                                            const { s, e } = parseLeaveRange(l);
                                            if (!s || !e || isNaN(s) || isNaN(e)) return false;
                                            return s <= monthEnd && e >= monthStart;
                                        }).sort((a,b) => {
                                            const sa = parseLeaveRange(a).s ? parseLeaveRange(a).s.getTime() : 0;
                                            const sb = parseLeaveRange(b).s ? parseLeaveRange(b).s.getTime() : 0;
                                            return sa - sb;
                                        });
                                        
                                        const fmt = (v) => {
                                            if (!v) return '-';
                                            const d = v instanceof Date ? v : new Date(v);
                                            if (isNaN(d)) return String(v);
                                            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                                        };
                                        return (
                                            <div id="attendance-report" className="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 overflow-x-auto">
                                                <div className="min-w-[720px]">
                                                    <div className="text-center font-bold text-lg text-gray-800 py-1">
                                                        西北保全{user?.title || ''}{user?.name || ''}
                                                    </div>
                                                    <div className="text-center font-bold text-md text-gray-600 pb-3">
                                                        {cadreRecordDate.split('-').slice(0,2).join('-')} 請假月報表
                                                    </div>
                                                    <div className="grid text-xs font-bold text-gray-600 bg-gray-50 rounded-xl" style={{ gridTemplateColumns: '10mm 10mm 20mm 30mm 30mm 30mm 15mm 15mm 30mm' }}>
                                                        <div className="px-3 py-2">日期</div>
                                                        <div className="px-3 py-2">星期</div>
                                                        <div className="px-3 py-2">事由</div>
                                                        <div className="px-3 py-2">開始時間</div>
                                                        <div className="px-3 py-2">結束時間</div>
                                                        <div className="px-3 py-2">實際日期</div>
                                                        <div className="px-3 py-2">實際天數</div>
                                                        <div className="px-3 py-2">實際時數</div>
                                                        <div className="px-3 py-2">備註</div>
                                                    </div>
                                                    <div className="divide-y divide-gray-100">
                                                        {monthLeaves.filter(l => l.approvalStatus === 'approved').map((l, idx) => {
                                                            const rng = (function(){ const r = parseLeaveRange(l); return r; })();
                                                            const sd = rng.s;
                                                            const w = !sd || isNaN(sd) ? '-' : weekMap[sd.getDay()];
                                                            const statusMap = { approved: '請假', pending: '待核准', rejected: '已駁回' };
                                                            const status = statusMap[l.approvalStatus] || l.approvalStatus || '';

                                                            let actualDates = [];
                                                            let actualHours = 0;
                                                            let actualDays = 0;
                                                            if (rng.s && rng.e && !isNaN(rng.s) && !isNaN(rng.e)) {
                                                                let curr = new Date(rng.s);
                                                                let loopDate = new Date(curr.getFullYear(), curr.getMonth(), curr.getDate());
                                                                const endDate = new Date(rng.e.getFullYear(), rng.e.getMonth(), rng.e.getDate());
                                                                
                                                                while (loopDate <= endDate) {
                                                                    const dStr = `${loopDate.getFullYear()}-${String(loopDate.getMonth()+1).padStart(2,'0')}-${String(loopDate.getDate()).padStart(2,'0')}`;
                                                                    const isHoliday = holidays.includes(dStr);
                                                                    const isWeekend = loopDate.getDay() === 0 || loopDate.getDay() === 6;
                                                                    const sched = userSchedules ? userSchedules[dStr] : null;
                                                                    const isRest = sched && (sched.type === 'off' || sched.type === 'rest' || sched.type === 'holiday');
                                                                    const isFridayOff = loopDate.getDay() === 5 && (!sched || sched.type === 'off');
                                                                    const fullDateStr = `${loopDate.getFullYear()}/${String(loopDate.getMonth()+1).padStart(2,'0')}/${String(loopDate.getDate()).padStart(2,'0')}`;
                                                                    
                                                                    if (!isHoliday && !isWeekend && !isRest && !isFridayOff) {
                                                                        if (sched && (sched.type === 'work' || sched.type === 'duty' || sched.type === 'card') && sched.startTime && sched.endTime) {
                                                                            const parseToMin = (s) => {
                                                                                const [h, m] = String(s).split(':').map(Number);
                                                                                return (h * 60) + m;
                                                                            };
                                                                            let startMin = parseToMin(sched.startTime);
                                                                            let endMin = parseToMin(sched.endTime);
                                                                            
                                                                            const schedStart = new Date(loopDate);
                                                                            schedStart.setHours(Math.floor(startMin/60), startMin%60, 0, 0);
                                                                            const schedEnd = new Date(loopDate);
                                                                            schedEnd.setHours(Math.floor(endMin/60), endMin%60, 0, 0);
                                                                            if (sched.crossDay) schedEnd.setDate(schedEnd.getDate() + 1);

                                                                            const scheduleDurationMs = schedEnd - schedStart;
                                                                            const scheduleHours = scheduleDurationMs / 3600000;
                                                                            
                                                                            const leaveStartMs = rng.s.getTime();
                                                                            const leaveEndMs = rng.e.getTime();
                                                                            const schedStartMs = schedStart.getTime();
                                                                            const schedEndMs = schedEnd.getTime();
                                                                            
                                                                            const overlapStart = Math.max(leaveStartMs, schedStartMs);
                                                                            const overlapEnd = Math.min(leaveEndMs, schedEndMs);
                                                                            
                                                                            if (overlapEnd > overlapStart) {
                                                                                const overlapMs = overlapEnd - overlapStart;
                                                                                const overlapHours = overlapMs / 3600000;
                                                                                
                                                                                actualHours += overlapHours;
                                                                                if (scheduleHours > 0) {
                                                                                    actualDays += (overlapHours / scheduleHours);
                                                                                }
                                                                                actualDates.push(fullDateStr);
                                                                            }
                                                                        }
                                                                    }
                                                                    loopDate.setDate(loopDate.getDate() + 1);
                                                                }
                                                            }

                                                            return (
                                                                <div key={idx} className="grid text-sm" style={{ gridTemplateColumns: '10mm 10mm 20mm 30mm 30mm 30mm 15mm 15mm 30mm' }}>
                                                                    <div className="px-3 py-2">{(!sd || isNaN(sd)) ? '-' : String(sd.getDate()).padStart(2,'0')}</div>
                                                                    <div className="px-3 py-2">{w}</div>
                                                                    <div className="px-3 py-2">{l.leaveReason || '-'}</div>
                                                                    <div className="px-3 py-2">{fmt(rng.s)}</div>
                                                                    <div className="px-3 py-2">{fmt(rng.e)}</div>
                                                                    <div className="px-3 py-2">
                                                                        {actualDates.length > 0 ? actualDates.map((d, i) => (
                                                                            <div key={i}>{d}</div>
                                                                        )) : '-'}
                                                                    </div>
                                                                    <div className="px-3 py-2">{parseFloat(actualDays.toFixed(2))}</div>
                                                                    <div className="px-3 py-2">{actualDates.length > 0 ? actualHours.toFixed(1) : '-'}</div>
                                                                    <div className="px-3 py-2">{l.leaveDescription || ''}</div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    }
                                    if (reportModalType === 'duty') {
                                        if (!cadreMapSelectedUserId) {
                                            return (
                                                <div className="flex flex-col items-center justify-center h-full text-gray-400">
                                                    <ClipboardList className="w-12 h-12 mb-4 opacity-20" />
                                                    <p>請先在左側列表選取人員</p>
                                                </div>
                                            );
                                        }
                                        const user = usersList.find(u => u.id === cadreMapSelectedUserId);
                                        const weekMap = ['日','一','二','三','四','五','六'];
                                        const monthStart = new Date(targetYear, targetMonth, 1, 0, 0, 0);
                                        const monthEnd = new Date(targetYear, targetMonth + 1, 0, 23, 59, 59);
                                        const monthRecords = attendanceList.filter(r => {
                                            if (r.userId !== cadreMapSelectedUserId) return false;
                                            const ts = r.timestamp?.seconds;
                                            if (!ts) return false;
                                            const d = new Date(ts * 1000);
                                            return d >= monthStart && d <= monthEnd;
                                        });
                                        const cardRecords = monthRecords.filter(r => ['late_in','late_out'].includes(r.type));
                                        const byDay = {};
                                        cardRecords.forEach(r => {
                                            const d = new Date(r.timestamp.seconds * 1000);
                                            const day = d.getDate();
                                            byDay[day] = byDay[day] || { ins: [], outs: [], locationName: '' };
                                            if (r.type === 'late_in') byDay[day].ins.push(r);
                                            if (r.type === 'late_out') byDay[day].outs.push(r);
                                            const comm = communities.find(c => String(c.id) === String(r.communityId));
                                            const locName = r.checkInLocationName || (comm ? comm.name : '') || r.address || '';
                                            if (!byDay[day].locationName && locName) byDay[day].locationName = locName;
                                        });
                                        const rows = Object.keys(byDay).map(k => {
                                            const day = Number(k);
                                            const ins = byDay[day].ins.sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                                            const outs = byDay[day].outs.sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                                            const firstIn = ins[0] || null;
                                            const lastOut = outs.length > 0 ? outs[outs.length - 1] : null;
                                            const dateObj = new Date(targetYear, targetMonth, day);
                                            let workStr = '-';
                                            if (firstIn && lastOut) {
                                                const diffMs = (lastOut.timestamp.seconds - firstIn.timestamp.seconds) * 1000;
                                                const actualHours = diffMs / 3600000;
                                                let showHr = true;
                                                const dateStr = `${targetYear}-${String(targetMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                                // 卡班月報表不判定異常，直接顯示實際工時
                                                // 原本有檢查 schedule 並判定未達工時，現在移除
                                                
                                                if (showHr) {
                                                    workStr = `${actualHours.toFixed(1)} hr`;
                                                }
                                            }
                                            const inTimeStr = firstIn ? new Date(firstIn.timestamp.seconds * 1000).toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '-';
                                            const outTimeStr = lastOut ? new Date(lastOut.timestamp.seconds * 1000).toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '-';
                                            return {
                                                day,
                                                week: weekMap[dateObj.getDay()],
                                                inTimeStr,
                                                outTimeStr,
                                                workStr,
                                                location: byDay[day].locationName || '-',
                                                remarks: ''
                                            };
                                        }).sort((a,b) => a.day - b.day);
                                        
                                        return (
                                            <div id="attendance-report" className="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 overflow-x-auto">
                                                <div className="min-w-[720px]">
                                                    <div className="text-center font-bold text-lg text-gray-800 py-1">
                                                        西北保全{user?.title || ''}{user?.name || ''}
                                                    </div>
                                                    <div className="text-center font-bold text-md text-gray-600 pb-3">
                                                        {cadreRecordDate.split('-').slice(0,2).join('-')} 卡班月報表
                                                    </div>
                                                    <div className="grid grid-cols-7 text-xs font-bold text-gray-600 bg-gray-50 rounded-xl">
                                                        <div className="px-3 py-2">日期</div>
                                                        <div className="px-3 py-2">星期</div>
                                                        <div className="px-3 py-2">開始時間</div>
                                                        <div className="px-3 py-2">結束時間</div>
                                                        <div className="px-3 py-2">判定工時</div>
                                                        <div className="px-3 py-2">打卡位置</div>
                                                        <div className="px-3 py-2">備註</div>
                                                    </div>
                                                    <div className="divide-y divide-gray-100">
                                                        {rows.map((row, idx) => (
                                                            <div key={idx} className="grid grid-cols-7 text-sm">
                                                                <div className="px-3 py-2">{String(row.day).padStart(2,'0')}</div>
                                                                <div className="px-3 py-2">{row.week}</div>
                                                                <div className="px-3 py-2">{row.inTimeStr}</div>
                                                                <div className="px-3 py-2">{row.outTimeStr}</div>
                                                                <div className="px-3 py-2">{row.workStr}</div>
                                                                <div className="px-3 py-2">{row.location}</div>
                                                                <div className="px-3 py-2">{row.remarks}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    }
                                    if (reportModalType === 'outing') {
                                        if (!cadreMapSelectedUserId) {
                                            return (
                                                <div className="flex flex-col items-center justify-center h-full text-gray-400">
                                                    <ClipboardList className="w-12 h-12 mb-4 opacity-20" />
                                                    <p>請先在左側列表選取人員</p>
                                                </div>
                                            );
                                        }
                                        const user = usersList.find(u => u.id === cadreMapSelectedUserId);
                                        const weekMap = ['日','一','二','三','四','五','六'];
                                        const monthStart = new Date(targetYear, targetMonth, 1, 0, 0, 0);
                                        const monthEnd = new Date(targetYear, targetMonth + 1, 0, 23, 59, 59);
                                        const monthRecords = attendanceList.filter(r => {
                                            if (r.userId !== cadreMapSelectedUserId) return false;
                                            const ts = r.timestamp?.seconds;
                                            if (!ts) return false;
                                            const d = new Date(ts * 1000);
                                            return d >= monthStart && d <= monthEnd;
                                        });
                                        const outingRecords = monthRecords.filter(r => ['outing_start','outing_arrive','outing_end'].includes(r.type));
                                        
                                        const rows = [];
                                        const recordsByDay = {};
                                        
                                        // Group by day
                                        outingRecords.forEach(r => {
                                            const d = new Date(r.timestamp.seconds * 1000);
                                            const day = d.getDate();
                                            if (!recordsByDay[day]) recordsByDay[day] = [];
                                            recordsByDay[day].push(r);
                                        });

                                        const formatTime = ts => new Date(ts * 1000).toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });

                                        Object.keys(recordsByDay).forEach(dayKey => {
                                            const day = Number(dayKey);
                                            const dayRecs = recordsByDay[dayKey];
                                            
                                            // Sort by time
                                            dayRecs.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                                            
                                            const starts = dayRecs.filter(r => r.type === 'outing_start');
                                            const arrives = dayRecs.filter(r => r.type === 'outing_arrive');
                                            const ends = dayRecs.filter(r => r.type === 'outing_end');
                                            
                                            if (starts.length === 0 && (arrives.length > 0 || ends.length > 0)) {
                                                const firstRec = arrives[0] || ends[0];
                                                const comm = communities.find(c => String(c.id) === String(firstRec.communityId));
                                                const locName = firstRec.checkInLocationName || (comm ? comm.name : '') || firstRec.address || '';
                                                
                                                rows.push({
                                                    day,
                                                    week: weekMap[new Date(targetYear, targetMonth, day).getDay()],
                                                    startStr: '-',
                                                    arriveStr: arrives[0] ? formatTime(arrives[0].timestamp.seconds) : '-',
                                                    endStr: ends.length > 0 ? formatTime(ends[ends.length - 1].timestamp.seconds) : '-',
                                                    location: locName,
                                                    reasonStr: '公出(補)'
                                                });
                                            } else {
                                                starts.forEach((s, idx) => {
                                                    const nextStart = starts[idx + 1];
                                                    const myArrive = arrives.find(a => a.timestamp.seconds > s.timestamp.seconds && (!nextStart || a.timestamp.seconds < nextStart.timestamp.seconds));
                                                    const myEnd = ends.find(e => e.timestamp.seconds > s.timestamp.seconds && (!nextStart || e.timestamp.seconds < nextStart.timestamp.seconds));
                                                    
                                                    const comm = communities.find(c => String(c.id) === String(s.communityId));
                                                    const locName = s.checkInLocationName || (comm ? comm.name : '') || s.address || '';
                                                    
                                                    rows.push({
                                                        day,
                                                        week: weekMap[new Date(targetYear, targetMonth, day).getDay()],
                                                        startStr: formatTime(s.timestamp.seconds),
                                                        arriveStr: myArrive ? formatTime(myArrive.timestamp.seconds) : '-',
                                                        endStr: myEnd ? formatTime(myEnd.timestamp.seconds) : '-',
                                                        location: locName,
                                                        reasonStr: s.outingReason || '公出'
                                                    });
                                                });
                                            }
                                        });
                                        
                                        rows.sort((a, b) => {
                                            if (a.day !== b.day) return a.day - b.day;
                                            return a.startStr.localeCompare(b.startStr);
                                        });
                                        
                                        return (
                                            <div id="attendance-report" className="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 overflow-x-auto">
                                                <div className="min-w-[720px]">
                                                    <div className="text-center font-bold text-lg text-gray-800 py-1">
                                                        西北保全{user?.title || ''}{user?.name || ''}
                                                    </div>
                                                    <div className="text-center font-bold text-md text-gray-600 pb-3">
                                                        {cadreRecordDate.split('-').slice(0,2).join('-')} 外出月報表
                                                    </div>
                                                    <div className="grid grid-cols-7 text-xs font-bold text-gray-600 bg-gray-50 rounded-xl">
                                                        <div className="px-3 py-2">日期</div>
                                                        <div className="px-3 py-2">星期</div>
                                                        <div className="px-3 py-2">外出事由</div>
                                                        <div className="px-3 py-2">外出位置</div>
                                                        <div className="px-3 py-2">外出時間</div>
                                                        <div className="px-3 py-2">抵達時間</div>
                                                        <div className="px-3 py-2">離開時間</div>
                                                    </div>
                                                    <div className="divide-y divide-gray-100">
                                                        {rows.map((row, idx) => (
                                                            <div key={idx} className="grid grid-cols-7 text-sm">
                                                                <div className="px-3 py-2">{String(row.day).padStart(2,'0')}</div>
                                                                <div className="px-3 py-2">{row.week}</div>
                                                                <div className="px-3 py-2">{row.reasonStr}</div>
                                                                <div className="px-3 py-2">{row.location}</div>
                                                                <div className="px-3 py-2">{row.startStr}</div>
                                                                <div className="px-3 py-2">{row.arriveStr}</div>
                                                                <div className="px-3 py-2">{row.endStr}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    }
                                    
                                    const monthRecords = attendanceList.filter(r => {
                                        if (!cadreMapSelectedUserId) return false;
                                        if (r.userId !== cadreMapSelectedUserId) return false;
                                        
                                        const rDate = new Date((r.timestamp?.seconds || 0) * 1000);
                                        return rDate.getFullYear() === targetYear && rDate.getMonth() === targetMonth;
                                    }).sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                                    if (!cadreMapSelectedUserId) {
                                        return (
                                            <div id="attendance-report" className="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 overflow-x-auto">
                                                <div className="min-w-[1200px]">
                                                    <div className="mb-4 print:hidden">
                                                        {(function(){
                                                            const filteredUsers = usersList.filter(u => {
                                                                if (u.name === '蔡總') return false;
                                                                
                                                                if (cadreCompany) {
                                                                    // 1. Resolve Cadre Company to ID
                                                                    const targetComp = companies.find(c => c.name === cadreCompany);
                                                                    
                                                                    // 2. Check for ID Match (Primary)
                                                                    if (targetComp) {
                                                                        const hasIdMatch = (u.companyIds && u.companyIds.includes(targetComp.id)) || 
                                                                                           (u.companyId === targetComp.id);
                                                                        if (hasIdMatch) return true;
                                                                    }
                                                                    
                                                                    // 3. Check for Name Match (Legacy/Fallback)
                                                                    const normalize = (s) => (s || '').replace('公司', '').trim();
                                                                    const uComp = normalize(u.company);
                                                                    const cComp = normalize(cadreCompany);
                                                                    
                                                                    if (uComp === cComp && uComp !== '') return true;
                                                                    
                                                                    return false;
                                                                }
                                                                return true;
                                                            });
                                                            
                                                            return (
                                                                <>
                                                                    <label className="flex items-center gap-2 mb-2 font-bold cursor-pointer text-sm">
                                                                        <input type="checkbox" 
                                                                            checked={reportSelectedUserIds.length > 0 && reportSelectedUserIds.length === filteredUsers.length}
                                                                            onChange={(e) => {
                                                                                if (e.target.checked) setReportSelectedUserIds(filteredUsers.map(u=>u.id));
                                                                                else setReportSelectedUserIds([]);
                                                                            }}
                                                                        />
                                                                        全選 (已選 {reportSelectedUserIds.length} 人)
                                                                    </label>
                                                                    <div className="flex flex-nowrap overflow-x-auto gap-2 border border-gray-200 p-2 rounded-xl bg-gray-50 items-center">
                                                                        {filteredUsers.map(u => (
                                                                            <label key={u.id} className="flex-shrink-0 flex items-center gap-1 text-xs cursor-pointer select-none bg-white px-2 py-1 rounded border border-gray-100 hover:bg-blue-50 whitespace-nowrap">
                                                                                <input type="checkbox"
                                                                                    checked={reportSelectedUserIds.includes(u.id)}
                                                                                    onChange={(e) => {
                                                                                        if (e.target.checked) setReportSelectedUserIds(prev => [...prev, u.id]);
                                                                                        else setReportSelectedUserIds(prev => prev.filter(id => id !== u.id));
                                                                                    }}
                                                                                />
                                                                                {u.name}
                                                                            </label>
                                                                        ))}
                                                                    </div>
                                                                </>
                                                            );
                                                        })()}
                                                    </div>

                                                    <div className="text-center font-bold text-lg text-gray-800 py-1">
                                                        西北保全{cadreCompany}人員
                                                    </div>
                                                    <div className="text-center font-bold text-md text-gray-600 pb-3">
                                                        {cadreRecordDate.split('-').slice(0,2).join('-')} 出勤月報表
                                                    </div>
                                                    
                                                    <div className="grid grid-cols-[80px_repeat(31,minmax(24px,1fr))_repeat(7,32px)_150px] text-[10px] border-b border-r border-gray-300 user-select-none">
                                                        <div className="border-t border-l border-gray-300 bg-gray-100 p-1 flex items-center justify-center font-bold sticky left-0 z-10">姓名</div>
                                                        {Array.from({length: 31}, (_, i) => i+1).map(d => {
                                                            const dateObj = new Date(targetYear, targetMonth, d);
                                                            const weekMap = ['日','一','二','三','四','五','六'];
                                                            const week = weekMap[dateObj.getDay()];
                                                            const isValidDate = dateObj.getMonth() === targetMonth;
                                                            return (
                                                                <div key={d} className={`border-t border-l border-gray-300 ${['六','日'].includes(week) ? 'bg-orange-50' : 'bg-gray-100'} p-1 flex flex-col items-center justify-center font-bold`}>
                                                                    {isValidDate ? (
                                                                        <>
                                                                            <span>{d}</span>
                                                                            <span className="text-[8px]">({week})</span>
                                                                        </>
                                                                    ) : (
                                                                        <span className="text-gray-300">-</span>
                                                                    )}
                                                                </div>
                                                            );
                                                        })}
                                                        {['出勤<br/>工時','請假<br/>時數','曠職<br/>日數','遲到<br/>次數','早退<br/>次數','外出<br/>次數','卡班<br/>工時'].map(h => (
                                                            <div key={h} className="border-t border-l border-gray-300 bg-gray-100 p-1 flex items-center justify-center font-bold text-center leading-tight">
                                                                <span dangerouslySetInnerHTML={{ __html: h }}></span>
                                                            </div>
                                                        ))}
                                                        <div className="border-t border-l border-gray-300 bg-gray-100 p-1 flex items-center justify-center font-bold text-center leading-tight">備註</div>

                                                        {(function(){
                                                            // Calculate data for selected users
                                                            const targetUsers = usersList.filter(u => reportSelectedUserIds.includes(u.id));
                                                            const monthStart = new Date(targetYear, targetMonth, 1, 0, 0, 0);
                                                            const monthEnd = new Date(targetYear, targetMonth + 1, 0, 23, 59, 59);
                                                            
                                                            const allMonthRecords = attendanceList.filter(r => {
                                                                const ts = r.timestamp?.seconds;
                                                                if (!ts) return false;
                                                                const d = new Date(ts * 1000);
                                                                return d >= monthStart && d <= monthEnd;
                                                            });
                                                            
                                                            const allMonthLeaves = leavesList.filter(l => {
                                                                // Simple leave check (intersection)
                                                                // Reuse parseLeaveRange logic if possible or inline simplified version
                                                                return l.approvalStatus === 'approved'; // Only count approved?
                                                            });

                                                            return targetUsers.map(u => {
                                                                const currentRemarks = [];
                                                                const uRecords = allMonthRecords.filter(r => r.userId === u.id);
                                                                const uLeaves = allMonthLeaves.filter(r => r.userId === u.id);
                                                                // Pre-filter schedules for this user from the bulk list
                                                                const uSchedules = schedulesList.filter(s => s.userId === u.id);
                                                                
                                                                let attendanceDays = 0;
                                                                let totalHours = 0;
                                                                let restDays = 0;
                                                                let leaveDays = 0;
                                                                let leaveHours = 0;
                                                                let absentDays = 0;
                                                                let lateCount = 0;
                                                                let earlyCount = 0;
                                                                let outingCount = 0;
                                                                let cardDays = 0;
                                                                let cardHours = 0;

                                                                const dailyCells = Array.from({length: 31}, (_, i) => i+1).map(d => {
                                                                    const dateObj = new Date(targetYear, targetMonth, d);
                                                                    if (dateObj.getMonth() !== targetMonth) return <div key={d} className="border-t border-l border-gray-300 bg-gray-50"></div>;
                                                                    
                                                                    const dateStr = `${targetYear}-${String(targetMonth + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                                                    const dayStart = new Date(targetYear, targetMonth, d, 0, 0, 0);
                                                                    const dayEnd = new Date(targetYear, targetMonth, d, 23, 59, 59);
                                                                    const todayStart = new Date();
                                                                    todayStart.setHours(0,0,0,0);
                                                                    
                                                                    // 1. Check Records
                                                                    const dayRecords = uRecords.filter(r => {
                                                                        const rd = new Date(r.timestamp.seconds * 1000);
                                                                        return rd >= dayStart && rd <= dayEnd;
                                                                    }).sort((a,b) => a.timestamp.seconds - b.timestamp.seconds);
                                                                    
                                                                    const isV = dayRecords.length > 0;

                                                                    // Late/Early calculation moved to after schedule and leave determination
                                                                    
                                                                    // 2. Check Schedule
                                                                    // Prioritize userSchedules for the selected user (most reliable), otherwise use bulk list
                                                                    let schedule = null;
                                                                    if (u.id === cadreMapSelectedUserId && userSchedules[dateStr]) {
                                                                        schedule = userSchedules[dateStr];
                                                                    } else {
                                                                        schedule = uSchedules.find(s => s.date === dateStr);
                                                                    }
                                                                    
                                                                    // National Holidays 2026 (From Schedule Reference)
                                                                    const nationalHolidays = [
                                                                        '2025-01-01','2025-01-25','2025-01-26','2025-01-27','2025-01-28','2025-01-29','2025-01-30','2025-01-31','2025-02-01','2025-02-02',
                                                                        '2025-02-28','2025-04-03','2025-04-04','2025-04-05','2025-04-06','2025-05-01','2025-05-30','2025-05-31','2025-06-01',
                                                                        '2025-10-04','2025-10-05','2025-10-06','2025-10-10','2025-10-11','2025-10-12','2025-12-25',
                                                                        '2026-01-01','2026-02-14','2026-02-15','2026-02-16','2026-02-17','2026-02-18','2026-02-19','2026-02-20','2026-02-21','2026-02-22',
                                                                        '2026-02-27','2026-02-28','2026-03-01','2026-04-03','2026-04-04','2026-04-05','2026-04-06','2026-05-01',
                                                                        '2026-06-19','2026-06-20','2026-06-21','2026-09-25','2026-09-26','2026-09-27','2026-10-09','2026-10-10','2026-10-11','2026-12-25'
                                                                    ];
                                                                    const isNationalHoliday = nationalHolidays.includes(dateStr);

                                                                    // Determine if Duty/Card day
                                                                    let isCardDay = false;
                                                                    let isDutyDay = false;
                                                                    let isWorkDay = false;
                                                                    let isOff = false;
                                                                    let isHoliday = false;

                                                                    if (schedule) {
                                                                        if (schedule.type === 'card') isCardDay = true;
                                                                        else if (schedule.type === 'duty') isDutyDay = true;
                                                                        else if (['work'].includes(schedule.type)) isWorkDay = true;
                                                                        else if (schedule.type === 'off') isOff = true;
                                                                        else if (schedule.type === 'holiday') isHoliday = true;
                                                                    } else {
                                                                        // Fallback logic
                                                                        const w = dateObj.getDay();
                                                                        
                                                                        if (isNationalHoliday) {
                                                                            isHoliday = true;
                                                                        } else if (w === 0 || w === 6) {
                                                                            // Saturday (6) and Sunday (0) are Holidays
                                                                            isHoliday = true;
                                                                        } else if (w === 5) {
                                                                            // Friday (5) is default Off day (特休) if no schedule
                                                                            isOff = true;
                                                                        } else {
                                                                            // Mon-Thu are Work days (unless scheduled otherwise)
                                                                            isWorkDay = true;
                                                                        }
                                                                    }
                                                                    
                                                                    // Hours Calculation
                                                                    let dayHours = 0;
                                                                    let cardCalcHours = 0;
                                                                    let regularCalcHours = 0;
                                                                    
                                                                    // Split records into Card Shift (late_in/late_out) and Regular
                                                                    // Card Shift Report Logic: uses late_in and late_out types
                                                                    const cardShiftRecords = dayRecords.filter(r => ['late_in', 'late_out'].includes(r.type));
                                                                    const regularRecords = dayRecords.filter(r => !['late_in', 'late_out'].includes(r.type));

                                                                    // 1. Calculate Card Shift Hours (Replicating Card Shift Report logic)
                                                                    if (cardShiftRecords.length > 0) {
                                                                        const ins = cardShiftRecords.filter(r => r.type === 'late_in').sort((a,b) => a.timestamp.seconds - b.timestamp.seconds);
                                                                        const outs = cardShiftRecords.filter(r => r.type === 'late_out').sort((a,b) => a.timestamp.seconds - b.timestamp.seconds);
                                                                        
                                                                        if (ins.length > 0 && outs.length > 0) {
                                                                            const firstIn = ins[0];
                                                                            const lastOut = outs[outs.length - 1];
                                                                            if (lastOut.timestamp.seconds > firstIn.timestamp.seconds) {
                                                                                cardCalcHours = (lastOut.timestamp.seconds - firstIn.timestamp.seconds) / 3600;
                                                                            }
                                                                        }
                                                                    }

                                                                    // 2. Calculate Regular Hours
                                                                    if (regularRecords.length > 0) {
                                                                         const first = regularRecords[0];
                                                                         const last = regularRecords[regularRecords.length-1];
                                                                         if (first && last && first !== last) {
                                                                             regularCalcHours = (last.timestamp.seconds - first.timestamp.seconds) / 3600;
                                                                         }
                                                                    }

                                                                    // Determined Hours Logic (判定工時)
                                                                    // For Work/Duty days: If Actual > Scheduled, use Scheduled. Else use Actual.
                                                                    if ((isWorkDay || isDutyDay) && schedule && schedule.startTime && schedule.endTime) {
                                                                        const [sH, sM] = schedule.startTime.split(':').map(Number);
                                                                        const [eH, eM] = schedule.endTime.split(':').map(Number);
                                                                        
                                                                        let sDate = new Date(dayStart);
                                                                        sDate.setHours(sH, sM, 0, 0);
                                                                        
                                                                        let eDate = new Date(dayStart);
                                                                        eDate.setHours(eH, eM, 0, 0);
                                                                        
                                                                        // Handle overnight
                                                                        if (eDate < sDate) {
                                                                            eDate.setDate(eDate.getDate() + 1);
                                                                        }
                                                                        
                                                                        const scheduledHours = (eDate - sDate) / (1000 * 60 * 60);
                                                                        
                                                                        if (regularCalcHours > scheduledHours) {
                                                                            regularCalcHours = scheduledHours;
                                                                        }
                                                                    }

                                                                    // Combined dayHours for display (if needed, but usually we use specific hours)
                                                                    dayHours = regularCalcHours; // Default cell display uses regular hours

                                                                    // Update Totals
                                                                    // Always count Off days (restDays) based on schedule type, regardless of attendance
                                                                    if (isOff) {
                                                                        restDays++;
                                                                    }

                                                                    if (cardCalcHours > 0) {
                                                                        cardDays++;
                                                                        cardHours += cardCalcHours;
                                                                    }

                                                                        if (regularCalcHours > 0) {
                                                                         if (isDutyDay) {
                                                                             attendanceDays++; 
                                                                             totalHours += Number(regularCalcHours.toFixed(1));
                                                                         } else if (isWorkDay) {
                                                                             attendanceDays++;
                                                                             totalHours += Number(regularCalcHours.toFixed(1));
                                                                         }
                                                                         // Off/Holiday regular hours are excluded from totals
                                                                    }
                                                                    
                                                                    // 3. Check Leave
                                                                    const getLeaveRange = (l) => {
                                                                        let s, e;
                                                                        
                                                                        const parseDate = (d, t) => {
                                                                            if (!d) return null;
                                                                            if (typeof d === 'object' && d.seconds) {
                                                                                return new Date(d.seconds * 1000);
                                                                            }
                                                                            if (d instanceof Date) return d;

                                                                            const sd = String(d).replace(/\//g, '-');
                                                                            // Check if it's already a full datetime (has T or space)
                                                                            if (sd.includes('T') || sd.includes(' ')) {
                                                                                return new Date(sd.replace('T', ' '));
                                                                            }
                                                                            
                                                                            if (t) return new Date(sd + 'T' + t);
                                                                            return new Date(sd);
                                                                        };

                                                                        if (l.leaveStartDate) {
                                                                            s = parseDate(l.leaveStartDate, l.leaveStartTime || '00:00');
                                                                        } else if (l.startDate) {
                                                                            s = parseDate(l.startDate);
                                                                        } else if (l.leaveDate) {
                                                                            s = parseDate(l.leaveDate, l.leaveTime || '00:00');
                                                                        }
                                                                        
                                                                        if (l.leaveEndDate) {
                                                                            e = parseDate(l.leaveEndDate, l.leaveEndTime || '23:59');
                                                                        } else if (l.endDate) {
                                                                            e = parseDate(l.endDate);
                                                                        } else if (s) {
                                                                            e = new Date(s.getFullYear(), s.getMonth(), s.getDate(), 23, 59, 59);
                                                                        }
                                                                        
                                                                        if (s && e && e < s) e = new Date(s.getFullYear(), s.getMonth(), s.getDate(), 23, 59, 59);
                                                                        
                                                                        return { s, e };
                                                                    };
                                                                    
                                                                    const activeLeave = uLeaves.find(l => {
                                                                         const { s, e } = getLeaveRange(l);
                                                                         if (!s || !e || isNaN(s) || isNaN(e)) return false;
                                                                         return s <= dayEnd && e >= dayStart;
                                                                    });
                                                                    let leaveObj = activeLeave || null;
                                                                    if (!leaveObj && Array.isArray(userLeaveRequests) && userLeaveRequests.length > 0) {
                                                                        leaveObj = userLeaveRequests.find(l => {
                                                                            if (l.approvalStatus !== 'approved') return false;
                                                                            const { s, e } = getLeaveRange(l);
                                                                            if (!s || !e || isNaN(s) || isNaN(e)) return false;
                                                                            return s <= dayEnd && e >= dayStart;
                                                                        }) || null;
                                                                    }

                                                                    // Check Cadre Signatures if still no leave found
                                                                    if (!leaveObj && cadreSignatures && cadreSignatures.length > 0) {
                                                                        const sig = cadreSignatures.find(s => {
                                                                            if (s.userId !== u.id) return false;
                                                                            if (s.type !== '請假' && s.type !== '公出') return false;
                                                                            if (s.status !== 'approved') return false;
                                                                            
                                                                            const regex = /(\d{4})[-/](\d{1,2})[-/](\d{1,2})/g;
                                                                            let match;
                                                                            while ((match = regex.exec(s.content || '')) !== null) {
                                                                                const y = parseInt(match[1]);
                                                                                const m = parseInt(match[2]) - 1;
                                                                                const da = parseInt(match[3]);
                                                                                if (y === targetYear && m === targetMonth && da === d) return true;
                                                                            }
                                                                            return false;
                                                                        });

                                                                        if (sig) {
                                                                            leaveObj = {
                                                                                leaveReason: sig.type, 
                                                                                startDate: new Date(targetYear, targetMonth, d),
                                                                                endDate: new Date(targetYear, targetMonth, d)
                                                                            };
                                                                            // Try to extract time from content
                                                                            const timeRegex = /(\d{1,2}:\d{2})\s*[~-]\s*(\d{1,2}:\d{2})/;
                                                                            const timeMatch = (sig.content || '').match(timeRegex);
                                                                            if (timeMatch) {
                                                                                leaveObj.leaveStartTime = timeMatch[1];
                                                                                leaveObj.leaveEndTime = timeMatch[2];
                                                                                leaveObj.leaveDate = `${targetYear}-${String(targetMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                                                                
                                                                                // Refine startDate/endDate with time
                                                                                const [sh, sm] = timeMatch[1].split(':').map(Number);
                                                                                const [eh, em] = timeMatch[2].split(':').map(Number);
                                                                                leaveObj.startDate.setHours(sh, sm, 0, 0);
                                                                                leaveObj.endDate.setHours(eh, em, 0, 0);
                                                                            } else {
                                                                                // Default to full day if no time found
                                                                                leaveObj.startDate.setHours(0,0,0,0);
                                                                                leaveObj.endDate.setHours(23,59,59,999);
                                                                            }
                                                                        }
                                                                    }
                                                                    if (leaveObj && leaveObj.leaveReason === '公出') {
                                                                        outingCount++;
                                                                    }
                                                                    
                                                                    // Add actual outing records from attendance
                                                                    const actualOutings = dayRecords.filter(r => r.type === 'outing_start').length;
                                                                    outingCount += actualOutings;

                                                                    // Late/Early Logic (After Schedule & Leave determination)
                                                                    if ((isWorkDay || isDutyDay) && !isHoliday && !isOff && !leaveObj) {
                                                                        if (schedule) {
                                                                            // Late Count
                                                                            if (schedule.startTime) {
                                                                                const [sh, sm] = schedule.startTime.split(':').map(Number);
                                                                                const sTime = new Date(dayStart);
                                                                                sTime.setHours(sh, sm + 10, 0, 0); // +10 mins buffer
                                                                                
                                                                                const firstIn = dayRecords.find(r => ['in', 'late_in'].includes(r.type));
                                                                                if (firstIn) {
                                                                                    const inTime = new Date(firstIn.timestamp.seconds * 1000);
                                                                                    if (inTime > sTime) lateCount++;
                                                                                }
                                                                            }
                                                                            
                                                                            // Early Count
                                                                            if (schedule.endTime) {
                                                                                const [eh, em] = schedule.endTime.split(':').map(Number);
                                                                                let eTime = new Date(dayStart);
                                                                                eTime.setHours(eh, em, 0, 0);
                                                                                if (eTime < dayStart) eTime.setDate(eTime.getDate() + 1); // Handle overnight logic if needed, usually same day end
                                                                                // Check if end time is actually next day (e.g. 02:00)
                                                                                const [sh] = (schedule.startTime || '00:00').split(':').map(Number);
                                                                                if (eh < sh) {
                                                                                     // eTime is already handled above if we constructed it correctly? 
                                                                                     // Actually if eTime < sTime, it's next day.
                                                                                     // Let's use simple logic: if endTime is small and startTime is large.
                                                                                     eTime = new Date(dayStart);
                                                                                     eTime.setHours(eh, em, 0, 0);
                                                                                     if (eh < sh) eTime.setDate(eTime.getDate() + 1);
                                                                                }

                                                                                const lastOut = [...dayRecords].reverse().find(r => ['out', 'early_out'].includes(r.type));
                                                                                if (lastOut) {
                                                                                    const outTime = new Date(lastOut.timestamp.seconds * 1000);
                                                                                    if (outTime < eTime) earlyCount++;
                                                                                }
                                                                            }
                                                                        }
                                                                    }


                                                                    // Determine Content
                                                                    let cellContent = '';
                                                                    let bgClass = 'bg-white';
                                                                    let fontSizeClass = 'text-xs';
                                                                    
                                                                    if (leaveObj) {
                                                                        fontSizeClass = 'text-xs';
                                                                        bgClass = 'bg-yellow-50';
                                                                        
                                                                        let h = 0;
                                                                        if (leaveObj.leaveReason !== '公出') {
                                                                            leaveDays++;
                                                                            const { s, e } = getLeaveRange(leaveObj);
                                                                            if (s && e) {
                                                                                let os = s > dayStart ? s : dayStart;
                                                                                let oe = e < dayEnd ? e : dayEnd;
                                                                                
                                                                                let scheduledDuration = 0;
                                                                                if (schedule && (schedule.type === 'work' || schedule.type === 'duty') && schedule.startTime && schedule.endTime) {
                                                                                    const [sh, sm] = String(schedule.startTime).split(':').map(Number);
                                                                                    const [eh, em] = String(schedule.endTime).split(':').map(Number);
                                                                                    
                                                                                    let ss = new Date(dayStart);
                                                                                    ss.setHours(sh, sm, 0, 0);
                                                                                    let se = new Date(dayStart);
                                                                                    se.setHours(eh, em, 0, 0);
                                                                                    
                                                                                    if (se < ss) se.setDate(se.getDate() + 1);
                                                                                    
                                                                                    scheduledDuration = (se - ss) / 3600000;

                                                                                    if (os < ss) os = ss;
                                                                                    if (oe > se) oe = se;
                                                                                }
                                                                                
                                                                                h = Math.max(0, (oe - os) / 3600000);
                                                                                h = Number(h.toFixed(1));
                                                                                leaveHours += h;

                                                                                // Cap regularCalcHours based on effective schedule (User Request)
                                                                                if (scheduledDuration > 0) {
                                                                                    const effectiveScheduledHours = Math.max(0, scheduledDuration - h);
                                                                                    if (regularCalcHours > effectiveScheduledHours) {
                                                                                        const oldVal = Number(regularCalcHours.toFixed(1));
                                                                                        regularCalcHours = effectiveScheduledHours;
                                                                                        const newVal = Number(regularCalcHours.toFixed(1));
                                                                                        
                                                                                        if (isDutyDay || isWorkDay) {
                                                                                            if (oldVal > 0) {
                                                                                                totalHours = Number((totalHours - oldVal + newVal).toFixed(1));
                                                                                            } else if (newVal > 0) {
                                                                                                totalHours = Number((totalHours + newVal).toFixed(1));
                                                                                            }
                                                                                        }
                                                                                        // Also update dayHours for display
                                                                                        dayHours = regularCalcHours;
                                                                                    }
                                                                                }
                                                                            }
                                                                            
                                                                            if (h > 0) {
                                                                                currentRemarks.push(`${d}日 請假${h}hr`);
                                                                            } else {
                                                                                currentRemarks.push(`${d}日 請假`);
                                                                            }
                                                                        } else {
                                                                            currentRemarks.push(`${d}日 公出`);
                                                                        }
                                                                        
                                                                        if (regularCalcHours > 0) {
                                                                            const workVal = regularCalcHours.toFixed(1);
                                                                            cellContent = workVal.endsWith('.0') ? workVal.slice(0, -2) : workVal;
                                                                        } else {
                                                                            if (isCardDay || cardCalcHours > 0 || cardShiftRecords.length > 0) cellContent = 'V';
                                                                            else if (isWorkDay) cellContent = '上班';
                                                                            else if (isDutyDay) cellContent = '值班';
                                                                            else if (isOff) cellContent = '公休';
                                                                            else if (isHoliday) cellContent = '假日';
                                                                            else cellContent = '上班';
                                                                        }
                                                                    } else if (isV) {
                                                                        // Attendance logic
                                                                        if (isCardDay || cardCalcHours > 0 || cardShiftRecords.length > 0) {
                                                                            cellContent = 'V';
                                                                        } else if (isHoliday) {
                                                                             // If holiday and attended, do NOT show hours as per request
                                                                             // Show '假日' or maybe just empty/special indicator?
                                                                             // Request: "若為假日則當日上班不予顯示工時"
                                                                             // Let's keep it as '假日' to indicate the day type, even if attended.
                                                                             // Or maybe show nothing? But usually we want to know it's a holiday.
                                                                             // Let's stick to showing '假日' but maybe with a different style or just '假日'
                                                                             // Actually, if they worked on holiday, usually it's overtime.
                                                                             // But user said "do not show hours".
                                                                             // If we show '假日', it covers the request.
                                                                             cellContent = '假日';
                                                                             fontSizeClass = 'text-[10px] scale-90';
                                                                             bgClass = 'bg-orange-50';
                                                                        } else if (isOff) {
                                                                            // If Off day and attended, similar logic?
                                                                            // User didn't explicitly say for Off days, but usually grouped with Holiday.
                                                                            // But request specifically said "若為假日...".
                                                                            // Let's assume Off days (特休) also follow this or maybe show hours?
                                                                            // Previous request said "如非假日或特休 只顯示上班或值班 工時".
                                                                            // So Off day should also NOT show hours.
                                                                            cellContent = '公休';
                                                                            fontSizeClass = 'text-[10px] scale-90';
                                                                            bgClass = 'bg-gray-50';
                                                                            // restDays already incremented above
                                                                        } else {
                                                                            // Show hours for Work, Duty (if attended and not holiday/off)
                                                                            // Use dayHours directly (already determined by logic above)
                                                                            const displayVal = dayHours.toFixed(1);
                                                                            cellContent = displayVal.endsWith('.0') ? displayVal.slice(0, -2) : displayVal;
                                                                        }
                                                                    } else {
                                                                        // No Attendance
                                                                        if (isDutyDay) {
                                                                            // Duty day but no attendance? Usually shouldn't happen if planned.
                                                                            // Request: "當日值班則應為'值班'(不顯示公休)"
                                                                            // If scheduled as Duty, it overrides Off/Holiday logic in classification above.
                                                                            // So isOff/isHoliday would be false if isDutyDay is true (based on current logic).
                                                                            // Wait, let's check classification logic.
                                                                            // if (schedule) ...
                                                                            // If schedule.type is duty, isDutyDay=true, others false.
                                                                            // So it won't be Off/Holiday.
                                                                            // But if NO schedule, fallback logic might set isOff/isHoliday.
                                                                            // If fallback sets isOff, but we want it to be Duty? 
                                                                            // No, if it's Duty, it must come from schedule (or user needs to add schedule).
                                                                            // Assuming Duty is always from schedule.
                                                                            
                                                                            // If isDutyDay is true, and no attendance (isV false).
                                                                            // Should we show '值班' or '曠職'?
                                                                            // Usually if duty and no show -> Absent.
                                                                            // But maybe user just wants to see the schedule label if future/no data?
                                                                            // "當日值班則應為'值班'(不顯示公休)" -> This might refer to the LABEL when there IS attendance or simply the day type.
                                                                            // If there IS attendance (isV), we showed hours above (unless Card).
                                                                            // If user wants '值班' text instead of hours for Duty?
                                                                            // "當日值班則應為'值班'(不顯示公休)"
                                                                            // This sounds like if a day is BOTH Duty and (Holiday/Off), Duty takes precedence.
                                                                            // My current logic: if schedule is Duty, isDutyDay=true, isOff=false. So '公休' won't show.
                                                                            // So this is already handled IF duty is scheduled.
                                                                            
                                                                            // However, if the user means: "If I worked on a Duty day, show '值班' instead of hours?"
                                                                            // Re-reading: "div 當日值班則應為'值班'(不顯示公休)"
                                                                            // Context: User clicked on '公休' cell.
                                                                            // Maybe that day WAS a duty day but showed '公休'?
                                                                            // That implies schedule was missing or fallback took over.
                                                                            // If schedule is 'duty', my code sets isDutyDay=true.
                                                                            // And fallback is skipped.
                                                                            // So '公休' shouldn't appear.
                                                                            
                                                                            // UNLESS: isDutyDay is true, but isV is false.
                                                                            // Then it goes to 'else' block.
                                                                            // Inside else: if (isOff) ... else if (isHoliday) ... else if (isWorkDay || isDutyDay) ...
                                                                            // Ah, if isDutyDay is true, it falls to the last block -> '曠職' if past.
                                                                            // It won't show '公休'.
                                                                            
                                                                            // Wait, maybe the user means: On a Duty day, don't show '公休' text even if it's a weekend?
                                                                            // Yes, my logic does that.
                                                                            
                                                                            // Let's assume the user wants to see '值班' text explicitly if it is a Duty day and NO attendance (instead of Absent? or just label?).
                                                                            // Or if attended, show '值班' instead of hours?
                                                                            // Previous request: "只顯示上班或值班 工時". So Duty should show hours.
                                                                            
                                                                            // Let's look at "div 當日值班則應為'值班'(不顯示公休)" again.
                                                                            // Maybe the user wants the cell to say '值班' if it is a duty day?
                                                                            // But we just enabled hours for duty.
                                                                            // Maybe for the header or specific state?
                                                                            
                                                                            // Let's strictly follow "若為假日則當日上班不予顯示工時".
                                                                            // Done above (isHoliday check inside isV).
                                                                            
                                                                            // "當日值班則應為'值班'(不顯示公休)"
                                                                            // Likely case: It's a weekend (normally 公休), but user is scheduled for Duty.
                                                                            // User wants to ensure it doesn't say '公休'.
                                                                            // My code: if schedule='duty', isOff=false. So it won't say '公休'.
                                                                            // But if no attendance, it might say '曠職'.
                                                                            // Maybe user wants it to say '值班' if no attendance yet (future) or just as a label?
                                                                            // Or if attended, maybe show '值班' label? But user asked for hours on duty before.
                                                                            // Contradiction? "只顯示上班或值班 工時" vs "當日值班則應為'值班'".
                                                                            // Maybe "值班" refers to the day type label when NO attendance?
                                                                            
                                                                            // Let's ensure if isDutyDay && !isV, we show '值班' instead of '曠職' or nothing, if not past?
                                                                            // Or maybe just show '值班' text if it is duty day?
                                                                            
                                                                            // Let's add a check: if isDutyDay and !isV.
                                                                            cellContent = '值班';
                                                                            fontSizeClass = 'text-[10px] scale-90';
                                                                            // But if past and no V, is it Absent?
                                                                            if (dateObj < todayStart) {
                                                                                 cellContent = '曠職';
                                                                                 fontSizeClass = 'text-[10px] scale-90 text-red-500';
                                                                                 absentDays++;
                                                                                 bgClass = 'bg-red-50';
                                                                            }
                                                                        } else if (isOff) {
                                                                            cellContent = '公休';
                                                                            fontSizeClass = 'text-[10px] scale-90'; 
                                                                            // restDays already incremented above
                                                                            bgClass = 'bg-gray-50';
                                                                        } else if (isHoliday) {
                                                                            cellContent = '假日';
                                                                            fontSizeClass = 'text-[10px] scale-90'; 
                                                                            // restDays++; 
                                                                            bgClass = 'bg-orange-50';
                                                                        } else if (isWorkDay || isCardDay) {
                                                                            if (dateObj < todayStart && !isV) {
                                                                                cellContent = '曠職';
                                                                                fontSizeClass = 'text-[10px] scale-90 text-red-500'; 
                                                                                absentDays++;
                                                                                bgClass = 'bg-red-50';
                                                                            }
                                                                        }
                                                                    }
                                                                    
                                                                    return (
                                                                        <div key={d} className={`border-t border-l border-gray-300 p-1 flex items-center justify-center font-bold ${fontSizeClass} ${bgClass}`}>
                                                                            {cellContent}
                                                                        </div>
                                                                    );
                                                                });

                                                                return (
                                                                    <React.Fragment key={u.id}>
                                                                        <div className="border-t border-l border-gray-300 p-1 flex items-center justify-center font-bold bg-white sticky left-0 z-10 text-xs">{u.name}</div>
                                                                        {dailyCells}
                                                                        <div className="border-t border-l border-gray-300 p-1 flex items-center justify-center text-xs">{totalHours.toFixed(1)}</div>
                                                                        <div className="border-t border-l border-gray-300 p-1 flex items-center justify-center text-xs">{leaveHours.toFixed(1)}</div>
                                                                        <div className="border-t border-l border-gray-300 p-1 flex items-center justify-center text-xs text-red-500">{absentDays}</div>
                                                                        <div className="border-t border-l border-gray-300 p-1 flex items-center justify-center text-xs text-orange-500">{lateCount}</div>
                                                                        <div className="border-t border-l border-gray-300 p-1 flex items-center justify-center text-xs text-orange-500">{earlyCount}</div>
                                                                        <div className="border-t border-l border-gray-300 p-1 flex items-center justify-center text-xs text-blue-500 cursor-pointer hover:bg-blue-50" onClick={() => { setReportModalType('outing'); setCadreMapSelectedUserId(u.id); setReportModalOpen(true); }}>{outingCount}</div>
                                                                        <div className="border-t border-l border-gray-300 p-1 flex items-center justify-center text-xs">{cardHours.toFixed(1)}</div>
                                                                        <div className="border-t border-l border-gray-300 p-1 flex items-center justify-start text-[10px] leading-tight px-2 whitespace-pre-wrap">{currentRemarks.join('\n')}</div>
                                                                    </React.Fragment>
                                                                );
                                                            });
                                                        })()}
                                                    </div>
                                                </div>
                                                <style>{`
                                                    @page { size: A4 landscape; margin: 10mm; }
                                                    @media print {
                                                        #attendance-report .min-w-\\[1200px\\] { min-width: auto; width: 100%; }
                                                        #attendance-report { margin-top: 0 !important; }
                                                    }
                                                `}</style>
                                            </div>
                                        );
                                    }

                                    const user = usersList.find(u => u.id === cadreMapSelectedUserId);
                                    const daysInMonth = new Date(targetYear, targetMonth + 1, 0).getDate();
                                    const weekMap = ['日','一','二','三','四','五','六'];
                                    const holidays = [
                                        '2025-01-01','2025-01-25','2025-01-26','2025-01-27','2025-01-28','2025-01-29','2025-01-30','2025-01-31','2025-02-01','2025-02-02',
                                        '2025-02-28','2025-04-03','2025-04-04','2025-04-05','2025-04-06','2025-05-01','2025-05-30','2025-05-31','2025-06-01',
                                        '2025-10-04','2025-10-05','2025-10-06','2025-10-10','2025-10-11','2025-10-12','2025-12-25',
                                        '2026-01-01','2026-02-14','2026-02-15','2026-02-16','2026-02-17','2026-02-18','2026-02-19','2026-02-20','2026-02-21','2026-02-22',
                                        '2026-02-27','2026-02-28','2026-03-01','2026-04-03','2026-04-04','2026-04-05','2026-04-06','2026-05-01',
                                        '2026-06-19','2026-06-20','2026-06-21','2026-09-25','2026-09-26','2026-09-27','2026-10-09','2026-10-10','2026-10-11','2026-12-25'
                                    ];
                                    
                                    const dayRows = [];
                                    const getLogicalDayDate = (recordDate, isNight) => {
                                        const d = new Date(recordDate);
                                        if (isNight && d.getHours() < 12) {
                                            d.setDate(d.getDate() - 1);
                                        }
                                        return d;
                                    };
                                    for (let day = 1; day <= daysInMonth; day++) {
                                        const dayStart = new Date(targetYear, targetMonth, day, 0, 0, 0);
                                        const dayEnd = new Date(targetYear, targetMonth, day, 23, 59, 59);
                                        const records = monthRecords.filter(r => {
                                            const rawDate = new Date((r.timestamp?.seconds || 0) * 1000);
                                            const isNight = !!r.isNightShift;
                                            const logicalDate = getLogicalDayDate(rawDate, isNight);
                                            return logicalDate >= dayStart && logicalDate <= dayEnd;
                                        });
                                        
                                        const sortByTimestamp = (a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0);
                                        const getFirstInLastOut = recs => {
                                            const ins = recs.filter(r => r.type === 'in').sort(sortByTimestamp);
                                            const outs = recs.filter(r => r.type === 'out').sort(sortByTimestamp);
                                            return {
                                                firstIn: ins[0],
                                                lastOut: outs.length > 0 ? outs[outs.length - 1] : null
                                            };
                                        };
                                        
                                        const dayRecords = records.filter(r => !r.isNightShift);
                                        const nightRecords = records.filter(r => r.isNightShift);
                                        
                                        const { firstIn, lastOut } = getFirstInLastOut(records);
                                        const { firstIn: firstInDay, lastOut: lastOutDay } = getFirstInLastOut(dayRecords);
                                        const { firstIn: firstInNight, lastOut: lastOutNight } = getFirstInLastOut(nightRecords);
                                        
                                        const hasOuting = records.some(r => (r.type || '').startsWith('outing'));
                                        const hasDuty = records.some(r => (r.type || '').startsWith('late'));
                                        
                                        let hasApprovedLeave = false;
                                        let leaveHoursForDay = 0;
                                        
                                        const getLeaveRange = (l) => {
                                            let s;
                                            let e;
                                            
                                            const parseDate = (d, t) => {
                                                if (!d) return null;
                                                if (typeof d === 'object' && d.seconds) {
                                                    return new Date(d.seconds * 1000);
                                                }
                                                if (d instanceof Date) return d;
                                                
                                                const sd = String(d).replace(/\//g, '-');
                                                if (sd.includes('T') || sd.includes(' ')) {
                                                    return new Date(sd.replace('T', ' '));
                                                }
                                                if (t) return new Date(sd + 'T' + t);
                                                return new Date(sd);
                                            };
                                            
                                            if (l.leaveStartDate) {
                                                s = parseDate(l.leaveStartDate, l.leaveStartTime || '00:00');
                                            } else if (l.startDate) {
                                                s = parseDate(l.startDate);
                                            } else if (l.leaveDate) {
                                                s = parseDate(l.leaveDate, l.leaveTime || '00:00');
                                            }
                                            
                                            if (l.leaveEndDate) {
                                                e = parseDate(l.leaveEndDate, l.leaveEndTime || '23:59');
                                            } else if (l.endDate) {
                                                e = parseDate(l.endDate);
                                            } else if (s) {
                                                e = new Date(s.getFullYear(), s.getMonth(), s.getDate(), 23, 59, 59);
                                            }
                                            
                                            if (s && e && e < s) {
                                                e = new Date(s.getFullYear(), s.getMonth(), s.getDate(), 23, 59, 59);
                                            }
                                            
                                            return { s, e };
                                        };
                                        
                                        let leaveObj = null;
                                        
                                        if (Array.isArray(leavesList) && leavesList.length > 0) {
                                            const uLeaves = leavesList.filter(l => l.userId === cadreMapSelectedUserId && l.approvalStatus === 'approved');
                                            leaveObj = uLeaves.find(l => {
                                                const { s, e } = getLeaveRange(l);
                                                if (!s || !e || isNaN(s) || isNaN(e)) return false;
                                                return s <= dayEnd && e >= dayStart;
                                            }) || null;
                                        }
                                        
                                        if (!leaveObj && Array.isArray(userLeaveRequests) && userLeaveRequests.length > 0) {
                                            leaveObj = userLeaveRequests.find(l => {
                                                if (l.approvalStatus !== 'approved') return false;
                                                const { s, e } = getLeaveRange(l);
                                                if (!s || !e || isNaN(s) || isNaN(e)) return false;
                                                return s <= dayEnd && e >= dayStart;
                                            }) || null;
                                        }
                                        
                                        if (!leaveObj && Array.isArray(cadreSignatures) && cadreSignatures.length > 0) {
                                            const sig = cadreSignatures.find(s => {
                                                if (s.userId !== cadreMapSelectedUserId) return false;
                                                if (s.type !== '請假') return false;
                                                if (s.status !== 'approved') return false;
                                                
                                                const regex = /(\d{4})[-/](\d{1,2})[-/](\d{1,2})/g;
                                                let match;
                                                while ((match = regex.exec(s.content || '')) !== null) {
                                                    const y = parseInt(match[1]);
                                                    const m = parseInt(match[2]) - 1;
                                                    const da = parseInt(match[3]);
                                                    if (y === targetYear && m === targetMonth && da === day) return true;
                                                }
                                                return false;
                                            });
                                            
                                            if (sig) {
                                                const tmp = {
                                                    leaveReason: '請假',
                                                    startDate: new Date(targetYear, targetMonth, day),
                                                    endDate: new Date(targetYear, targetMonth, day)
                                                };
                                                const timeRegex = /(\d{1,2}:\d{2})\s*[~-]\s*(\d{1,2}:\d{2})/;
                                                const timeMatch = (sig.content || '').match(timeRegex);
                                                if (timeMatch) {
                                                    tmp.leaveStartTime = timeMatch[1];
                                                    tmp.leaveEndTime = timeMatch[2];
                                                    tmp.leaveDate = `${targetYear}-${String(targetMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                                    const [sh, sm] = timeMatch[1].split(':').map(Number);
                                                    const [eh, em] = timeMatch[2].split(':').map(Number);
                                                    tmp.startDate.setHours(sh, sm, 0, 0);
                                                    tmp.endDate.setHours(eh, em, 0, 0);
                                                } else {
                                                    tmp.startDate.setHours(0, 0, 0, 0);
                                                    tmp.endDate.setHours(23, 59, 59, 999);
                                                }
                                                leaveObj = tmp;
                                            }
                                        }
                                        
                                        if (leaveObj && leaveObj.leaveReason !== '公出') {
                                            const { s, e } = getLeaveRange(leaveObj);
                                            if (s && e && !isNaN(s) && !isNaN(e)) {
                                                let os = s > dayStart ? s : dayStart;
                                                let oe = e < dayEnd ? e : dayEnd;
                                                
                                                if (schedule && (schedule.type === 'work' || schedule.type === 'duty' || schedule.type === 'card') && schedule.startTime && schedule.endTime) {
                                                    const [sh, sm] = String(schedule.startTime).split(':').map(Number);
                                                    const [eh, em] = String(schedule.endTime).split(':').map(Number);
                                                    
                                                    let ss = new Date(dayStart);
                                                    ss.setHours(sh, sm, 0, 0);
                                                    let se = new Date(dayStart);
                                                    se.setHours(eh, em, 0, 0);
                                                    if (se < ss) se.setDate(se.getDate() + 1);
                                                    
                                                    if (os < ss) os = ss;
                                                    if (oe > se) oe = se;
                                                } else {
                                                    // Fallback to default workday window if no schedulable window is available
                                                    const defStart = new Date(dayStart);
                                                    defStart.setHours(9, 0, 0, 0);
                                                    const defEnd = new Date(dayStart);
                                                    defEnd.setHours(17, 30, 0, 0);
                                                    // Only apply fallback clamp when leave spans a large portion of the day
                                                    const spanHours = Math.max(0, (oe - os) / 3600000);
                                                    if (spanHours >= 12) {
                                                        if (os < defStart) os = defStart;
                                                        if (oe > defEnd) oe = defEnd;
                                                    }
                                                }
                                                
                                                const h = Math.max(0, (oe - os) / 3600000);
                                                leaveHoursForDay = h;
                                                if (h > 0) {
                                                    hasApprovedLeave = true;
                                                }
                                            }
                                        }
                                        
                                        if (!hasApprovedLeave) {
                                            hasApprovedLeave = records.some(r => (r.type || '') === 'leave' && r.status === 'approved');
                                        }
                                        
                                        const formatTime = tsSeconds => new Date(tsSeconds * 1000).toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                                        const makeTimeInfo = (first, last) => {
                                            const inStr = first ? formatTime(first.timestamp.seconds) : '-';
                                            let outStr = last ? formatTime(last.timestamp.seconds) : '-';
                                            if (last && last.isNightShift) {
                                                const rawOutDate = new Date(last.timestamp.seconds * 1000);
                                                const outDay = rawOutDate.getDate();
                                                if (outDay !== day) {
                                                    outStr = `${outStr}(跨日)`;
                                                }
                                            }
                                            const locStr = first ? (first.checkInLocationName || first.address || '-') : '-';
                                            return { inStr, outStr, locStr };
                                        };
                                        
                                        const allTimeInfo = makeTimeInfo(firstIn, lastOut);
                                        const dayTimeInfo = makeTimeInfo(firstInDay, lastOutDay);
                                        const nightTimeInfo = makeTimeInfo(firstInNight, lastOutNight);
                                        
                                        const dateStr = `${targetYear}-${String(targetMonth + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                                        const schedule = userSchedules[dateStr] || null;

                                        let workStr = '-';
                                        if (firstIn && lastOut) {
                                            let diffMs = (lastOut.timestamp.seconds - firstIn.timestamp.seconds) * 1000;
                                            
                                            // 判定工時：若實際 > 班表，取班表；否則取實際 (取最小值)
                                            if (schedule && (schedule.type === 'work' || schedule.type === 'duty' || schedule.type === 'card') && schedule.startTime != null && schedule.endTime != null) {
                                                const parseToMin = (t) => {
                                                    const parts = String(t).split(':');
                                                    return parseInt(parts[0], 10) * 60 + (parts[1] ? parseInt(parts[1], 10) : 0);
                                                };
                                                const sStartMin = parseToMin(schedule.startTime);
                                                const sEndMin = parseToMin(schedule.endTime);
                                                
                                                let sDurationMin = sEndMin - sStartMin;
                                                if (sDurationMin < 0) sDurationMin += 24 * 60; // 跨日
                                                
                                                if (sDurationMin > 0) {
                                                    let scheduleMs = sDurationMin * 60000;
                                                    
                                                    // 扣除請假時數 (leaveHoursForDay 已計算為 schedule 內的請假時數)
                                                    if (leaveHoursForDay > 0) {
                                                        scheduleMs -= (leaveHoursForDay * 3600000);
                                                        if (scheduleMs < 0) scheduleMs = 0;
                                                    }

                                                    if (diffMs > scheduleMs) diffMs = scheduleMs;
                                                }
                                            }

                                            const totalHours = diffMs / 3600000;
                                            workStr = `${totalHours.toFixed(1)} hr`;
                                        }
                                        
                                        const abnormalReasons = [];
                                        
                                        // 檢查曠職：若班表為上班/值班，且完全沒有打卡紀錄，且無核准請假
                                        if (!hasApprovedLeave) {
                                        const todayDate = new Date();
                                            todayDate.setHours(0,0,0,0);
                                            const targetDayDate = new Date(targetYear, targetMonth, day);
                                            
                                            // 只有在日期已過（小於今天）才判定曠職
                                            if (schedule && (schedule.type === 'work' || schedule.type === 'duty' || schedule.type === 'card')) {
                                                 if (targetDayDate < todayDate) {
                                                    if (!firstIn && !lastOut) {
                                                        abnormalReasons.push('曠職');
                                                    } else {
                                                        if (!firstIn) abnormalReasons.push('未上班');
                                                        if (!lastOut) abnormalReasons.push('未下班');
                                                    }
                                                 }
                                            } else {
                                                // 無班表或非工作日，僅檢查有上班沒下班或有下班沒上班
                                                if (firstIn && !lastOut) abnormalReasons.push('未下班');
                                                if (!firstIn && lastOut) abnormalReasons.push('未上班');
                                            }
                                        }

                                        const remarks = abnormalReasons.length > 0 ? `異常-${abnormalReasons.join('、')}` : '';

                                        let status = null;
                                        
                                        const dayOfWeek = dayStart.getDay();
                                        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                                        const isNationalHoliday = holidays.includes(dateStr);

                                        let scheduleInStr = '-';
                                        let scheduleOutStr = '-';

                                        if (schedule) {
                                            if (schedule.type === 'work') status = '上班';
                                            else if (schedule.type === 'duty' || schedule.type === 'card') status = '值班';
                                            else if (schedule.type === 'off') status = '特休';
                                            else if (schedule.type === 'leave') status = '請假';
                                            else if (schedule.type === 'holiday') status = '假日';
                                            else if (schedule.type === 'comp_leave') status = '補休';

                                            if (schedule.type === 'work' || schedule.type === 'duty' || schedule.type === 'card') {
                                                scheduleInStr = schedule.startTime ? `${schedule.startTime}:00` : '-';
                                                scheduleOutStr = schedule.endTime ? `${schedule.endTime}:00` : '-';
                                            }
                                        } else if (isWeekend || isNationalHoliday) {
                                            status = '假日';
                                        }

                                        if (status !== '特休' && status !== '假日') {
                                            if (hasApprovedLeave) {
                                                // 不覆蓋原有狀態（如上班、值班），僅記錄備註
                                                // 若原狀態為空或 '-'，則設為請假
                                                if (!status || status === '-') {
                                                    status = '請假';
                                                }
                                            }
                                        }
                                        
                                        let statusClass = 'text-gray-700';
                                        if (status && status.startsWith('請假')) statusClass = 'text-gray-900';

                                        // 處理備註：異常 + 請假 + 外出/卡班
                                        let finalRemarks = remarks;
                                        let extraRemarks = [];
                                        
                                        if (hasApprovedLeave) {
                                            if (leaveHoursForDay > 0) {
                                                const displayHours = Number(leaveHoursForDay.toFixed(1));
                                                extraRemarks.push(`請假${displayHours}hr`);
                                            } else {
                                                extraRemarks.push('請假');
                                            }
                                        }
                                        
                                        if (hasOuting) extraRemarks.push('外出');
                                        if (hasDuty) extraRemarks.push('卡班');
                                        
                                        // 組合備註顯示 HTML
                                        const remarkContent = (
                                            <>
                                                <span className={remarks.includes('異常') ? 'text-red-600 font-bold' : ''}>{remarks}</span>
                                                {remarks && extraRemarks.length > 0 && <span>、</span>}
                                                {extraRemarks.map((r, i) => (
                                                    <span key={i}>
                                                        {i > 0 && <span>、</span>}
                                                        <span className={r === '外出' ? 'text-blue-600 font-bold' : 'text-purple-600 font-bold'}>{r}</span>
                                                    </span>
                                                ))}
                                            </>
                                        );

                                        const isLeaveStatus = hasApprovedLeave;
                                        
                                        const hasDayAndNight = dayRecords.length > 0 && nightRecords.length > 0;
                                        const baseLocationStr = allTimeInfo.locStr;
                                        
                                        if (hasDayAndNight) {
                                            dayRows.push({
                                                dateNum: day,
                                                week: weekMap[dayOfWeek],
                                                inTimeStr: dayTimeInfo.inStr,
                                                outTimeStr: dayTimeInfo.outStr,
                                                locationStr: dayTimeInfo.locStr || baseLocationStr,
                                                scheduleInStr,
                                                scheduleOutStr,
                                                workStr,
                                                remarks: remarkContent,
                                                status,
                                                statusClass,
                                                isHoliday: status === '假日',
                                                isLeave: isLeaveStatus
                                            });
                                            
                                            dayRows.push({
                                                dateNum: day,
                                                week: weekMap[dayOfWeek],
                                                inTimeStr: nightTimeInfo.inStr,
                                                outTimeStr: nightTimeInfo.outStr,
                                                locationStr: nightTimeInfo.locStr || baseLocationStr,
                                                scheduleInStr,
                                                scheduleOutStr,
                                                workStr: '',
                                                remarks: remarkContent,
                                                status,
                                                statusClass,
                                                isHoliday: status === '假日',
                                                isLeave: isLeaveStatus
                                            });
                                        } else {
                                            const useTimeInfo = dayRecords.length > 0 ? dayTimeInfo : nightTimeInfo;
                                            const finalTimeInfo = (dayRecords.length === 0 && nightRecords.length === 0) ? allTimeInfo : useTimeInfo;
                                            
                                            dayRows.push({
                                                dateNum: day,
                                                week: weekMap[dayOfWeek],
                                                inTimeStr: finalTimeInfo.inStr,
                                                outTimeStr: finalTimeInfo.outStr,
                                                locationStr: finalTimeInfo.locStr || baseLocationStr,
                                                scheduleInStr,
                                                scheduleOutStr,
                                                workStr,
                                                remarks: remarkContent,
                                                status,
                                                statusClass,
                                                isHoliday: status === '假日',
                                                isLeave: isLeaveStatus
                                            });
                                        }
                                    }

                                    

                                    return (
                                        <div id="attendance-report" className="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 overflow-x-auto">
                                            <div className="min-w-[720px]">
                                                <div className="text-center font-bold text-lg text-gray-800 py-1">
                                                    西北保全{user?.title || ''}{user?.name || ''}
                                                </div>
                                                <div className="text-center font-bold text-md text-gray-600 pb-3">
                                                    {cadreRecordDate.split('-').slice(0,2).join('-')} 出缺勤月報表
                                                </div>
                                                <div className="grid text-xs font-bold text-gray-600 bg-gray-50 rounded-xl" style={{ gridTemplateColumns: '10mm 10mm 20mm 45mm 45mm 15mm 15mm 30mm' }}>
                                                    <div className="px-3 py-2">日期</div>
                                                    <div className="px-3 py-2">星期</div>
                                                    <div className="px-3 py-2">打卡位置</div>
                                                    <div className="px-3 py-2">上班時間</div>
                                                    <div className="px-3 py-2">下班時間</div>
                                                    <div className="px-3 py-2">判定工時</div>
                                                    <div className="px-3 py-2">狀況</div>
                                                    <div className="px-3 py-2">備註</div>
                                                </div>
                                                <div className="divide-y divide-gray-100">
                                                    {dayRows.map((row, idx) => (
                                                        <div key={idx} className={`grid text-sm ${row.isHoliday ? 'bg-gray-200' : ''} ${row.isLeave ? 'bg-orange-100' : ''}`} style={{ gridTemplateColumns: '10mm 10mm 20mm 45mm 45mm 15mm 15mm 30mm' }}>
                                                            <div className="px-3 py-2">{String(row.dateNum).padStart(2,'0')}</div>
                                                            <div className="px-3 py-2">{row.week}</div>
                                                            <div className="px-3 py-2 text-xs truncate" title={row.locationStr}>{row.locationStr}</div>
                                                            <div className="px-3 py-2">
                                                                {(!row.isHoliday && row.status !== '請假' && row.status !== '特休' && row.status !== '假日' && row.status !== '補休') ? (
                                                                    <>
                                                                        <div className="text-gray-500 text-xs">班表 : {row.scheduleInStr}</div>
                                                                        <div className="text-gray-500 text-xs">打卡 : {row.inTimeStr}</div>
                                                                    </>
                                                                ) : (
                                                                    (row.inTimeStr && row.inTimeStr !== '-' && row.inTimeStr !== '--:--') && (
                                                                        <div className="text-gray-500 text-xs">打卡 : {row.inTimeStr}</div>
                                                                    )
                                                                )}
                                                            </div>
                                                            <div className="px-3 py-2">
                                                                {(!row.isHoliday && row.status !== '請假' && row.status !== '特休' && row.status !== '假日' && row.status !== '補休') ? (
                                                                    <>
                                                                        <div className="text-gray-500 text-xs">班表 : {row.scheduleOutStr}</div>
                                                                        <div className="text-gray-500 text-xs">打卡 : {row.outTimeStr}</div>
                                                                    </>
                                                                ) : (
                                                                    (row.outTimeStr && row.outTimeStr !== '-' && row.outTimeStr !== '--:--') && (
                                                                        <div className="text-gray-500 text-xs">打卡 : {row.outTimeStr}</div>
                                                                    )
                                                                )}
                                                            </div>
                                                            <div className="px-3 py-2">{(row.status === '特休' || row.status === '假日' || row.status === '補休' || row.isHoliday) ? '' : row.workStr}</div>
                                                            <div className={`px-3 py-2 font-bold ${row.statusClass}`}>{row.status}</div>
                                                            <div className="px-3 py-2">{row.remarks}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>
                        </div>
                    )}

                    <SignatureModal 
                        isOpen={showSignatureModal}
                        onClose={() => { setShowSignatureModal(false); setSignatureEditTarget(null); setSignatureError(''); }}
                        onConfirm={signatureEditTarget ? handleEditSignatureConfirm : handleAddSignature}
                        loading={signatureLoading}
                        error={signatureError}
                        form={signatureForm}
                        setForm={setSignatureForm}
                        signatureTypes={signatureTypes}
                        title={signatureEditTarget ? '編輯電子簽呈' : '新增電子簽呈'}
                        confirmText={signatureEditTarget ? '儲存變更' : '送出申請'}
                    />

                    {overviewDutyModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={() => setOverviewDutyModalOpen(false)}>
                            <div className="bg-white rounded-2xl w-full max-w-sm max-h-[80vh] overflow-hidden flex flex-col shadow-2xl animate-in zoom-in duration-200" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                    <div className="flex items-center gap-2">
                                        <span className="text-gray-500 text-lg font-bold">
                                            {companies.find(c => String(c.id) === String(dbUser?.companyId))?.name}
                                        </span>
                                        <span className="text-gray-500 text-lg font-bold">
                                            {(overviewDutyFridays[0]?.date || '').split('-').slice(0,2).join('年')}月
                                        </span>
                                        <h3 className="font-bold text-gray-800 flex items-center gap-2 text-lg">
                                            <i className="fas fa-user-clock text-purple-600"></i>
                                            週五值班名單
                                        </h3>
                                    </div>
                                    <button onClick={() => setOverviewDutyModalOpen(false)} className="w-8 h-8 rounded-full bg-white text-black hover:text-gray-800 flex items-center justify-center shadow-sm transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                <div className="overflow-y-auto p-4 space-y-3">
                                    {overviewDutyFridays.length > 0 ? (
                                        overviewDutyFridays.map((item, idx) => (
                                            <div key={idx} className="bg-purple-50 rounded-xl p-3 border border-purple-100">
                                                <div className="text-purple-800 font-bold text-sm mb-2 border-b border-purple-200 pb-1 flex justify-between items-center">
                                                    <span>{item.date} (五)</span>
                                                    <span className="text-xs font-normal bg-white px-2 py-0.5 rounded-full text-purple-600 shadow-sm">{item.users.length} 人</span>
                                                </div>
                                                <div className="flex flex-wrap gap-2">
                                                    {item.users.length > 0 ? (
                                                        item.users.map(u => (
                                                            <div key={u.id} className="flex items-center gap-1.5 bg-white px-2 py-1 rounded-lg border border-purple-100 shadow-sm">
                                                                <div 
                                                                    className="w-5 h-5 rounded-full bg-gray-200 bg-cover bg-center border border-gray-100"
                                                                    style={{ backgroundImage: u.avatarUrl ? `url(${u.avatarUrl})` : 'none' }}
                                                                >
                                                                    {!u.avatarUrl && <span className="flex w-full h-full items-center justify-center text-[8px] text-gray-500">{u.name?.[0]}</span>}
                                                                </div>
                                                                <span className="text-xs text-gray-700 font-medium">{u.name}</span>
                                                            </div>
                                                        ))
                                                    ) : (
                                                        <div className="text-xs text-gray-400 italic w-full text-center py-1">無人值班</div>
                                                    )}
                                                </div>
                                            </div>
                                        ))
                                    ) : (
                                        <div className="text-center text-gray-500 py-8">
                                            <div className="bg-gray-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                                                <i className="fas fa-calendar-times text-gray-300 text-2xl"></i>
                                            </div>
                                            本月無週五值班資料
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    {overviewMeetingModalOpen && (function() {
                        const company = companies.find(c => c.name === overviewCompany);
                        const companyId = company ? company.id : null;
                        const availableCommunities = companyId
                            ? communities.filter(comm => {
                                const ids = comm.companyIds || (comm.companyId ? [comm.companyId] : []);
                                return ids.some(id => String(id) === String(companyId));
                            })
                            : [];
                        const availableUsers = companyId
                            ? usersList.filter(u => {
                                const ids = u.companyIds || (u.companyId ? [u.companyId] : []);
                                return ids.some(id => String(id) === String(companyId)) && (u.status || '在職') !== '離職';
                            })
                            : [];
                        const participantIds = overviewMeetingForm.participants || [];
                        const participantUsers = availableUsers.filter(u => participantIds.includes(u.id));
                        return (
                            <div className="fixed inset-0 z-[95] bg-black/50 flex items-center justify-center p-4" onClick={() => setOverviewMeetingModalOpen(false)}>
                                <div className="bg-white w-[90vw] h-[90vh] max-w-[90vw] max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up flex flex-col" onClick={e => e.stopPropagation()}>
                                    <div className="px-6 pt-6 pb-4 border-b border-gray-100 flex items-center justify-between flex-shrink-0">
                                        <h3 className="text-lg font-bold text-gray-800">新增例會</h3>
                                        <button
                                            type="button"
                                            onClick={() => setOverviewMeetingModalOpen(false)}
                                            className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200"
                                        >
                                            ×
                                        </button>
                                    </div>
                                    <div className="p-6 space-y-4 text-sm flex-1 overflow-y-auto">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">社區名稱</label>
                                            <select
                                                value={overviewMeetingForm.communityId}
                                                onChange={e => handleOverviewMeetingFormChange('communityId', e.target.value)}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                            >
                                                <option value="">請選擇社區</option>
                                                {availableCommunities.map(comm => (
                                                    <option key={comm.id} value={comm.id}>{comm.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">會議項目</label>
                                            <select
                                                value={overviewMeetingForm.type}
                                                onChange={e => handleOverviewMeetingFormChange('type', e.target.value)}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                            >
                                                <option value="例會">例會</option>
                                                <option value="臨時會">臨時會</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">日期</label>
                                            <input
                                                type="date"
                                                value={overviewMeetingForm.date}
                                                onChange={e => handleOverviewMeetingFormChange('date', e.target.value)}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">時間</label>
                                            <input
                                                type="time"
                                                value={overviewMeetingForm.time}
                                                onChange={e => handleOverviewMeetingFormChange('time', e.target.value)}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">參加人員（可複選）</label>
                                            <div className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 max-h-48 overflow-y-auto space-y-2">
                                                {availableUsers.map(u => {
                                                    const checked = participantIds.includes(u.id);
                                                    return (
                                                        <label key={u.id} className="flex items-center gap-2 text-sm">
                                                            <input
                                                                type="checkbox"
                                                                checked={checked}
                                                                onChange={e => handleOverviewMeetingParticipantToggle(u.id, e.target.checked)}
                                                                className="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500"
                                                            />
                                                            <span>{u.name || u.email || u.phone || u.id}</span>
                                                        </label>
                                                    );
                                                })}
                                            </div>
                                            <div className="mt-2">
                                                <label className="block text-xs font-bold text-gray-500 mb-1">其他人員（自訂）</label>
                                                <input
                                                    type="text"
                                                    value={overviewMeetingForm.otherParticipants || ''}
                                                    onChange={e => handleOverviewMeetingFormChange('otherParticipants', e.target.value)}
                                                    placeholder="請輸入其他參加人員，以、分隔"
                                                    className="w-full bg-white border border-gray-200 p-2 rounded-xl text-xs text-gray-800 focus:ring-2 focus:ring-red-100"
                                                />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">主導人員</label>
                                            <select
                                                value={overviewMeetingForm.leaderId || ''}
                                                onChange={e => handleOverviewMeetingFormChange('leaderId', e.target.value)}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                            >
                                                <option value="">請選擇主導人員</option>
                                                {participantUsers.map(u => (
                                                    <option key={u.id} value={u.id}>
                                                        {u.name || u.email || u.phone || u.id}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">會議說明</label>
                                            <textarea
                                                value={overviewMeetingForm.description}
                                                onChange={e => handleOverviewMeetingFormChange('description', e.target.value)}
                                                rows={4}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100 resize-none"
                                            />
                                        </div>
                                    </div>
                                    <div className="px-6 pb-6 pt-4 border-t border-gray-100 flex gap-3 flex-shrink-0">
                                        <button
                                            type="button"
                                            onClick={() => setOverviewMeetingModalOpen(false)}
                                            className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition"
                                        >
                                            取消
                                        </button>
                                        <button
                                            type="button"
                                            onClick={handleSaveOverviewMeeting}
                                            className="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition shadow-lg shadow-red-200"
                                        >
                                            儲存
                                        </button>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}

                    {overviewDistrictMeetingModalOpen && (function() {
                        const company = companies.find(c => c.name === overviewCompany);
                        const companyId = company ? company.id : null;
                        const availableCommunities = companyId
                            ? communities.filter(comm => {
                                const ids = comm.companyIds || (comm.companyId ? [comm.companyId] : []);
                                return ids.some(id => String(id) === String(companyId));
                            })
                            : [];
                        const availableUsers = companyId
                            ? usersList.filter(u => {
                                const ids = u.companyIds || (u.companyId ? [u.companyId] : []);
                                return ids.some(id => String(id) === String(companyId)) && (u.status || '在職') !== '離職';
                            })
                            : [];
                        const participantIds = overviewDistrictMeetingForm.participants || [];
                        const participantUsers = availableUsers.filter(u => participantIds.includes(u.id));
                        return (
                            <div className="fixed inset-0 z-[95] bg-black/50 flex items-center justify-center p-4" onClick={() => setOverviewDistrictMeetingModalOpen(false)}>
                                <div className="bg-white w-[90vw] h-[90vh] max-w-[90vw] max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up flex flex-col" onClick={e => e.stopPropagation()}>
                                    <div className="px-6 pt-6 pb-4 border-b border-gray-100 flex items-center justify-between flex-shrink-0">
                                        <h3 className="text-lg font-bold text-gray-800">新增區大</h3>
                                        <button
                                            type="button"
                                            onClick={() => setOverviewDistrictMeetingModalOpen(false)}
                                            className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200"
                                        >
                                            ×
                                        </button>
                                    </div>
                                    <div className="p-6 space-y-4 text-sm flex-1 overflow-y-auto">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">社區名稱</label>
                                            <select
                                                value={overviewDistrictMeetingForm.communityId}
                                                onChange={e => handleOverviewDistrictMeetingFormChange('communityId', e.target.value)}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                            >
                                                <option value="">請選擇社區</option>
                                                {availableCommunities.map(comm => (
                                                    <option key={comm.id} value={comm.id}>{comm.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">項目</label>
                                            <select
                                                value={overviewDistrictMeetingForm.type}
                                                onChange={e => handleOverviewDistrictMeetingFormChange('type', e.target.value)}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                            >
                                                <option value="區大">區大</option>
                                                <option value="臨時區大">臨時區大</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">日期</label>
                                            <input
                                                type="date"
                                                value={overviewDistrictMeetingForm.date}
                                                onChange={e => handleOverviewDistrictMeetingFormChange('date', e.target.value)}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">時間</label>
                                            <input
                                                type="time"
                                                value={overviewDistrictMeetingForm.time}
                                                onChange={e => handleOverviewDistrictMeetingFormChange('time', e.target.value)}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">參加人員（可複選）</label>
                                            <div className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 max-h-48 overflow-y-auto space-y-2">
                                                {availableUsers.map(u => {
                                                    const checked = participantIds.includes(u.id);
                                                    return (
                                                        <label key={u.id} className="flex items-center gap-2 text-sm">
                                                            <input
                                                                type="checkbox"
                                                                checked={checked}
                                                                onChange={e => handleOverviewDistrictMeetingParticipantToggle(u.id, e.target.checked)}
                                                                className="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500"
                                                            />
                                                            <span>{u.name || u.email || u.phone || u.id}</span>
                                                        </label>
                                                    );
                                                })}
                                            </div>
                                            <div className="mt-2">
                                                <label className="block text-xs font-bold text-gray-500 mb-1">其他人員（自訂）</label>
                                                <input
                                                    type="text"
                                                    value={overviewDistrictMeetingForm.otherParticipants || ''}
                                                    onChange={e => handleOverviewDistrictMeetingFormChange('otherParticipants', e.target.value)}
                                                    placeholder="請輸入其他參加人員，以、分隔"
                                                    className="w-full bg白 border border-gray-200 p-2 rounded-xl text-xs text-gray-800 focus:ring-2 focus:ring-red-100"
                                                />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">主導人員</label>
                                            <select
                                                value={overviewDistrictMeetingForm.leaderId || ''}
                                                onChange={e => handleOverviewDistrictMeetingFormChange('leaderId', e.target.value)}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                            >
                                                <option value="">請選擇主導人員</option>
                                                {participantUsers.map(u => (
                                                    <option key={u.id} value={u.id}>
                                                        {u.name || u.email || u.phone || u.id}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">說明</label>
                                            <textarea
                                                value={overviewDistrictMeetingForm.description}
                                                onChange={e => handleOverviewDistrictMeetingFormChange('description', e.target.value)}
                                                rows={4}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100 resize-none"
                                            />
                                        </div>
                                    </div>
                                    <div className="px-6 pb-6 pt-4 border-t border-gray-100 flex gap-3 flex-shrink-0">
                                        <button
                                            type="button"
                                            onClick={() => setOverviewDistrictMeetingModalOpen(false)}
                                            className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition"
                                        >
                                            取消
                                        </button>
                                        <button
                                            type="button"
                                            onClick={handleSaveOverviewDistrictMeeting}
                                            className="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition shadow-lg shadow-red-200"
                                        >
                                            儲存
                                        </button>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}

                    {overviewActivityModalOpen && (function() {
                        const company = companies.find(c => c.name === overviewCompany);
                        const companyId = company ? company.id : null;
                        const availableCommunities = companyId
                            ? communities.filter(comm => {
                                const ids = comm.companyIds || (comm.companyId ? [comm.companyId] : []);
                                return ids.some(id => String(id) === String(companyId));
                            })
                            : [];
                        const availableUsers = companyId
                            ? usersList.filter(u => {
                                const ids = u.companyIds || (u.companyId ? [u.companyId] : []);
                                return ids.some(id => String(id) === String(companyId)) && (u.status || '在職') !== '離職';
                            })
                            : [];
                        const participantIds = overviewActivityForm.participants || [];
                        const participantUsers = availableUsers.filter(u => participantIds.includes(u.id));
                        return (
                            <div className="fixed inset-0 z-[95] bg-black/50 flex items-center justify-center p-4" onClick={() => setOverviewActivityModalOpen(false)}>
                                <div className="bg-white w-[90vw] h-[90vh] max-w-[90vw] max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up flex flex-col" onClick={e => e.stopPropagation()}>
                                    <div className="px-6 pt-6 pb-4 border-b border-gray-100 flex items-center justify-between flex-shrink-0">
                                        <h3 className="text-lg font-bold text-gray-800">新增活動</h3>
                                        <button
                                            type="button"
                                            onClick={() => setOverviewActivityModalOpen(false)}
                                            className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200"
                                        >
                                            ×
                                        </button>
                                    </div>
                                    <div className="p-6 space-y-4 text-sm flex-1 overflow-y-auto">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">社區名稱</label>
                                            <select
                                                value={overviewActivityForm.communityId}
                                                onChange={e => handleOverviewActivityFormChange('communityId', e.target.value)}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                            >
                                                <option value="">請選擇社區</option>
                                                {availableCommunities.map(comm => (
                                                    <option key={comm.id} value={comm.id}>{comm.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">項目</label>
                                            <select
                                                value={['節日活動'].includes(overviewActivityForm.type) ? overviewActivityForm.type : '其他'}
                                                onChange={e => {
                                                    const val = e.target.value;
                                                    if (val === '其他') {
                                                        // Keep existing type if it's not '節日活動', else clear it
                                                        const current = overviewActivityForm.type;
                                                        handleOverviewActivityFormChange('type', current === '節日活動' ? '' : current);
                                                    } else {
                                                        handleOverviewActivityFormChange('type', val);
                                                    }
                                                }}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100 mb-2"
                                            >
                                                <option value="其他">其他 (自定義)</option>
                                                <option value="節日活動">節日活動</option>
                                            </select>
                                            {(!['節日活動'].includes(overviewActivityForm.type)) && (
                                                <input
                                                    type="text"
                                                    value={overviewActivityForm.type === '節日活動' ? '' : overviewActivityForm.type}
                                                    onChange={e => handleOverviewActivityFormChange('type', e.target.value)}
                                                    placeholder="請輸入活動名稱"
                                                    className="w-full bg-white border border-gray-200 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                                />
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">日期</label>
                                            <input
                                                type="date"
                                                value={overviewActivityForm.date}
                                                onChange={e => handleOverviewActivityFormChange('date', e.target.value)}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">時間</label>
                                            <input
                                                type="time"
                                                value={overviewActivityForm.time}
                                                onChange={e => handleOverviewActivityFormChange('time', e.target.value)}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">參加人員（可複選）</label>
                                            <div className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 max-h-48 overflow-y-auto space-y-2">
                                                {availableUsers.map(u => {
                                                    const checked = participantIds.includes(u.id);
                                                    return (
                                                        <label key={u.id} className="flex items-center gap-2 text-sm">
                                                            <input
                                                                type="checkbox"
                                                                checked={checked}
                                                                onChange={e => handleOverviewActivityParticipantToggle(u.id, e.target.checked)}
                                                                className="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500"
                                                            />
                                                            <span>{u.name || u.email || u.phone || u.id}</span>
                                                        </label>
                                                    );
                                                })}
                                            </div>
                                            <div className="mt-2">
                                                <label className="block text-xs font-bold text-gray-500 mb-1">其他人員（自訂）</label>
                                                <input
                                                    type="text"
                                                    value={overviewActivityForm.otherParticipants || ''}
                                                    onChange={e => handleOverviewActivityFormChange('otherParticipants', e.target.value)}
                                                    placeholder="請輸入其他參加人員，以、分隔"
                                                    className="w-full bg-white border border-gray-200 p-2 rounded-xl text-xs text-gray-800 focus:ring-2 focus:ring-red-100"
                                                />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">主導人員</label>
                                            <select
                                                value={overviewActivityForm.leaderId || ''}
                                                onChange={e => handleOverviewActivityFormChange('leaderId', e.target.value)}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                            >
                                                <option value="">請選擇主導人員</option>
                                                {participantUsers.map(u => (
                                                    <option key={u.id} value={u.id}>
                                                        {u.name || u.email || u.phone || u.id}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">說明</label>
                                            <textarea
                                                value={overviewActivityForm.description}
                                                onChange={e => handleOverviewActivityFormChange('description', e.target.value)}
                                                rows={4}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100 resize-none"
                                            />
                                        </div>
                                    </div>
                                    <div className="px-6 pb-6 pt-4 border-t border-gray-100 flex gap-3 flex-shrink-0">
                                        <button
                                            type="button"
                                            onClick={() => setOverviewActivityModalOpen(false)}
                                            className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition"
                                        >
                                            取消
                                        </button>
                                        <button
                                            type="button"
                                            onClick={handleSaveOverviewActivity}
                                            className="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition shadow-lg shadow-red-200"
                                        >
                                            儲存
                                        </button>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}

                    {overviewPresentationModalOpen && (function() {
                        const company = companies.find(c => c.name === overviewCompany);
                        const companyId = company ? company.id : null;
                        const availableCommunities = companyId
                            ? communities.filter(comm => {
                                const ids = comm.companyIds || (comm.companyId ? [comm.companyId] : []);
                                return ids.some(id => String(id) === String(companyId));
                            })
                            : [];
                        const availableUsers = companyId
                            ? usersList.filter(u => {
                                const ids = u.companyIds || (u.companyId ? [u.companyId] : []);
                                return ids.some(id => String(id) === String(companyId)) && (u.status || '在職') !== '離職';
                            })
                            : [];
                        const participantIds = overviewPresentationForm.participants || [];
                        const participantUsers = availableUsers.filter(u => participantIds.includes(u.id));
                        return (
                            <div className="fixed inset-0 z-[95] bg-black/50 flex items-center justify-center p-4" onClick={() => setOverviewPresentationModalOpen(false)}>
                                <div className="bg-white w-[90vw] h-[90vh] max-w-[90vw] max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up flex flex-col" onClick={e => e.stopPropagation()}>
                                    <div className="px-6 pt-6 pb-4 border-b border-gray-100 flex items-center justify-between flex-shrink-0">
                                        <h3 className="text-lg font-bold text-gray-800">新增簡報</h3>
                                        <button
                                            type="button"
                                            onClick={() => setOverviewPresentationModalOpen(false)}
                                            className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200"
                                        >
                                            ×
                                        </button>
                                    </div>
                                    <div className="p-6 space-y-4 text-sm flex-1 overflow-y-auto">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">社區名稱</label>
                                            <select
                                                value={
                                                    availableCommunities.some(comm => String(comm.id) === String(overviewPresentationForm.communityId))
                                                        ? overviewPresentationForm.communityId
                                                        : (overviewPresentationForm.communityId ? '其他' : '')
                                                }
                                                onChange={e => {
                                                    const val = e.target.value;
                                                    if (val === '其他') {
                                                        const current = overviewPresentationForm.communityId;
                                                        const isExisting = availableCommunities.some(comm => String(comm.id) === String(current));
                                                        const placeholder = (!current || isExisting) ? '自訂社區' : current;
                                                        handleOverviewPresentationFormChange('communityId', placeholder);
                                                    } else {
                                                        handleOverviewPresentationFormChange('communityId', val);
                                                    }
                                                }}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100 mb-2"
                                            >
                                                <option value="">請選擇社區</option>
                                                <option value="其他">其他 (自定義)</option>
                                                {availableCommunities.map(comm => (
                                                    <option key={comm.id} value={comm.id}>{comm.name}</option>
                                                ))}
                                            </select>
                                            {overviewPresentationForm.communityId &&
                                                !availableCommunities.some(comm => String(comm.id) === String(overviewPresentationForm.communityId)) && (
                                                <input
                                                    type="text"
                                                    value={overviewPresentationForm.communityId}
                                                    onChange={e => handleOverviewPresentationFormChange('communityId', e.target.value)}
                                                    placeholder="請輸入社區名稱"
                                                    className="w-full bg-white border border-gray-200 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                                />
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">項目</label>
                                            <input
                                                type="text"
                                                value="簡報"
                                                readOnly
                                                className="w-full bg-gray-100 border-0 p-3 rounded-xl text-gray-800"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">日期</label>
                                            <input
                                                type="date"
                                                value={overviewPresentationForm.date}
                                                onChange={e => handleOverviewPresentationFormChange('date', e.target.value)}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">時間</label>
                                            <input
                                                type="time"
                                                value={overviewPresentationForm.time}
                                                onChange={e => handleOverviewPresentationFormChange('time', e.target.value)}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">參加人員（可複選）</label>
                                            <div className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 max-h-48 overflow-y-auto space-y-2">
                                                {availableUsers.map(u => {
                                                    const checked = participantIds.includes(u.id);
                                                    return (
                                                        <label key={u.id} className="flex items-center gap-2 text-sm">
                                                            <input
                                                                type="checkbox"
                                                                checked={checked}
                                                                onChange={e => handleOverviewPresentationParticipantToggle(u.id, e.target.checked)}
                                                                className="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500"
                                                            />
                                                            <span>{u.name || u.email || u.phone || u.id}</span>
                                                        </label>
                                                    );
                                                })}
                                            </div>
                                            <div className="mt-2">
                                                <label className="block text-xs font-bold text-gray-500 mb-1">其他人員（自訂）</label>
                                                <input
                                                    type="text"
                                                    value={overviewPresentationForm.otherParticipants || ''}
                                                    onChange={e => handleOverviewPresentationFormChange('otherParticipants', e.target.value)}
                                                    placeholder="請輸入其他參加人員，以、分隔"
                                                    className="w-full bg-white border border-gray-200 p-2 rounded-xl text-xs text-gray-800 focus:ring-2 focus:ring-red-100"
                                                />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">主導人員</label>
                                            <select
                                                value={overviewPresentationForm.leaderId || ''}
                                                onChange={e => handleOverviewPresentationFormChange('leaderId', e.target.value)}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100"
                                            >
                                                <option value="">請選擇主導人員</option>
                                                {participantUsers.map(u => (
                                                    <option key={u.id} value={u.id}>
                                                        {u.name || u.email || u.phone || u.id}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">說明</label>
                                            <textarea
                                                value={overviewPresentationForm.description}
                                                onChange={e => handleOverviewPresentationFormChange('description', e.target.value)}
                                                rows={4}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-red-100 resize-none"
                                            />
                                        </div>
                                    </div>
                                    <div className="px-6 pb-6 pt-4 border-t border-gray-100 flex gap-3 flex-shrink-0">
                                        <button
                                            type="button"
                                            onClick={() => setOverviewPresentationModalOpen(false)}
                                            className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition"
                                        >
                                            取消
                                        </button>
                                        <button
                                            type="button"
                                            onClick={handleSaveOverviewPresentation}
                                            className="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition shadow-lg shadow-red-200"
                                        >
                                            儲存
                                        </button>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}

                    {completeMeetingModalOpen && (function() {
                        const target = completeMeetingTarget || {};
                        return (
                            <div className="fixed inset-0 z-[96] bg-black/50 flex items-center justify-center p-4" onClick={() => setCompleteMeetingModalOpen(false)}>
                                <div className="bg-white w-[90vw] h-[90vh] max-w-[90vw] max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up flex flex-col" onClick={e => e.stopPropagation()}>
                                    <div className="px-6 pt-6 pb-4 border-b border-gray-100 flex items-center justify-between flex-shrink-0">
                                        <h3 className="text-lg font-bold text-gray-800">完成會議</h3>
                                        <button
                                            type="button"
                                            onClick={() => setCompleteMeetingModalOpen(false)}
                                            className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200"
                                        >
                                            ×
                                        </button>
                                    </div>
                                    <div className="p-6 space-y-4 text-sm flex-1 overflow-y-auto">
                                        <div>
                                            <div className="text-xs text-gray-500">
                                                {target.type || '會議'}（{target.date || ''} {target.time || ''}）
                                            </div>
                                        </div>
                                        <div>
                                            <div className="flex items-center gap-2 mb-4">
                                                <input
                                                    type="checkbox"
                                                    id="meeting-completed-checkbox"
                                                    checked={completeMeetingForm.isCompleted}
                                                    onChange={e => handleCompleteMeetingFormChange('isCompleted', e.target.checked)}
                                                    className="w-5 h-5 rounded text-green-600 focus:ring-green-500 border-gray-300"
                                                />
                                                <label htmlFor="meeting-completed-checkbox" className="text-sm font-bold text-gray-700 select-none">
                                                    會議已完成
                                                </label>
                                            </div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">會議紀錄</label>
                                            <textarea
                                                value={completeMeetingForm.minutes}
                                                onChange={e => handleCompleteMeetingFormChange('minutes', e.target.value)}
                                                rows={6}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 focus:ring-2 focus:ring-green-100 resize-none"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">上傳照片</label>
                                            <input
                                                type="file"
                                                accept="image/*"
                                                multiple
                                                onChange={e => handleCompletePhotoUpload(e.target.files)}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800"
                                            />
                                            {Array.isArray(completeMeetingForm.photos) && completeMeetingForm.photos.length > 0 && (
                                                <div className="grid grid-cols-4 gap-2 mt-2">
                                                    {completeMeetingForm.photos.map((p, idx) => (
                                                        <div key={idx} className="relative">
                                                            <img
                                                                src={p.dataUrl || p}
                                                                alt="預覽"
                                                                className="w-full h-24 object-cover rounded"
                                                            />
                                                            <button
                                                                type="button"
                                                                onClick={() => handleRemoveCompletePhoto(idx)}
                                                                className="absolute top-1 right-1 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs"
                                                            >
                                                                ×
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="px-6 pb-6 pt-4 border-t border-gray-100 flex gap-3 flex-shrink-0">
                                        <button
                                            type="button"
                                            onClick={() => setCompleteMeetingModalOpen(false)}
                                            className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition"
                                        >
                                            取消
                                        </button>
                                        <button
                                            type="button"
                                            onClick={handleSaveCompleteOverviewMeeting}
                                            className="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition shadow-lg shadow-green-200"
                                        >
                                            完成
                                        </button>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}

                    {isEditUserModalOpen && (
                        <div className="fixed inset-0 z-[80] bg-black/50 flex items-center justify-center p-4" onClick={() => setIsEditUserModalOpen(false)}>
                            <div className="bg-white rounded-2xl w-full max-w-sm p-6" onClick={e => e.stopPropagation()}>
                                <h3 className="font-bold text-lg mb-4 text-gray-800">編輯帳號</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">姓名</label>
                                        <input
                                            type="text"
                                            value={editUserForm.name}
                                            onChange={e => setEditUserForm({ ...editUserForm, name: e.target.value })}
                                            className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 font-bold focus:ring-2 focus:ring-blue-100"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">角色</label>
                                        <select
                                            value={editUserForm.role}
                                            onChange={e => setEditUserForm({ ...editUserForm, role: e.target.value })}
                                            className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 font-bold focus:ring-2 focus:ring-blue-100"
                                        >
                                            <option value="staff">員工</option>
                                            <option value="cadre">幹部</option>
                                            <option value="hr">人事</option>
                                            <option value="manager">管理層</option>
                                            <option value="admin">系統管理員</option>
                                            {roles.filter(r => !['staff','cadre','hr','manager','admin'].includes(r.id)).map(r => (
                                                <option key={r.id} value={r.id}>{r.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">職稱</label>
                                        <input
                                            type="text"
                                            value={editUserForm.title}
                                            onChange={e => setEditUserForm({ ...editUserForm, title: e.target.value })}
                                            className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 font-bold focus:ring-2 focus:ring-blue-100"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">電話</label>
                                        <input
                                            type="text"
                                            value={editUserForm.phone}
                                            onChange={e => setEditUserForm({ ...editUserForm, phone: e.target.value })}
                                            className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 font-bold focus:ring-2 focus:ring-blue-100"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Email</label>
                                        <input
                                            type="email"
                                            value={editUserForm.email}
                                            onChange={e => setEditUserForm({ ...editUserForm, email: e.target.value })}
                                            className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 font-bold focus:ring-2 focus:ring-blue-100"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">狀態</label>
                                        <select
                                            value={editUserForm.status}
                                            onChange={e => setEditUserForm({ ...editUserForm, status: e.target.value })}
                                            className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 font-bold focus:ring-2 focus:ring-blue-100"
                                        >
                                            <option value="在職">在職</option>
                                            <option value="離職">離職</option>
                                        </select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">在職起始時間</label>
                                            <input
                                                type="date"
                                                value={editUserForm.startDate}
                                                onChange={e => setEditUserForm({ ...editUserForm, startDate: e.target.value })}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 font-bold focus:ring-2 focus:ring-blue-100"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">離職起始時間</label>
                                            <input
                                                type="date"
                                                value={editUserForm.resignDate}
                                                onChange={e => setEditUserForm({ ...editUserForm, resignDate: e.target.value })}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-gray-800 font-bold focus:ring-2 focus:ring-blue-100"
                                            />
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-6 flex justify-end gap-2">
                                    <button 
                                        onClick={() => setIsEditUserModalOpen(false)}
                                        className="px-4 py-2 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200"
                                    >
                                        取消
                                    </button>
                                    <button 
                                        onClick={handleUpdateUserSubmit}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200"
                                    >
                                        儲存
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showScheduleModal && (
                        <div className="fixed inset-0 z-[100] bg-black/50 flex items-center justify-center p-4" onClick={() => setShowScheduleModal(false)}>
                            <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up p-6" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold text-gray-800 mb-4 text-center">
                                    {scheduleModalDate} 排班
                                </h3>
                                
                                <div className="grid grid-cols-3 gap-3 mb-6">
                                    <button
                                        onClick={() => setScheduleForm(prev => ({ ...prev, type: 'work', startTime: '09:00', endTime: '17:30' }))}
                                        className={`p-3 rounded-xl font-bold text-sm transition-all ${scheduleForm.type === 'work' ? 'bg-blue-600 text-white shadow-lg shadow-blue-200 transform scale-105' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}
                                    >
                                        上班
                                    </button>
                                    <button
                                        onClick={() => setScheduleForm(prev => ({ ...prev, type: 'duty', startTime: '09:00', endTime: '17:30' }))}
                                        className={`p-3 rounded-xl font-bold text-sm transition-all ${scheduleForm.type === 'duty' ? 'bg-yellow-400 text-white shadow-lg shadow-yellow-200 transform scale-105' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}
                                    >
                                        值班
                                    </button>
                                    <button
                                        onClick={() => setScheduleForm(prev => ({ ...prev, type: 'off' }))}
                                        className={`p-3 rounded-xl font-bold text-sm transition-all ${scheduleForm.type === 'off' ? 'bg-orange-500 text-white shadow-lg shadow-orange-200 transform scale-105' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}
                                    >
                                        特休
                                    </button>
                                    <button
                                        onClick={() => setScheduleForm(prev => ({ ...prev, type: 'leave' }))}
                                        className={`p-3 rounded-xl font-bold text-sm transition-all ${scheduleForm.type === 'leave' ? 'bg-orange-100 text-orange-700 border border-orange-200 shadow-lg shadow-orange-200 transform scale-105' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}
                                    >
                                        請假
                                    </button>
                                    <button
                                        onClick={() => setScheduleForm(prev => ({ ...prev, type: 'holiday' }))}
                                        className={`p-3 rounded-xl font-bold text-sm transition-all ${scheduleForm.type === 'holiday' ? 'bg-stone-600 text-white shadow-lg shadow-stone-200 transform scale-105' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}
                                    >
                                        假日
                                    </button>
                                    <button
                                        onClick={() => setScheduleForm(prev => ({ ...prev, type: 'comp_leave' }))}
                                        className={`p-3 rounded-xl font-bold text-sm transition-all ${scheduleForm.type === 'comp_leave' ? 'bg-indigo-500 text-white shadow-lg shadow-indigo-200 transform scale-105' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}
                                    >
                                        補休
                                    </button>
                                </div>

                                {(!['off','leave','holiday','comp_leave'].includes(scheduleForm.type)) && (
                                    <div className="space-y-4 mb-6">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">上班時間</label>
                                            <input
                                                type="time"
                                                value={scheduleForm.startTime}
                                                onChange={e => setScheduleForm(prev => ({ ...prev, startTime: e.target.value }))}
                                                className="w-full bg-gray-50 border-0 p-3 rounded-xl text-lg font-bold text-gray-800 focus:ring-2 focus:ring-blue-100"
                                            />
                                        </div>
                                        <div>
                                            <div className="flex items-center justify-between mb-1">
                                                <label className="block text-xs font-bold text-gray-500 uppercase">下班時間</label>
                                                <div className="flex items-center gap-2">
                                                    <label className="flex items-center gap-1 cursor-pointer">
                                                        <input 
                                                            type="checkbox" 
                                                            checked={scheduleForm.crossDay || false}
                                                            onChange={e => setScheduleForm(prev => ({ ...prev, crossDay: e.target.checked }))}
                                                            className="w-3 h-3 text-red-600 rounded focus:ring-red-500 border-gray-300"
                                                        />
                                                        <span className="text-xs font-bold text-gray-500">跨日</span>
                                                    </label>
                                                    {scheduleForm.crossDay && (
                                                        <span className="text-xs font-bold text-white bg-red-500 px-2 py-0.5 rounded-full shadow-sm animate-pulse">
                                                            次日
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                            <input
                                                type="time"
                                                value={scheduleForm.endTime}
                                                onChange={e => setScheduleForm(prev => ({ ...prev, endTime: e.target.value }))}
                                                className={`w-full bg-gray-50 border-0 p-3 rounded-xl text-lg font-bold focus:ring-2 focus:ring-blue-100 ${scheduleForm.crossDay ? 'text-red-600 bg-red-50' : 'text-gray-800'}`}
                                            />
                                        </div>
                                    </div>
                                )}

                                <div className="flex gap-3">
                                    <button
                                        onClick={handleDeleteSchedule}
                                        disabled={scheduleSaving}
                                        className="flex-1 py-3 bg-red-100 text-red-600 rounded-xl font-bold hover:bg-red-200 transition"
                                    >
                                        刪除
                                    </button>
                                    <button
                                        onClick={() => setShowScheduleModal(false)}
                                        className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition"
                                    >
                                        取消
                                    </button>
                                    <button
                                        onClick={handleSaveSchedule}
                                        disabled={scheduleSaving}
                                        className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-200 disabled:opacity-50"
                                    >
                                        {scheduleSaving ? '儲存中...' : '確認儲存'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showAdminDeleteModal && (
                        <div className="fixed inset-0 z-[80] bg-black/50 flex items-center justify-center p-4" onClick={() => setShowAdminDeleteModal(false)}>
                            <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-gray-800 mb-4">確認刪除</h3>
                                <p className="text-gray-600 mb-6">確定要刪除此筆紀錄嗎？此動作無法復原。</p>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => setShowAdminDeleteModal(false)}
                                        className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition-colors"
                                    >
                                        取消
                                    </button>
                                    <button 
                                        onClick={confirmAdminDelete}
                                        className="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors"
                                    >
                                        確認
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {notificationToDeleteId && (
                        <div className="fixed inset-0 z-[80] bg-black/50 flex items-center justify-center p-4" onClick={() => setNotificationToDeleteId(null)}>
                            <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-gray-800 mb-4">確認刪除通知</h3>
                                <p className="text-gray-600 mb-6">確定要刪除此通知嗎？此動作無法復原。</p>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => setNotificationToDeleteId(null)}
                                        className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition-colors"
                                    >
                                        取消
                                    </button>
                                    <button 
                                        onClick={confirmDeleteNotification}
                                        className="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors"
                                    >
                                        確認
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {toast && (
                        <div className={`fixed top-[10vh] left-1/2 -translate-x-1/2 z-[75] px-6 py-4 rounded-2xl shadow-xl flex items-center gap-3 transition-all transform duration-300 ${toast === '打卡完成' ? 'bg-green-600 scale-110 top-1/2 -translate-y-1/2' : 'bg-gray-800'}`}>
                           {toast === '打卡完成' && <CheckCircle className="w-8 h-8 text-white" />}
                           <span className={`${toast === '打卡完成' ? 'text-xl font-bold' : 'text-sm'} text-white`}>{toast}</span>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
