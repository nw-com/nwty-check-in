rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isLoggedIn() {
      return request.auth != null;
    }

    function isSelf(uid) {
      return isLoggedIn() && request.auth.uid == uid;
    }

    // 認定「系統管理員」角色可管理後台資料
    function isAdmin() {
      return isLoggedIn() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "系統管理員";
    }

    // 幹部身份可讀公司內他人資料
    function isOfficer() {
      return isLoggedIn() && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "系統管理員" ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "管理層" ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "高階主管" ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "初階主管" ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "行政"
      );
    }
    function canTab(tab) {
      return isLoggedIn() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.pagePermissions != null &&
        (tab in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.pagePermissions);
    }

    // 使用者資料：可讀（登入），建立/刪除（管理員），本人更新但不可改變角色
    match /users/{uid} {
      allow read: if isLoggedIn();
      allow create: if isAdmin();
      allow update: if isAdmin() || (isSelf(uid) && request.resource.data.role == resource.data.role);
      allow delete: if isAdmin();
    }

    // 後台管理資料：僅管理員可寫入；登入者可讀取
    match /companies/{docId} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }

    match /regions/{docId} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }

    match /licenses/{docId} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }

    match /communities/{docId} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }

    // 打卡紀錄：登入者可讀與建立，更新/刪除限管理員或本人
    match /checkins/{docId} {
      allow read: if canTab('leader') || isOfficer() || (isLoggedIn() && resource.data.uid == request.auth.uid);
      allow create: if isLoggedIn() && request.resource.data.uid == request.auth.uid;
      allow update, delete: if isAdmin() || (isLoggedIn() && resource.data.uid == request.auth.uid);
    }

    // 帳號申請：任何人可提交；僅管理員可讀取/修改/刪除
    match /pendingAccounts/{docId} {
      allow create: if
        request.resource.data.keys().hasOnly([
          'photoUrl','name','title','email','phone','licenses','role',
          'companyId','serviceCommunities','pagePermissions','status','createdAt'
        ]) &&
        (request.resource.data.photoUrl == null || request.resource.data.photoUrl is string) &&
        request.resource.data.name is string &&
        (request.resource.data.title == null || request.resource.data.title is string) &&
        request.resource.data.email is string &&
        (request.resource.data.phone == null || request.resource.data.phone is string) &&
        (request.resource.data.licenses == null || request.resource.data.licenses is list) &&
        (request.resource.data.companyId == null || request.resource.data.companyId is string) &&
        (request.resource.data.serviceCommunities == null || request.resource.data.serviceCommunities is list) &&
        (request.resource.data.pagePermissions == null || request.resource.data.pagePermissions is list) &&
        request.resource.data.role == '一般' &&
        request.resource.data.status == '待審核' &&
        (request.resource.data.createdAt == null || request.resource.data.createdAt is timestamp || request.resource.data.createdAt is string);

      allow read: if isAdmin() || (isLoggedIn() && resource.data.email == request.auth.token.email);
      allow update, delete: if isAdmin();
    }

    // 請假申請：本人可讀與建立；更新/刪除限管理員或本人（且未核准）
    match /leaveRequests/{docId} {
      allow read: if canTab('leader') || isOfficer() || isAdmin() || (isLoggedIn() && resource.data.uid == request.auth.uid);
      allow create: if isLoggedIn() && request.resource.data.uid == request.auth.uid && request.resource.data.status == '送審';
      allow update: if canTab('leader') || isAdmin() || (
        isLoggedIn() &&
        resource.data.uid == request.auth.uid &&
        resource.data.status != '核准' &&
        request.resource.data.status == resource.data.status
      );
      allow delete: if isAdmin() || canTab('leader') || (
        isLoggedIn() && resource.data.uid == request.auth.uid && resource.data.status != '核准'
      );
    }

    // 計點規則：所有登入者可讀；僅管理員可寫
    match /pointsRules/{docId} {
      allow read: if isLoggedIn() || isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // 計點申訴：本人可建立與讀取（僅本人或管理員）；管理員可讀寫刪除
    match /pointAppeals/{docId} {
      allow read: if canTab('leader') || isOfficer() || isAdmin() || (isLoggedIn() && resource.data.uid == request.auth.uid);
      allow create: if isLoggedIn() && request.resource.data.uid == request.auth.uid && request.resource.data.state == '送審';
      allow update: if canTab('leader') || isAdmin();
      allow delete: if canTab('leader') || isAdmin();
    }
    match /makeupRequests/{docId} {
      allow read: if canTab('leader') || isOfficer() || isAdmin() || (isLoggedIn() && resource.data.uid == request.auth.uid);
      allow create: if isLoggedIn() && request.resource.data.uid == request.auth.uid && request.resource.data.state == '送審';
      allow update: if canTab('leader') || isAdmin();
      allow delete: if canTab('leader') || isAdmin();
    }

    // 角色設定：登入者可讀；僅系統管理員可寫入
    match /roles/{docId} {
      allow read: if isLoggedIn();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
  }
}
